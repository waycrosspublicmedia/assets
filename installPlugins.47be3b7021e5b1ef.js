//  Merci-Michel [R]
//  https://www.merci-michel.com/
//  Build 20240429-165907

var e=Object.defineProperty,t=Object.defineProperties,i=Object.getOwnPropertyDescriptors,n=Object.getOwnPropertySymbols,r=Object.prototype.hasOwnProperty,s=Object.prototype.propertyIsEnumerable,a=(t,i,n)=>i in t?e(t,i,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[i]=n,o=(e,t)=>{for(var i in t||(t={}))r.call(t,i)&&a(e,i,t[i]);if(n)for(var i of n(t))s.call(t,i)&&a(e,i,t[i]);return e},l=(e,n)=>t(e,i(n));import{l as c,W as u,m as h,g as d,A as p,w as m,s as f,n as g,o as v,p as y,q as x,t as _,v as b,c as w,M,e as S,f as T,h as A,i as C,j as L,k as P}from"./messages.c5e9087321e5b1ef.js";import{K as E,i as D,g as I,h as R,a as z,a3 as N,w as O,a4 as F,a5 as U,m as k,A as B,y as V}from"./vendor.1eed6b1e21e5b1ef.js";import{r as G,l as W,k as H,j,m as q,a as X,d as Y,n as Z,w as J,p as Q,q as K,s as $,t as ee}from"./caution.2f23ff8a21e5b1ef.js";function te(e,t=0,i=1){return(e-t)/(i-t)}function ie(e,t,i,n,r){return n+(e-t)/(i-t)*(r-n)}function ne(e,t,i){const n=c((i-e)/(t-e),0,1);return n*n*(3-2*n)}function re(e,t,i={}){if(!e._isStoreSignal||!t)return;const n=i.session?sessionStorage:localStorage,r=i.type,s=i.boolean||r===Boolean,a=i.number||r===Number;let o=n.getItem(t);return null==o?o=e.value:s?o=!!+o:a&&(o=isNaN(+o)?0:+o),e.value=o,e.watch((e=>{let i=e;s?i=i?1:0:a&&(i=isNaN(+i)?0:+i),n.setItem(t,i)})),e}function se(e={}){e.notFoundComponent?h.push({path:"/:pathMatch(.*)*",name:"404",component:e.notFoundComponent}):h.push({path:"/:pathMatch(.*)*",redirect:"/"});const t=e.historyMode(d()),i=E(Object.assign({routes:h,history:t},e)),n=i.install.bind(i);return i.install=function(e){e.component("AnimatedRouterView",p),n.call(this,e)},i}var ae={setup(e,{expose:t}){const i=D(),n=B()?V("webGL"):Uf;let r=D();return I((()=>{r.value=n.getElement(),r.value.classList.add("webgl-canvas"),i.value.appendChild(r.value)})),R((()=>{r=null})),t({wrapper:i,canvas:r}),(e,t)=>t[0]||(N(-1),t[0]=z("aside",{ref:(e,t)=>{t.wrapper=e,i.value=e},class:"webgl-wrapper"},null,512),N(1),t[0])}};function oe(e,t,i=0){if("string"==typeof e&&(e=t[e]),0===i)return function(){return e.call(t)};if(1===i)return function(i){return e.call(t,i)};if(2===i)return function(i,n){return e.call(t,i,n)};if(3===i)return function(i,n,r){return e.call(t,i,n,r)};if(4===i)return function(i,n,r,s){return e.call(t,i,n,r,s)};if(5===i)return function(i,n,r,s,a){return e.call(t,i,n,r,s,a)};throw new Error("Too many arguments")}function le(e,t,i=Number.MAX_SAFE_INTEGER){const n=[];function r(){return new e}return"function"==typeof t&&(e.prototype.onPoolReset=t),e.prototype.release=function(){return e.release(this),this},e.alloc=function(t){if(!(t<=0))for(;t--;)e.release(r())},e.get=function(){const e=n.pop()||r();return e.onPoolReset&&e.onPoolReset(e),e},e.release=function(){let e=arguments.length;for(;e--;)n.length<i&&n.push(arguments[e])},e}class ce{addEventListener(e,t){void 0===this._listeners&&(this._listeners={});const i=this._listeners;void 0===i[e]&&(i[e]=[]),-1===i[e].indexOf(t)&&i[e].push(t)}hasEventListener(e,t){if(void 0===this._listeners)return!1;const i=this._listeners;return void 0!==i[e]&&-1!==i[e].indexOf(t)}removeEventListener(e,t){if(void 0===this._listeners)return;const i=this._listeners[e];if(void 0!==i){const e=i.indexOf(t);-1!==e&&i.splice(e,1)}}dispatchEvent(e){if(void 0===this._listeners)return;const t=this._listeners[e.type];if(void 0!==t){e.target=this;const i=t.slice(0);for(let t=0,n=i.length;t<n;t++)i[t].call(this,e);e.target=null}}}const ue=Math.PI/180,he=180/Math.PI,de=[];for(let jf=0;jf<256;jf++)de[jf]=(jf<16?"0":"")+jf.toString(16);const pe="undefined"!=typeof crypto&&"randomUUID"in crypto;function me(){if(pe)return crypto.randomUUID().toUpperCase();const e=4294967295*Math.random()|0,t=4294967295*Math.random()|0,i=4294967295*Math.random()|0,n=4294967295*Math.random()|0;return(de[255&e]+de[e>>8&255]+de[e>>16&255]+de[e>>24&255]+"-"+de[255&t]+de[t>>8&255]+"-"+de[t>>16&15|64]+de[t>>24&255]+"-"+de[63&i|128]+de[i>>8&255]+"-"+de[i>>16&255]+de[i>>24&255]+de[255&n]+de[n>>8&255]+de[n>>16&255]+de[n>>24&255]).toUpperCase()}function fe(e,t,i){return Math.max(t,Math.min(i,e))}function ge(e,t,i){return(1-i)*e+i*t}function ve(e){return 0==(e&e-1)&&0!==e}function ye(e){return Math.pow(2,Math.floor(Math.log(e)/Math.LN2))}class xe{constructor(e=0,t=0){this.x=e,this.y=t}get width(){return this.x}set width(e){this.x=e}get height(){return this.y}set height(e){this.y=e}set(e,t){return this.x=e,this.y=t,this}setScalar(e){return this.x=e,this.y=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setComponent(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;default:throw new Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;default:throw new Error("index is out of range: "+e)}}clone(){return new this.constructor(this.x,this.y)}copy(e){return this.x=e.x,this.y=e.y,this}add(e,t){return void 0!==t?this.addVectors(e,t):(this.x+=e.x,this.y+=e.y,this)}addScalar(e){return this.x+=e,this.y+=e,this}addVectors(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this}addScaledVector(e,t){return this.x+=e.x*t,this.y+=e.y*t,this}sub(e,t){return void 0!==t?this.subVectors(e,t):(this.x-=e.x,this.y-=e.y,this)}subScalar(e){return this.x-=e,this.y-=e,this}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this}multiply(e){return this.x*=e.x,this.y*=e.y,this}multiplyScalar(e){return this.x*=e,this.y*=e,this}divide(e){return this.x/=e.x,this.y/=e.y,this}divideScalar(e){return this.multiplyScalar(1/e)}applyMatrix3(e){const t=this.x,i=this.y,n=e.elements;return this.x=n[0]*t+n[3]*i+n[6],this.y=n[1]*t+n[4]*i+n[7],this}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this}clamp(e,t){return this.x=Math.max(e.x,Math.min(t.x,this.x)),this.y=Math.max(e.y,Math.min(t.y,this.y)),this}clampScalar(e,t){return this.x=Math.max(e,Math.min(t,this.x)),this.y=Math.max(e,Math.min(t,this.y)),this}clampLength(e,t){const i=this.length();return this.divideScalar(i||1).multiplyScalar(Math.max(e,Math.min(t,i)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}roundToZero(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this}negate(){return this.x=-this.x,this.y=-this.y,this}dot(e){return this.x*e.x+this.y*e.y}cross(e){return this.x*e.y-this.y*e.x}lengthSq(){return this.x*this.x+this.y*this.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)}normalize(){return this.divideScalar(this.length()||1)}angle(){return Math.atan2(-this.y,-this.x)+Math.PI}distanceTo(e){return Math.sqrt(this.distanceToSquared(e))}distanceToSquared(e){const t=this.x-e.x,i=this.y-e.y;return t*t+i*i}manhattanDistanceTo(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this}lerpVectors(e,t,i){return this.x=e.x+(t.x-e.x)*i,this.y=e.y+(t.y-e.y)*i,this}equals(e){return e.x===this.x&&e.y===this.y}fromArray(e,t=0){return this.x=e[t],this.y=e[t+1],this}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e}fromBufferAttribute(e,t,i){return this.x=e.getX(t),this.y=e.getY(t),this}rotateAround(e,t){const i=Math.cos(t),n=Math.sin(t),r=this.x-e.x,s=this.y-e.y;return this.x=r*i-s*n+e.x,this.y=r*n+s*i+e.y,this}random(){return this.x=Math.random(),this.y=Math.random(),this}*[Symbol.iterator](){yield this.x,yield this.y}}xe.prototype.isVector2=!0;class _e{constructor(){this.elements=[1,0,0,0,1,0,0,0,1]}set(e,t,i,n,r,s,a,o,l){const c=this.elements;return c[0]=e,c[1]=n,c[2]=a,c[3]=t,c[4]=r,c[5]=o,c[6]=i,c[7]=s,c[8]=l,this}identity(){return this.set(1,0,0,0,1,0,0,0,1),this}copy(e){const t=this.elements,i=e.elements;return t[0]=i[0],t[1]=i[1],t[2]=i[2],t[3]=i[3],t[4]=i[4],t[5]=i[5],t[6]=i[6],t[7]=i[7],t[8]=i[8],this}extractBasis(e,t,i){return e.setFromMatrix3Column(this,0),t.setFromMatrix3Column(this,1),i.setFromMatrix3Column(this,2),this}setFromMatrix4(e){const t=e.elements;return this.set(t[0],t[4],t[8],t[1],t[5],t[9],t[2],t[6],t[10]),this}multiply(e){return this.multiplyMatrices(this,e)}premultiply(e){return this.multiplyMatrices(e,this)}multiplyMatrices(e,t){const i=e.elements,n=t.elements,r=this.elements,s=i[0],a=i[3],o=i[6],l=i[1],c=i[4],u=i[7],h=i[2],d=i[5],p=i[8],m=n[0],f=n[3],g=n[6],v=n[1],y=n[4],x=n[7],_=n[2],b=n[5],w=n[8];return r[0]=s*m+a*v+o*_,r[3]=s*f+a*y+o*b,r[6]=s*g+a*x+o*w,r[1]=l*m+c*v+u*_,r[4]=l*f+c*y+u*b,r[7]=l*g+c*x+u*w,r[2]=h*m+d*v+p*_,r[5]=h*f+d*y+p*b,r[8]=h*g+d*x+p*w,this}multiplyScalar(e){const t=this.elements;return t[0]*=e,t[3]*=e,t[6]*=e,t[1]*=e,t[4]*=e,t[7]*=e,t[2]*=e,t[5]*=e,t[8]*=e,this}determinant(){const e=this.elements,t=e[0],i=e[1],n=e[2],r=e[3],s=e[4],a=e[5],o=e[6],l=e[7],c=e[8];return t*s*c-t*a*l-i*r*c+i*a*o+n*r*l-n*s*o}invert(){const e=this.elements,t=e[0],i=e[1],n=e[2],r=e[3],s=e[4],a=e[5],o=e[6],l=e[7],c=e[8],u=c*s-a*l,h=a*o-c*r,d=l*r-s*o,p=t*u+i*h+n*d;if(0===p)return this.set(0,0,0,0,0,0,0,0,0);const m=1/p;return e[0]=u*m,e[1]=(n*l-c*i)*m,e[2]=(a*i-n*s)*m,e[3]=h*m,e[4]=(c*t-n*o)*m,e[5]=(n*r-a*t)*m,e[6]=d*m,e[7]=(i*o-l*t)*m,e[8]=(s*t-i*r)*m,this}transpose(){let e;const t=this.elements;return e=t[1],t[1]=t[3],t[3]=e,e=t[2],t[2]=t[6],t[6]=e,e=t[5],t[5]=t[7],t[7]=e,this}getNormalMatrix(e){return this.setFromMatrix4(e).invert().transpose()}transposeIntoArray(e){const t=this.elements;return e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8],this}setUvTransform(e,t,i,n,r,s,a){const o=Math.cos(r),l=Math.sin(r);return this.set(i*o,i*l,-i*(o*s+l*a)+s+e,-n*l,n*o,-n*(-l*s+o*a)+a+t,0,0,1),this}scale(e,t){const i=this.elements;return i[0]*=e,i[3]*=e,i[6]*=e,i[1]*=t,i[4]*=t,i[7]*=t,this}rotate(e){const t=Math.cos(e),i=Math.sin(e),n=this.elements,r=n[0],s=n[3],a=n[6],o=n[1],l=n[4],c=n[7];return n[0]=t*r+i*o,n[3]=t*s+i*l,n[6]=t*a+i*c,n[1]=-i*r+t*o,n[4]=-i*s+t*l,n[7]=-i*a+t*c,this}translate(e,t){const i=this.elements;return i[0]+=e*i[2],i[3]+=e*i[5],i[6]+=e*i[8],i[1]+=t*i[2],i[4]+=t*i[5],i[7]+=t*i[8],this}equals(e){const t=this.elements,i=e.elements;for(let n=0;n<9;n++)if(t[n]!==i[n])return!1;return!0}fromArray(e,t=0){for(let i=0;i<9;i++)this.elements[i]=e[i+t];return this}toArray(e=[],t=0){const i=this.elements;return e[t]=i[0],e[t+1]=i[1],e[t+2]=i[2],e[t+3]=i[3],e[t+4]=i[4],e[t+5]=i[5],e[t+6]=i[6],e[t+7]=i[7],e[t+8]=i[8],e}clone(){return(new this.constructor).fromArray(this.elements)}}function be(e){if(0===e.length)return-Infinity;let t=e[0];for(let i=1,n=e.length;i<n;++i)e[i]>t&&(t=e[i]);return t}function we(e){return document.createElementNS("http://www.w3.org/1999/xhtml",e)}let Me;_e.prototype.isMatrix3=!0;let Se=0;class Te extends ce{constructor(e=Te.DEFAULT_IMAGE,t=Te.DEFAULT_MAPPING,i=1001,n=1001,r=1006,s=1008,a=1023,o=1009,l=1,c=3e3){super(),Object.defineProperty(this,"id",{value:Se++}),this.uuid=me(),this.name="",this.image=e,this.mipmaps=[],this.mapping=t,this.wrapS=i,this.wrapT=n,this.magFilter=r,this.minFilter=s,this.anisotropy=l,this.format=a,this.internalFormat=null,this.type=o,this.offset=new xe(0,0),this.repeat=new xe(1,1),this.center=new xe(0,0),this.rotation=0,this.matrixAutoUpdate=!0,this.matrix=new _e,this.generateMipmaps=!0,this.premultiplyAlpha=!1,this.flipY=!0,this.unpackAlignment=4,this.encoding=c,this.version=0,this.onUpdate=null,this.isRenderTargetTexture=!1}updateMatrix(){this.matrix.setUvTransform(this.offset.x,this.offset.y,this.repeat.x,this.repeat.y,this.rotation,this.center.x,this.center.y)}clone(){return(new this.constructor).copy(this)}copy(e){return this.name=e.name,this.image=e.image,this.mipmaps=e.mipmaps.slice(0),this.mapping=e.mapping,this.wrapS=e.wrapS,this.wrapT=e.wrapT,this.magFilter=e.magFilter,this.minFilter=e.minFilter,this.anisotropy=e.anisotropy,this.format=e.format,this.internalFormat=e.internalFormat,this.type=e.type,this.offset.copy(e.offset),this.repeat.copy(e.repeat),this.center.copy(e.center),this.rotation=e.rotation,this.matrixAutoUpdate=e.matrixAutoUpdate,this.matrix.copy(e.matrix),this.generateMipmaps=e.generateMipmaps,this.premultiplyAlpha=e.premultiplyAlpha,this.flipY=e.flipY,this.unpackAlignment=e.unpackAlignment,this.encoding=e.encoding,this}toJSON(e){const t=void 0===e||"string"==typeof e;if(!t&&void 0!==e.textures[this.uuid])return e.textures[this.uuid];const i={metadata:{version:4.5,type:"Texture",generator:"Texture.toJSON"},uuid:this.uuid,name:this.name,mapping:this.mapping,repeat:[this.repeat.x,this.repeat.y],offset:[this.offset.x,this.offset.y],center:[this.center.x,this.center.y],rotation:this.rotation,wrap:[this.wrapS,this.wrapT],format:this.format,type:this.type,encoding:this.encoding,minFilter:this.minFilter,magFilter:this.magFilter,anisotropy:this.anisotropy,flipY:this.flipY,premultiplyAlpha:this.premultiplyAlpha,unpackAlignment:this.unpackAlignment};if(void 0!==this.image){const n=this.image;if(void 0===n.uuid&&(n.uuid=me()),!t&&void 0===e.images[n.uuid]){let t;if(Array.isArray(n)){t=[];for(let e=0,i=n.length;e<i;e++)n[e].isDataTexture?t.push(Ae(n[e].image)):t.push(Ae(n[e]))}else t=Ae(n);e.images[n.uuid]={uuid:n.uuid,url:t}}i.image=n.uuid}return t||(e.textures[this.uuid]=i),i}dispose(){this.dispatchEvent({type:"dispose"})}transformUv(e){if(300!==this.mapping)return e;if(e.applyMatrix3(this.matrix),e.x<0||e.x>1)switch(this.wrapS){case 1e3:e.x=e.x-Math.floor(e.x);break;case 1001:e.x=e.x<0?0:1;break;case 1002:1===Math.abs(Math.floor(e.x)%2)?e.x=Math.ceil(e.x)-e.x:e.x=e.x-Math.floor(e.x)}if(e.y<0||e.y>1)switch(this.wrapT){case 1e3:e.y=e.y-Math.floor(e.y);break;case 1001:e.y=e.y<0?0:1;break;case 1002:1===Math.abs(Math.floor(e.y)%2)?e.y=Math.ceil(e.y)-e.y:e.y=e.y-Math.floor(e.y)}return this.flipY&&(e.y=1-e.y),e}set needsUpdate(e){!0===e&&this.version++}}function Ae(e){return"undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap?class{static getDataURL(e){if(/^data:/i.test(e.src))return e.src;if("undefined"==typeof HTMLCanvasElement)return e.src;let t;if(e instanceof HTMLCanvasElement)t=e;else{void 0===Me&&(Me=we("canvas")),Me.width=e.width,Me.height=e.height;const i=Me.getContext("2d");e instanceof ImageData?i.putImageData(e,0,0):i.drawImage(e,0,0,e.width,e.height),t=Me}return t.width>2048||t.height>2048?t.toDataURL("image/jpeg",.6):t.toDataURL("image/png")}}.getDataURL(e):e.data?{data:Array.prototype.slice.call(e.data),width:e.width,height:e.height,type:e.data.constructor.name}:{}}Te.DEFAULT_IMAGE=void 0,Te.DEFAULT_MAPPING=300,Te.prototype.isTexture=!0;class Ce{constructor(e=0,t=0,i=0,n=1){this.x=e,this.y=t,this.z=i,this.w=n}get width(){return this.z}set width(e){this.z=e}get height(){return this.w}set height(e){this.w=e}set(e,t,i,n){return this.x=e,this.y=t,this.z=i,this.w=n,this}setScalar(e){return this.x=e,this.y=e,this.z=e,this.w=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setZ(e){return this.z=e,this}setW(e){return this.w=e,this}setComponent(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;case 2:this.z=t;break;case 3:this.w=t;break;default:throw new Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;case 3:return this.w;default:throw new Error("index is out of range: "+e)}}clone(){return new this.constructor(this.x,this.y,this.z,this.w)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=void 0!==e.w?e.w:1,this}add(e,t){return void 0!==t?this.addVectors(e,t):(this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this)}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this.w+=e,this}addVectors(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this.w=e.w+t.w,this}addScaledVector(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this.w+=e.w*t,this}sub(e,t){return void 0!==t?this.subVectors(e,t):(this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this)}subScalar(e){return this.x-=e,this.y-=e,this.z-=e,this.w-=e,this}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this.w=e.w-t.w,this}multiply(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this}multiplyScalar(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this}applyMatrix4(e){const t=this.x,i=this.y,n=this.z,r=this.w,s=e.elements;return this.x=s[0]*t+s[4]*i+s[8]*n+s[12]*r,this.y=s[1]*t+s[5]*i+s[9]*n+s[13]*r,this.z=s[2]*t+s[6]*i+s[10]*n+s[14]*r,this.w=s[3]*t+s[7]*i+s[11]*n+s[15]*r,this}divideScalar(e){return this.multiplyScalar(1/e)}setAxisAngleFromQuaternion(e){this.w=2*Math.acos(e.w);const t=Math.sqrt(1-e.w*e.w);return t<1e-4?(this.x=1,this.y=0,this.z=0):(this.x=e.x/t,this.y=e.y/t,this.z=e.z/t),this}setAxisAngleFromRotationMatrix(e){let t,i,n,r;const s=.01,a=.1,o=e.elements,l=o[0],c=o[4],u=o[8],h=o[1],d=o[5],p=o[9],m=o[2],f=o[6],g=o[10];if(Math.abs(c-h)<s&&Math.abs(u-m)<s&&Math.abs(p-f)<s){if(Math.abs(c+h)<a&&Math.abs(u+m)<a&&Math.abs(p+f)<a&&Math.abs(l+d+g-3)<a)return this.set(1,0,0,0),this;t=Math.PI;const e=(l+1)/2,o=(d+1)/2,v=(g+1)/2,y=(c+h)/4,x=(u+m)/4,_=(p+f)/4;return e>o&&e>v?e<s?(i=0,n=.707106781,r=.707106781):(i=Math.sqrt(e),n=y/i,r=x/i):o>v?o<s?(i=.707106781,n=0,r=.707106781):(n=Math.sqrt(o),i=y/n,r=_/n):v<s?(i=.707106781,n=.707106781,r=0):(r=Math.sqrt(v),i=x/r,n=_/r),this.set(i,n,r,t),this}let v=Math.sqrt((f-p)*(f-p)+(u-m)*(u-m)+(h-c)*(h-c));return Math.abs(v)<.001&&(v=1),this.x=(f-p)/v,this.y=(u-m)/v,this.z=(h-c)/v,this.w=Math.acos((l+d+g-1)/2),this}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this.w=Math.min(this.w,e.w),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this.w=Math.max(this.w,e.w),this}clamp(e,t){return this.x=Math.max(e.x,Math.min(t.x,this.x)),this.y=Math.max(e.y,Math.min(t.y,this.y)),this.z=Math.max(e.z,Math.min(t.z,this.z)),this.w=Math.max(e.w,Math.min(t.w,this.w)),this}clampScalar(e,t){return this.x=Math.max(e,Math.min(t,this.x)),this.y=Math.max(e,Math.min(t,this.y)),this.z=Math.max(e,Math.min(t,this.z)),this.w=Math.max(e,Math.min(t,this.w)),this}clampLength(e,t){const i=this.length();return this.divideScalar(i||1).multiplyScalar(Math.max(e,Math.min(t,i)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this.w=Math.floor(this.w),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this.w=Math.ceil(this.w),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this.w=Math.round(this.w),this}roundToZero(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this.z=this.z<0?Math.ceil(this.z):Math.floor(this.z),this.w=this.w<0?Math.ceil(this.w):Math.floor(this.w),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)+Math.abs(this.w)}normalize(){return this.divideScalar(this.length()||1)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this.w+=(e.w-this.w)*t,this}lerpVectors(e,t,i){return this.x=e.x+(t.x-e.x)*i,this.y=e.y+(t.y-e.y)*i,this.z=e.z+(t.z-e.z)*i,this.w=e.w+(t.w-e.w)*i,this}equals(e){return e.x===this.x&&e.y===this.y&&e.z===this.z&&e.w===this.w}fromArray(e,t=0){return this.x=e[t],this.y=e[t+1],this.z=e[t+2],this.w=e[t+3],this}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w,e}fromBufferAttribute(e,t,i){return this.x=e.getX(t),this.y=e.getY(t),this.z=e.getZ(t),this.w=e.getW(t),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this.w=Math.random(),this}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z,yield this.w}}Ce.prototype.isVector4=!0;class Le extends ce{constructor(e,t,i={}){super(),this.width=e,this.height=t,this.depth=1,this.scissor=new Ce(0,0,e,t),this.scissorTest=!1,this.viewport=new Ce(0,0,e,t),this.texture=new Te(void 0,i.mapping,i.wrapS,i.wrapT,i.magFilter,i.minFilter,i.format,i.type,i.anisotropy,i.encoding),this.texture.isRenderTargetTexture=!0,this.texture.image={width:e,height:t,depth:1},this.texture.generateMipmaps=void 0!==i.generateMipmaps&&i.generateMipmaps,this.texture.internalFormat=void 0!==i.internalFormat?i.internalFormat:null,this.texture.minFilter=void 0!==i.minFilter?i.minFilter:1006,this.depthBuffer=void 0===i.depthBuffer||i.depthBuffer,this.stencilBuffer=void 0!==i.stencilBuffer&&i.stencilBuffer,this.depthTexture=void 0!==i.depthTexture?i.depthTexture:null}setTexture(e){e.image={width:this.width,height:this.height,depth:this.depth},this.texture=e}setSize(e,t,i=1){this.width===e&&this.height===t&&this.depth===i||(this.width=e,this.height=t,this.depth=i,this.texture.image.width=e,this.texture.image.height=t,this.texture.image.depth=i,this.dispose()),this.viewport.set(0,0,e,t),this.scissor.set(0,0,e,t)}clone(){return(new this.constructor).copy(this)}copy(e){return this.width=e.width,this.height=e.height,this.depth=e.depth,this.viewport.copy(e.viewport),this.texture=e.texture.clone(),this.texture.image=o({},this.texture.image),this.depthBuffer=e.depthBuffer,this.stencilBuffer=e.stencilBuffer,this.depthTexture=e.depthTexture,this}dispose(){this.dispatchEvent({type:"dispose"})}}Le.prototype.isWebGLRenderTarget=!0;class Pe extends Le{constructor(e,t,i){super(e,t,i),this.samples=4}copy(e){return super.copy.call(this,e),this.samples=e.samples,this}}Pe.prototype.isWebGLMultisampleRenderTarget=!0;class Ee{constructor(e=0,t=0,i=0,n=1){this._x=e,this._y=t,this._z=i,this._w=n}static slerp(e,t,i,n){return i.slerpQuaternions(e,t,n)}static slerpFlat(e,t,i,n,r,s,a){let o=i[n+0],l=i[n+1],c=i[n+2],u=i[n+3];const h=r[s+0],d=r[s+1],p=r[s+2],m=r[s+3];if(0===a)return e[t+0]=o,e[t+1]=l,e[t+2]=c,void(e[t+3]=u);if(1===a)return e[t+0]=h,e[t+1]=d,e[t+2]=p,void(e[t+3]=m);if(u!==m||o!==h||l!==d||c!==p){let e=1-a;const t=o*h+l*d+c*p+u*m,i=t>=0?1:-1,n=1-t*t;if(n>Number.EPSILON){const r=Math.sqrt(n),s=Math.atan2(r,t*i);e=Math.sin(e*s)/r,a=Math.sin(a*s)/r}const r=a*i;if(o=o*e+h*r,l=l*e+d*r,c=c*e+p*r,u=u*e+m*r,e===1-a){const e=1/Math.sqrt(o*o+l*l+c*c+u*u);o*=e,l*=e,c*=e,u*=e}}e[t]=o,e[t+1]=l,e[t+2]=c,e[t+3]=u}static multiplyQuaternionsFlat(e,t,i,n,r,s){const a=i[n],o=i[n+1],l=i[n+2],c=i[n+3],u=r[s],h=r[s+1],d=r[s+2],p=r[s+3];return e[t]=a*p+c*u+o*d-l*h,e[t+1]=o*p+c*h+l*u-a*d,e[t+2]=l*p+c*d+a*h-o*u,e[t+3]=c*p-a*u-o*h-l*d,e}get x(){return this._x}set x(e){this._x=e,this._onChangeCallback()}get y(){return this._y}set y(e){this._y=e,this._onChangeCallback()}get z(){return this._z}set z(e){this._z=e,this._onChangeCallback()}get w(){return this._w}set w(e){this._w=e,this._onChangeCallback()}set(e,t,i,n){return this._x=e,this._y=t,this._z=i,this._w=n,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._w)}copy(e){return this._x=e.x,this._y=e.y,this._z=e.z,this._w=e.w,this._onChangeCallback(),this}setFromEuler(e,t){if(!e||!e.isEuler)throw new Error("THREE.Quaternion: .setFromEuler() now expects an Euler rotation rather than a Vector3 and order.");const i=e._x,n=e._y,r=e._z,s=e._order,a=Math.cos,o=Math.sin,l=a(i/2),c=a(n/2),u=a(r/2),h=o(i/2),d=o(n/2),p=o(r/2);switch(s){case"XYZ":this._x=h*c*u+l*d*p,this._y=l*d*u-h*c*p,this._z=l*c*p+h*d*u,this._w=l*c*u-h*d*p;break;case"YXZ":this._x=h*c*u+l*d*p,this._y=l*d*u-h*c*p,this._z=l*c*p-h*d*u,this._w=l*c*u+h*d*p;break;case"ZXY":this._x=h*c*u-l*d*p,this._y=l*d*u+h*c*p,this._z=l*c*p+h*d*u,this._w=l*c*u-h*d*p;break;case"ZYX":this._x=h*c*u-l*d*p,this._y=l*d*u+h*c*p,this._z=l*c*p-h*d*u,this._w=l*c*u+h*d*p;break;case"YZX":this._x=h*c*u+l*d*p,this._y=l*d*u+h*c*p,this._z=l*c*p-h*d*u,this._w=l*c*u-h*d*p;break;case"XZY":this._x=h*c*u-l*d*p,this._y=l*d*u-h*c*p,this._z=l*c*p+h*d*u,this._w=l*c*u+h*d*p}return!1!==t&&this._onChangeCallback(),this}setFromAxisAngle(e,t){const i=t/2,n=Math.sin(i);return this._x=e.x*n,this._y=e.y*n,this._z=e.z*n,this._w=Math.cos(i),this._onChangeCallback(),this}setFromRotationMatrix(e){const t=e.elements,i=t[0],n=t[4],r=t[8],s=t[1],a=t[5],o=t[9],l=t[2],c=t[6],u=t[10],h=i+a+u;if(h>0){const e=.5/Math.sqrt(h+1);this._w=.25/e,this._x=(c-o)*e,this._y=(r-l)*e,this._z=(s-n)*e}else if(i>a&&i>u){const e=2*Math.sqrt(1+i-a-u);this._w=(c-o)/e,this._x=.25*e,this._y=(n+s)/e,this._z=(r+l)/e}else if(a>u){const e=2*Math.sqrt(1+a-i-u);this._w=(r-l)/e,this._x=(n+s)/e,this._y=.25*e,this._z=(o+c)/e}else{const e=2*Math.sqrt(1+u-i-a);this._w=(s-n)/e,this._x=(r+l)/e,this._y=(o+c)/e,this._z=.25*e}return this._onChangeCallback(),this}setFromUnitVectors(e,t){let i=e.dot(t)+1;return i<Number.EPSILON?(i=0,Math.abs(e.x)>Math.abs(e.z)?(this._x=-e.y,this._y=e.x,this._z=0,this._w=i):(this._x=0,this._y=-e.z,this._z=e.y,this._w=i)):(this._x=e.y*t.z-e.z*t.y,this._y=e.z*t.x-e.x*t.z,this._z=e.x*t.y-e.y*t.x,this._w=i),this.normalize()}angleTo(e){return 2*Math.acos(Math.abs(fe(this.dot(e),-1,1)))}rotateTowards(e,t){const i=this.angleTo(e);if(0===i)return this;const n=Math.min(1,t/i);return this.slerp(e,n),this}identity(){return this.set(0,0,0,1)}invert(){return this.conjugate()}conjugate(){return this._x*=-1,this._y*=-1,this._z*=-1,this._onChangeCallback(),this}dot(e){return this._x*e._x+this._y*e._y+this._z*e._z+this._w*e._w}lengthSq(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}length(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)}normalize(){let e=this.length();return 0===e?(this._x=0,this._y=0,this._z=0,this._w=1):(e=1/e,this._x=this._x*e,this._y=this._y*e,this._z=this._z*e,this._w=this._w*e),this._onChangeCallback(),this}multiply(e,t){return void 0!==t?this.multiplyQuaternions(e,t):this.multiplyQuaternions(this,e)}premultiply(e){return this.multiplyQuaternions(e,this)}multiplyQuaternions(e,t){const i=e._x,n=e._y,r=e._z,s=e._w,a=t._x,o=t._y,l=t._z,c=t._w;return this._x=i*c+s*a+n*l-r*o,this._y=n*c+s*o+r*a-i*l,this._z=r*c+s*l+i*o-n*a,this._w=s*c-i*a-n*o-r*l,this._onChangeCallback(),this}slerp(e,t){if(0===t)return this;if(1===t)return this.copy(e);const i=this._x,n=this._y,r=this._z,s=this._w;let a=s*e._w+i*e._x+n*e._y+r*e._z;if(a<0?(this._w=-e._w,this._x=-e._x,this._y=-e._y,this._z=-e._z,a=-a):this.copy(e),a>=1)return this._w=s,this._x=i,this._y=n,this._z=r,this;const o=1-a*a;if(o<=Number.EPSILON){const e=1-t;return this._w=e*s+t*this._w,this._x=e*i+t*this._x,this._y=e*n+t*this._y,this._z=e*r+t*this._z,this.normalize(),this._onChangeCallback(),this}const l=Math.sqrt(o),c=Math.atan2(l,a),u=Math.sin((1-t)*c)/l,h=Math.sin(t*c)/l;return this._w=s*u+this._w*h,this._x=i*u+this._x*h,this._y=n*u+this._y*h,this._z=r*u+this._z*h,this._onChangeCallback(),this}slerpQuaternions(e,t,i){this.copy(e).slerp(t,i)}random(){const e=Math.random(),t=Math.sqrt(1-e),i=Math.sqrt(e),n=2*Math.PI*Math.random(),r=2*Math.PI*Math.random();return this.set(t*Math.cos(n),i*Math.sin(r),i*Math.cos(r),t*Math.sin(n))}equals(e){return e._x===this._x&&e._y===this._y&&e._z===this._z&&e._w===this._w}fromArray(e,t=0){return this._x=e[t],this._y=e[t+1],this._z=e[t+2],this._w=e[t+3],this._onChangeCallback(),this}toArray(e=[],t=0){return e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._w,e}fromBufferAttribute(e,t){return this._x=e.getX(t),this._y=e.getY(t),this._z=e.getZ(t),this._w=e.getW(t),this}_onChange(e){return this._onChangeCallback=e,this}_onChangeCallback(){}}Ee.prototype.isQuaternion=!0;class De{constructor(e=0,t=0,i=0){this.x=e,this.y=t,this.z=i}set(e,t,i){return void 0===i&&(i=this.z),this.x=e,this.y=t,this.z=i,this}setScalar(e){return this.x=e,this.y=e,this.z=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setZ(e){return this.z=e,this}setComponent(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;case 2:this.z=t;break;default:throw new Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+e)}}clone(){return new this.constructor(this.x,this.y,this.z)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this}add(e,t){return void 0!==t?this.addVectors(e,t):(this.x+=e.x,this.y+=e.y,this.z+=e.z,this)}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this}addVectors(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this}addScaledVector(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this}sub(e,t){return void 0!==t?this.subVectors(e,t):(this.x-=e.x,this.y-=e.y,this.z-=e.z,this)}subScalar(e){return this.x-=e,this.y-=e,this.z-=e,this}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this}multiply(e,t){return void 0!==t?this.multiplyVectors(e,t):(this.x*=e.x,this.y*=e.y,this.z*=e.z,this)}multiplyScalar(e){return this.x*=e,this.y*=e,this.z*=e,this}multiplyVectors(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this.z=e.z*t.z,this}applyEuler(e){return!e||e.isEuler,this.applyQuaternion(Re.setFromEuler(e))}applyAxisAngle(e,t){return this.applyQuaternion(Re.setFromAxisAngle(e,t))}applyMatrix3(e){const t=this.x,i=this.y,n=this.z,r=e.elements;return this.x=r[0]*t+r[3]*i+r[6]*n,this.y=r[1]*t+r[4]*i+r[7]*n,this.z=r[2]*t+r[5]*i+r[8]*n,this}applyNormalMatrix(e){return this.applyMatrix3(e).normalize()}applyMatrix4(e){const t=this.x,i=this.y,n=this.z,r=e.elements,s=1/(r[3]*t+r[7]*i+r[11]*n+r[15]);return this.x=(r[0]*t+r[4]*i+r[8]*n+r[12])*s,this.y=(r[1]*t+r[5]*i+r[9]*n+r[13])*s,this.z=(r[2]*t+r[6]*i+r[10]*n+r[14])*s,this}applyQuaternion(e){const t=this.x,i=this.y,n=this.z,r=e.x,s=e.y,a=e.z,o=e.w,l=o*t+s*n-a*i,c=o*i+a*t-r*n,u=o*n+r*i-s*t,h=-r*t-s*i-a*n;return this.x=l*o+h*-r+c*-a-u*-s,this.y=c*o+h*-s+u*-r-l*-a,this.z=u*o+h*-a+l*-s-c*-r,this}project(e){return this.applyMatrix4(e.matrixWorldInverse).applyMatrix4(e.projectionMatrix)}unproject(e){return this.applyMatrix4(e.projectionMatrixInverse).applyMatrix4(e.matrixWorld)}transformDirection(e){const t=this.x,i=this.y,n=this.z,r=e.elements;return this.x=r[0]*t+r[4]*i+r[8]*n,this.y=r[1]*t+r[5]*i+r[9]*n,this.z=r[2]*t+r[6]*i+r[10]*n,this.normalize()}divide(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this}divideScalar(e){return this.multiplyScalar(1/e)}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this}clamp(e,t){return this.x=Math.max(e.x,Math.min(t.x,this.x)),this.y=Math.max(e.y,Math.min(t.y,this.y)),this.z=Math.max(e.z,Math.min(t.z,this.z)),this}clampScalar(e,t){return this.x=Math.max(e,Math.min(t,this.x)),this.y=Math.max(e,Math.min(t,this.y)),this.z=Math.max(e,Math.min(t,this.z)),this}clampLength(e,t){const i=this.length();return this.divideScalar(i||1).multiplyScalar(Math.max(e,Math.min(t,i)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}roundToZero(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this.z=this.z<0?Math.ceil(this.z):Math.floor(this.z),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)}normalize(){return this.divideScalar(this.length()||1)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this}lerpVectors(e,t,i){return this.x=e.x+(t.x-e.x)*i,this.y=e.y+(t.y-e.y)*i,this.z=e.z+(t.z-e.z)*i,this}cross(e,t){return void 0!==t?this.crossVectors(e,t):this.crossVectors(this,e)}crossVectors(e,t){const i=e.x,n=e.y,r=e.z,s=t.x,a=t.y,o=t.z;return this.x=n*o-r*a,this.y=r*s-i*o,this.z=i*a-n*s,this}projectOnVector(e){const t=e.lengthSq();if(0===t)return this.set(0,0,0);const i=e.dot(this)/t;return this.copy(e).multiplyScalar(i)}projectOnPlane(e){return Ie.copy(this).projectOnVector(e),this.sub(Ie)}reflect(e){return this.sub(Ie.copy(e).multiplyScalar(2*this.dot(e)))}angleTo(e){const t=Math.sqrt(this.lengthSq()*e.lengthSq());if(0===t)return Math.PI/2;const i=this.dot(e)/t;return Math.acos(fe(i,-1,1))}distanceTo(e){return Math.sqrt(this.distanceToSquared(e))}distanceToSquared(e){const t=this.x-e.x,i=this.y-e.y,n=this.z-e.z;return t*t+i*i+n*n}manhattanDistanceTo(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)+Math.abs(this.z-e.z)}setFromSpherical(e){return this.setFromSphericalCoords(e.radius,e.phi,e.theta)}setFromSphericalCoords(e,t,i){const n=Math.sin(t)*e;return this.x=n*Math.sin(i),this.y=Math.cos(t)*e,this.z=n*Math.cos(i),this}setFromCylindrical(e){return this.setFromCylindricalCoords(e.radius,e.theta,e.y)}setFromCylindricalCoords(e,t,i){return this.x=e*Math.sin(t),this.y=i,this.z=e*Math.cos(t),this}setFromMatrixPosition(e){const t=e.elements;return this.x=t[12],this.y=t[13],this.z=t[14],this}setFromMatrixScale(e){const t=this.setFromMatrixColumn(e,0).length(),i=this.setFromMatrixColumn(e,1).length(),n=this.setFromMatrixColumn(e,2).length();return this.x=t,this.y=i,this.z=n,this}setFromMatrixColumn(e,t){return this.fromArray(e.elements,4*t)}setFromMatrix3Column(e,t){return this.fromArray(e.elements,3*t)}equals(e){return e.x===this.x&&e.y===this.y&&e.z===this.z}fromArray(e,t=0){return this.x=e[t],this.y=e[t+1],this.z=e[t+2],this}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e}fromBufferAttribute(e,t,i){return this.x=e.getX(t),this.y=e.getY(t),this.z=e.getZ(t),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this}randomDirection(){const e=2*(Math.random()-.5),t=Math.random()*Math.PI*2,i=Math.sqrt(1-e**2);return this.x=i*Math.cos(t),this.y=i*Math.sin(t),this.z=e,this}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z}}De.prototype.isVector3=!0;const Ie=new De,Re=new Ee;class ze{constructor(e=new De(Infinity,Infinity,Infinity),t=new De(-Infinity,-Infinity,-Infinity)){this.min=e,this.max=t}set(e,t){return this.min.copy(e),this.max.copy(t),this}setFromArray(e){let t=Infinity,i=Infinity,n=Infinity,r=-Infinity,s=-Infinity,a=-Infinity;for(let o=0,l=e.length;o<l;o+=3){const l=e[o],c=e[o+1],u=e[o+2];l<t&&(t=l),c<i&&(i=c),u<n&&(n=u),l>r&&(r=l),c>s&&(s=c),u>a&&(a=u)}return this.min.set(t,i,n),this.max.set(r,s,a),this}setFromBufferAttribute(e){let t=Infinity,i=Infinity,n=Infinity,r=-Infinity,s=-Infinity,a=-Infinity;for(let o=0,l=e.count;o<l;o++){const l=e.getX(o),c=e.getY(o),u=e.getZ(o);l<t&&(t=l),c<i&&(i=c),u<n&&(n=u),l>r&&(r=l),c>s&&(s=c),u>a&&(a=u)}return this.min.set(t,i,n),this.max.set(r,s,a),this}setFromPoints(e){this.makeEmpty();for(let t=0,i=e.length;t<i;t++)this.expandByPoint(e[t]);return this}setFromCenterAndSize(e,t){const i=Oe.copy(t).multiplyScalar(.5);return this.min.copy(e).sub(i),this.max.copy(e).add(i),this}setFromObject(e){return this.makeEmpty(),this.expandByObject(e)}clone(){return(new this.constructor).copy(this)}copy(e){return this.min.copy(e.min),this.max.copy(e.max),this}makeEmpty(){return this.min.x=this.min.y=this.min.z=Infinity,this.max.x=this.max.y=this.max.z=-Infinity,this}isEmpty(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z}getCenter(e){return this.isEmpty()?e.set(0,0,0):e.addVectors(this.min,this.max).multiplyScalar(.5)}getSize(e){return this.isEmpty()?e.set(0,0,0):e.subVectors(this.max,this.min)}expandByPoint(e){return this.min.min(e),this.max.max(e),this}expandByVector(e){return this.min.sub(e),this.max.add(e),this}expandByScalar(e){return this.min.addScalar(-e),this.max.addScalar(e),this}expandByObject(e){e.updateWorldMatrix(!1,!1);const t=e.geometry;void 0!==t&&(null===t.boundingBox&&t.computeBoundingBox(),Fe.copy(t.boundingBox),Fe.applyMatrix4(e.matrixWorld),this.union(Fe));const i=e.children;for(let n=0,r=i.length;n<r;n++)this.expandByObject(i[n]);return this}containsPoint(e){return!(e.x<this.min.x||e.x>this.max.x||e.y<this.min.y||e.y>this.max.y||e.z<this.min.z||e.z>this.max.z)}containsBox(e){return this.min.x<=e.min.x&&e.max.x<=this.max.x&&this.min.y<=e.min.y&&e.max.y<=this.max.y&&this.min.z<=e.min.z&&e.max.z<=this.max.z}getParameter(e,t){return t.set((e.x-this.min.x)/(this.max.x-this.min.x),(e.y-this.min.y)/(this.max.y-this.min.y),(e.z-this.min.z)/(this.max.z-this.min.z))}intersectsBox(e){return!(e.max.x<this.min.x||e.min.x>this.max.x||e.max.y<this.min.y||e.min.y>this.max.y||e.max.z<this.min.z||e.min.z>this.max.z)}intersectsSphere(e){return this.clampPoint(e.center,Oe),Oe.distanceToSquared(e.center)<=e.radius*e.radius}intersectsPlane(e){let t,i;return e.normal.x>0?(t=e.normal.x*this.min.x,i=e.normal.x*this.max.x):(t=e.normal.x*this.max.x,i=e.normal.x*this.min.x),e.normal.y>0?(t+=e.normal.y*this.min.y,i+=e.normal.y*this.max.y):(t+=e.normal.y*this.max.y,i+=e.normal.y*this.min.y),e.normal.z>0?(t+=e.normal.z*this.min.z,i+=e.normal.z*this.max.z):(t+=e.normal.z*this.max.z,i+=e.normal.z*this.min.z),t<=-e.constant&&i>=-e.constant}intersectsTriangle(e){if(this.isEmpty())return!1;this.getCenter(He),je.subVectors(this.max,He),Ue.subVectors(e.a,He),ke.subVectors(e.b,He),Be.subVectors(e.c,He),Ve.subVectors(ke,Ue),Ge.subVectors(Be,ke),We.subVectors(Ue,Be);let t=[0,-Ve.z,Ve.y,0,-Ge.z,Ge.y,0,-We.z,We.y,Ve.z,0,-Ve.x,Ge.z,0,-Ge.x,We.z,0,-We.x,-Ve.y,Ve.x,0,-Ge.y,Ge.x,0,-We.y,We.x,0];return!!Ye(t,Ue,ke,Be,je)&&(t=[1,0,0,0,1,0,0,0,1],!!Ye(t,Ue,ke,Be,je)&&(qe.crossVectors(Ve,Ge),t=[qe.x,qe.y,qe.z],Ye(t,Ue,ke,Be,je)))}clampPoint(e,t){return t.copy(e).clamp(this.min,this.max)}distanceToPoint(e){return Oe.copy(e).clamp(this.min,this.max).sub(e).length()}getBoundingSphere(e){return this.getCenter(e.center),e.radius=.5*this.getSize(Oe).length(),e}intersect(e){return this.min.max(e.min),this.max.min(e.max),this.isEmpty()&&this.makeEmpty(),this}union(e){return this.min.min(e.min),this.max.max(e.max),this}applyMatrix4(e){return this.isEmpty()||(Ne[0].set(this.min.x,this.min.y,this.min.z).applyMatrix4(e),Ne[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(e),Ne[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(e),Ne[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(e),Ne[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(e),Ne[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(e),Ne[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(e),Ne[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(e),this.setFromPoints(Ne)),this}translate(e){return this.min.add(e),this.max.add(e),this}equals(e){return e.min.equals(this.min)&&e.max.equals(this.max)}}ze.prototype.isBox3=!0;const Ne=[new De,new De,new De,new De,new De,new De,new De,new De],Oe=new De,Fe=new ze,Ue=new De,ke=new De,Be=new De,Ve=new De,Ge=new De,We=new De,He=new De,je=new De,qe=new De,Xe=new De;function Ye(e,t,i,n,r){for(let s=0,a=e.length-3;s<=a;s+=3){Xe.fromArray(e,s);const a=r.x*Math.abs(Xe.x)+r.y*Math.abs(Xe.y)+r.z*Math.abs(Xe.z),o=t.dot(Xe),l=i.dot(Xe),c=n.dot(Xe);if(Math.max(-Math.max(o,l,c),Math.min(o,l,c))>a)return!1}return!0}const Ze=new ze,Je=new De,Qe=new De,Ke=new De;class $e{constructor(e=new De,t=-1){this.center=e,this.radius=t}set(e,t){return this.center.copy(e),this.radius=t,this}setFromPoints(e,t){const i=this.center;void 0!==t?i.copy(t):Ze.setFromPoints(e).getCenter(i);let n=0;for(let r=0,s=e.length;r<s;r++)n=Math.max(n,i.distanceToSquared(e[r]));return this.radius=Math.sqrt(n),this}copy(e){return this.center.copy(e.center),this.radius=e.radius,this}isEmpty(){return this.radius<0}makeEmpty(){return this.center.set(0,0,0),this.radius=-1,this}containsPoint(e){return e.distanceToSquared(this.center)<=this.radius*this.radius}distanceToPoint(e){return e.distanceTo(this.center)-this.radius}intersectsSphere(e){const t=this.radius+e.radius;return e.center.distanceToSquared(this.center)<=t*t}intersectsBox(e){return e.intersectsSphere(this)}intersectsPlane(e){return Math.abs(e.distanceToPoint(this.center))<=this.radius}clampPoint(e,t){const i=this.center.distanceToSquared(e);return t.copy(e),i>this.radius*this.radius&&(t.sub(this.center).normalize(),t.multiplyScalar(this.radius).add(this.center)),t}getBoundingBox(e){return this.isEmpty()?(e.makeEmpty(),e):(e.set(this.center,this.center),e.expandByScalar(this.radius),e)}applyMatrix4(e){return this.center.applyMatrix4(e),this.radius=this.radius*e.getMaxScaleOnAxis(),this}translate(e){return this.center.add(e),this}expandByPoint(e){Ke.subVectors(e,this.center);const t=Ke.lengthSq();if(t>this.radius*this.radius){const e=Math.sqrt(t),i=.5*(e-this.radius);this.center.add(Ke.multiplyScalar(i/e)),this.radius+=i}return this}union(e){return Qe.subVectors(e.center,this.center).normalize().multiplyScalar(e.radius),this.expandByPoint(Je.copy(e.center).add(Qe)),this.expandByPoint(Je.copy(e.center).sub(Qe)),this}equals(e){return e.center.equals(this.center)&&e.radius===this.radius}clone(){return(new this.constructor).copy(this)}}const et=new De,tt=new De,it=new De,nt=new De,rt=new De,st=new De,at=new De;class ot{constructor(e=new De,t=new De(0,0,-1)){this.origin=e,this.direction=t}set(e,t){return this.origin.copy(e),this.direction.copy(t),this}copy(e){return this.origin.copy(e.origin),this.direction.copy(e.direction),this}at(e,t){return t.copy(this.direction).multiplyScalar(e).add(this.origin)}lookAt(e){return this.direction.copy(e).sub(this.origin).normalize(),this}recast(e){return this.origin.copy(this.at(e,et)),this}closestPointToPoint(e,t){t.subVectors(e,this.origin);const i=t.dot(this.direction);return i<0?t.copy(this.origin):t.copy(this.direction).multiplyScalar(i).add(this.origin)}distanceToPoint(e){return Math.sqrt(this.distanceSqToPoint(e))}distanceSqToPoint(e){const t=et.subVectors(e,this.origin).dot(this.direction);return t<0?this.origin.distanceToSquared(e):(et.copy(this.direction).multiplyScalar(t).add(this.origin),et.distanceToSquared(e))}distanceSqToSegment(e,t,i,n){tt.copy(e).add(t).multiplyScalar(.5),it.copy(t).sub(e).normalize(),nt.copy(this.origin).sub(tt);const r=.5*e.distanceTo(t),s=-this.direction.dot(it),a=nt.dot(this.direction),o=-nt.dot(it),l=nt.lengthSq(),c=Math.abs(1-s*s);let u,h,d,p;if(c>0)if(u=s*o-a,h=s*a-o,p=r*c,u>=0)if(h>=-p)if(h<=p){const e=1/c;u*=e,h*=e,d=u*(u+s*h+2*a)+h*(s*u+h+2*o)+l}else h=r,u=Math.max(0,-(s*h+a)),d=-u*u+h*(h+2*o)+l;else h=-r,u=Math.max(0,-(s*h+a)),d=-u*u+h*(h+2*o)+l;else h<=-p?(u=Math.max(0,-(-s*r+a)),h=u>0?-r:Math.min(Math.max(-r,-o),r),d=-u*u+h*(h+2*o)+l):h<=p?(u=0,h=Math.min(Math.max(-r,-o),r),d=h*(h+2*o)+l):(u=Math.max(0,-(s*r+a)),h=u>0?r:Math.min(Math.max(-r,-o),r),d=-u*u+h*(h+2*o)+l);else h=s>0?-r:r,u=Math.max(0,-(s*h+a)),d=-u*u+h*(h+2*o)+l;return i&&i.copy(this.direction).multiplyScalar(u).add(this.origin),n&&n.copy(it).multiplyScalar(h).add(tt),d}intersectSphere(e,t){et.subVectors(e.center,this.origin);const i=et.dot(this.direction),n=et.dot(et)-i*i,r=e.radius*e.radius;if(n>r)return null;const s=Math.sqrt(r-n),a=i-s,o=i+s;return a<0&&o<0?null:a<0?this.at(o,t):this.at(a,t)}intersectsSphere(e){return this.distanceSqToPoint(e.center)<=e.radius*e.radius}distanceToPlane(e){const t=e.normal.dot(this.direction);if(0===t)return 0===e.distanceToPoint(this.origin)?0:null;const i=-(this.origin.dot(e.normal)+e.constant)/t;return i>=0?i:null}intersectPlane(e,t){const i=this.distanceToPlane(e);return null===i?null:this.at(i,t)}intersectsPlane(e){const t=e.distanceToPoint(this.origin);if(0===t)return!0;return e.normal.dot(this.direction)*t<0}intersectBox(e,t){let i,n,r,s,a,o;const l=1/this.direction.x,c=1/this.direction.y,u=1/this.direction.z,h=this.origin;return l>=0?(i=(e.min.x-h.x)*l,n=(e.max.x-h.x)*l):(i=(e.max.x-h.x)*l,n=(e.min.x-h.x)*l),c>=0?(r=(e.min.y-h.y)*c,s=(e.max.y-h.y)*c):(r=(e.max.y-h.y)*c,s=(e.min.y-h.y)*c),i>s||r>n?null:((r>i||i!=i)&&(i=r),(s<n||n!=n)&&(n=s),u>=0?(a=(e.min.z-h.z)*u,o=(e.max.z-h.z)*u):(a=(e.max.z-h.z)*u,o=(e.min.z-h.z)*u),i>o||a>n?null:((a>i||i!=i)&&(i=a),(o<n||n!=n)&&(n=o),n<0?null:this.at(i>=0?i:n,t)))}intersectsBox(e){return null!==this.intersectBox(e,et)}intersectTriangle(e,t,i,n,r){rt.subVectors(t,e),st.subVectors(i,e),at.crossVectors(rt,st);let s,a=this.direction.dot(at);if(a>0){if(n)return null;s=1}else{if(!(a<0))return null;s=-1,a=-a}nt.subVectors(this.origin,e);const o=s*this.direction.dot(st.crossVectors(nt,st));if(o<0)return null;const l=s*this.direction.dot(rt.cross(nt));if(l<0)return null;if(o+l>a)return null;const c=-s*nt.dot(at);return c<0?null:this.at(c/a,r)}applyMatrix4(e){return this.origin.applyMatrix4(e),this.direction.transformDirection(e),this}equals(e){return e.origin.equals(this.origin)&&e.direction.equals(this.direction)}clone(){return(new this.constructor).copy(this)}}class lt{constructor(){this.elements=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}set(e,t,i,n,r,s,a,o,l,c,u,h,d,p,m,f){const g=this.elements;return g[0]=e,g[4]=t,g[8]=i,g[12]=n,g[1]=r,g[5]=s,g[9]=a,g[13]=o,g[2]=l,g[6]=c,g[10]=u,g[14]=h,g[3]=d,g[7]=p,g[11]=m,g[15]=f,this}identity(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this}clone(){return(new lt).fromArray(this.elements)}copy(e){const t=this.elements,i=e.elements;return t[0]=i[0],t[1]=i[1],t[2]=i[2],t[3]=i[3],t[4]=i[4],t[5]=i[5],t[6]=i[6],t[7]=i[7],t[8]=i[8],t[9]=i[9],t[10]=i[10],t[11]=i[11],t[12]=i[12],t[13]=i[13],t[14]=i[14],t[15]=i[15],this}copyPosition(e){const t=this.elements,i=e.elements;return t[12]=i[12],t[13]=i[13],t[14]=i[14],this}setFromMatrix3(e){const t=e.elements;return this.set(t[0],t[3],t[6],0,t[1],t[4],t[7],0,t[2],t[5],t[8],0,0,0,0,1),this}extractBasis(e,t,i){return e.setFromMatrixColumn(this,0),t.setFromMatrixColumn(this,1),i.setFromMatrixColumn(this,2),this}makeBasis(e,t,i){return this.set(e.x,t.x,i.x,0,e.y,t.y,i.y,0,e.z,t.z,i.z,0,0,0,0,1),this}extractRotation(e){const t=this.elements,i=e.elements,n=1/ct.setFromMatrixColumn(e,0).length(),r=1/ct.setFromMatrixColumn(e,1).length(),s=1/ct.setFromMatrixColumn(e,2).length();return t[0]=i[0]*n,t[1]=i[1]*n,t[2]=i[2]*n,t[3]=0,t[4]=i[4]*r,t[5]=i[5]*r,t[6]=i[6]*r,t[7]=0,t[8]=i[8]*s,t[9]=i[9]*s,t[10]=i[10]*s,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this}makeRotationFromEuler(e){!e||e.isEuler;const t=this.elements,i=e.x,n=e.y,r=e.z,s=Math.cos(i),a=Math.sin(i),o=Math.cos(n),l=Math.sin(n),c=Math.cos(r),u=Math.sin(r);if("XYZ"===e.order){const e=s*c,i=s*u,n=a*c,r=a*u;t[0]=o*c,t[4]=-o*u,t[8]=l,t[1]=i+n*l,t[5]=e-r*l,t[9]=-a*o,t[2]=r-e*l,t[6]=n+i*l,t[10]=s*o}else if("YXZ"===e.order){const e=o*c,i=o*u,n=l*c,r=l*u;t[0]=e+r*a,t[4]=n*a-i,t[8]=s*l,t[1]=s*u,t[5]=s*c,t[9]=-a,t[2]=i*a-n,t[6]=r+e*a,t[10]=s*o}else if("ZXY"===e.order){const e=o*c,i=o*u,n=l*c,r=l*u;t[0]=e-r*a,t[4]=-s*u,t[8]=n+i*a,t[1]=i+n*a,t[5]=s*c,t[9]=r-e*a,t[2]=-s*l,t[6]=a,t[10]=s*o}else if("ZYX"===e.order){const e=s*c,i=s*u,n=a*c,r=a*u;t[0]=o*c,t[4]=n*l-i,t[8]=e*l+r,t[1]=o*u,t[5]=r*l+e,t[9]=i*l-n,t[2]=-l,t[6]=a*o,t[10]=s*o}else if("YZX"===e.order){const e=s*o,i=s*l,n=a*o,r=a*l;t[0]=o*c,t[4]=r-e*u,t[8]=n*u+i,t[1]=u,t[5]=s*c,t[9]=-a*c,t[2]=-l*c,t[6]=i*u+n,t[10]=e-r*u}else if("XZY"===e.order){const e=s*o,i=s*l,n=a*o,r=a*l;t[0]=o*c,t[4]=-u,t[8]=l*c,t[1]=e*u+r,t[5]=s*c,t[9]=i*u-n,t[2]=n*u-i,t[6]=a*c,t[10]=r*u+e}return t[3]=0,t[7]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this}makeRotationFromQuaternion(e){return this.compose(ht,e,dt)}lookAt(e,t,i){const n=this.elements;return ft.subVectors(e,t),0===ft.lengthSq()&&(ft.z=1),ft.normalize(),pt.crossVectors(i,ft),0===pt.lengthSq()&&(1===Math.abs(i.z)?ft.x+=1e-4:ft.z+=1e-4,ft.normalize(),pt.crossVectors(i,ft)),pt.normalize(),mt.crossVectors(ft,pt),n[0]=pt.x,n[4]=mt.x,n[8]=ft.x,n[1]=pt.y,n[5]=mt.y,n[9]=ft.y,n[2]=pt.z,n[6]=mt.z,n[10]=ft.z,this}multiply(e,t){return void 0!==t?this.multiplyMatrices(e,t):this.multiplyMatrices(this,e)}premultiply(e){return this.multiplyMatrices(e,this)}multiplyMatrices(e,t){const i=e.elements,n=t.elements,r=this.elements,s=i[0],a=i[4],o=i[8],l=i[12],c=i[1],u=i[5],h=i[9],d=i[13],p=i[2],m=i[6],f=i[10],g=i[14],v=i[3],y=i[7],x=i[11],_=i[15],b=n[0],w=n[4],M=n[8],S=n[12],T=n[1],A=n[5],C=n[9],L=n[13],P=n[2],E=n[6],D=n[10],I=n[14],R=n[3],z=n[7],N=n[11],O=n[15];return r[0]=s*b+a*T+o*P+l*R,r[4]=s*w+a*A+o*E+l*z,r[8]=s*M+a*C+o*D+l*N,r[12]=s*S+a*L+o*I+l*O,r[1]=c*b+u*T+h*P+d*R,r[5]=c*w+u*A+h*E+d*z,r[9]=c*M+u*C+h*D+d*N,r[13]=c*S+u*L+h*I+d*O,r[2]=p*b+m*T+f*P+g*R,r[6]=p*w+m*A+f*E+g*z,r[10]=p*M+m*C+f*D+g*N,r[14]=p*S+m*L+f*I+g*O,r[3]=v*b+y*T+x*P+_*R,r[7]=v*w+y*A+x*E+_*z,r[11]=v*M+y*C+x*D+_*N,r[15]=v*S+y*L+x*I+_*O,this}multiplyScalar(e){const t=this.elements;return t[0]*=e,t[4]*=e,t[8]*=e,t[12]*=e,t[1]*=e,t[5]*=e,t[9]*=e,t[13]*=e,t[2]*=e,t[6]*=e,t[10]*=e,t[14]*=e,t[3]*=e,t[7]*=e,t[11]*=e,t[15]*=e,this}determinant(){const e=this.elements,t=e[0],i=e[4],n=e[8],r=e[12],s=e[1],a=e[5],o=e[9],l=e[13],c=e[2],u=e[6],h=e[10],d=e[14];return e[3]*(+r*o*u-n*l*u-r*a*h+i*l*h+n*a*d-i*o*d)+e[7]*(+t*o*d-t*l*h+r*s*h-n*s*d+n*l*c-r*o*c)+e[11]*(+t*l*u-t*a*d-r*s*u+i*s*d+r*a*c-i*l*c)+e[15]*(-n*a*c-t*o*u+t*a*h+n*s*u-i*s*h+i*o*c)}transpose(){const e=this.elements;let t;return t=e[1],e[1]=e[4],e[4]=t,t=e[2],e[2]=e[8],e[8]=t,t=e[6],e[6]=e[9],e[9]=t,t=e[3],e[3]=e[12],e[12]=t,t=e[7],e[7]=e[13],e[13]=t,t=e[11],e[11]=e[14],e[14]=t,this}setPosition(e,t,i){const n=this.elements;return e.isVector3?(n[12]=e.x,n[13]=e.y,n[14]=e.z):(n[12]=e,n[13]=t,n[14]=i),this}invert(){const e=this.elements,t=e[0],i=e[1],n=e[2],r=e[3],s=e[4],a=e[5],o=e[6],l=e[7],c=e[8],u=e[9],h=e[10],d=e[11],p=e[12],m=e[13],f=e[14],g=e[15],v=u*f*l-m*h*l+m*o*d-a*f*d-u*o*g+a*h*g,y=p*h*l-c*f*l-p*o*d+s*f*d+c*o*g-s*h*g,x=c*m*l-p*u*l+p*a*d-s*m*d-c*a*g+s*u*g,_=p*u*o-c*m*o-p*a*h+s*m*h+c*a*f-s*u*f,b=t*v+i*y+n*x+r*_;if(0===b)return this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);const w=1/b;return e[0]=v*w,e[1]=(m*h*r-u*f*r-m*n*d+i*f*d+u*n*g-i*h*g)*w,e[2]=(a*f*r-m*o*r+m*n*l-i*f*l-a*n*g+i*o*g)*w,e[3]=(u*o*r-a*h*r-u*n*l+i*h*l+a*n*d-i*o*d)*w,e[4]=y*w,e[5]=(c*f*r-p*h*r+p*n*d-t*f*d-c*n*g+t*h*g)*w,e[6]=(p*o*r-s*f*r-p*n*l+t*f*l+s*n*g-t*o*g)*w,e[7]=(s*h*r-c*o*r+c*n*l-t*h*l-s*n*d+t*o*d)*w,e[8]=x*w,e[9]=(p*u*r-c*m*r-p*i*d+t*m*d+c*i*g-t*u*g)*w,e[10]=(s*m*r-p*a*r+p*i*l-t*m*l-s*i*g+t*a*g)*w,e[11]=(c*a*r-s*u*r-c*i*l+t*u*l+s*i*d-t*a*d)*w,e[12]=_*w,e[13]=(c*m*n-p*u*n+p*i*h-t*m*h-c*i*f+t*u*f)*w,e[14]=(p*a*n-s*m*n-p*i*o+t*m*o+s*i*f-t*a*f)*w,e[15]=(s*u*n-c*a*n+c*i*o-t*u*o-s*i*h+t*a*h)*w,this}scale(e){const t=this.elements,i=e.x,n=e.y,r=e.z;return t[0]*=i,t[4]*=n,t[8]*=r,t[1]*=i,t[5]*=n,t[9]*=r,t[2]*=i,t[6]*=n,t[10]*=r,t[3]*=i,t[7]*=n,t[11]*=r,this}getMaxScaleOnAxis(){const e=this.elements,t=e[0]*e[0]+e[1]*e[1]+e[2]*e[2],i=e[4]*e[4]+e[5]*e[5]+e[6]*e[6],n=e[8]*e[8]+e[9]*e[9]+e[10]*e[10];return Math.sqrt(Math.max(t,i,n))}makeTranslation(e,t,i){return this.set(1,0,0,e,0,1,0,t,0,0,1,i,0,0,0,1),this}makeRotationX(e){const t=Math.cos(e),i=Math.sin(e);return this.set(1,0,0,0,0,t,-i,0,0,i,t,0,0,0,0,1),this}makeRotationY(e){const t=Math.cos(e),i=Math.sin(e);return this.set(t,0,i,0,0,1,0,0,-i,0,t,0,0,0,0,1),this}makeRotationZ(e){const t=Math.cos(e),i=Math.sin(e);return this.set(t,-i,0,0,i,t,0,0,0,0,1,0,0,0,0,1),this}makeRotationAxis(e,t){const i=Math.cos(t),n=Math.sin(t),r=1-i,s=e.x,a=e.y,o=e.z,l=r*s,c=r*a;return this.set(l*s+i,l*a-n*o,l*o+n*a,0,l*a+n*o,c*a+i,c*o-n*s,0,l*o-n*a,c*o+n*s,r*o*o+i,0,0,0,0,1),this}makeScale(e,t,i){return this.set(e,0,0,0,0,t,0,0,0,0,i,0,0,0,0,1),this}makeShear(e,t,i,n,r,s){return this.set(1,i,r,0,e,1,s,0,t,n,1,0,0,0,0,1),this}compose(e,t,i){const n=this.elements,r=t._x,s=t._y,a=t._z,o=t._w,l=r+r,c=s+s,u=a+a,h=r*l,d=r*c,p=r*u,m=s*c,f=s*u,g=a*u,v=o*l,y=o*c,x=o*u,_=i.x,b=i.y,w=i.z;return n[0]=(1-(m+g))*_,n[1]=(d+x)*_,n[2]=(p-y)*_,n[3]=0,n[4]=(d-x)*b,n[5]=(1-(h+g))*b,n[6]=(f+v)*b,n[7]=0,n[8]=(p+y)*w,n[9]=(f-v)*w,n[10]=(1-(h+m))*w,n[11]=0,n[12]=e.x,n[13]=e.y,n[14]=e.z,n[15]=1,this}decompose(e,t,i){const n=this.elements;let r=ct.set(n[0],n[1],n[2]).length();const s=ct.set(n[4],n[5],n[6]).length(),a=ct.set(n[8],n[9],n[10]).length();this.determinant()<0&&(r=-r),e.x=n[12],e.y=n[13],e.z=n[14],ut.copy(this);const o=1/r,l=1/s,c=1/a;return ut.elements[0]*=o,ut.elements[1]*=o,ut.elements[2]*=o,ut.elements[4]*=l,ut.elements[5]*=l,ut.elements[6]*=l,ut.elements[8]*=c,ut.elements[9]*=c,ut.elements[10]*=c,t.setFromRotationMatrix(ut),i.x=r,i.y=s,i.z=a,this}makePerspective(e,t,i,n,r,s){const a=this.elements,o=2*r/(t-e),l=2*r/(i-n),c=(t+e)/(t-e),u=(i+n)/(i-n),h=-(s+r)/(s-r),d=-2*s*r/(s-r);return a[0]=o,a[4]=0,a[8]=c,a[12]=0,a[1]=0,a[5]=l,a[9]=u,a[13]=0,a[2]=0,a[6]=0,a[10]=h,a[14]=d,a[3]=0,a[7]=0,a[11]=-1,a[15]=0,this}makeOrthographic(e,t,i,n,r,s){const a=this.elements,o=1/(t-e),l=1/(i-n),c=1/(s-r),u=(t+e)*o,h=(i+n)*l,d=(s+r)*c;return a[0]=2*o,a[4]=0,a[8]=0,a[12]=-u,a[1]=0,a[5]=2*l,a[9]=0,a[13]=-h,a[2]=0,a[6]=0,a[10]=-2*c,a[14]=-d,a[3]=0,a[7]=0,a[11]=0,a[15]=1,this}equals(e){const t=this.elements,i=e.elements;for(let n=0;n<16;n++)if(t[n]!==i[n])return!1;return!0}fromArray(e,t=0){for(let i=0;i<16;i++)this.elements[i]=e[i+t];return this}toArray(e=[],t=0){const i=this.elements;return e[t]=i[0],e[t+1]=i[1],e[t+2]=i[2],e[t+3]=i[3],e[t+4]=i[4],e[t+5]=i[5],e[t+6]=i[6],e[t+7]=i[7],e[t+8]=i[8],e[t+9]=i[9],e[t+10]=i[10],e[t+11]=i[11],e[t+12]=i[12],e[t+13]=i[13],e[t+14]=i[14],e[t+15]=i[15],e}}lt.prototype.isMatrix4=!0;const ct=new De,ut=new lt,ht=new De(0,0,0),dt=new De(1,1,1),pt=new De,mt=new De,ft=new De,gt=new lt,vt=new Ee;class yt{constructor(e=0,t=0,i=0,n=yt.DefaultOrder){this._x=e,this._y=t,this._z=i,this._order=n}get x(){return this._x}set x(e){this._x=e,this._onChangeCallback()}get y(){return this._y}set y(e){this._y=e,this._onChangeCallback()}get z(){return this._z}set z(e){this._z=e,this._onChangeCallback()}get order(){return this._order}set order(e){this._order=e,this._onChangeCallback()}set(e,t,i,n=this._order){return this._x=e,this._y=t,this._z=i,this._order=n,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._order)}copy(e){return this._x=e._x,this._y=e._y,this._z=e._z,this._order=e._order,this._onChangeCallback(),this}setFromRotationMatrix(e,t=this._order,i=!0){const n=e.elements,r=n[0],s=n[4],a=n[8],o=n[1],l=n[5],c=n[9],u=n[2],h=n[6],d=n[10];switch(t){case"XYZ":this._y=Math.asin(fe(a,-1,1)),Math.abs(a)<.9999999?(this._x=Math.atan2(-c,d),this._z=Math.atan2(-s,r)):(this._x=Math.atan2(h,l),this._z=0);break;case"YXZ":this._x=Math.asin(-fe(c,-1,1)),Math.abs(c)<.9999999?(this._y=Math.atan2(a,d),this._z=Math.atan2(o,l)):(this._y=Math.atan2(-u,r),this._z=0);break;case"ZXY":this._x=Math.asin(fe(h,-1,1)),Math.abs(h)<.9999999?(this._y=Math.atan2(-u,d),this._z=Math.atan2(-s,l)):(this._y=0,this._z=Math.atan2(o,r));break;case"ZYX":this._y=Math.asin(-fe(u,-1,1)),Math.abs(u)<.9999999?(this._x=Math.atan2(h,d),this._z=Math.atan2(o,r)):(this._x=0,this._z=Math.atan2(-s,l));break;case"YZX":this._z=Math.asin(fe(o,-1,1)),Math.abs(o)<.9999999?(this._x=Math.atan2(-c,l),this._y=Math.atan2(-u,r)):(this._x=0,this._y=Math.atan2(a,d));break;case"XZY":this._z=Math.asin(-fe(s,-1,1)),Math.abs(s)<.9999999?(this._x=Math.atan2(h,l),this._y=Math.atan2(a,r)):(this._x=Math.atan2(-c,d),this._y=0)}return this._order=t,!0===i&&this._onChangeCallback(),this}setFromQuaternion(e,t,i){return gt.makeRotationFromQuaternion(e),this.setFromRotationMatrix(gt,t,i)}setFromVector3(e,t=this._order){return this.set(e.x,e.y,e.z,t)}reorder(e){return vt.setFromEuler(this),this.setFromQuaternion(vt,e)}equals(e){return e._x===this._x&&e._y===this._y&&e._z===this._z&&e._order===this._order}fromArray(e){return this._x=e[0],this._y=e[1],this._z=e[2],void 0!==e[3]&&(this._order=e[3]),this._onChangeCallback(),this}toArray(e=[],t=0){return e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._order,e}toVector3(e){return e?e.set(this._x,this._y,this._z):new De(this._x,this._y,this._z)}_onChange(e){return this._onChangeCallback=e,this}_onChangeCallback(){}}yt.prototype.isEuler=!0,yt.DefaultOrder="XYZ",yt.RotationOrders=["XYZ","YZX","ZXY","XZY","YXZ","ZYX"];class xt{constructor(){this.mask=1}set(e){this.mask=1<<e|0}enable(e){this.mask|=1<<e|0}enableAll(){this.mask=-1}toggle(e){this.mask^=1<<e|0}disable(e){this.mask&=~(1<<e|0)}disableAll(){this.mask=0}test(e){return 0!=(this.mask&e.mask)}}let _t=0;const bt=new De,wt=new Ee,Mt=new lt,St=new De,Tt=new De,At=new De,Ct=new Ee,Lt=new De(1,0,0),Pt=new De(0,1,0),Et=new De(0,0,1),Dt={type:"added"},It={type:"removed"};class Rt extends ce{constructor(){super(),Object.defineProperty(this,"id",{value:_t++}),this.uuid=me(),this.name="",this.type="Object3D",this.parent=null,this.children=[],this.up=Rt.DefaultUp.clone();const e=new De,t=new yt,i=new Ee,n=new De(1,1,1);t._onChange((function(){i.setFromEuler(t,!1)})),i._onChange((function(){t.setFromQuaternion(i,void 0,!1)})),Object.defineProperties(this,{position:{configurable:!0,enumerable:!0,value:e},rotation:{configurable:!0,enumerable:!0,value:t},quaternion:{configurable:!0,enumerable:!0,value:i},scale:{configurable:!0,enumerable:!0,value:n},modelViewMatrix:{value:new lt},normalMatrix:{value:new _e}}),this.matrix=new lt,this.matrixWorld=new lt,this.matrixAutoUpdate=Rt.DefaultMatrixAutoUpdate,this.matrixWorldNeedsUpdate=!1,this.layers=new xt,this.visible=!0,this.castShadow=!1,this.receiveShadow=!1,this.frustumCulled=!0,this.renderOrder=0,this.animations=[],this.userData={}}onBeforeRender(){}onAfterRender(){}applyMatrix4(e){this.matrixAutoUpdate&&this.updateMatrix(),this.matrix.premultiply(e),this.matrix.decompose(this.position,this.quaternion,this.scale)}applyQuaternion(e){return this.quaternion.premultiply(e),this}setRotationFromAxisAngle(e,t){this.quaternion.setFromAxisAngle(e,t)}setRotationFromEuler(e){this.quaternion.setFromEuler(e,!0)}setRotationFromMatrix(e){this.quaternion.setFromRotationMatrix(e)}setRotationFromQuaternion(e){this.quaternion.copy(e)}rotateOnAxis(e,t){return wt.setFromAxisAngle(e,t),this.quaternion.multiply(wt),this}rotateOnWorldAxis(e,t){return wt.setFromAxisAngle(e,t),this.quaternion.premultiply(wt),this}rotateX(e){return this.rotateOnAxis(Lt,e)}rotateY(e){return this.rotateOnAxis(Pt,e)}rotateZ(e){return this.rotateOnAxis(Et,e)}translateOnAxis(e,t){return bt.copy(e).applyQuaternion(this.quaternion),this.position.add(bt.multiplyScalar(t)),this}translateX(e){return this.translateOnAxis(Lt,e)}translateY(e){return this.translateOnAxis(Pt,e)}translateZ(e){return this.translateOnAxis(Et,e)}localToWorld(e){return e.applyMatrix4(this.matrixWorld)}worldToLocal(e){return e.applyMatrix4(Mt.copy(this.matrixWorld).invert())}lookAt(e,t,i){e.isVector3?St.copy(e):St.set(e,t,i);const n=this.parent;this.updateWorldMatrix(!0,!1),Tt.setFromMatrixPosition(this.matrixWorld),this.isCamera||this.isLight?Mt.lookAt(Tt,St,this.up):Mt.lookAt(St,Tt,this.up),this.quaternion.setFromRotationMatrix(Mt),n&&(Mt.extractRotation(n.matrixWorld),wt.setFromRotationMatrix(Mt),this.quaternion.premultiply(wt.invert()))}add(e){if(arguments.length>1){for(let e=0;e<arguments.length;e++)this.add(arguments[e]);return this}return e===this||e&&e.isObject3D&&(null!==e.parent&&e.parent.remove(e),e.parent=this,this.children.push(e),e.dispatchEvent(Dt)),this}remove(e){if(arguments.length>1){for(let e=0;e<arguments.length;e++)this.remove(arguments[e]);return this}const t=this.children.indexOf(e);return-1!==t&&(e.parent=null,this.children.splice(t,1),e.dispatchEvent(It)),this}removeFromParent(){const e=this.parent;return null!==e&&e.remove(this),this}clear(){for(let e=0;e<this.children.length;e++){const t=this.children[e];t.parent=null,t.dispatchEvent(It)}return this.children.length=0,this}attach(e){return this.updateWorldMatrix(!0,!1),Mt.copy(this.matrixWorld).invert(),null!==e.parent&&(e.parent.updateWorldMatrix(!0,!1),Mt.multiply(e.parent.matrixWorld)),e.applyMatrix4(Mt),this.add(e),e.updateWorldMatrix(!1,!0),this}getObjectById(e){return this.getObjectByProperty("id",e)}getObjectByName(e){return this.getObjectByProperty("name",e)}getObjectByProperty(e,t){if(this[e]===t)return this;for(let i=0,n=this.children.length;i<n;i++){const n=this.children[i].getObjectByProperty(e,t);if(void 0!==n)return n}}getWorldPosition(e){return this.updateWorldMatrix(!0,!1),e.setFromMatrixPosition(this.matrixWorld)}getWorldQuaternion(e){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(Tt,e,At),e}getWorldScale(e){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(Tt,Ct,e),e}getWorldDirection(e){this.updateWorldMatrix(!0,!1);const t=this.matrixWorld.elements;return e.set(t[8],t[9],t[10]).normalize()}raycast(){}traverse(e){e(this);const t=this.children;for(let i=0,n=t.length;i<n;i++)t[i].traverse(e)}traverseVisible(e){if(!1===this.visible)return;e(this);const t=this.children;for(let i=0,n=t.length;i<n;i++)t[i].traverseVisible(e)}traverseAncestors(e){const t=this.parent;null!==t&&(e(t),t.traverseAncestors(e))}updateMatrix(){this.matrix.compose(this.position,this.quaternion,this.scale),this.matrixWorldNeedsUpdate=!0}updateMatrixWorld(e){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||e)&&(null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.matrixWorldNeedsUpdate=!1,e=!0);const t=this.children;for(let i=0,n=t.length;i<n;i++)t[i].updateMatrixWorld(e)}updateWorldMatrix(e,t){const i=this.parent;if(!0===e&&null!==i&&i.updateWorldMatrix(!0,!1),this.matrixAutoUpdate&&this.updateMatrix(),null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),!0===t){const e=this.children;for(let t=0,i=e.length;t<i;t++)e[t].updateWorldMatrix(!1,!0)}}toJSON(e){const t=void 0===e||"string"==typeof e,i={};t&&(e={geometries:{},materials:{},textures:{},images:{},shapes:{},skeletons:{},animations:{}},i.metadata={version:4.5,type:"Object",generator:"Object3D.toJSON"});const n={};function r(t,i){return void 0===t[i.uuid]&&(t[i.uuid]=i.toJSON(e)),i.uuid}if(n.uuid=this.uuid,n.type=this.type,""!==this.name&&(n.name=this.name),!0===this.castShadow&&(n.castShadow=!0),!0===this.receiveShadow&&(n.receiveShadow=!0),!1===this.visible&&(n.visible=!1),!1===this.frustumCulled&&(n.frustumCulled=!1),0!==this.renderOrder&&(n.renderOrder=this.renderOrder),"{}"!==JSON.stringify(this.userData)&&(n.userData=this.userData),n.layers=this.layers.mask,n.matrix=this.matrix.toArray(),!1===this.matrixAutoUpdate&&(n.matrixAutoUpdate=!1),this.isInstancedMesh&&(n.type="InstancedMesh",n.count=this.count,n.instanceMatrix=this.instanceMatrix.toJSON(),null!==this.instanceColor&&(n.instanceColor=this.instanceColor.toJSON())),this.isScene)this.background&&(this.background.isColor?n.background=this.background.toJSON():this.background.isTexture&&(n.background=this.background.toJSON(e).uuid)),this.environment&&this.environment.isTexture&&(n.environment=this.environment.toJSON(e).uuid);else if(this.isMesh||this.isLine||this.isPoints){n.geometry=r(e.geometries,this.geometry);const t=this.geometry.parameters;if(void 0!==t&&void 0!==t.shapes){const i=t.shapes;if(Array.isArray(i))for(let t=0,n=i.length;t<n;t++){const n=i[t];r(e.shapes,n)}else r(e.shapes,i)}}if(this.isSkinnedMesh&&(n.bindMode=this.bindMode,n.bindMatrix=this.bindMatrix.toArray(),void 0!==this.skeleton&&(r(e.skeletons,this.skeleton),n.skeleton=this.skeleton.uuid)),void 0!==this.material)if(Array.isArray(this.material)){const t=[];for(let i=0,n=this.material.length;i<n;i++)t.push(r(e.materials,this.material[i]));n.material=t}else n.material=r(e.materials,this.material);if(this.children.length>0){n.children=[];for(let t=0;t<this.children.length;t++)n.children.push(this.children[t].toJSON(e).object)}if(this.animations.length>0){n.animations=[];for(let t=0;t<this.animations.length;t++){const i=this.animations[t];n.animations.push(r(e.animations,i))}}if(t){const t=s(e.geometries),n=s(e.materials),r=s(e.textures),a=s(e.images),o=s(e.shapes),l=s(e.skeletons),c=s(e.animations);t.length>0&&(i.geometries=t),n.length>0&&(i.materials=n),r.length>0&&(i.textures=r),a.length>0&&(i.images=a),o.length>0&&(i.shapes=o),l.length>0&&(i.skeletons=l),c.length>0&&(i.animations=c)}return i.object=n,i;function s(e){const t=[];for(const i in e){const n=e[i];delete n.metadata,t.push(n)}return t}}clone(e){return(new this.constructor).copy(this,e)}copy(e,t=!0){if(this.name=e.name,this.up.copy(e.up),this.position.copy(e.position),this.rotation.order=e.rotation.order,this.quaternion.copy(e.quaternion),this.scale.copy(e.scale),this.matrix.copy(e.matrix),this.matrixWorld.copy(e.matrixWorld),this.matrixAutoUpdate=e.matrixAutoUpdate,this.matrixWorldNeedsUpdate=e.matrixWorldNeedsUpdate,this.layers.mask=e.layers.mask,this.visible=e.visible,this.castShadow=e.castShadow,this.receiveShadow=e.receiveShadow,this.frustumCulled=e.frustumCulled,this.renderOrder=e.renderOrder,this.userData=JSON.parse(JSON.stringify(e.userData)),!0===t)for(let i=0;i<e.children.length;i++){const t=e.children[i];this.add(t.clone())}return this}}Rt.DefaultUp=new De(0,1,0),Rt.DefaultMatrixAutoUpdate=!0,Rt.prototype.isObject3D=!0;const zt=new De,Nt=new De,Ot=new De,Ft=new De,Ut=new De,kt=new De,Bt=new De,Vt=new De,Gt=new De,Wt=new De;class Ht{constructor(e=new De,t=new De,i=new De){this.a=e,this.b=t,this.c=i}static getNormal(e,t,i,n){n.subVectors(i,t),zt.subVectors(e,t),n.cross(zt);const r=n.lengthSq();return r>0?n.multiplyScalar(1/Math.sqrt(r)):n.set(0,0,0)}static getBarycoord(e,t,i,n,r){zt.subVectors(n,t),Nt.subVectors(i,t),Ot.subVectors(e,t);const s=zt.dot(zt),a=zt.dot(Nt),o=zt.dot(Ot),l=Nt.dot(Nt),c=Nt.dot(Ot),u=s*l-a*a;if(0===u)return r.set(-2,-1,-1);const h=1/u,d=(l*o-a*c)*h,p=(s*c-a*o)*h;return r.set(1-d-p,p,d)}static containsPoint(e,t,i,n){return this.getBarycoord(e,t,i,n,Ft),Ft.x>=0&&Ft.y>=0&&Ft.x+Ft.y<=1}static getUV(e,t,i,n,r,s,a,o){return this.getBarycoord(e,t,i,n,Ft),o.set(0,0),o.addScaledVector(r,Ft.x),o.addScaledVector(s,Ft.y),o.addScaledVector(a,Ft.z),o}static isFrontFacing(e,t,i,n){return zt.subVectors(i,t),Nt.subVectors(e,t),zt.cross(Nt).dot(n)<0}set(e,t,i){return this.a.copy(e),this.b.copy(t),this.c.copy(i),this}setFromPointsAndIndices(e,t,i,n){return this.a.copy(e[t]),this.b.copy(e[i]),this.c.copy(e[n]),this}setFromAttributeAndIndices(e,t,i,n){return this.a.fromBufferAttribute(e,t),this.b.fromBufferAttribute(e,i),this.c.fromBufferAttribute(e,n),this}clone(){return(new this.constructor).copy(this)}copy(e){return this.a.copy(e.a),this.b.copy(e.b),this.c.copy(e.c),this}getArea(){return zt.subVectors(this.c,this.b),Nt.subVectors(this.a,this.b),.5*zt.cross(Nt).length()}getMidpoint(e){return e.addVectors(this.a,this.b).add(this.c).multiplyScalar(1/3)}getNormal(e){return Ht.getNormal(this.a,this.b,this.c,e)}getPlane(e){return e.setFromCoplanarPoints(this.a,this.b,this.c)}getBarycoord(e,t){return Ht.getBarycoord(e,this.a,this.b,this.c,t)}getUV(e,t,i,n,r){return Ht.getUV(e,this.a,this.b,this.c,t,i,n,r)}containsPoint(e){return Ht.containsPoint(e,this.a,this.b,this.c)}isFrontFacing(e){return Ht.isFrontFacing(this.a,this.b,this.c,e)}intersectsBox(e){return e.intersectsTriangle(this)}closestPointToPoint(e,t){const i=this.a,n=this.b,r=this.c;let s,a;Ut.subVectors(n,i),kt.subVectors(r,i),Vt.subVectors(e,i);const o=Ut.dot(Vt),l=kt.dot(Vt);if(o<=0&&l<=0)return t.copy(i);Gt.subVectors(e,n);const c=Ut.dot(Gt),u=kt.dot(Gt);if(c>=0&&u<=c)return t.copy(n);const h=o*u-c*l;if(h<=0&&o>=0&&c<=0)return s=o/(o-c),t.copy(i).addScaledVector(Ut,s);Wt.subVectors(e,r);const d=Ut.dot(Wt),p=kt.dot(Wt);if(p>=0&&d<=p)return t.copy(r);const m=d*l-o*p;if(m<=0&&l>=0&&p<=0)return a=l/(l-p),t.copy(i).addScaledVector(kt,a);const f=c*p-d*u;if(f<=0&&u-c>=0&&d-p>=0)return Bt.subVectors(r,n),a=(u-c)/(u-c+(d-p)),t.copy(n).addScaledVector(Bt,a);const g=1/(f+m+h);return s=m*g,a=h*g,t.copy(i).addScaledVector(Ut,s).addScaledVector(kt,a)}equals(e){return e.a.equals(this.a)&&e.b.equals(this.b)&&e.c.equals(this.c)}}let jt=0;class qt extends ce{constructor(){super(),Object.defineProperty(this,"id",{value:jt++}),this.uuid=me(),this.name="",this.type="Material",this.fog=!0,this.blending=1,this.side=0,this.vertexColors=!1,this.opacity=1,this.format=1023,this.transparent=!1,this.blendSrc=204,this.blendDst=205,this.blendEquation=100,this.blendSrcAlpha=null,this.blendDstAlpha=null,this.blendEquationAlpha=null,this.depthFunc=3,this.depthTest=!0,this.depthWrite=!0,this.stencilWriteMask=255,this.stencilFunc=519,this.stencilRef=0,this.stencilFuncMask=255,this.stencilFail=7680,this.stencilZFail=7680,this.stencilZPass=7680,this.stencilWrite=!1,this.clippingPlanes=null,this.clipIntersection=!1,this.clipShadows=!1,this.shadowSide=null,this.colorWrite=!0,this.precision=null,this.polygonOffset=!1,this.polygonOffsetFactor=0,this.polygonOffsetUnits=0,this.dithering=!1,this.alphaToCoverage=!1,this.premultipliedAlpha=!1,this.visible=!0,this.toneMapped=!0,this.userData={},this.version=0,this._alphaTest=0}get alphaTest(){return this._alphaTest}set alphaTest(e){this._alphaTest>0!=e>0&&this.version++,this._alphaTest=e}onBuild(){}onBeforeRender(){}onBeforeCompile(){}customProgramCacheKey(){return this.onBeforeCompile.toString()}setValues(e){if(void 0!==e)for(const t in e){const i=e[t];if(void 0===i)continue;if("shading"===t){this.flatShading=1===i;continue}const n=this[t];void 0!==n&&(n&&n.isColor?n.set(i):n&&n.isVector3&&i&&i.isVector3?n.copy(i):this[t]=i)}}toJSON(e){const t=void 0===e||"string"==typeof e;t&&(e={textures:{},images:{}});const i={metadata:{version:4.5,type:"Material",generator:"Material.toJSON"}};function n(e){const t=[];for(const i in e){const n=e[i];delete n.metadata,t.push(n)}return t}if(i.uuid=this.uuid,i.type=this.type,""!==this.name&&(i.name=this.name),this.color&&this.color.isColor&&(i.color=this.color.getHex()),void 0!==this.roughness&&(i.roughness=this.roughness),void 0!==this.metalness&&(i.metalness=this.metalness),void 0!==this.sheen&&(i.sheen=this.sheen),this.sheenTint&&this.sheenTint.isColor&&(i.sheenTint=this.sheenTint.getHex()),void 0!==this.sheenRoughness&&(i.sheenRoughness=this.sheenRoughness),this.emissive&&this.emissive.isColor&&(i.emissive=this.emissive.getHex()),this.emissiveIntensity&&1!==this.emissiveIntensity&&(i.emissiveIntensity=this.emissiveIntensity),this.specular&&this.specular.isColor&&(i.specular=this.specular.getHex()),void 0!==this.specularIntensity&&(i.specularIntensity=this.specularIntensity),this.specularTint&&this.specularTint.isColor&&(i.specularTint=this.specularTint.getHex()),void 0!==this.shininess&&(i.shininess=this.shininess),void 0!==this.clearcoat&&(i.clearcoat=this.clearcoat),void 0!==this.clearcoatRoughness&&(i.clearcoatRoughness=this.clearcoatRoughness),this.clearcoatMap&&this.clearcoatMap.isTexture&&(i.clearcoatMap=this.clearcoatMap.toJSON(e).uuid),this.clearcoatRoughnessMap&&this.clearcoatRoughnessMap.isTexture&&(i.clearcoatRoughnessMap=this.clearcoatRoughnessMap.toJSON(e).uuid),this.clearcoatNormalMap&&this.clearcoatNormalMap.isTexture&&(i.clearcoatNormalMap=this.clearcoatNormalMap.toJSON(e).uuid,i.clearcoatNormalScale=this.clearcoatNormalScale.toArray()),this.map&&this.map.isTexture&&(i.map=this.map.toJSON(e).uuid),this.matcap&&this.matcap.isTexture&&(i.matcap=this.matcap.toJSON(e).uuid),this.alphaMap&&this.alphaMap.isTexture&&(i.alphaMap=this.alphaMap.toJSON(e).uuid),this.lightMap&&this.lightMap.isTexture&&(i.lightMap=this.lightMap.toJSON(e).uuid,i.lightMapIntensity=this.lightMapIntensity),this.aoMap&&this.aoMap.isTexture&&(i.aoMap=this.aoMap.toJSON(e).uuid,i.aoMapIntensity=this.aoMapIntensity),this.bumpMap&&this.bumpMap.isTexture&&(i.bumpMap=this.bumpMap.toJSON(e).uuid,i.bumpScale=this.bumpScale),this.normalMap&&this.normalMap.isTexture&&(i.normalMap=this.normalMap.toJSON(e).uuid,i.normalMapType=this.normalMapType,i.normalScale=this.normalScale.toArray()),this.displacementMap&&this.displacementMap.isTexture&&(i.displacementMap=this.displacementMap.toJSON(e).uuid,i.displacementScale=this.displacementScale,i.displacementBias=this.displacementBias),this.roughnessMap&&this.roughnessMap.isTexture&&(i.roughnessMap=this.roughnessMap.toJSON(e).uuid),this.metalnessMap&&this.metalnessMap.isTexture&&(i.metalnessMap=this.metalnessMap.toJSON(e).uuid),this.emissiveMap&&this.emissiveMap.isTexture&&(i.emissiveMap=this.emissiveMap.toJSON(e).uuid),this.specularMap&&this.specularMap.isTexture&&(i.specularMap=this.specularMap.toJSON(e).uuid),this.specularIntensityMap&&this.specularIntensityMap.isTexture&&(i.specularIntensityMap=this.specularIntensityMap.toJSON(e).uuid),this.specularTintMap&&this.specularTintMap.isTexture&&(i.specularTintMap=this.specularTintMap.toJSON(e).uuid),this.envMap&&this.envMap.isTexture&&(i.envMap=this.envMap.toJSON(e).uuid,void 0!==this.combine&&(i.combine=this.combine)),void 0!==this.envMapIntensity&&(i.envMapIntensity=this.envMapIntensity),void 0!==this.reflectivity&&(i.reflectivity=this.reflectivity),void 0!==this.refractionRatio&&(i.refractionRatio=this.refractionRatio),this.gradientMap&&this.gradientMap.isTexture&&(i.gradientMap=this.gradientMap.toJSON(e).uuid),void 0!==this.transmission&&(i.transmission=this.transmission),this.transmissionMap&&this.transmissionMap.isTexture&&(i.transmissionMap=this.transmissionMap.toJSON(e).uuid),void 0!==this.thickness&&(i.thickness=this.thickness),this.thicknessMap&&this.thicknessMap.isTexture&&(i.thicknessMap=this.thicknessMap.toJSON(e).uuid),void 0!==this.attenuationDistance&&(i.attenuationDistance=this.attenuationDistance),void 0!==this.attenuationTint&&(i.attenuationTint=this.attenuationTint.getHex()),void 0!==this.size&&(i.size=this.size),null!==this.shadowSide&&(i.shadowSide=this.shadowSide),void 0!==this.sizeAttenuation&&(i.sizeAttenuation=this.sizeAttenuation),1!==this.blending&&(i.blending=this.blending),0!==this.side&&(i.side=this.side),this.vertexColors&&(i.vertexColors=!0),this.opacity<1&&(i.opacity=this.opacity),1023!==this.format&&(i.format=this.format),!0===this.transparent&&(i.transparent=this.transparent),i.depthFunc=this.depthFunc,i.depthTest=this.depthTest,i.depthWrite=this.depthWrite,i.colorWrite=this.colorWrite,i.stencilWrite=this.stencilWrite,i.stencilWriteMask=this.stencilWriteMask,i.stencilFunc=this.stencilFunc,i.stencilRef=this.stencilRef,i.stencilFuncMask=this.stencilFuncMask,i.stencilFail=this.stencilFail,i.stencilZFail=this.stencilZFail,i.stencilZPass=this.stencilZPass,this.rotation&&0!==this.rotation&&(i.rotation=this.rotation),!0===this.polygonOffset&&(i.polygonOffset=!0),0!==this.polygonOffsetFactor&&(i.polygonOffsetFactor=this.polygonOffsetFactor),0!==this.polygonOffsetUnits&&(i.polygonOffsetUnits=this.polygonOffsetUnits),this.linewidth&&1!==this.linewidth&&(i.linewidth=this.linewidth),void 0!==this.dashSize&&(i.dashSize=this.dashSize),void 0!==this.gapSize&&(i.gapSize=this.gapSize),void 0!==this.scale&&(i.scale=this.scale),!0===this.dithering&&(i.dithering=!0),this.alphaTest>0&&(i.alphaTest=this.alphaTest),!0===this.alphaToCoverage&&(i.alphaToCoverage=this.alphaToCoverage),!0===this.premultipliedAlpha&&(i.premultipliedAlpha=this.premultipliedAlpha),!0===this.wireframe&&(i.wireframe=this.wireframe),this.wireframeLinewidth>1&&(i.wireframeLinewidth=this.wireframeLinewidth),"round"!==this.wireframeLinecap&&(i.wireframeLinecap=this.wireframeLinecap),"round"!==this.wireframeLinejoin&&(i.wireframeLinejoin=this.wireframeLinejoin),!0===this.flatShading&&(i.flatShading=this.flatShading),!1===this.visible&&(i.visible=!1),!1===this.toneMapped&&(i.toneMapped=!1),"{}"!==JSON.stringify(this.userData)&&(i.userData=this.userData),t){const t=n(e.textures),r=n(e.images);t.length>0&&(i.textures=t),r.length>0&&(i.images=r)}return i}clone(){return(new this.constructor).copy(this)}copy(e){this.name=e.name,this.fog=e.fog,this.blending=e.blending,this.side=e.side,this.vertexColors=e.vertexColors,this.opacity=e.opacity,this.format=e.format,this.transparent=e.transparent,this.blendSrc=e.blendSrc,this.blendDst=e.blendDst,this.blendEquation=e.blendEquation,this.blendSrcAlpha=e.blendSrcAlpha,this.blendDstAlpha=e.blendDstAlpha,this.blendEquationAlpha=e.blendEquationAlpha,this.depthFunc=e.depthFunc,this.depthTest=e.depthTest,this.depthWrite=e.depthWrite,this.stencilWriteMask=e.stencilWriteMask,this.stencilFunc=e.stencilFunc,this.stencilRef=e.stencilRef,this.stencilFuncMask=e.stencilFuncMask,this.stencilFail=e.stencilFail,this.stencilZFail=e.stencilZFail,this.stencilZPass=e.stencilZPass,this.stencilWrite=e.stencilWrite;const t=e.clippingPlanes;let i=null;if(null!==t){const e=t.length;i=new Array(e);for(let n=0;n!==e;++n)i[n]=t[n].clone()}return this.clippingPlanes=i,this.clipIntersection=e.clipIntersection,this.clipShadows=e.clipShadows,this.shadowSide=e.shadowSide,this.colorWrite=e.colorWrite,this.precision=e.precision,this.polygonOffset=e.polygonOffset,this.polygonOffsetFactor=e.polygonOffsetFactor,this.polygonOffsetUnits=e.polygonOffsetUnits,this.dithering=e.dithering,this.alphaTest=e.alphaTest,this.alphaToCoverage=e.alphaToCoverage,this.premultipliedAlpha=e.premultipliedAlpha,this.visible=e.visible,this.toneMapped=e.toneMapped,this.userData=JSON.parse(JSON.stringify(e.userData)),this}dispose(){this.dispatchEvent({type:"dispose"})}set needsUpdate(e){!0===e&&this.version++}}qt.prototype.isMaterial=!0;const Xt={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074},Yt={h:0,s:0,l:0},Zt={h:0,s:0,l:0};function Jt(e,t,i){return i<0&&(i+=1),i>1&&(i-=1),i<1/6?e+6*(t-e)*i:i<.5?t:i<2/3?e+6*(t-e)*(2/3-i):e}function Qt(e){return e<.04045?.0773993808*e:Math.pow(.9478672986*e+.0521327014,2.4)}function Kt(e){return e<.0031308?12.92*e:1.055*Math.pow(e,.41666)-.055}class $t{constructor(e,t,i){return void 0===t&&void 0===i?this.set(e):this.setRGB(e,t,i)}set(e){return e&&e.isColor?this.copy(e):"number"==typeof e?this.setHex(e):"string"==typeof e&&this.setStyle(e),this}setScalar(e){return this.r=e,this.g=e,this.b=e,this}setHex(e){return e=Math.floor(e),this.r=(e>>16&255)/255,this.g=(e>>8&255)/255,this.b=(255&e)/255,this}setRGB(e,t,i){return this.r=e,this.g=t,this.b=i,this}setHSL(e,t,i){var n;if(e=(e%(n=1)+n)%n,t=fe(t,0,1),i=fe(i,0,1),0===t)this.r=this.g=this.b=i;else{const n=i<=.5?i*(1+t):i+t-i*t,r=2*i-n;this.r=Jt(r,n,e+1/3),this.g=Jt(r,n,e),this.b=Jt(r,n,e-1/3)}return this}setStyle(e){function t(e){void 0!==e&&parseFloat(e)}let i;if(i=/^((?:rgb|hsl)a?)\(([^\)]*)\)/.exec(e)){let e;const n=i[1],r=i[2];switch(n){case"rgb":case"rgba":if(e=/^\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(r))return this.r=Math.min(255,parseInt(e[1],10))/255,this.g=Math.min(255,parseInt(e[2],10))/255,this.b=Math.min(255,parseInt(e[3],10))/255,t(e[4]),this;if(e=/^\s*(\d+)\%\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(r))return this.r=Math.min(100,parseInt(e[1],10))/100,this.g=Math.min(100,parseInt(e[2],10))/100,this.b=Math.min(100,parseInt(e[3],10))/100,t(e[4]),this;break;case"hsl":case"hsla":if(e=/^\s*(\d*\.?\d+)\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(r)){const i=parseFloat(e[1])/360,n=parseInt(e[2],10)/100,r=parseInt(e[3],10)/100;return t(e[4]),this.setHSL(i,n,r)}}}else if(i=/^\#([A-Fa-f\d]+)$/.exec(e)){const e=i[1],t=e.length;if(3===t)return this.r=parseInt(e.charAt(0)+e.charAt(0),16)/255,this.g=parseInt(e.charAt(1)+e.charAt(1),16)/255,this.b=parseInt(e.charAt(2)+e.charAt(2),16)/255,this;if(6===t)return this.r=parseInt(e.charAt(0)+e.charAt(1),16)/255,this.g=parseInt(e.charAt(2)+e.charAt(3),16)/255,this.b=parseInt(e.charAt(4)+e.charAt(5),16)/255,this}return e&&e.length>0?this.setColorName(e):this}setColorName(e){const t=Xt[e.toLowerCase()];return void 0!==t&&this.setHex(t),this}clone(){return new this.constructor(this.r,this.g,this.b)}copy(e){return this.r=e.r,this.g=e.g,this.b=e.b,this}copyGammaToLinear(e,t=2){return this.r=Math.pow(e.r,t),this.g=Math.pow(e.g,t),this.b=Math.pow(e.b,t),this}copyLinearToGamma(e,t=2){const i=t>0?1/t:1;return this.r=Math.pow(e.r,i),this.g=Math.pow(e.g,i),this.b=Math.pow(e.b,i),this}convertGammaToLinear(e){return this.copyGammaToLinear(this,e),this}convertLinearToGamma(e){return this.copyLinearToGamma(this,e),this}copySRGBToLinear(e){return this.r=Qt(e.r),this.g=Qt(e.g),this.b=Qt(e.b),this}copyLinearToSRGB(e){return this.r=Kt(e.r),this.g=Kt(e.g),this.b=Kt(e.b),this}convertSRGBToLinear(){return this.copySRGBToLinear(this),this}convertLinearToSRGB(){return this.copyLinearToSRGB(this),this}getHex(){return 255*this.r<<16^255*this.g<<8^255*this.b<<0}getHexString(){return("000000"+this.getHex().toString(16)).slice(-6)}getHSL(e){const t=this.r,i=this.g,n=this.b,r=Math.max(t,i,n),s=Math.min(t,i,n);let a,o;const l=(s+r)/2;if(s===r)a=0,o=0;else{const e=r-s;switch(o=l<=.5?e/(r+s):e/(2-r-s),r){case t:a=(i-n)/e+(i<n?6:0);break;case i:a=(n-t)/e+2;break;case n:a=(t-i)/e+4}a/=6}return e.h=a,e.s=o,e.l=l,e}getStyle(){return"rgb("+(255*this.r|0)+","+(255*this.g|0)+","+(255*this.b|0)+")"}offsetHSL(e,t,i){return this.getHSL(Yt),Yt.h+=e,Yt.s+=t,Yt.l+=i,this.setHSL(Yt.h,Yt.s,Yt.l),this}add(e){return this.r+=e.r,this.g+=e.g,this.b+=e.b,this}addColors(e,t){return this.r=e.r+t.r,this.g=e.g+t.g,this.b=e.b+t.b,this}addScalar(e){return this.r+=e,this.g+=e,this.b+=e,this}sub(e){return this.r=Math.max(0,this.r-e.r),this.g=Math.max(0,this.g-e.g),this.b=Math.max(0,this.b-e.b),this}multiply(e){return this.r*=e.r,this.g*=e.g,this.b*=e.b,this}multiplyScalar(e){return this.r*=e,this.g*=e,this.b*=e,this}lerp(e,t){return this.r+=(e.r-this.r)*t,this.g+=(e.g-this.g)*t,this.b+=(e.b-this.b)*t,this}lerpColors(e,t,i){return this.r=e.r+(t.r-e.r)*i,this.g=e.g+(t.g-e.g)*i,this.b=e.b+(t.b-e.b)*i,this}lerpHSL(e,t){this.getHSL(Yt),e.getHSL(Zt);const i=ge(Yt.h,Zt.h,t),n=ge(Yt.s,Zt.s,t),r=ge(Yt.l,Zt.l,t);return this.setHSL(i,n,r),this}equals(e){return e.r===this.r&&e.g===this.g&&e.b===this.b}fromArray(e,t=0){return this.r=e[t],this.g=e[t+1],this.b=e[t+2],this}toArray(e=[],t=0){return e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,e}fromBufferAttribute(e,t){return this.r=e.getX(t),this.g=e.getY(t),this.b=e.getZ(t),!0===e.normalized&&(this.r/=255,this.g/=255,this.b/=255),this}toJSON(){return this.getHex()}}$t.NAMES=Xt,$t.prototype.isColor=!0,$t.prototype.r=1,$t.prototype.g=1,$t.prototype.b=1;class ei extends qt{constructor(e){super(),this.type="MeshBasicMaterial",this.color=new $t(16777215),this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.combine=0,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.specularMap=e.specularMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.combine=e.combine,this.reflectivity=e.reflectivity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this}}ei.prototype.isMeshBasicMaterial=!0;const ti=new De,ii=new xe;class ni{constructor(e,t,i){if(Array.isArray(e))throw new TypeError("THREE.BufferAttribute: array should be a Typed Array.");this.name="",this.array=e,this.itemSize=t,this.count=void 0!==e?e.length/t:0,this.normalized=!0===i,this.usage=35044,this.updateRange={offset:0,count:-1},this.version=0}onUploadCallback(){}set needsUpdate(e){!0===e&&this.version++}setUsage(e){return this.usage=e,this}copy(e){return this.name=e.name,this.array=new e.array.constructor(e.array),this.itemSize=e.itemSize,this.count=e.count,this.normalized=e.normalized,this.usage=e.usage,this}copyAt(e,t,i){e*=this.itemSize,i*=t.itemSize;for(let n=0,r=this.itemSize;n<r;n++)this.array[e+n]=t.array[i+n];return this}copyArray(e){return this.array.set(e),this}copyColorsArray(e){const t=this.array;let i=0;for(let n=0,r=e.length;n<r;n++){let r=e[n];void 0===r&&(r=new $t),t[i++]=r.r,t[i++]=r.g,t[i++]=r.b}return this}copyVector2sArray(e){const t=this.array;let i=0;for(let n=0,r=e.length;n<r;n++){let r=e[n];void 0===r&&(r=new xe),t[i++]=r.x,t[i++]=r.y}return this}copyVector3sArray(e){const t=this.array;let i=0;for(let n=0,r=e.length;n<r;n++){let r=e[n];void 0===r&&(r=new De),t[i++]=r.x,t[i++]=r.y,t[i++]=r.z}return this}copyVector4sArray(e){const t=this.array;let i=0;for(let n=0,r=e.length;n<r;n++){let r=e[n];void 0===r&&(r=new Ce),t[i++]=r.x,t[i++]=r.y,t[i++]=r.z,t[i++]=r.w}return this}applyMatrix3(e){if(2===this.itemSize)for(let t=0,i=this.count;t<i;t++)ii.fromBufferAttribute(this,t),ii.applyMatrix3(e),this.setXY(t,ii.x,ii.y);else if(3===this.itemSize)for(let t=0,i=this.count;t<i;t++)ti.fromBufferAttribute(this,t),ti.applyMatrix3(e),this.setXYZ(t,ti.x,ti.y,ti.z);return this}applyMatrix4(e){for(let t=0,i=this.count;t<i;t++)ti.x=this.getX(t),ti.y=this.getY(t),ti.z=this.getZ(t),ti.applyMatrix4(e),this.setXYZ(t,ti.x,ti.y,ti.z);return this}applyNormalMatrix(e){for(let t=0,i=this.count;t<i;t++)ti.x=this.getX(t),ti.y=this.getY(t),ti.z=this.getZ(t),ti.applyNormalMatrix(e),this.setXYZ(t,ti.x,ti.y,ti.z);return this}transformDirection(e){for(let t=0,i=this.count;t<i;t++)ti.x=this.getX(t),ti.y=this.getY(t),ti.z=this.getZ(t),ti.transformDirection(e),this.setXYZ(t,ti.x,ti.y,ti.z);return this}set(e,t=0){return this.array.set(e,t),this}getX(e){return this.array[e*this.itemSize]}setX(e,t){return this.array[e*this.itemSize]=t,this}getY(e){return this.array[e*this.itemSize+1]}setY(e,t){return this.array[e*this.itemSize+1]=t,this}getZ(e){return this.array[e*this.itemSize+2]}setZ(e,t){return this.array[e*this.itemSize+2]=t,this}getW(e){return this.array[e*this.itemSize+3]}setW(e,t){return this.array[e*this.itemSize+3]=t,this}setXY(e,t,i){return e*=this.itemSize,this.array[e+0]=t,this.array[e+1]=i,this}setXYZ(e,t,i,n){return e*=this.itemSize,this.array[e+0]=t,this.array[e+1]=i,this.array[e+2]=n,this}setXYZW(e,t,i,n,r){return e*=this.itemSize,this.array[e+0]=t,this.array[e+1]=i,this.array[e+2]=n,this.array[e+3]=r,this}onUpload(e){return this.onUploadCallback=e,this}clone(){return new this.constructor(this.array,this.itemSize).copy(this)}toJSON(){const e={itemSize:this.itemSize,type:this.array.constructor.name,array:Array.prototype.slice.call(this.array),normalized:this.normalized};return""!==this.name&&(e.name=this.name),35044!==this.usage&&(e.usage=this.usage),0===this.updateRange.offset&&-1===this.updateRange.count||(e.updateRange=this.updateRange),e}}ni.prototype.isBufferAttribute=!0;class ri extends ni{constructor(e,t,i){super(new Uint8Array(e),t,i)}}class si extends ni{constructor(e,t,i){super(new Uint16Array(e),t,i)}}class ai extends ni{constructor(e,t,i){super(new Uint32Array(e),t,i)}}(class extends ni{constructor(e,t,i){super(new Uint16Array(e),t,i)}}).prototype.isFloat16BufferAttribute=!0;class oi extends ni{constructor(e,t,i){super(new Float32Array(e),t,i)}}let li=0;const ci=new lt,ui=new Rt,hi=new De,di=new ze,pi=new ze,mi=new De;class fi extends ce{constructor(){super(),Object.defineProperty(this,"id",{value:li++}),this.uuid=me(),this.name="",this.type="BufferGeometry",this.index=null,this.attributes={},this.morphAttributes={},this.morphTargetsRelative=!1,this.groups=[],this.boundingBox=null,this.boundingSphere=null,this.drawRange={start:0,count:Infinity},this.userData={}}getIndex(){return this.index}setIndex(e){return Array.isArray(e)?this.index=new(be(e)>65535?ai:si)(e,1):this.index=e,this}getAttribute(e){return this.attributes[e]}setAttribute(e,t){return this.attributes[e]=t,this}deleteAttribute(e){return delete this.attributes[e],this}hasAttribute(e){return void 0!==this.attributes[e]}addGroup(e,t,i=0){this.groups.push({start:e,count:t,materialIndex:i})}clearGroups(){this.groups=[]}setDrawRange(e,t){this.drawRange.start=e,this.drawRange.count=t}applyMatrix4(e){const t=this.attributes.position;void 0!==t&&(t.applyMatrix4(e),t.needsUpdate=!0);const i=this.attributes.normal;if(void 0!==i){const t=(new _e).getNormalMatrix(e);i.applyNormalMatrix(t),i.needsUpdate=!0}const n=this.attributes.tangent;return void 0!==n&&(n.transformDirection(e),n.needsUpdate=!0),null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this}applyQuaternion(e){return ci.makeRotationFromQuaternion(e),this.applyMatrix4(ci),this}rotateX(e){return ci.makeRotationX(e),this.applyMatrix4(ci),this}rotateY(e){return ci.makeRotationY(e),this.applyMatrix4(ci),this}rotateZ(e){return ci.makeRotationZ(e),this.applyMatrix4(ci),this}translate(e,t,i){return ci.makeTranslation(e,t,i),this.applyMatrix4(ci),this}scale(e,t,i){return ci.makeScale(e,t,i),this.applyMatrix4(ci),this}lookAt(e){return ui.lookAt(e),ui.updateMatrix(),this.applyMatrix4(ui.matrix),this}center(){return this.computeBoundingBox(),this.boundingBox.getCenter(hi).negate(),this.translate(hi.x,hi.y,hi.z),this}setFromPoints(e){const t=[];for(let i=0,n=e.length;i<n;i++){const n=e[i];t.push(n.x,n.y,n.z||0)}return this.setAttribute("position",new oi(t,3)),this}computeBoundingBox(){null===this.boundingBox&&(this.boundingBox=new ze);const e=this.attributes.position,t=this.morphAttributes.position;if(e&&e.isGLBufferAttribute)this.boundingBox.set(new De(-Infinity,-Infinity,-Infinity),new De(Infinity,Infinity,Infinity));else{if(void 0!==e){if(this.boundingBox.setFromBufferAttribute(e),t)for(let e=0,i=t.length;e<i;e++){const i=t[e];di.setFromBufferAttribute(i),this.morphTargetsRelative?(mi.addVectors(this.boundingBox.min,di.min),this.boundingBox.expandByPoint(mi),mi.addVectors(this.boundingBox.max,di.max),this.boundingBox.expandByPoint(mi)):(this.boundingBox.expandByPoint(di.min),this.boundingBox.expandByPoint(di.max))}}else this.boundingBox.makeEmpty();isNaN(this.boundingBox.min.x)||isNaN(this.boundingBox.min.y)||isNaN(this.boundingBox.min.z)}}computeBoundingSphere(){null===this.boundingSphere&&(this.boundingSphere=new $e);const e=this.attributes.position,t=this.morphAttributes.position;if(e&&e.isGLBufferAttribute)this.boundingSphere.set(new De,Infinity);else if(e){const i=this.boundingSphere.center;if(di.setFromBufferAttribute(e),t)for(let e=0,r=t.length;e<r;e++){const i=t[e];pi.setFromBufferAttribute(i),this.morphTargetsRelative?(mi.addVectors(di.min,pi.min),di.expandByPoint(mi),mi.addVectors(di.max,pi.max),di.expandByPoint(mi)):(di.expandByPoint(pi.min),di.expandByPoint(pi.max))}di.getCenter(i);let n=0;for(let t=0,r=e.count;t<r;t++)mi.fromBufferAttribute(e,t),n=Math.max(n,i.distanceToSquared(mi));if(t)for(let r=0,s=t.length;r<s;r++){const s=t[r],a=this.morphTargetsRelative;for(let t=0,r=s.count;t<r;t++)mi.fromBufferAttribute(s,t),a&&(hi.fromBufferAttribute(e,t),mi.add(hi)),n=Math.max(n,i.distanceToSquared(mi))}this.boundingSphere.radius=Math.sqrt(n),isNaN(this.boundingSphere.radius)}}computeTangents(){const e=this.index,t=this.attributes;if(null===e||void 0===t.position||void 0===t.normal||void 0===t.uv)return;const i=e.array,n=t.position.array,r=t.normal.array,s=t.uv.array,a=n.length/3;void 0===t.tangent&&this.setAttribute("tangent",new ni(new Float32Array(4*a),4));const o=t.tangent.array,l=[],c=[];for(let T=0;T<a;T++)l[T]=new De,c[T]=new De;const u=new De,h=new De,d=new De,p=new xe,m=new xe,f=new xe,g=new De,v=new De;function y(e,t,i){u.fromArray(n,3*e),h.fromArray(n,3*t),d.fromArray(n,3*i),p.fromArray(s,2*e),m.fromArray(s,2*t),f.fromArray(s,2*i),h.sub(u),d.sub(u),m.sub(p),f.sub(p);const r=1/(m.x*f.y-f.x*m.y);isFinite(r)&&(g.copy(h).multiplyScalar(f.y).addScaledVector(d,-m.y).multiplyScalar(r),v.copy(d).multiplyScalar(m.x).addScaledVector(h,-f.x).multiplyScalar(r),l[e].add(g),l[t].add(g),l[i].add(g),c[e].add(v),c[t].add(v),c[i].add(v))}let x=this.groups;0===x.length&&(x=[{start:0,count:i.length}]);for(let T=0,A=x.length;T<A;++T){const e=x[T],t=e.start;for(let n=t,r=t+e.count;n<r;n+=3)y(i[n+0],i[n+1],i[n+2])}const _=new De,b=new De,w=new De,M=new De;function S(e){w.fromArray(r,3*e),M.copy(w);const t=l[e];_.copy(t),_.sub(w.multiplyScalar(w.dot(t))).normalize(),b.crossVectors(M,t);const i=b.dot(c[e])<0?-1:1;o[4*e]=_.x,o[4*e+1]=_.y,o[4*e+2]=_.z,o[4*e+3]=i}for(let T=0,A=x.length;T<A;++T){const e=x[T],t=e.start;for(let n=t,r=t+e.count;n<r;n+=3)S(i[n+0]),S(i[n+1]),S(i[n+2])}}computeVertexNormals(){const e=this.index,t=this.getAttribute("position");if(void 0!==t){let i=this.getAttribute("normal");if(void 0===i)i=new ni(new Float32Array(3*t.count),3),this.setAttribute("normal",i);else for(let e=0,t=i.count;e<t;e++)i.setXYZ(e,0,0,0);const n=new De,r=new De,s=new De,a=new De,o=new De,l=new De,c=new De,u=new De;if(e)for(let h=0,d=e.count;h<d;h+=3){const d=e.getX(h+0),p=e.getX(h+1),m=e.getX(h+2);n.fromBufferAttribute(t,d),r.fromBufferAttribute(t,p),s.fromBufferAttribute(t,m),c.subVectors(s,r),u.subVectors(n,r),c.cross(u),a.fromBufferAttribute(i,d),o.fromBufferAttribute(i,p),l.fromBufferAttribute(i,m),a.add(c),o.add(c),l.add(c),i.setXYZ(d,a.x,a.y,a.z),i.setXYZ(p,o.x,o.y,o.z),i.setXYZ(m,l.x,l.y,l.z)}else for(let e=0,h=t.count;e<h;e+=3)n.fromBufferAttribute(t,e+0),r.fromBufferAttribute(t,e+1),s.fromBufferAttribute(t,e+2),c.subVectors(s,r),u.subVectors(n,r),c.cross(u),i.setXYZ(e+0,c.x,c.y,c.z),i.setXYZ(e+1,c.x,c.y,c.z),i.setXYZ(e+2,c.x,c.y,c.z);this.normalizeNormals(),i.needsUpdate=!0}}merge(e,t){if(!e||!e.isBufferGeometry)return;void 0===t&&(t=0);const i=this.attributes;for(const n in i){if(void 0===e.attributes[n])continue;const r=i[n].array,s=e.attributes[n],a=s.array,o=s.itemSize*t,l=Math.min(a.length,r.length-o);for(let e=0,t=o;e<l;e++,t++)r[t]=a[e]}return this}normalizeNormals(){const e=this.attributes.normal;for(let t=0,i=e.count;t<i;t++)mi.fromBufferAttribute(e,t),mi.normalize(),e.setXYZ(t,mi.x,mi.y,mi.z)}toNonIndexed(){function e(e,t){const i=e.array,n=e.itemSize,r=e.normalized,s=new i.constructor(t.length*n);let a=0,o=0;for(let l=0,c=t.length;l<c;l++){a=e.isInterleavedBufferAttribute?t[l]*e.data.stride+e.offset:t[l]*n;for(let e=0;e<n;e++)s[o++]=i[a++]}return new ni(s,n,r)}if(null===this.index)return this;const t=new fi,i=this.index.array,n=this.attributes;for(const a in n){const r=e(n[a],i);t.setAttribute(a,r)}const r=this.morphAttributes;for(const a in r){const n=[],s=r[a];for(let t=0,r=s.length;t<r;t++){const r=e(s[t],i);n.push(r)}t.morphAttributes[a]=n}t.morphTargetsRelative=this.morphTargetsRelative;const s=this.groups;for(let a=0,o=s.length;a<o;a++){const e=s[a];t.addGroup(e.start,e.count,e.materialIndex)}return t}toJSON(){const e={metadata:{version:4.5,type:"BufferGeometry",generator:"BufferGeometry.toJSON"}};if(e.uuid=this.uuid,e.type=this.type,""!==this.name&&(e.name=this.name),Object.keys(this.userData).length>0&&(e.userData=this.userData),void 0!==this.parameters){const t=this.parameters;for(const i in t)void 0!==t[i]&&(e[i]=t[i]);return e}e.data={attributes:{}};const t=this.index;null!==t&&(e.data.index={type:t.array.constructor.name,array:Array.prototype.slice.call(t.array)});const i=this.attributes;for(const o in i){const t=i[o];e.data.attributes[o]=t.toJSON(e.data)}const n={};let r=!1;for(const o in this.morphAttributes){const t=this.morphAttributes[o],i=[];for(let n=0,r=t.length;n<r;n++){const r=t[n];i.push(r.toJSON(e.data))}i.length>0&&(n[o]=i,r=!0)}r&&(e.data.morphAttributes=n,e.data.morphTargetsRelative=this.morphTargetsRelative);const s=this.groups;s.length>0&&(e.data.groups=JSON.parse(JSON.stringify(s)));const a=this.boundingSphere;return null!==a&&(e.data.boundingSphere={center:a.center.toArray(),radius:a.radius}),e}clone(){return(new this.constructor).copy(this)}copy(e){this.index=null,this.attributes={},this.morphAttributes={},this.groups=[],this.boundingBox=null,this.boundingSphere=null;const t={};this.name=e.name;const i=e.index;null!==i&&this.setIndex(i.clone(t));const n=e.attributes;for(const l in n){const e=n[l];this.setAttribute(l,e.clone(t))}const r=e.morphAttributes;for(const l in r){const e=[],i=r[l];for(let n=0,r=i.length;n<r;n++)e.push(i[n].clone(t));this.morphAttributes[l]=e}this.morphTargetsRelative=e.morphTargetsRelative;const s=e.groups;for(let l=0,c=s.length;l<c;l++){const e=s[l];this.addGroup(e.start,e.count,e.materialIndex)}const a=e.boundingBox;null!==a&&(this.boundingBox=a.clone());const o=e.boundingSphere;return null!==o&&(this.boundingSphere=o.clone()),this.drawRange.start=e.drawRange.start,this.drawRange.count=e.drawRange.count,this.userData=e.userData,void 0!==e.parameters&&(this.parameters=Object.assign({},e.parameters)),this}dispose(){this.dispatchEvent({type:"dispose"})}}fi.prototype.isBufferGeometry=!0;const gi=new lt,vi=new ot,yi=new $e,xi=new De,_i=new De,bi=new De,wi=new De,Mi=new De,Si=new De,Ti=new De,Ai=new De,Ci=new De,Li=new xe,Pi=new xe,Ei=new xe,Di=new De,Ii=new De;class Ri extends Rt{constructor(e=new fi,t=new ei){super(),this.type="Mesh",this.geometry=e,this.material=t,this.updateMorphTargets()}copy(e){return super.copy(e),void 0!==e.morphTargetInfluences&&(this.morphTargetInfluences=e.morphTargetInfluences.slice()),void 0!==e.morphTargetDictionary&&(this.morphTargetDictionary=Object.assign({},e.morphTargetDictionary)),this.material=e.material,this.geometry=e.geometry,this}updateMorphTargets(){const e=this.geometry;if(e.isBufferGeometry){const t=e.morphAttributes,i=Object.keys(t);if(i.length>0){const e=t[i[0]];if(void 0!==e){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let t=0,i=e.length;t<i;t++){const i=e[t].name||String(t);this.morphTargetInfluences.push(0),this.morphTargetDictionary[i]=t}}}}else{const t=e.morphTargets;void 0!==t&&t.length}}raycast(e,t){const i=this.geometry,n=this.material,r=this.matrixWorld;if(void 0===n)return;if(null===i.boundingSphere&&i.computeBoundingSphere(),yi.copy(i.boundingSphere),yi.applyMatrix4(r),!1===e.ray.intersectsSphere(yi))return;if(gi.copy(r).invert(),vi.copy(e.ray).applyMatrix4(gi),null!==i.boundingBox&&!1===vi.intersectsBox(i.boundingBox))return;let s;if(i.isBufferGeometry){const r=i.index,a=i.attributes.position,o=i.morphAttributes.position,l=i.morphTargetsRelative,c=i.attributes.uv,u=i.attributes.uv2,h=i.groups,d=i.drawRange;if(null!==r)if(Array.isArray(n))for(let i=0,p=h.length;i<p;i++){const p=h[i],m=n[p.materialIndex];for(let i=Math.max(p.start,d.start),n=Math.min(r.count,Math.min(p.start+p.count,d.start+d.count));i<n;i+=3){const n=r.getX(i),h=r.getX(i+1),d=r.getX(i+2);s=zi(this,m,e,vi,a,o,l,c,u,n,h,d),s&&(s.faceIndex=Math.floor(i/3),s.face.materialIndex=p.materialIndex,t.push(s))}}else{for(let i=Math.max(0,d.start),h=Math.min(r.count,d.start+d.count);i<h;i+=3){const h=r.getX(i),d=r.getX(i+1),p=r.getX(i+2);s=zi(this,n,e,vi,a,o,l,c,u,h,d,p),s&&(s.faceIndex=Math.floor(i/3),t.push(s))}}else if(void 0!==a)if(Array.isArray(n))for(let i=0,p=h.length;i<p;i++){const r=h[i],p=n[r.materialIndex];for(let i=Math.max(r.start,d.start),n=Math.min(a.count,Math.min(r.start+r.count,d.start+d.count));i<n;i+=3){s=zi(this,p,e,vi,a,o,l,c,u,i,i+1,i+2),s&&(s.faceIndex=Math.floor(i/3),s.face.materialIndex=r.materialIndex,t.push(s))}}else{for(let i=Math.max(0,d.start),r=Math.min(a.count,d.start+d.count);i<r;i+=3){s=zi(this,n,e,vi,a,o,l,c,u,i,i+1,i+2),s&&(s.faceIndex=Math.floor(i/3),t.push(s))}}}else i.isGeometry}}function zi(e,t,i,n,r,s,a,o,l,c,u,h){xi.fromBufferAttribute(r,c),_i.fromBufferAttribute(r,u),bi.fromBufferAttribute(r,h);const d=e.morphTargetInfluences;if(s&&d){Ti.set(0,0,0),Ai.set(0,0,0),Ci.set(0,0,0);for(let e=0,t=s.length;e<t;e++){const t=d[e],i=s[e];0!==t&&(wi.fromBufferAttribute(i,c),Mi.fromBufferAttribute(i,u),Si.fromBufferAttribute(i,h),a?(Ti.addScaledVector(wi,t),Ai.addScaledVector(Mi,t),Ci.addScaledVector(Si,t)):(Ti.addScaledVector(wi.sub(xi),t),Ai.addScaledVector(Mi.sub(_i),t),Ci.addScaledVector(Si.sub(bi),t)))}xi.add(Ti),_i.add(Ai),bi.add(Ci)}e.isSkinnedMesh&&(e.boneTransform(c,xi),e.boneTransform(u,_i),e.boneTransform(h,bi));const p=function(e,t,i,n,r,s,a,o){let l;if(l=1===t.side?n.intersectTriangle(a,s,r,!0,o):n.intersectTriangle(r,s,a,2!==t.side,o),null===l)return null;Ii.copy(o),Ii.applyMatrix4(e.matrixWorld);const c=i.ray.origin.distanceTo(Ii);return c<i.near||c>i.far?null:{distance:c,point:Ii.clone(),object:e}}(e,t,i,n,xi,_i,bi,Di);if(p){o&&(Li.fromBufferAttribute(o,c),Pi.fromBufferAttribute(o,u),Ei.fromBufferAttribute(o,h),p.uv=Ht.getUV(Di,xi,_i,bi,Li,Pi,Ei,new xe)),l&&(Li.fromBufferAttribute(l,c),Pi.fromBufferAttribute(l,u),Ei.fromBufferAttribute(l,h),p.uv2=Ht.getUV(Di,xi,_i,bi,Li,Pi,Ei,new xe));const e={a:c,b:u,c:h,normal:new De,materialIndex:0};Ht.getNormal(xi,_i,bi,e.normal),p.face=e}return p}Ri.prototype.isMesh=!0;class Ni extends fi{constructor(e=1,t=1,i=1,n=1,r=1,s=1){super(),this.type="BoxGeometry",this.parameters={width:e,height:t,depth:i,widthSegments:n,heightSegments:r,depthSegments:s};const a=this;n=Math.floor(n),r=Math.floor(r),s=Math.floor(s);const o=[],l=[],c=[],u=[];let h=0,d=0;function p(e,t,i,n,r,s,p,m,f,g,v){const y=s/f,x=p/g,_=s/2,b=p/2,w=m/2,M=f+1,S=g+1;let T=0,A=0;const C=new De;for(let a=0;a<S;a++){const s=a*x-b;for(let o=0;o<M;o++){const h=o*y-_;C[e]=h*n,C[t]=s*r,C[i]=w,l.push(C.x,C.y,C.z),C[e]=0,C[t]=0,C[i]=m>0?1:-1,c.push(C.x,C.y,C.z),u.push(o/f),u.push(1-a/g),T+=1}}for(let a=0;a<g;a++)for(let e=0;e<f;e++){const t=h+e+M*a,i=h+e+M*(a+1),n=h+(e+1)+M*(a+1),r=h+(e+1)+M*a;o.push(t,i,r),o.push(i,n,r),A+=6}a.addGroup(d,A,v),d+=A,h+=T}p("z","y","x",-1,-1,i,t,e,s,r,0),p("z","y","x",1,-1,i,t,-e,s,r,1),p("x","z","y",1,1,e,i,t,n,s,2),p("x","z","y",1,-1,e,i,-t,n,s,3),p("x","y","z",1,-1,e,t,i,n,r,4),p("x","y","z",-1,-1,e,t,-i,n,r,5),this.setIndex(o),this.setAttribute("position",new oi(l,3)),this.setAttribute("normal",new oi(c,3)),this.setAttribute("uv",new oi(u,2))}static fromJSON(e){return new Ni(e.width,e.height,e.depth,e.widthSegments,e.heightSegments,e.depthSegments)}}function Oi(e){const t={};for(const i in e){t[i]={};for(const n in e[i]){const r=e[i][n];r&&(r.isColor||r.isMatrix3||r.isMatrix4||r.isVector2||r.isVector3||r.isVector4||r.isTexture||r.isQuaternion)?t[i][n]=r.clone():Array.isArray(r)?t[i][n]=r.slice():t[i][n]=r}}return t}function Fi(e){const t={};for(let i=0;i<e.length;i++){const n=Oi(e[i]);for(const e in n)t[e]=n[e]}return t}const Ui={clone:Oi,merge:Fi};class ki extends qt{constructor(e){super(),this.type="ShaderMaterial",this.defines={},this.uniforms={},this.vertexShader="void main(){gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.0);}",this.fragmentShader="void main(){gl_FragColor=vec4(1.0,0.0,0.0,1.0);}",this.linewidth=1,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.lights=!1,this.clipping=!1,this.extensions={derivatives:!1,fragDepth:!1,drawBuffers:!1,shaderTextureLOD:!1},this.defaultAttributeValues={color:[1,1,1],uv:[0,0],uv2:[0,0]},this.index0AttributeName=void 0,this.uniformsNeedUpdate=!1,this.glslVersion=null,void 0!==e&&(e.attributes,this.setValues(e))}copy(e){return super.copy(e),this.fragmentShader=e.fragmentShader,this.vertexShader=e.vertexShader,this.uniforms=Oi(e.uniforms),this.defines=Object.assign({},e.defines),this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.lights=e.lights,this.clipping=e.clipping,this.extensions=Object.assign({},e.extensions),this.glslVersion=e.glslVersion,this}toJSON(e){const t=super.toJSON(e);t.glslVersion=this.glslVersion,t.uniforms={};for(const n in this.uniforms){const i=this.uniforms[n].value;i&&i.isTexture?t.uniforms[n]={type:"t",value:i.toJSON(e).uuid}:i&&i.isColor?t.uniforms[n]={type:"c",value:i.getHex()}:i&&i.isVector2?t.uniforms[n]={type:"v2",value:i.toArray()}:i&&i.isVector3?t.uniforms[n]={type:"v3",value:i.toArray()}:i&&i.isVector4?t.uniforms[n]={type:"v4",value:i.toArray()}:i&&i.isMatrix3?t.uniforms[n]={type:"m3",value:i.toArray()}:i&&i.isMatrix4?t.uniforms[n]={type:"m4",value:i.toArray()}:t.uniforms[n]={value:i}}Object.keys(this.defines).length>0&&(t.defines=this.defines),t.vertexShader=this.vertexShader,t.fragmentShader=this.fragmentShader;const i={};for(const n in this.extensions)!0===this.extensions[n]&&(i[n]=!0);return Object.keys(i).length>0&&(t.extensions=i),t}}ki.prototype.isShaderMaterial=!0;class Bi extends Rt{constructor(){super(),this.type="Camera",this.matrixWorldInverse=new lt,this.projectionMatrix=new lt,this.projectionMatrixInverse=new lt}copy(e,t){return super.copy(e,t),this.matrixWorldInverse.copy(e.matrixWorldInverse),this.projectionMatrix.copy(e.projectionMatrix),this.projectionMatrixInverse.copy(e.projectionMatrixInverse),this}getWorldDirection(e){this.updateWorldMatrix(!0,!1);const t=this.matrixWorld.elements;return e.set(-t[8],-t[9],-t[10]).normalize()}updateMatrixWorld(e){super.updateMatrixWorld(e),this.matrixWorldInverse.copy(this.matrixWorld).invert()}updateWorldMatrix(e,t){super.updateWorldMatrix(e,t),this.matrixWorldInverse.copy(this.matrixWorld).invert()}clone(){return(new this.constructor).copy(this)}}Bi.prototype.isCamera=!0;class Vi extends Bi{constructor(e=50,t=1,i=.1,n=2e3){super(),this.type="PerspectiveCamera",this.fov=e,this.zoom=1,this.near=i,this.far=n,this.focus=10,this.aspect=t,this.view=null,this.filmGauge=35,this.filmOffset=0,this.updateProjectionMatrix()}copy(e,t){return super.copy(e,t),this.fov=e.fov,this.zoom=e.zoom,this.near=e.near,this.far=e.far,this.focus=e.focus,this.aspect=e.aspect,this.view=null===e.view?null:Object.assign({},e.view),this.filmGauge=e.filmGauge,this.filmOffset=e.filmOffset,this}setFocalLength(e){const t=.5*this.getFilmHeight()/e;this.fov=2*he*Math.atan(t),this.updateProjectionMatrix()}getFocalLength(){const e=Math.tan(.5*ue*this.fov);return.5*this.getFilmHeight()/e}getEffectiveFOV(){return 2*he*Math.atan(Math.tan(.5*ue*this.fov)/this.zoom)}getFilmWidth(){return this.filmGauge*Math.min(this.aspect,1)}getFilmHeight(){return this.filmGauge/Math.max(this.aspect,1)}setViewOffset(e,t,i,n,r,s){this.aspect=e/t,null===this.view&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=e,this.view.fullHeight=t,this.view.offsetX=i,this.view.offsetY=n,this.view.width=r,this.view.height=s,this.updateProjectionMatrix()}clearViewOffset(){null!==this.view&&(this.view.enabled=!1),this.updateProjectionMatrix()}updateProjectionMatrix(){const e=this.near;let t=e*Math.tan(.5*ue*this.fov)/this.zoom,i=2*t,n=this.aspect*i,r=-.5*n;const s=this.view;if(null!==this.view&&this.view.enabled){const e=s.fullWidth,a=s.fullHeight;r+=s.offsetX*n/e,t-=s.offsetY*i/a,n*=s.width/e,i*=s.height/a}const a=this.filmOffset;0!==a&&(r+=e*a/this.getFilmWidth()),this.projectionMatrix.makePerspective(r,r+n,t,t-i,e,this.far),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()}toJSON(e){const t=super.toJSON(e);return t.object.fov=this.fov,t.object.zoom=this.zoom,t.object.near=this.near,t.object.far=this.far,t.object.focus=this.focus,t.object.aspect=this.aspect,null!==this.view&&(t.object.view=Object.assign({},this.view)),t.object.filmGauge=this.filmGauge,t.object.filmOffset=this.filmOffset,t}}Vi.prototype.isPerspectiveCamera=!0;class Gi extends Rt{constructor(e,t,i){if(super(),this.type="CubeCamera",!0!==i.isWebGLCubeRenderTarget)return;this.renderTarget=i;const n=new Vi(90,1,e,t);n.layers=this.layers,n.up.set(0,-1,0),n.lookAt(new De(1,0,0)),this.add(n);const r=new Vi(90,1,e,t);r.layers=this.layers,r.up.set(0,-1,0),r.lookAt(new De(-1,0,0)),this.add(r);const s=new Vi(90,1,e,t);s.layers=this.layers,s.up.set(0,0,1),s.lookAt(new De(0,1,0)),this.add(s);const a=new Vi(90,1,e,t);a.layers=this.layers,a.up.set(0,0,-1),a.lookAt(new De(0,-1,0)),this.add(a);const o=new Vi(90,1,e,t);o.layers=this.layers,o.up.set(0,-1,0),o.lookAt(new De(0,0,1)),this.add(o);const l=new Vi(90,1,e,t);l.layers=this.layers,l.up.set(0,-1,0),l.lookAt(new De(0,0,-1)),this.add(l)}update(e,t){null===this.parent&&this.updateMatrixWorld();const i=this.renderTarget,[n,r,s,a,o,l]=this.children,c=e.xr.enabled,u=e.getRenderTarget();e.xr.enabled=!1;const h=i.texture.generateMipmaps;i.texture.generateMipmaps=!1,e.setRenderTarget(i,0),e.render(t,n),e.setRenderTarget(i,1),e.render(t,r),e.setRenderTarget(i,2),e.render(t,s),e.setRenderTarget(i,3),e.render(t,a),e.setRenderTarget(i,4),e.render(t,o),i.texture.generateMipmaps=h,e.setRenderTarget(i,5),e.render(t,l),e.setRenderTarget(u),e.xr.enabled=c}}class Wi extends Te{constructor(e,t,i,n,r,s,a,o,l,c){super(e=void 0!==e?e:[],t=void 0!==t?t:301,i,n,r,s,a,o,l,c),this.flipY=!1}get images(){return this.image}set images(e){this.image=e}}Wi.prototype.isCubeTexture=!0;class Hi extends Le{constructor(e,t,i){Number.isInteger(t)&&(t=i),super(e,e,t),t=t||{},this.texture=new Wi(void 0,t.mapping,t.wrapS,t.wrapT,t.magFilter,t.minFilter,t.format,t.type,t.anisotropy,t.encoding),this.texture.isRenderTargetTexture=!0,this.texture.generateMipmaps=void 0!==t.generateMipmaps&&t.generateMipmaps,this.texture.minFilter=void 0!==t.minFilter?t.minFilter:1006,this.texture._needsFlipEnvMap=!1}fromEquirectangularTexture(e,t){this.texture.type=t.type,this.texture.format=1023,this.texture.encoding=t.encoding,this.texture.generateMipmaps=t.generateMipmaps,this.texture.minFilter=t.minFilter,this.texture.magFilter=t.magFilter;const i={uniforms:{tEquirect:{value:null}},vertexShader:"varying vec3 vWorldDirection;vec3 transformDirection(in vec3 dir,in mat4 matrix){return normalize((matrix*vec4(dir,0.0)).xyz);}void main(){vWorldDirection=transformDirection(position,modelMatrix);\n#include <begin_vertex>\n#include <project_vertex>\n}",fragmentShader:"uniform sampler2D tEquirect;varying vec3 vWorldDirection;\n#include <common>\nvoid main(){vec3 direction=normalize(vWorldDirection);vec2 sampleUV=equirectUv(direction);gl_FragColor=texture2D(tEquirect,sampleUV);}"},n=new Ni(5,5,5),r=new ki({name:"CubemapFromEquirect",uniforms:Oi(i.uniforms),vertexShader:i.vertexShader,fragmentShader:i.fragmentShader,side:1,blending:0});r.uniforms.tEquirect.value=t;const s=new Ri(n,r),a=t.minFilter;1008===t.minFilter&&(t.minFilter=1006);return new Gi(1,10,this).update(e,s),t.minFilter=a,s.geometry.dispose(),s.material.dispose(),this}clear(e,t,i,n){const r=e.getRenderTarget();for(let s=0;s<6;s++)e.setRenderTarget(this,s),e.clear(t,i,n);e.setRenderTarget(r)}}Hi.prototype.isWebGLCubeRenderTarget=!0;const ji=new De,qi=new De,Xi=new _e;class Yi{constructor(e=new De(1,0,0),t=0){this.normal=e,this.constant=t}set(e,t){return this.normal.copy(e),this.constant=t,this}setComponents(e,t,i,n){return this.normal.set(e,t,i),this.constant=n,this}setFromNormalAndCoplanarPoint(e,t){return this.normal.copy(e),this.constant=-t.dot(this.normal),this}setFromCoplanarPoints(e,t,i){const n=ji.subVectors(i,t).cross(qi.subVectors(e,t)).normalize();return this.setFromNormalAndCoplanarPoint(n,e),this}copy(e){return this.normal.copy(e.normal),this.constant=e.constant,this}normalize(){const e=1/this.normal.length();return this.normal.multiplyScalar(e),this.constant*=e,this}negate(){return this.constant*=-1,this.normal.negate(),this}distanceToPoint(e){return this.normal.dot(e)+this.constant}distanceToSphere(e){return this.distanceToPoint(e.center)-e.radius}projectPoint(e,t){return t.copy(this.normal).multiplyScalar(-this.distanceToPoint(e)).add(e)}intersectLine(e,t){const i=e.delta(ji),n=this.normal.dot(i);if(0===n)return 0===this.distanceToPoint(e.start)?t.copy(e.start):null;const r=-(e.start.dot(this.normal)+this.constant)/n;return r<0||r>1?null:t.copy(i).multiplyScalar(r).add(e.start)}intersectsLine(e){const t=this.distanceToPoint(e.start),i=this.distanceToPoint(e.end);return t<0&&i>0||i<0&&t>0}intersectsBox(e){return e.intersectsPlane(this)}intersectsSphere(e){return e.intersectsPlane(this)}coplanarPoint(e){return e.copy(this.normal).multiplyScalar(-this.constant)}applyMatrix4(e,t){const i=t||Xi.getNormalMatrix(e),n=this.coplanarPoint(ji).applyMatrix4(e),r=this.normal.applyMatrix3(i).normalize();return this.constant=-n.dot(r),this}translate(e){return this.constant-=e.dot(this.normal),this}equals(e){return e.normal.equals(this.normal)&&e.constant===this.constant}clone(){return(new this.constructor).copy(this)}}Yi.prototype.isPlane=!0;const Zi=new $e,Ji=new De;class Qi{constructor(e=new Yi,t=new Yi,i=new Yi,n=new Yi,r=new Yi,s=new Yi){this.planes=[e,t,i,n,r,s]}set(e,t,i,n,r,s){const a=this.planes;return a[0].copy(e),a[1].copy(t),a[2].copy(i),a[3].copy(n),a[4].copy(r),a[5].copy(s),this}copy(e){const t=this.planes;for(let i=0;i<6;i++)t[i].copy(e.planes[i]);return this}setFromProjectionMatrix(e){const t=this.planes,i=e.elements,n=i[0],r=i[1],s=i[2],a=i[3],o=i[4],l=i[5],c=i[6],u=i[7],h=i[8],d=i[9],p=i[10],m=i[11],f=i[12],g=i[13],v=i[14],y=i[15];return t[0].setComponents(a-n,u-o,m-h,y-f).normalize(),t[1].setComponents(a+n,u+o,m+h,y+f).normalize(),t[2].setComponents(a+r,u+l,m+d,y+g).normalize(),t[3].setComponents(a-r,u-l,m-d,y-g).normalize(),t[4].setComponents(a-s,u-c,m-p,y-v).normalize(),t[5].setComponents(a+s,u+c,m+p,y+v).normalize(),this}intersectsObject(e){const t=e.geometry;return null===t.boundingSphere&&t.computeBoundingSphere(),Zi.copy(t.boundingSphere).applyMatrix4(e.matrixWorld),this.intersectsSphere(Zi)}intersectsSprite(e){return Zi.center.set(0,0,0),Zi.radius=.7071067811865476,Zi.applyMatrix4(e.matrixWorld),this.intersectsSphere(Zi)}intersectsSphere(e){const t=this.planes,i=e.center,n=-e.radius;for(let r=0;r<6;r++){if(t[r].distanceToPoint(i)<n)return!1}return!0}intersectsBox(e){const t=this.planes;for(let i=0;i<6;i++){const n=t[i];if(Ji.x=n.normal.x>0?e.max.x:e.min.x,Ji.y=n.normal.y>0?e.max.y:e.min.y,Ji.z=n.normal.z>0?e.max.z:e.min.z,n.distanceToPoint(Ji)<0)return!1}return!0}containsPoint(e){const t=this.planes;for(let i=0;i<6;i++)if(t[i].distanceToPoint(e)<0)return!1;return!0}clone(){return(new this.constructor).copy(this)}}function Ki(){let e=null,t=!1,i=null,n=null;function r(t,s){i(t,s),n=e.requestAnimationFrame(r)}return{start:function(){!0!==t&&null!==i&&(n=e.requestAnimationFrame(r),t=!0)},stop:function(){e.cancelAnimationFrame(n),t=!1},setAnimationLoop:function(e){i=e},setContext:function(t){e=t}}}function $i(e,t){const i=t.isWebGL2,n=new WeakMap;return{get:function(e){return e.isInterleavedBufferAttribute&&(e=e.data),n.get(e)},remove:function(t){t.isInterleavedBufferAttribute&&(t=t.data);const i=n.get(t);i&&(e.deleteBuffer(i.buffer),n.delete(t))},update:function(t,r){if(t.isGLBufferAttribute){const e=n.get(t);return void((!e||e.version<t.version)&&n.set(t,{buffer:t.buffer,type:t.type,bytesPerElement:t.elementSize,version:t.version}))}t.isInterleavedBufferAttribute&&(t=t.data);const s=n.get(t);void 0===s?n.set(t,function(t,n){const r=t.array,s=t.usage,a=e.createBuffer();e.bindBuffer(n,a),e.bufferData(n,r,s),t.onUploadCallback();let o=5126;return r instanceof Float32Array?o=5126:r instanceof Float64Array||(r instanceof Uint16Array?t.isFloat16BufferAttribute?i&&(o=5131):o=5123:r instanceof Int16Array?o=5122:r instanceof Uint32Array?o=5125:r instanceof Int32Array?o=5124:r instanceof Int8Array?o=5120:(r instanceof Uint8Array||r instanceof Uint8ClampedArray)&&(o=5121)),{buffer:a,type:o,bytesPerElement:r.BYTES_PER_ELEMENT,version:t.version}}(t,r)):s.version<t.version&&(!function(t,n,r){const s=n.array,a=n.updateRange;e.bindBuffer(r,t),-1===a.count?e.bufferSubData(r,0,s):(i?e.bufferSubData(r,a.offset*s.BYTES_PER_ELEMENT,s,a.offset,a.count):e.bufferSubData(r,a.offset*s.BYTES_PER_ELEMENT,s.subarray(a.offset,a.offset+a.count)),a.count=-1)}(s.buffer,t,r),s.version=t.version)}}}class en extends fi{constructor(e=1,t=1,i=1,n=1){super(),this.type="PlaneGeometry",this.parameters={width:e,height:t,widthSegments:i,heightSegments:n};const r=e/2,s=t/2,a=Math.floor(i),o=Math.floor(n),l=a+1,c=o+1,u=e/a,h=t/o,d=[],p=[],m=[],f=[];for(let g=0;g<c;g++){const e=g*h-s;for(let t=0;t<l;t++){const i=t*u-r;p.push(i,-e,0),m.push(0,0,1),f.push(t/a),f.push(1-g/o)}}for(let g=0;g<o;g++)for(let e=0;e<a;e++){const t=e+l*g,i=e+l*(g+1),n=e+1+l*(g+1),r=e+1+l*g;d.push(t,i,r),d.push(i,n,r)}this.setIndex(d),this.setAttribute("position",new oi(p,3)),this.setAttribute("normal",new oi(m,3)),this.setAttribute("uv",new oi(f,2))}static fromJSON(e){return new en(e.width,e.height,e.widthSegments,e.heightSegments)}}const tn={alphamap_fragment:"#ifdef USE_ALPHAMAP\ndiffuseColor.a*=texture2D(alphaMap,vUv).g;\n#endif",alphamap_pars_fragment:"#ifdef USE_ALPHAMAP\nuniform sampler2D alphaMap;\n#endif",alphatest_fragment:"#ifdef USE_ALPHATEST\nif(diffuseColor.a<alphaTest)discard;\n#endif",alphatest_pars_fragment:"#ifdef USE_ALPHATEST\nuniform float alphaTest;\n#endif",aomap_fragment:"#ifdef USE_AOMAP\nfloat ambientOcclusion=(texture2D(aoMap,vUv2).r-1.0)*aoMapIntensity+1.0;reflectedLight.indirectDiffuse*=ambientOcclusion;\n#if defined(USE_ENVMAP)&&defined(STANDARD)\nfloat dotNV=saturate(dot(geometry.normal,geometry.viewDir));reflectedLight.indirectSpecular*=computeSpecularOcclusion(dotNV,ambientOcclusion,material.roughness);\n#endif\n#endif",aomap_pars_fragment:"#ifdef USE_AOMAP\nuniform sampler2D aoMap;uniform float aoMapIntensity;\n#endif",begin_vertex:"vec3 transformed=vec3(position);",beginnormal_vertex:"vec3 objectNormal=vec3(normal);\n#ifdef USE_TANGENT\nvec3 objectTangent=vec3(tangent.xyz);\n#endif",bsdfs:"vec3 BRDF_Lambert(const in vec3 diffuseColor){return RECIPROCAL_PI*diffuseColor;}vec3 F_Schlick(const in vec3 f0,const in float f90,const in float dotVH){float fresnel=exp2((-5.55473*dotVH-6.98316)*dotVH);return f0*(1.0-fresnel)+(f90*fresnel);}float V_GGX_SmithCorrelated(const in float alpha,const in float dotNL,const in float dotNV){float a2=pow2(alpha);float gv=dotNL*sqrt(a2+(1.0-a2)*pow2(dotNV));float gl=dotNV*sqrt(a2+(1.0-a2)*pow2(dotNL));return 0.5/max(gv+gl,EPSILON);}float D_GGX(const in float alpha,const in float dotNH){float a2=pow2(alpha);float denom=pow2(dotNH)*(a2-1.0)+1.0;return RECIPROCAL_PI*a2/pow2(denom);}vec3 BRDF_GGX(const in vec3 lightDir,const in vec3 viewDir,const in vec3 normal,const in vec3 f0,const in float f90,const in float roughness){float alpha=pow2(roughness);vec3 halfDir=normalize(lightDir+viewDir);float dotNL=saturate(dot(normal,lightDir));float dotNV=saturate(dot(normal,viewDir));float dotNH=saturate(dot(normal,halfDir));float dotVH=saturate(dot(viewDir,halfDir));vec3 F=F_Schlick(f0,f90,dotVH);float V=V_GGX_SmithCorrelated(alpha,dotNL,dotNV);float D=D_GGX(alpha,dotNH);return F*(V*D);}vec2 LTC_Uv(const in vec3 N,const in vec3 V,const in float roughness){const float LUT_SIZE=64.0;const float LUT_SCALE=(LUT_SIZE-1.0)/LUT_SIZE;const float LUT_BIAS=0.5/LUT_SIZE;float dotNV=saturate(dot(N,V));vec2 uv=vec2(roughness,sqrt(1.0-dotNV));uv=uv*LUT_SCALE+LUT_BIAS;return uv;}float LTC_ClippedSphereFormFactor(const in vec3 f){float l=length(f);return max((l*l+f.z)/(l+1.0),0.0);}vec3 LTC_EdgeVectorFormFactor(const in vec3 v1,const in vec3 v2){float x=dot(v1,v2);float y=abs(x);float a=0.8543985+(0.4965155+0.0145206*y)*y;float b=3.4175940+(4.1616724+y)*y;float v=a/b;float theta_sintheta=(x>0.0)?v:0.5*inversesqrt(max(1.0-x*x,1e-7))-v;return cross(v1,v2)*theta_sintheta;}vec3 LTC_Evaluate(const in vec3 N,const in vec3 V,const in vec3 P,const in mat3 mInv,const in vec3 rectCoords[4]){vec3 v1=rectCoords[1]-rectCoords[0];vec3 v2=rectCoords[3]-rectCoords[0];vec3 lightNormal=cross(v1,v2);if(dot(lightNormal,P-rectCoords[0])<0.0)return vec3(0.0);vec3 T1,T2;T1=normalize(V-N*dot(V,N));T2=-cross(N,T1);mat3 mat=mInv*transposeMat3(mat3(T1,T2,N));vec3 coords[4];coords[0]=mat*(rectCoords[0]-P);coords[1]=mat*(rectCoords[1]-P);coords[2]=mat*(rectCoords[2]-P);coords[3]=mat*(rectCoords[3]-P);coords[0]=normalize(coords[0]);coords[1]=normalize(coords[1]);coords[2]=normalize(coords[2]);coords[3]=normalize(coords[3]);vec3 vectorFormFactor=vec3(0.0);vectorFormFactor+=LTC_EdgeVectorFormFactor(coords[0],coords[1]);vectorFormFactor+=LTC_EdgeVectorFormFactor(coords[1],coords[2]);vectorFormFactor+=LTC_EdgeVectorFormFactor(coords[2],coords[3]);vectorFormFactor+=LTC_EdgeVectorFormFactor(coords[3],coords[0]);float result=LTC_ClippedSphereFormFactor(vectorFormFactor);return vec3(result);}float G_BlinnPhong_Implicit(){return 0.25;}float D_BlinnPhong(const in float shininess,const in float dotNH){return RECIPROCAL_PI*(shininess*0.5+1.0)*pow(dotNH,shininess);}vec3 BRDF_BlinnPhong(const in vec3 lightDir,const in vec3 viewDir,const in vec3 normal,const in vec3 specularColor,const in float shininess){vec3 halfDir=normalize(lightDir+viewDir);float dotNH=saturate(dot(normal,halfDir));float dotVH=saturate(dot(viewDir,halfDir));vec3 F=F_Schlick(specularColor,1.0,dotVH);float G=G_BlinnPhong_Implicit();float D=D_BlinnPhong(shininess,dotNH);return F*(G*D);}\n#if defined(USE_SHEEN)\nfloat D_Charlie(float roughness,float dotNH){float alpha=pow2(roughness);float invAlpha=1.0/alpha;float cos2h=dotNH*dotNH;float sin2h=max(1.0-cos2h,0.0078125);return(2.0+invAlpha)*pow(sin2h,invAlpha*0.5)/(2.0*PI);}float V_Neubelt(float dotNV,float dotNL){return saturate(1.0/(4.0*(dotNL+dotNV-dotNL*dotNV)));}vec3 BRDF_Sheen(const in vec3 lightDir,const in vec3 viewDir,const in vec3 normal,vec3 sheenTint,const in float sheenRoughness){vec3 halfDir=normalize(lightDir+viewDir);float dotNL=saturate(dot(normal,lightDir));float dotNV=saturate(dot(normal,viewDir));float dotNH=saturate(dot(normal,halfDir));float D=D_Charlie(sheenRoughness,dotNH);float V=V_Neubelt(dotNV,dotNL);return sheenTint*(D*V);}\n#endif",bumpmap_pars_fragment:"#ifdef USE_BUMPMAP\nuniform sampler2D bumpMap;uniform float bumpScale;vec2 dHdxy_fwd(){vec2 dSTdx=dFdx(vUv);vec2 dSTdy=dFdy(vUv);float Hll=bumpScale*texture2D(bumpMap,vUv).x;float dBx=bumpScale*texture2D(bumpMap,vUv+dSTdx).x-Hll;float dBy=bumpScale*texture2D(bumpMap,vUv+dSTdy).x-Hll;return vec2(dBx,dBy);}vec3 perturbNormalArb(vec3 surf_pos,vec3 surf_norm,vec2 dHdxy,float faceDirection){vec3 vSigmaX=vec3(dFdx(surf_pos.x),dFdx(surf_pos.y),dFdx(surf_pos.z));vec3 vSigmaY=vec3(dFdy(surf_pos.x),dFdy(surf_pos.y),dFdy(surf_pos.z));vec3 vN=surf_norm;vec3 R1=cross(vSigmaY,vN);vec3 R2=cross(vN,vSigmaX);float fDet=dot(vSigmaX,R1)*faceDirection;vec3 vGrad=sign(fDet)*(dHdxy.x*R1+dHdxy.y*R2);return normalize(abs(fDet)*surf_norm-vGrad);}\n#endif",clipping_planes_fragment:"#if NUM_CLIPPING_PLANES>0\nvec4 plane;\n#pragma unroll_loop_start\nfor(int i=0;i<UNION_CLIPPING_PLANES;i++){plane=clippingPlanes[i];if(dot(vClipPosition,plane.xyz)>plane.w)discard;}\n#pragma unroll_loop_end\n#if UNION_CLIPPING_PLANES<NUM_CLIPPING_PLANES\nbool clipped=true;\n#pragma unroll_loop_start\nfor(int i=UNION_CLIPPING_PLANES;i<NUM_CLIPPING_PLANES;i++){plane=clippingPlanes[i];clipped=(dot(vClipPosition,plane.xyz)>plane.w)&&clipped;}\n#pragma unroll_loop_end\nif(clipped)discard;\n#endif\n#endif",clipping_planes_pars_fragment:"#if NUM_CLIPPING_PLANES>0\nvarying vec3 vClipPosition;uniform vec4 clippingPlanes[NUM_CLIPPING_PLANES];\n#endif",clipping_planes_pars_vertex:"#if NUM_CLIPPING_PLANES>0\nvarying vec3 vClipPosition;\n#endif",clipping_planes_vertex:"#if NUM_CLIPPING_PLANES>0\nvClipPosition=-mvPosition.xyz;\n#endif",color_fragment:"#if defined(USE_COLOR_ALPHA)\ndiffuseColor*=vColor;\n#elif defined(USE_COLOR)\ndiffuseColor.rgb*=vColor;\n#endif",color_pars_fragment:"#if defined(USE_COLOR_ALPHA)\nvarying vec4 vColor;\n#elif defined(USE_COLOR)\nvarying vec3 vColor;\n#endif",color_pars_vertex:"#if defined(USE_COLOR_ALPHA)\nvarying vec4 vColor;\n#elif defined(USE_COLOR)||defined(USE_INSTANCING_COLOR)\nvarying vec3 vColor;\n#endif",color_vertex:"#if defined(USE_COLOR_ALPHA)\nvColor=vec4(1.0);\n#elif defined(USE_COLOR)||defined(USE_INSTANCING_COLOR)\nvColor=vec3(1.0);\n#endif\n#ifdef USE_COLOR\nvColor*=color;\n#endif\n#ifdef USE_INSTANCING_COLOR\nvColor.xyz*=instanceColor.xyz;\n#endif",common:"#define PI 3.141592653589793\n#define PI2 6.283185307179586\n#define PI_HALF 1.5707963267948966\n#define RECIPROCAL_PI 0.3183098861837907\n#define RECIPROCAL_PI2 0.15915494309189535\n#define EPSILON 1e-6\n#ifndef saturate\n#define saturate(a)clamp(a,0.0,1.0)\n#endif\n#define whiteComplement(a)(1.0-saturate(a))\nfloat pow2(const in float x){return x*x;}float pow3(const in float x){return x*x*x;}float pow4(const in float x){float x2=x*x;return x2*x2;}float max3(const in vec3 v){return max(max(v.x,v.y),v.z);}float average(const in vec3 color){return dot(color,vec3(0.3333));}highp float rand(const in vec2 uv){const highp float a=12.9898,b=78.233,c=43758.5453;highp float dt=dot(uv.xy,vec2(a,b)),sn=mod(dt,PI);return fract(sin(sn)*c);}\n#ifdef HIGH_PRECISION\nfloat precisionSafeLength(vec3 v){return length(v);}\n#else\nfloat precisionSafeLength(vec3 v){float maxComponent=max3(abs(v));return length(v/maxComponent)*maxComponent;}\n#endif\nstruct IncidentLight{vec3 color;vec3 direction;bool visible;};struct ReflectedLight{vec3 directDiffuse;vec3 directSpecular;vec3 indirectDiffuse;vec3 indirectSpecular;};struct GeometricContext{vec3 position;vec3 normal;vec3 viewDir;\n#ifdef USE_CLEARCOAT\nvec3 clearcoatNormal;\n#endif\n};vec3 transformDirection(in vec3 dir,in mat4 matrix){return normalize((matrix*vec4(dir,0.0)).xyz);}vec3 inverseTransformDirection(in vec3 dir,in mat4 matrix){return normalize((vec4(dir,0.0)*matrix).xyz);}mat3 transposeMat3(const in mat3 m){mat3 tmp;tmp[0]=vec3(m[0].x,m[1].x,m[2].x);tmp[1]=vec3(m[0].y,m[1].y,m[2].y);tmp[2]=vec3(m[0].z,m[1].z,m[2].z);return tmp;}float linearToRelativeLuminance(const in vec3 color){vec3 weights=vec3(0.2126,0.7152,0.0722);return dot(weights,color.rgb);}bool isPerspectiveMatrix(mat4 m){return m[2][3]==-1.0;}vec2 equirectUv(in vec3 dir){float u=atan(dir.z,dir.x)*RECIPROCAL_PI2+0.5;float v=asin(clamp(dir.y,-1.0,1.0))*RECIPROCAL_PI+0.5;return vec2(u,v);}",cube_uv_reflection_fragment:"#ifdef ENVMAP_TYPE_CUBE_UV\n#define cubeUV_maxMipLevel 8.0\n#define cubeUV_minMipLevel 4.0\n#define cubeUV_maxTileSize 256.0\n#define cubeUV_minTileSize 16.0\nfloat getFace(vec3 direction){vec3 absDirection=abs(direction);float face=-1.0;if(absDirection.x>absDirection.z){if(absDirection.x>absDirection.y)face=direction.x>0.0?0.0:3.0;else face=direction.y>0.0?1.0:4.0;}else{if(absDirection.z>absDirection.y)face=direction.z>0.0?2.0:5.0;else face=direction.y>0.0?1.0:4.0;}return face;}vec2 getUV(vec3 direction,float face){vec2 uv;if(face==0.0){uv=vec2(direction.z,direction.y)/abs(direction.x);}else if(face==1.0){uv=vec2(-direction.x,-direction.z)/abs(direction.y);}else if(face==2.0){uv=vec2(-direction.x,direction.y)/abs(direction.z);}else if(face==3.0){uv=vec2(-direction.z,direction.y)/abs(direction.x);}else if(face==4.0){uv=vec2(-direction.x,direction.z)/abs(direction.y);}else{uv=vec2(direction.x,direction.y)/abs(direction.z);}return 0.5*(uv+1.0);}vec3 bilinearCubeUV(sampler2D envMap,vec3 direction,float mipInt){float face=getFace(direction);float filterInt=max(cubeUV_minMipLevel-mipInt,0.0);mipInt=max(mipInt,cubeUV_minMipLevel);float faceSize=exp2(mipInt);float texelSize=1.0/(3.0*cubeUV_maxTileSize);vec2 uv=getUV(direction,face)*(faceSize-1.0);vec2 f=fract(uv);uv+=0.5-f;if(face>2.0){uv.y+=faceSize;face-=3.0;}uv.x+=face*faceSize;if(mipInt<cubeUV_maxMipLevel){uv.y+=2.0*cubeUV_maxTileSize;}uv.y+=filterInt*2.0*cubeUV_minTileSize;uv.x+=3.0*max(0.0,cubeUV_maxTileSize-2.0*faceSize);uv*=texelSize;vec3 tl=envMapTexelToLinear(texture2D(envMap,uv)).rgb;uv.x+=texelSize;vec3 tr=envMapTexelToLinear(texture2D(envMap,uv)).rgb;uv.y+=texelSize;vec3 br=envMapTexelToLinear(texture2D(envMap,uv)).rgb;uv.x-=texelSize;vec3 bl=envMapTexelToLinear(texture2D(envMap,uv)).rgb;vec3 tm=mix(tl,tr,f.x);vec3 bm=mix(bl,br,f.x);return mix(tm,bm,f.y);}\n#define r0 1.0\n#define v0 0.339\n#define m0-2.0\n#define r1 0.8\n#define v1 0.276\n#define m1-1.0\n#define r4 0.4\n#define v4 0.046\n#define m4 2.0\n#define r5 0.305\n#define v5 0.016\n#define m5 3.0\n#define r6 0.21\n#define v6 0.0038\n#define m6 4.0\nfloat roughnessToMip(float roughness){float mip=0.0;if(roughness>=r1){mip=(r0-roughness)*(m1-m0)/(r0-r1)+m0;}else if(roughness>=r4){mip=(r1-roughness)*(m4-m1)/(r1-r4)+m1;}else if(roughness>=r5){mip=(r4-roughness)*(m5-m4)/(r4-r5)+m4;}else if(roughness>=r6){mip=(r5-roughness)*(m6-m5)/(r5-r6)+m5;}else{mip=-2.0*log2(1.16*roughness);}return mip;}vec4 textureCubeUV(sampler2D envMap,vec3 sampleDir,float roughness){float mip=clamp(roughnessToMip(roughness),m0,cubeUV_maxMipLevel);float mipF=fract(mip);float mipInt=floor(mip);vec3 color0=bilinearCubeUV(envMap,sampleDir,mipInt);if(mipF==0.0){return vec4(color0,1.0);}else{vec3 color1=bilinearCubeUV(envMap,sampleDir,mipInt+1.0);return vec4(mix(color0,color1,mipF),1.0);}}\n#endif",defaultnormal_vertex:"vec3 transformedNormal=objectNormal;\n#ifdef USE_INSTANCING\nmat3 m=mat3(instanceMatrix);transformedNormal/=vec3(dot(m[0],m[0]),dot(m[1],m[1]),dot(m[2],m[2]));transformedNormal=m*transformedNormal;\n#endif\ntransformedNormal=normalMatrix*transformedNormal;\n#ifdef FLIP_SIDED\ntransformedNormal=-transformedNormal;\n#endif\n#ifdef USE_TANGENT\nvec3 transformedTangent=(modelViewMatrix*vec4(objectTangent,0.0)).xyz;\n#ifdef FLIP_SIDED\ntransformedTangent=-transformedTangent;\n#endif\n#endif",displacementmap_pars_vertex:"#ifdef USE_DISPLACEMENTMAP\nuniform sampler2D displacementMap;uniform float displacementScale;uniform float displacementBias;\n#endif",displacementmap_vertex:"#ifdef USE_DISPLACEMENTMAP\ntransformed+=normalize(objectNormal)*(texture2D(displacementMap,vUv).x*displacementScale+displacementBias);\n#endif",emissivemap_fragment:"#ifdef USE_EMISSIVEMAP\nvec4 emissiveColor=texture2D(emissiveMap,vUv);emissiveColor.rgb=emissiveMapTexelToLinear(emissiveColor).rgb;totalEmissiveRadiance*=emissiveColor.rgb;\n#endif",emissivemap_pars_fragment:"#ifdef USE_EMISSIVEMAP\nuniform sampler2D emissiveMap;\n#endif",encodings_fragment:"gl_FragColor=linearToOutputTexel(gl_FragColor);",encodings_pars_fragment:"vec4 LinearToLinear(in vec4 value){return value;}vec4 GammaToLinear(in vec4 value,in float gammaFactor){return vec4(pow(value.rgb,vec3(gammaFactor)),value.a);}vec4 LinearToGamma(in vec4 value,in float gammaFactor){return vec4(pow(value.rgb,vec3(1.0/gammaFactor)),value.a);}vec4 sRGBToLinear(in vec4 value){return vec4(mix(pow(value.rgb*0.9478672986+vec3(0.0521327014),vec3(2.4)),value.rgb*0.0773993808,vec3(lessThanEqual(value.rgb,vec3(0.04045)))),value.a);}vec4 LinearTosRGB(in vec4 value){return vec4(mix(pow(value.rgb,vec3(0.41666))*1.055-vec3(0.055),value.rgb*12.92,vec3(lessThanEqual(value.rgb,vec3(0.0031308)))),value.a);}vec4 RGBEToLinear(in vec4 value){return vec4(value.rgb*exp2(value.a*255.0-128.0),1.0);}vec4 LinearToRGBE(in vec4 value){float maxComponent=max(max(value.r,value.g),value.b);float fExp=clamp(ceil(log2(maxComponent)),-128.0,127.0);return vec4(value.rgb/exp2(fExp),(fExp+128.0)/255.0);}vec4 RGBMToLinear(in vec4 value,in float maxRange){return vec4(value.rgb*value.a*maxRange,1.0);}vec4 LinearToRGBM(in vec4 value,in float maxRange){float maxRGB=max(value.r,max(value.g,value.b));float M=clamp(maxRGB/maxRange,0.0,1.0);M=ceil(M*255.0)/255.0;return vec4(value.rgb/(M*maxRange),M);}vec4 RGBDToLinear(in vec4 value,in float maxRange){return vec4(value.rgb*((maxRange/255.0)/value.a),1.0);}vec4 LinearToRGBD(in vec4 value,in float maxRange){float maxRGB=max(value.r,max(value.g,value.b));float D=max(maxRange/maxRGB,1.0);D=clamp(floor(D)/255.0,0.0,1.0);return vec4(value.rgb*(D*(255.0/maxRange)),D);}const mat3 cLogLuvM=mat3(0.2209,0.3390,0.4184,0.1138,0.6780,0.7319,0.0102,0.1130,0.2969);vec4 LinearToLogLuv(in vec4 value){vec3 Xp_Y_XYZp=cLogLuvM*value.rgb;Xp_Y_XYZp=max(Xp_Y_XYZp,vec3(1e-6,1e-6,1e-6));vec4 vResult;vResult.xy=Xp_Y_XYZp.xy/Xp_Y_XYZp.z;float Le=2.0*log2(Xp_Y_XYZp.y)+127.0;vResult.w=fract(Le);vResult.z=(Le-(floor(vResult.w*255.0))/255.0)/255.0;return vResult;}const mat3 cLogLuvInverseM=mat3(6.0014,-2.7008,-1.7996,-1.3320,3.1029,-5.7721,0.3008,-1.0882,5.6268);vec4 LogLuvToLinear(in vec4 value){float Le=value.z*255.0+value.w;vec3 Xp_Y_XYZp;Xp_Y_XYZp.y=exp2((Le-127.0)/2.0);Xp_Y_XYZp.z=Xp_Y_XYZp.y/value.y;Xp_Y_XYZp.x=value.x*Xp_Y_XYZp.z;vec3 vRGB=cLogLuvInverseM*Xp_Y_XYZp.rgb;return vec4(max(vRGB,0.0),1.0);}",envmap_fragment:"#ifdef USE_ENVMAP\n#ifdef ENV_WORLDPOS\nvec3 cameraToFrag;if(isOrthographic){cameraToFrag=normalize(vec3(-viewMatrix[0][2],-viewMatrix[1][2],-viewMatrix[2][2]));}else{cameraToFrag=normalize(vWorldPosition-cameraPosition);}vec3 worldNormal=inverseTransformDirection(normal,viewMatrix);\n#ifdef ENVMAP_MODE_REFLECTION\nvec3 reflectVec=reflect(cameraToFrag,worldNormal);\n#else\nvec3 reflectVec=refract(cameraToFrag,worldNormal,refractionRatio);\n#endif\n#else\nvec3 reflectVec=vReflect;\n#endif\n#ifdef ENVMAP_TYPE_CUBE\nvec4 envColor=textureCube(envMap,vec3(flipEnvMap*reflectVec.x,reflectVec.yz));envColor=envMapTexelToLinear(envColor);\n#elif defined(ENVMAP_TYPE_CUBE_UV)\nvec4 envColor=textureCubeUV(envMap,reflectVec,0.0);\n#else\nvec4 envColor=vec4(0.0);\n#endif\n#ifdef ENVMAP_BLENDING_MULTIPLY\noutgoingLight=mix(outgoingLight,outgoingLight*envColor.xyz,specularStrength*reflectivity);\n#elif defined(ENVMAP_BLENDING_MIX)\noutgoingLight=mix(outgoingLight,envColor.xyz,specularStrength*reflectivity);\n#elif defined(ENVMAP_BLENDING_ADD)\noutgoingLight+=envColor.xyz*specularStrength*reflectivity;\n#endif\n#endif",envmap_common_pars_fragment:"#ifdef USE_ENVMAP\nuniform float envMapIntensity;uniform float flipEnvMap;uniform int maxMipLevel;\n#ifdef ENVMAP_TYPE_CUBE\nuniform samplerCube envMap;\n#else\nuniform sampler2D envMap;\n#endif\n#endif",envmap_pars_fragment:"#ifdef USE_ENVMAP\nuniform float reflectivity;\n#if defined(USE_BUMPMAP)||defined(USE_NORMALMAP)||defined(PHONG)\n#define ENV_WORLDPOS\n#endif\n#ifdef ENV_WORLDPOS\nvarying vec3 vWorldPosition;uniform float refractionRatio;\n#else\nvarying vec3 vReflect;\n#endif\n#endif",envmap_pars_vertex:"#ifdef USE_ENVMAP\n#if defined(USE_BUMPMAP)||defined(USE_NORMALMAP)||defined(PHONG)\n#define ENV_WORLDPOS\n#endif\n#ifdef ENV_WORLDPOS\nvarying vec3 vWorldPosition;\n#else\nvarying vec3 vReflect;uniform float refractionRatio;\n#endif\n#endif",envmap_physical_pars_fragment:"#if defined(USE_ENVMAP)\n#ifdef ENVMAP_MODE_REFRACTION\nuniform float refractionRatio;\n#endif\nvec3 getIBLIrradiance(const in vec3 normal){\n#if defined(ENVMAP_TYPE_CUBE_UV)\nvec3 worldNormal=inverseTransformDirection(normal,viewMatrix);vec4 envMapColor=textureCubeUV(envMap,worldNormal,1.0);return PI*envMapColor.rgb*envMapIntensity;\n#else\nreturn vec3(0.0);\n#endif\n}vec3 getIBLRadiance(const in vec3 viewDir,const in vec3 normal,const in float roughness){\n#if defined(ENVMAP_TYPE_CUBE_UV)\nvec3 reflectVec;\n#ifdef ENVMAP_MODE_REFLECTION\nreflectVec=reflect(-viewDir,normal);reflectVec=normalize(mix(reflectVec,normal,roughness*roughness));\n#else\nreflectVec=refract(-viewDir,normal,refractionRatio);\n#endif\nreflectVec=inverseTransformDirection(reflectVec,viewMatrix);vec4 envMapColor=textureCubeUV(envMap,reflectVec,roughness);return envMapColor.rgb*envMapIntensity;\n#else\nreturn vec3(0.0);\n#endif\n}\n#endif",envmap_vertex:"#ifdef USE_ENVMAP\n#ifdef ENV_WORLDPOS\nvWorldPosition=worldPosition.xyz;\n#else\nvec3 cameraToVertex;if(isOrthographic){cameraToVertex=normalize(vec3(-viewMatrix[0][2],-viewMatrix[1][2],-viewMatrix[2][2]));}else{cameraToVertex=normalize(worldPosition.xyz-cameraPosition);}vec3 worldNormal=inverseTransformDirection(transformedNormal,viewMatrix);\n#ifdef ENVMAP_MODE_REFLECTION\nvReflect=reflect(cameraToVertex,worldNormal);\n#else\nvReflect=refract(cameraToVertex,worldNormal,refractionRatio);\n#endif\n#endif\n#endif",fog_vertex:"#ifdef USE_FOG\nvFogDepth=-mvPosition.z;\n#endif",fog_pars_vertex:"#ifdef USE_FOG\nvarying float vFogDepth;\n#endif",fog_fragment:"#ifdef USE_FOG\n#ifdef FOG_EXP2\nfloat fogFactor=1.0-exp(-fogDensity*fogDensity*vFogDepth*vFogDepth);\n#else\nfloat fogFactor=smoothstep(fogNear,fogFar,vFogDepth);\n#endif\ngl_FragColor.rgb=mix(gl_FragColor.rgb,fogColor,fogFactor);\n#endif",fog_pars_fragment:"#ifdef USE_FOG\nuniform vec3 fogColor;varying float vFogDepth;\n#ifdef FOG_EXP2\nuniform float fogDensity;\n#else\nuniform float fogNear;uniform float fogFar;\n#endif\n#endif",gradientmap_pars_fragment:"#ifdef USE_GRADIENTMAP\nuniform sampler2D gradientMap;\n#endif\nvec3 getGradientIrradiance(vec3 normal,vec3 lightDirection){float dotNL=dot(normal,lightDirection);vec2 coord=vec2(dotNL*0.5+0.5,0.0);\n#ifdef USE_GRADIENTMAP\nreturn texture2D(gradientMap,coord).rgb;\n#else\nreturn(coord.x<0.7)?vec3(0.7):vec3(1.0);\n#endif\n}",lightmap_fragment:"#ifdef USE_LIGHTMAP\nvec4 lightMapTexel=texture2D(lightMap,vUv2);vec3 lightMapIrradiance=lightMapTexelToLinear(lightMapTexel).rgb*lightMapIntensity;\n#ifndef PHYSICALLY_CORRECT_LIGHTS\nlightMapIrradiance*=PI;\n#endif\nreflectedLight.indirectDiffuse+=lightMapIrradiance;\n#endif",lightmap_pars_fragment:"#ifdef USE_LIGHTMAP\nuniform sampler2D lightMap;uniform float lightMapIntensity;\n#endif",lights_lambert_vertex:"vec3 diffuse=vec3(1.0);GeometricContext geometry;geometry.position=mvPosition.xyz;geometry.normal=normalize(transformedNormal);geometry.viewDir=(isOrthographic)?vec3(0,0,1):normalize(-mvPosition.xyz);GeometricContext backGeometry;backGeometry.position=geometry.position;backGeometry.normal=-geometry.normal;backGeometry.viewDir=geometry.viewDir;vLightFront=vec3(0.0);vIndirectFront=vec3(0.0);\n#ifdef DOUBLE_SIDED\nvLightBack=vec3(0.0);vIndirectBack=vec3(0.0);\n#endif\nIncidentLight directLight;float dotNL;vec3 directLightColor_Diffuse;vIndirectFront+=getAmbientLightIrradiance(ambientLightColor);vIndirectFront+=getLightProbeIrradiance(lightProbe,geometry.normal);\n#ifdef DOUBLE_SIDED\nvIndirectBack+=getAmbientLightIrradiance(ambientLightColor);vIndirectBack+=getLightProbeIrradiance(lightProbe,backGeometry.normal);\n#endif\n#if NUM_POINT_LIGHTS>0\n#pragma unroll_loop_start\nfor(int i=0;i<NUM_POINT_LIGHTS;i++){getPointLightInfo(pointLights[i],geometry,directLight);dotNL=dot(geometry.normal,directLight.direction);directLightColor_Diffuse=directLight.color;vLightFront+=saturate(dotNL)*directLightColor_Diffuse;\n#ifdef DOUBLE_SIDED\nvLightBack+=saturate(-dotNL)*directLightColor_Diffuse;\n#endif\n}\n#pragma unroll_loop_end\n#endif\n#if NUM_SPOT_LIGHTS>0\n#pragma unroll_loop_start\nfor(int i=0;i<NUM_SPOT_LIGHTS;i++){getSpotLightInfo(spotLights[i],geometry,directLight);dotNL=dot(geometry.normal,directLight.direction);directLightColor_Diffuse=directLight.color;vLightFront+=saturate(dotNL)*directLightColor_Diffuse;\n#ifdef DOUBLE_SIDED\nvLightBack+=saturate(-dotNL)*directLightColor_Diffuse;\n#endif\n}\n#pragma unroll_loop_end\n#endif\n#if NUM_DIR_LIGHTS>0\n#pragma unroll_loop_start\nfor(int i=0;i<NUM_DIR_LIGHTS;i++){getDirectionalLightInfo(directionalLights[i],geometry,directLight);dotNL=dot(geometry.normal,directLight.direction);directLightColor_Diffuse=directLight.color;vLightFront+=saturate(dotNL)*directLightColor_Diffuse;\n#ifdef DOUBLE_SIDED\nvLightBack+=saturate(-dotNL)*directLightColor_Diffuse;\n#endif\n}\n#pragma unroll_loop_end\n#endif\n#if NUM_HEMI_LIGHTS>0\n#pragma unroll_loop_start\nfor(int i=0;i<NUM_HEMI_LIGHTS;i++){vIndirectFront+=getHemisphereLightIrradiance(hemisphereLights[i],geometry.normal);\n#ifdef DOUBLE_SIDED\nvIndirectBack+=getHemisphereLightIrradiance(hemisphereLights[i],backGeometry.normal);\n#endif\n}\n#pragma unroll_loop_end\n#endif",lights_pars_begin:"uniform bool receiveShadow;uniform vec3 ambientLightColor;uniform vec3 lightProbe[9];vec3 shGetIrradianceAt(in vec3 normal,in vec3 shCoefficients[9]){float x=normal.x,y=normal.y,z=normal.z;vec3 result=shCoefficients[0]*0.886227;result+=shCoefficients[1]*2.0*0.511664*y;result+=shCoefficients[2]*2.0*0.511664*z;result+=shCoefficients[3]*2.0*0.511664*x;result+=shCoefficients[4]*2.0*0.429043*x*y;result+=shCoefficients[5]*2.0*0.429043*y*z;result+=shCoefficients[6]*(0.743125*z*z-0.247708);result+=shCoefficients[7]*2.0*0.429043*x*z;result+=shCoefficients[8]*0.429043*(x*x-y*y);return result;}vec3 getLightProbeIrradiance(const in vec3 lightProbe[9],const in vec3 normal){vec3 worldNormal=inverseTransformDirection(normal,viewMatrix);vec3 irradiance=shGetIrradianceAt(worldNormal,lightProbe);return irradiance;}vec3 getAmbientLightIrradiance(const in vec3 ambientLightColor){vec3 irradiance=ambientLightColor;return irradiance;}float getDistanceAttenuation(const in float lightDistance,const in float cutoffDistance,const in float decayExponent){\n#if defined(PHYSICALLY_CORRECT_LIGHTS)\nfloat distanceFalloff=1.0/max(pow(lightDistance,decayExponent),0.01);if(cutoffDistance>0.0){distanceFalloff*=pow2(saturate(1.0-pow4(lightDistance/cutoffDistance)));}return distanceFalloff;\n#else\nif(cutoffDistance>0.0&&decayExponent>0.0){return pow(saturate(-lightDistance/cutoffDistance+1.0),decayExponent);}return 1.0;\n#endif\n}float getSpotAttenuation(const in float coneCosine,const in float penumbraCosine,const in float angleCosine){return smoothstep(coneCosine,penumbraCosine,angleCosine);}\n#if NUM_DIR_LIGHTS>0\nstruct DirectionalLight{vec3 direction;vec3 color;};uniform DirectionalLight directionalLights[NUM_DIR_LIGHTS];void getDirectionalLightInfo(const in DirectionalLight directionalLight,const in GeometricContext geometry,out IncidentLight light){light.color=directionalLight.color;light.direction=directionalLight.direction;light.visible=true;}\n#endif\n#if NUM_POINT_LIGHTS>0\nstruct PointLight{vec3 position;vec3 color;float distance;float decay;};uniform PointLight pointLights[NUM_POINT_LIGHTS];void getPointLightInfo(const in PointLight pointLight,const in GeometricContext geometry,out IncidentLight light){vec3 lVector=pointLight.position-geometry.position;light.direction=normalize(lVector);float lightDistance=length(lVector);light.color=pointLight.color;light.color*=getDistanceAttenuation(lightDistance,pointLight.distance,pointLight.decay);light.visible=(light.color!=vec3(0.0));}\n#endif\n#if NUM_SPOT_LIGHTS>0\nstruct SpotLight{vec3 position;vec3 direction;vec3 color;float distance;float decay;float coneCos;float penumbraCos;};uniform SpotLight spotLights[NUM_SPOT_LIGHTS];void getSpotLightInfo(const in SpotLight spotLight,const in GeometricContext geometry,out IncidentLight light){vec3 lVector=spotLight.position-geometry.position;light.direction=normalize(lVector);float angleCos=dot(light.direction,spotLight.direction);float spotAttenuation=getSpotAttenuation(spotLight.coneCos,spotLight.penumbraCos,angleCos);if(spotAttenuation>0.0){float lightDistance=length(lVector);light.color=spotLight.color*spotAttenuation;light.color*=getDistanceAttenuation(lightDistance,spotLight.distance,spotLight.decay);light.visible=(light.color!=vec3(0.0));}else{light.color=vec3(0.0);light.visible=false;}}\n#endif\n#if NUM_RECT_AREA_LIGHTS>0\nstruct RectAreaLight{vec3 color;vec3 position;vec3 halfWidth;vec3 halfHeight;};uniform sampler2D ltc_1;uniform sampler2D ltc_2;uniform RectAreaLight rectAreaLights[NUM_RECT_AREA_LIGHTS];\n#endif\n#if NUM_HEMI_LIGHTS>0\nstruct HemisphereLight{vec3 direction;vec3 skyColor;vec3 groundColor;};uniform HemisphereLight hemisphereLights[NUM_HEMI_LIGHTS];vec3 getHemisphereLightIrradiance(const in HemisphereLight hemiLight,const in vec3 normal){float dotNL=dot(normal,hemiLight.direction);float hemiDiffuseWeight=0.5*dotNL+0.5;vec3 irradiance=mix(hemiLight.groundColor,hemiLight.skyColor,hemiDiffuseWeight);return irradiance;}\n#endif",lights_toon_fragment:"ToonMaterial material;material.diffuseColor=diffuseColor.rgb;",lights_toon_pars_fragment:"varying vec3 vViewPosition;struct ToonMaterial{vec3 diffuseColor;};void RE_Direct_Toon(const in IncidentLight directLight,const in GeometricContext geometry,const in ToonMaterial material,inout ReflectedLight reflectedLight){vec3 irradiance=getGradientIrradiance(geometry.normal,directLight.direction)*directLight.color;reflectedLight.directDiffuse+=irradiance*BRDF_Lambert(material.diffuseColor);}void RE_IndirectDiffuse_Toon(const in vec3 irradiance,const in GeometricContext geometry,const in ToonMaterial material,inout ReflectedLight reflectedLight){reflectedLight.indirectDiffuse+=irradiance*BRDF_Lambert(material.diffuseColor);}\n#define RE_Direct RE_Direct_Toon\n#define RE_IndirectDiffuse RE_IndirectDiffuse_Toon\n#define Material_LightProbeLOD(material)(0)",lights_phong_fragment:"BlinnPhongMaterial material;material.diffuseColor=diffuseColor.rgb;material.specularColor=specular;material.specularShininess=shininess;material.specularStrength=specularStrength;",lights_phong_pars_fragment:"varying vec3 vViewPosition;struct BlinnPhongMaterial{vec3 diffuseColor;vec3 specularColor;float specularShininess;float specularStrength;};void RE_Direct_BlinnPhong(const in IncidentLight directLight,const in GeometricContext geometry,const in BlinnPhongMaterial material,inout ReflectedLight reflectedLight){float dotNL=saturate(dot(geometry.normal,directLight.direction));vec3 irradiance=dotNL*directLight.color;reflectedLight.directDiffuse+=irradiance*BRDF_Lambert(material.diffuseColor);reflectedLight.directSpecular+=irradiance*BRDF_BlinnPhong(directLight.direction,geometry.viewDir,geometry.normal,material.specularColor,material.specularShininess)*material.specularStrength;}void RE_IndirectDiffuse_BlinnPhong(const in vec3 irradiance,const in GeometricContext geometry,const in BlinnPhongMaterial material,inout ReflectedLight reflectedLight){reflectedLight.indirectDiffuse+=irradiance*BRDF_Lambert(material.diffuseColor);}\n#define RE_Direct RE_Direct_BlinnPhong\n#define RE_IndirectDiffuse RE_IndirectDiffuse_BlinnPhong\n#define Material_LightProbeLOD(material)(0)",lights_physical_fragment:"PhysicalMaterial material;material.diffuseColor=diffuseColor.rgb*(1.0-metalnessFactor);vec3 dxy=max(abs(dFdx(geometryNormal)),abs(dFdy(geometryNormal)));float geometryRoughness=max(max(dxy.x,dxy.y),dxy.z);material.roughness=max(roughnessFactor,0.0525);material.roughness+=geometryRoughness;material.roughness=min(material.roughness,1.0);\n#ifdef IOR\n#ifdef SPECULAR\nfloat specularIntensityFactor=specularIntensity;vec3 specularTintFactor=specularTint;\n#ifdef USE_SPECULARINTENSITYMAP\nspecularIntensityFactor*=texture2D(specularIntensityMap,vUv).a;\n#endif\n#ifdef USE_SPECULARTINTMAP\nspecularTintFactor*=specularTintMapTexelToLinear(texture2D(specularTintMap,vUv)).rgb;\n#endif\nmaterial.specularF90=mix(specularIntensityFactor,1.0,metalnessFactor);\n#else\nfloat specularIntensityFactor=1.0;vec3 specularTintFactor=vec3(1.0);material.specularF90=1.0;\n#endif\nmaterial.specularColor=mix(min(pow2((ior-1.0)/(ior+1.0))*specularTintFactor,vec3(1.0))*specularIntensityFactor,diffuseColor.rgb,metalnessFactor);\n#else\nmaterial.specularColor=mix(vec3(0.04),diffuseColor.rgb,metalnessFactor);material.specularF90=1.0;\n#endif\n#ifdef USE_CLEARCOAT\nmaterial.clearcoat=clearcoat;material.clearcoatRoughness=clearcoatRoughness;material.clearcoatF0=vec3(0.04);material.clearcoatF90=1.0;\n#ifdef USE_CLEARCOATMAP\nmaterial.clearcoat*=texture2D(clearcoatMap,vUv).x;\n#endif\n#ifdef USE_CLEARCOAT_ROUGHNESSMAP\nmaterial.clearcoatRoughness*=texture2D(clearcoatRoughnessMap,vUv).y;\n#endif\nmaterial.clearcoat=saturate(material.clearcoat);material.clearcoatRoughness=max(material.clearcoatRoughness,0.0525);material.clearcoatRoughness+=geometryRoughness;material.clearcoatRoughness=min(material.clearcoatRoughness,1.0);\n#endif\n#ifdef USE_SHEEN\nmaterial.sheenTint=sheenTint;material.sheenRoughness=clamp(sheenRoughness,0.07,1.0);\n#endif",lights_physical_pars_fragment:"struct PhysicalMaterial{vec3 diffuseColor;float roughness;vec3 specularColor;float specularF90;\n#ifdef USE_CLEARCOAT\nfloat clearcoat;float clearcoatRoughness;vec3 clearcoatF0;float clearcoatF90;\n#endif\n#ifdef USE_SHEEN\nvec3 sheenTint;float sheenRoughness;\n#endif\n};vec3 clearcoatSpecular=vec3(0.0);vec2 DFGApprox(const in vec3 normal,const in vec3 viewDir,const in float roughness){float dotNV=saturate(dot(normal,viewDir));const vec4 c0=vec4(-1,-0.0275,-0.572,0.022);const vec4 c1=vec4(1,0.0425,1.04,-0.04);vec4 r=roughness*c0+c1;float a004=min(r.x*r.x,exp2(-9.28*dotNV))*r.x+r.y;vec2 fab=vec2(-1.04,1.04)*a004+r.zw;return fab;}vec3 EnvironmentBRDF(const in vec3 normal,const in vec3 viewDir,const in vec3 specularColor,const in float specularF90,const in float roughness){vec2 fab=DFGApprox(normal,viewDir,roughness);return specularColor*fab.x+specularF90*fab.y;}void computeMultiscattering(const in vec3 normal,const in vec3 viewDir,const in vec3 specularColor,const in float specularF90,const in float roughness,inout vec3 singleScatter,inout vec3 multiScatter){vec2 fab=DFGApprox(normal,viewDir,roughness);vec3 FssEss=specularColor*fab.x+specularF90*fab.y;float Ess=fab.x+fab.y;float Ems=1.0-Ess;vec3 Favg=specularColor+(1.0-specularColor)*0.047619;vec3 Fms=FssEss*Favg/(1.0-Ems*Favg);singleScatter+=FssEss;multiScatter+=Fms*Ems;}\n#if NUM_RECT_AREA_LIGHTS>0\nvoid RE_Direct_RectArea_Physical(const in RectAreaLight rectAreaLight,const in GeometricContext geometry,const in PhysicalMaterial material,inout ReflectedLight reflectedLight){vec3 normal=geometry.normal;vec3 viewDir=geometry.viewDir;vec3 position=geometry.position;vec3 lightPos=rectAreaLight.position;vec3 halfWidth=rectAreaLight.halfWidth;vec3 halfHeight=rectAreaLight.halfHeight;vec3 lightColor=rectAreaLight.color;float roughness=material.roughness;vec3 rectCoords[4];rectCoords[0]=lightPos+halfWidth-halfHeight;rectCoords[1]=lightPos-halfWidth-halfHeight;rectCoords[2]=lightPos-halfWidth+halfHeight;rectCoords[3]=lightPos+halfWidth+halfHeight;vec2 uv=LTC_Uv(normal,viewDir,roughness);vec4 t1=texture2D(ltc_1,uv);vec4 t2=texture2D(ltc_2,uv);mat3 mInv=mat3(vec3(t1.x,0,t1.y),vec3(0,1,0),vec3(t1.z,0,t1.w));vec3 fresnel=(material.specularColor*t2.x+(vec3(1.0)-material.specularColor)*t2.y);reflectedLight.directSpecular+=lightColor*fresnel*LTC_Evaluate(normal,viewDir,position,mInv,rectCoords);reflectedLight.directDiffuse+=lightColor*material.diffuseColor*LTC_Evaluate(normal,viewDir,position,mat3(1.0),rectCoords);}\n#endif\nvoid RE_Direct_Physical(const in IncidentLight directLight,const in GeometricContext geometry,const in PhysicalMaterial material,inout ReflectedLight reflectedLight){float dotNL=saturate(dot(geometry.normal,directLight.direction));vec3 irradiance=dotNL*directLight.color;\n#ifdef USE_CLEARCOAT\nfloat dotNLcc=saturate(dot(geometry.clearcoatNormal,directLight.direction));vec3 ccIrradiance=dotNLcc*directLight.color;clearcoatSpecular+=ccIrradiance*BRDF_GGX(directLight.direction,geometry.viewDir,geometry.clearcoatNormal,material.clearcoatF0,material.clearcoatF90,material.clearcoatRoughness);\n#endif\n#ifdef USE_SHEEN\nreflectedLight.directSpecular+=irradiance*BRDF_Sheen(directLight.direction,geometry.viewDir,geometry.normal,material.sheenTint,material.sheenRoughness);\n#endif\nreflectedLight.directSpecular+=irradiance*BRDF_GGX(directLight.direction,geometry.viewDir,geometry.normal,material.specularColor,material.specularF90,material.roughness);reflectedLight.directDiffuse+=irradiance*BRDF_Lambert(material.diffuseColor);}void RE_IndirectDiffuse_Physical(const in vec3 irradiance,const in GeometricContext geometry,const in PhysicalMaterial material,inout ReflectedLight reflectedLight){reflectedLight.indirectDiffuse+=irradiance*BRDF_Lambert(material.diffuseColor);}void RE_IndirectSpecular_Physical(const in vec3 radiance,const in vec3 irradiance,const in vec3 clearcoatRadiance,const in GeometricContext geometry,const in PhysicalMaterial material,inout ReflectedLight reflectedLight){\n#ifdef USE_CLEARCOAT\nclearcoatSpecular+=clearcoatRadiance*EnvironmentBRDF(geometry.clearcoatNormal,geometry.viewDir,material.clearcoatF0,material.clearcoatF90,material.clearcoatRoughness);\n#endif\nvec3 singleScattering=vec3(0.0);vec3 multiScattering=vec3(0.0);vec3 cosineWeightedIrradiance=irradiance*RECIPROCAL_PI;computeMultiscattering(geometry.normal,geometry.viewDir,material.specularColor,material.specularF90,material.roughness,singleScattering,multiScattering);vec3 diffuse=material.diffuseColor*(1.0-(singleScattering+multiScattering));reflectedLight.indirectSpecular+=radiance*singleScattering;reflectedLight.indirectSpecular+=multiScattering*cosineWeightedIrradiance;reflectedLight.indirectDiffuse+=diffuse*cosineWeightedIrradiance;}\n#define RE_Direct RE_Direct_Physical\n#define RE_Direct_RectArea RE_Direct_RectArea_Physical\n#define RE_IndirectDiffuse RE_IndirectDiffuse_Physical\n#define RE_IndirectSpecular RE_IndirectSpecular_Physical\nfloat computeSpecularOcclusion(const in float dotNV,const in float ambientOcclusion,const in float roughness){return saturate(pow(dotNV+ambientOcclusion,exp2(-16.0*roughness-1.0))-1.0+ambientOcclusion);}",lights_fragment_begin:"GeometricContext geometry;geometry.position=-vViewPosition;geometry.normal=normal;geometry.viewDir=(isOrthographic)?vec3(0,0,1):normalize(vViewPosition);\n#ifdef USE_CLEARCOAT\ngeometry.clearcoatNormal=clearcoatNormal;\n#endif\nIncidentLight directLight;\n#if (NUM_POINT_LIGHTS>0)&&defined(RE_Direct)\nPointLight pointLight;\n#if defined(USE_SHADOWMAP)&&NUM_POINT_LIGHT_SHADOWS>0\nPointLightShadow pointLightShadow;\n#endif\n#pragma unroll_loop_start\nfor(int i=0;i<NUM_POINT_LIGHTS;i++){pointLight=pointLights[i];getPointLightInfo(pointLight,geometry,directLight);\n#if defined(USE_SHADOWMAP)&&(UNROLLED_LOOP_INDEX<NUM_POINT_LIGHT_SHADOWS)\npointLightShadow=pointLightShadows[i];directLight.color*=all(bvec2(directLight.visible,receiveShadow))?getPointShadow(pointShadowMap[i],pointLightShadow.shadowMapSize,pointLightShadow.shadowBias,pointLightShadow.shadowRadius,vPointShadowCoord[i],pointLightShadow.shadowCameraNear,pointLightShadow.shadowCameraFar):1.0;\n#endif\nRE_Direct(directLight,geometry,material,reflectedLight);}\n#pragma unroll_loop_end\n#endif\n#if (NUM_SPOT_LIGHTS>0)&&defined(RE_Direct)\nSpotLight spotLight;\n#if defined(USE_SHADOWMAP)&&NUM_SPOT_LIGHT_SHADOWS>0\nSpotLightShadow spotLightShadow;\n#endif\n#pragma unroll_loop_start\nfor(int i=0;i<NUM_SPOT_LIGHTS;i++){spotLight=spotLights[i];getSpotLightInfo(spotLight,geometry,directLight);\n#if defined(USE_SHADOWMAP)&&(UNROLLED_LOOP_INDEX<NUM_SPOT_LIGHT_SHADOWS)\nspotLightShadow=spotLightShadows[i];directLight.color*=all(bvec2(directLight.visible,receiveShadow))?getShadow(spotShadowMap[i],spotLightShadow.shadowMapSize,spotLightShadow.shadowBias,spotLightShadow.shadowRadius,vSpotShadowCoord[i]):1.0;\n#endif\nRE_Direct(directLight,geometry,material,reflectedLight);}\n#pragma unroll_loop_end\n#endif\n#if (NUM_DIR_LIGHTS>0)&&defined(RE_Direct)\nDirectionalLight directionalLight;\n#if defined(USE_SHADOWMAP)&&NUM_DIR_LIGHT_SHADOWS>0\nDirectionalLightShadow directionalLightShadow;\n#endif\n#pragma unroll_loop_start\nfor(int i=0;i<NUM_DIR_LIGHTS;i++){directionalLight=directionalLights[i];getDirectionalLightInfo(directionalLight,geometry,directLight);\n#if defined(USE_SHADOWMAP)&&(UNROLLED_LOOP_INDEX<NUM_DIR_LIGHT_SHADOWS)\ndirectionalLightShadow=directionalLightShadows[i];directLight.color*=all(bvec2(directLight.visible,receiveShadow))?getShadow(directionalShadowMap[i],directionalLightShadow.shadowMapSize,directionalLightShadow.shadowBias,directionalLightShadow.shadowRadius,vDirectionalShadowCoord[i]):1.0;\n#endif\nRE_Direct(directLight,geometry,material,reflectedLight);}\n#pragma unroll_loop_end\n#endif\n#if (NUM_RECT_AREA_LIGHTS>0)&&defined(RE_Direct_RectArea)\nRectAreaLight rectAreaLight;\n#pragma unroll_loop_start\nfor(int i=0;i<NUM_RECT_AREA_LIGHTS;i++){rectAreaLight=rectAreaLights[i];RE_Direct_RectArea(rectAreaLight,geometry,material,reflectedLight);}\n#pragma unroll_loop_end\n#endif\n#if defined(RE_IndirectDiffuse)\nvec3 iblIrradiance=vec3(0.0);vec3 irradiance=getAmbientLightIrradiance(ambientLightColor);irradiance+=getLightProbeIrradiance(lightProbe,geometry.normal);\n#if (NUM_HEMI_LIGHTS>0)\n#pragma unroll_loop_start\nfor(int i=0;i<NUM_HEMI_LIGHTS;i++){irradiance+=getHemisphereLightIrradiance(hemisphereLights[i],geometry.normal);}\n#pragma unroll_loop_end\n#endif\n#endif\n#if defined(RE_IndirectSpecular)\nvec3 radiance=vec3(0.0);vec3 clearcoatRadiance=vec3(0.0);\n#endif",lights_fragment_maps:"#if defined(RE_IndirectDiffuse)\n#ifdef USE_LIGHTMAP\nvec4 lightMapTexel=texture2D(lightMap,vUv2);vec3 lightMapIrradiance=lightMapTexelToLinear(lightMapTexel).rgb*lightMapIntensity;\n#ifndef PHYSICALLY_CORRECT_LIGHTS\nlightMapIrradiance*=PI;\n#endif\nirradiance+=lightMapIrradiance;\n#endif\n#if defined(USE_ENVMAP)&&defined(STANDARD)&&defined(ENVMAP_TYPE_CUBE_UV)\niblIrradiance+=getIBLIrradiance(geometry.normal);\n#endif\n#endif\n#if defined(USE_ENVMAP)&&defined(RE_IndirectSpecular)\nradiance+=getIBLRadiance(geometry.viewDir,geometry.normal,material.roughness);\n#ifdef USE_CLEARCOAT\nclearcoatRadiance+=getIBLRadiance(geometry.viewDir,geometry.clearcoatNormal,material.clearcoatRoughness);\n#endif\n#endif",lights_fragment_end:"#if defined(RE_IndirectDiffuse)\nRE_IndirectDiffuse(irradiance,geometry,material,reflectedLight);\n#endif\n#if defined(RE_IndirectSpecular)\nRE_IndirectSpecular(radiance,iblIrradiance,clearcoatRadiance,geometry,material,reflectedLight);\n#endif",logdepthbuf_fragment:"#if defined(USE_LOGDEPTHBUF)&&defined(USE_LOGDEPTHBUF_EXT)\ngl_FragDepthEXT=vIsPerspective==0.0?gl_FragCoord.z:log2(vFragDepth)*logDepthBufFC*0.5;\n#endif",logdepthbuf_pars_fragment:"#if defined(USE_LOGDEPTHBUF)&&defined(USE_LOGDEPTHBUF_EXT)\nuniform float logDepthBufFC;varying float vFragDepth;varying float vIsPerspective;\n#endif",logdepthbuf_pars_vertex:"#ifdef USE_LOGDEPTHBUF\n#ifdef USE_LOGDEPTHBUF_EXT\nvarying float vFragDepth;varying float vIsPerspective;\n#else\nuniform float logDepthBufFC;\n#endif\n#endif",logdepthbuf_vertex:"#ifdef USE_LOGDEPTHBUF\n#ifdef USE_LOGDEPTHBUF_EXT\nvFragDepth=1.0+gl_Position.w;vIsPerspective=float(isPerspectiveMatrix(projectionMatrix));\n#else\nif(isPerspectiveMatrix(projectionMatrix)){gl_Position.z=log2(max(EPSILON,gl_Position.w+1.0))*logDepthBufFC-1.0;gl_Position.z*=gl_Position.w;}\n#endif\n#endif",map_fragment:"#ifdef USE_MAP\nvec4 texelColor=texture2D(map,vUv);texelColor=mapTexelToLinear(texelColor);diffuseColor*=texelColor;\n#endif",map_pars_fragment:"#ifdef USE_MAP\nuniform sampler2D map;\n#endif",map_particle_fragment:"#if defined(USE_MAP)||defined(USE_ALPHAMAP)\nvec2 uv=(uvTransform*vec3(gl_PointCoord.x,1.0-gl_PointCoord.y,1)).xy;\n#endif\n#ifdef USE_MAP\nvec4 mapTexel=texture2D(map,uv);diffuseColor*=mapTexelToLinear(mapTexel);\n#endif\n#ifdef USE_ALPHAMAP\ndiffuseColor.a*=texture2D(alphaMap,uv).g;\n#endif",map_particle_pars_fragment:"#if defined(USE_MAP)||defined(USE_ALPHAMAP)\nuniform mat3 uvTransform;\n#endif\n#ifdef USE_MAP\nuniform sampler2D map;\n#endif\n#ifdef USE_ALPHAMAP\nuniform sampler2D alphaMap;\n#endif",metalnessmap_fragment:"float metalnessFactor=metalness;\n#ifdef USE_METALNESSMAP\nvec4 texelMetalness=texture2D(metalnessMap,vUv);metalnessFactor*=texelMetalness.b;\n#endif",metalnessmap_pars_fragment:"#ifdef USE_METALNESSMAP\nuniform sampler2D metalnessMap;\n#endif",morphnormal_vertex:"#ifdef USE_MORPHNORMALS\nobjectNormal*=morphTargetBaseInfluence;\n#ifdef MORPHTARGETS_TEXTURE\nfor(int i=0;i<MORPHTARGETS_COUNT;i++){if(morphTargetInfluences[i]>0.0)objectNormal+=getMorph(gl_VertexID,i,1,2)*morphTargetInfluences[i];}\n#else\nobjectNormal+=morphNormal0*morphTargetInfluences[0];objectNormal+=morphNormal1*morphTargetInfluences[1];objectNormal+=morphNormal2*morphTargetInfluences[2];objectNormal+=morphNormal3*morphTargetInfluences[3];\n#endif\n#endif",morphtarget_pars_vertex:"#ifdef USE_MORPHTARGETS\nuniform float morphTargetBaseInfluence;\n#ifdef MORPHTARGETS_TEXTURE\nuniform float morphTargetInfluences[MORPHTARGETS_COUNT];uniform sampler2DArray morphTargetsTexture;uniform vec2 morphTargetsTextureSize;vec3 getMorph(const in int vertexIndex,const in int morphTargetIndex,const in int offset,const in int stride){float texelIndex=float(vertexIndex*stride+offset);float y=floor(texelIndex/morphTargetsTextureSize.x);float x=texelIndex-y*morphTargetsTextureSize.x;vec3 morphUV=vec3((x+0.5)/morphTargetsTextureSize.x,y/morphTargetsTextureSize.y,morphTargetIndex);return texture(morphTargetsTexture,morphUV).xyz;}\n#else\n#ifndef USE_MORPHNORMALS\nuniform float morphTargetInfluences[8];\n#else\nuniform float morphTargetInfluences[4];\n#endif\n#endif\n#endif",morphtarget_vertex:"#ifdef USE_MORPHTARGETS\ntransformed*=morphTargetBaseInfluence;\n#ifdef MORPHTARGETS_TEXTURE\nfor(int i=0;i<MORPHTARGETS_COUNT;i++){\n#ifndef USE_MORPHNORMALS\nif(morphTargetInfluences[i]>0.0)transformed+=getMorph(gl_VertexID,i,0,1)*morphTargetInfluences[i];\n#else\nif(morphTargetInfluences[i]>0.0)transformed+=getMorph(gl_VertexID,i,0,2)*morphTargetInfluences[i];\n#endif\n}\n#else\ntransformed+=morphTarget0*morphTargetInfluences[0];transformed+=morphTarget1*morphTargetInfluences[1];transformed+=morphTarget2*morphTargetInfluences[2];transformed+=morphTarget3*morphTargetInfluences[3];\n#ifndef USE_MORPHNORMALS\ntransformed+=morphTarget4*morphTargetInfluences[4];transformed+=morphTarget5*morphTargetInfluences[5];transformed+=morphTarget6*morphTargetInfluences[6];transformed+=morphTarget7*morphTargetInfluences[7];\n#endif\n#endif\n#endif",normal_fragment_begin:"float faceDirection=gl_FrontFacing?1.0:-1.0;\n#ifdef FLAT_SHADED\nvec3 fdx=vec3(dFdx(vViewPosition.x),dFdx(vViewPosition.y),dFdx(vViewPosition.z));vec3 fdy=vec3(dFdy(vViewPosition.x),dFdy(vViewPosition.y),dFdy(vViewPosition.z));vec3 normal=normalize(cross(fdx,fdy));\n#else\nvec3 normal=normalize(vNormal);\n#ifdef DOUBLE_SIDED\nnormal=normal*faceDirection;\n#endif\n#ifdef USE_TANGENT\nvec3 tangent=normalize(vTangent);vec3 bitangent=normalize(vBitangent);\n#ifdef DOUBLE_SIDED\ntangent=tangent*faceDirection;bitangent=bitangent*faceDirection;\n#endif\n#if defined(TANGENTSPACE_NORMALMAP)||defined(USE_CLEARCOAT_NORMALMAP)\nmat3 vTBN=mat3(tangent,bitangent,normal);\n#endif\n#endif\n#endif\nvec3 geometryNormal=normal;",normal_fragment_maps:"#ifdef OBJECTSPACE_NORMALMAP\nnormal=texture2D(normalMap,vUv).xyz*2.0-1.0;\n#ifdef FLIP_SIDED\nnormal=-normal;\n#endif\n#ifdef DOUBLE_SIDED\nnormal=normal*faceDirection;\n#endif\nnormal=normalize(normalMatrix*normal);\n#elif defined(TANGENTSPACE_NORMALMAP)\nvec3 mapN=texture2D(normalMap,vUv).xyz*2.0-1.0;mapN.xy*=normalScale;\n#ifdef USE_TANGENT\nnormal=normalize(vTBN*mapN);\n#else\nnormal=perturbNormal2Arb(-vViewPosition,normal,mapN,faceDirection);\n#endif\n#elif defined(USE_BUMPMAP)\nnormal=perturbNormalArb(-vViewPosition,normal,dHdxy_fwd(),faceDirection);\n#endif",normal_pars_fragment:"#ifndef FLAT_SHADED\nvarying vec3 vNormal;\n#ifdef USE_TANGENT\nvarying vec3 vTangent;varying vec3 vBitangent;\n#endif\n#endif",normal_pars_vertex:"#ifndef FLAT_SHADED\nvarying vec3 vNormal;\n#ifdef USE_TANGENT\nvarying vec3 vTangent;varying vec3 vBitangent;\n#endif\n#endif",normal_vertex:"#ifndef FLAT_SHADED\nvNormal=normalize(transformedNormal);\n#ifdef USE_TANGENT\nvTangent=normalize(transformedTangent);vBitangent=normalize(cross(vNormal,vTangent)*tangent.w);\n#endif\n#endif",normalmap_pars_fragment:"#ifdef USE_NORMALMAP\nuniform sampler2D normalMap;uniform vec2 normalScale;\n#endif\n#ifdef OBJECTSPACE_NORMALMAP\nuniform mat3 normalMatrix;\n#endif\n#if !defined(USE_TANGENT)&&(defined(TANGENTSPACE_NORMALMAP)||defined(USE_CLEARCOAT_NORMALMAP))\nvec3 perturbNormal2Arb(vec3 eye_pos,vec3 surf_norm,vec3 mapN,float faceDirection){vec3 q0=vec3(dFdx(eye_pos.x),dFdx(eye_pos.y),dFdx(eye_pos.z));vec3 q1=vec3(dFdy(eye_pos.x),dFdy(eye_pos.y),dFdy(eye_pos.z));vec2 st0=dFdx(vUv.st);vec2 st1=dFdy(vUv.st);vec3 N=surf_norm;vec3 q1perp=cross(q1,N);vec3 q0perp=cross(N,q0);vec3 T=q1perp*st0.x+q0perp*st1.x;vec3 B=q1perp*st0.y+q0perp*st1.y;float det=max(dot(T,T),dot(B,B));float scale=(det==0.0)?0.0:faceDirection*inversesqrt(det);return normalize(T*(mapN.x*scale)+B*(mapN.y*scale)+N*mapN.z);}\n#endif",clearcoat_normal_fragment_begin:"#ifdef USE_CLEARCOAT\nvec3 clearcoatNormal=geometryNormal;\n#endif",clearcoat_normal_fragment_maps:"#ifdef USE_CLEARCOAT_NORMALMAP\nvec3 clearcoatMapN=texture2D(clearcoatNormalMap,vUv).xyz*2.0-1.0;clearcoatMapN.xy*=clearcoatNormalScale;\n#ifdef USE_TANGENT\nclearcoatNormal=normalize(vTBN*clearcoatMapN);\n#else\nclearcoatNormal=perturbNormal2Arb(-vViewPosition,clearcoatNormal,clearcoatMapN,faceDirection);\n#endif\n#endif",clearcoat_pars_fragment:"#ifdef USE_CLEARCOATMAP\nuniform sampler2D clearcoatMap;\n#endif\n#ifdef USE_CLEARCOAT_ROUGHNESSMAP\nuniform sampler2D clearcoatRoughnessMap;\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\nuniform sampler2D clearcoatNormalMap;uniform vec2 clearcoatNormalScale;\n#endif",output_fragment:"#ifdef OPAQUE\ndiffuseColor.a=1.0;\n#endif\n#ifdef USE_TRANSMISSION\ndiffuseColor.a*=transmissionAlpha+0.1;\n#endif\ngl_FragColor=vec4(outgoingLight,diffuseColor.a);",packing:"vec3 packNormalToRGB(const in vec3 normal){return normalize(normal)*0.5+0.5;}vec3 unpackRGBToNormal(const in vec3 rgb){return 2.0*rgb.xyz-1.0;}const float PackUpscale=256./255.;const float UnpackDownscale=255./256.;const vec3 PackFactors=vec3(256.*256.*256.,256.*256.,256.);const vec4 UnpackFactors=UnpackDownscale/vec4(PackFactors,1.);const float ShiftRight8=1./256.;vec4 packDepthToRGBA(const in float v){vec4 r=vec4(fract(v*PackFactors),v);r.yzw-=r.xyz*ShiftRight8;return r*PackUpscale;}float unpackRGBAToDepth(const in vec4 v){return dot(v,UnpackFactors);}vec4 pack2HalfToRGBA(vec2 v){vec4 r=vec4(v.x,fract(v.x*255.0),v.y,fract(v.y*255.0));return vec4(r.x-r.y/255.0,r.y,r.z-r.w/255.0,r.w);}vec2 unpackRGBATo2Half(vec4 v){return vec2(v.x+(v.y/255.0),v.z+(v.w/255.0));}float viewZToOrthographicDepth(const in float viewZ,const in float near,const in float far){return(viewZ+near)/(near-far);}float orthographicDepthToViewZ(const in float linearClipZ,const in float near,const in float far){return linearClipZ*(near-far)-near;}float viewZToPerspectiveDepth(const in float viewZ,const in float near,const in float far){return((near+viewZ)*far)/((far-near)*viewZ);}float perspectiveDepthToViewZ(const in float invClipZ,const in float near,const in float far){return(near*far)/((far-near)*invClipZ-far);}",premultiplied_alpha_fragment:"#ifdef PREMULTIPLIED_ALPHA\ngl_FragColor.rgb*=gl_FragColor.a;\n#endif",project_vertex:"vec4 mvPosition=vec4(transformed,1.0);\n#ifdef USE_INSTANCING\nmvPosition=instanceMatrix*mvPosition;\n#endif\nmvPosition=modelViewMatrix*mvPosition;gl_Position=projectionMatrix*mvPosition;",dithering_fragment:"#ifdef DITHERING\ngl_FragColor.rgb=dithering(gl_FragColor.rgb);\n#endif",dithering_pars_fragment:"#ifdef DITHERING\nvec3 dithering(vec3 color){float grid_position=rand(gl_FragCoord.xy);vec3 dither_shift_RGB=vec3(0.25/255.0,-0.25/255.0,0.25/255.0);dither_shift_RGB=mix(2.0*dither_shift_RGB,-2.0*dither_shift_RGB,grid_position);return color+dither_shift_RGB;}\n#endif",roughnessmap_fragment:"float roughnessFactor=roughness;\n#ifdef USE_ROUGHNESSMAP\nvec4 texelRoughness=texture2D(roughnessMap,vUv);roughnessFactor*=texelRoughness.g;\n#endif",roughnessmap_pars_fragment:"#ifdef USE_ROUGHNESSMAP\nuniform sampler2D roughnessMap;\n#endif",shadowmap_pars_fragment:"#ifdef USE_SHADOWMAP\n#if NUM_DIR_LIGHT_SHADOWS>0\nuniform sampler2D directionalShadowMap[NUM_DIR_LIGHT_SHADOWS];varying vec4 vDirectionalShadowCoord[NUM_DIR_LIGHT_SHADOWS];struct DirectionalLightShadow{float shadowBias;float shadowNormalBias;float shadowRadius;vec2 shadowMapSize;};uniform DirectionalLightShadow directionalLightShadows[NUM_DIR_LIGHT_SHADOWS];\n#endif\n#if NUM_SPOT_LIGHT_SHADOWS>0\nuniform sampler2D spotShadowMap[NUM_SPOT_LIGHT_SHADOWS];varying vec4 vSpotShadowCoord[NUM_SPOT_LIGHT_SHADOWS];struct SpotLightShadow{float shadowBias;float shadowNormalBias;float shadowRadius;vec2 shadowMapSize;};uniform SpotLightShadow spotLightShadows[NUM_SPOT_LIGHT_SHADOWS];\n#endif\n#if NUM_POINT_LIGHT_SHADOWS>0\nuniform sampler2D pointShadowMap[NUM_POINT_LIGHT_SHADOWS];varying vec4 vPointShadowCoord[NUM_POINT_LIGHT_SHADOWS];struct PointLightShadow{float shadowBias;float shadowNormalBias;float shadowRadius;vec2 shadowMapSize;float shadowCameraNear;float shadowCameraFar;};uniform PointLightShadow pointLightShadows[NUM_POINT_LIGHT_SHADOWS];\n#endif\nfloat texture2DCompare(sampler2D depths,vec2 uv,float compare){return step(compare,unpackRGBAToDepth(texture2D(depths,uv)));}vec2 texture2DDistribution(sampler2D shadow,vec2 uv){return unpackRGBATo2Half(texture2D(shadow,uv));}float VSMShadow(sampler2D shadow,vec2 uv,float compare){float occlusion=1.0;vec2 distribution=texture2DDistribution(shadow,uv);float hard_shadow=step(compare,distribution.x);if(hard_shadow!=1.0){float distance=compare-distribution.x;float variance=max(0.00000,distribution.y*distribution.y);float softness_probability=variance/(variance+distance*distance);softness_probability=clamp((softness_probability-0.3)/(0.95-0.3),0.0,1.0);occlusion=clamp(max(hard_shadow,softness_probability),0.0,1.0);}return occlusion;}float getShadow(sampler2D shadowMap,vec2 shadowMapSize,float shadowBias,float shadowRadius,vec4 shadowCoord){float shadow=1.0;shadowCoord.xyz/=shadowCoord.w;shadowCoord.z+=shadowBias;bvec4 inFrustumVec=bvec4(shadowCoord.x>=0.0,shadowCoord.x<=1.0,shadowCoord.y>=0.0,shadowCoord.y<=1.0);bool inFrustum=all(inFrustumVec);bvec2 frustumTestVec=bvec2(inFrustum,shadowCoord.z<=1.0);bool frustumTest=all(frustumTestVec);if(frustumTest){\n#if defined(SHADOWMAP_TYPE_PCF)\nvec2 texelSize=vec2(1.0)/shadowMapSize;float dx0=-texelSize.x*shadowRadius;float dy0=-texelSize.y*shadowRadius;float dx1=+texelSize.x*shadowRadius;float dy1=+texelSize.y*shadowRadius;float dx2=dx0/2.0;float dy2=dy0/2.0;float dx3=dx1/2.0;float dy3=dy1/2.0;shadow=(texture2DCompare(shadowMap,shadowCoord.xy+vec2(dx0,dy0),shadowCoord.z)+texture2DCompare(shadowMap,shadowCoord.xy+vec2(0.0,dy0),shadowCoord.z)+texture2DCompare(shadowMap,shadowCoord.xy+vec2(dx1,dy0),shadowCoord.z)+texture2DCompare(shadowMap,shadowCoord.xy+vec2(dx2,dy2),shadowCoord.z)+texture2DCompare(shadowMap,shadowCoord.xy+vec2(0.0,dy2),shadowCoord.z)+texture2DCompare(shadowMap,shadowCoord.xy+vec2(dx3,dy2),shadowCoord.z)+texture2DCompare(shadowMap,shadowCoord.xy+vec2(dx0,0.0),shadowCoord.z)+texture2DCompare(shadowMap,shadowCoord.xy+vec2(dx2,0.0),shadowCoord.z)+texture2DCompare(shadowMap,shadowCoord.xy,shadowCoord.z)+texture2DCompare(shadowMap,shadowCoord.xy+vec2(dx3,0.0),shadowCoord.z)+texture2DCompare(shadowMap,shadowCoord.xy+vec2(dx1,0.0),shadowCoord.z)+texture2DCompare(shadowMap,shadowCoord.xy+vec2(dx2,dy3),shadowCoord.z)+texture2DCompare(shadowMap,shadowCoord.xy+vec2(0.0,dy3),shadowCoord.z)+texture2DCompare(shadowMap,shadowCoord.xy+vec2(dx3,dy3),shadowCoord.z)+texture2DCompare(shadowMap,shadowCoord.xy+vec2(dx0,dy1),shadowCoord.z)+texture2DCompare(shadowMap,shadowCoord.xy+vec2(0.0,dy1),shadowCoord.z)+texture2DCompare(shadowMap,shadowCoord.xy+vec2(dx1,dy1),shadowCoord.z))*(1.0/17.0);\n#elif defined(SHADOWMAP_TYPE_PCF_SOFT)\nvec2 texelSize=vec2(1.0)/shadowMapSize;float dx=texelSize.x;float dy=texelSize.y;vec2 uv=shadowCoord.xy;vec2 f=fract(uv*shadowMapSize+0.5);uv-=f*texelSize;shadow=(texture2DCompare(shadowMap,uv,shadowCoord.z)+texture2DCompare(shadowMap,uv+vec2(dx,0.0),shadowCoord.z)+texture2DCompare(shadowMap,uv+vec2(0.0,dy),shadowCoord.z)+texture2DCompare(shadowMap,uv+texelSize,shadowCoord.z)+mix(texture2DCompare(shadowMap,uv+vec2(-dx,0.0),shadowCoord.z),texture2DCompare(shadowMap,uv+vec2(2.0*dx,0.0),shadowCoord.z),f.x)+mix(texture2DCompare(shadowMap,uv+vec2(-dx,dy),shadowCoord.z),texture2DCompare(shadowMap,uv+vec2(2.0*dx,dy),shadowCoord.z),f.x)+mix(texture2DCompare(shadowMap,uv+vec2(0.0,-dy),shadowCoord.z),texture2DCompare(shadowMap,uv+vec2(0.0,2.0*dy),shadowCoord.z),f.y)+mix(texture2DCompare(shadowMap,uv+vec2(dx,-dy),shadowCoord.z),texture2DCompare(shadowMap,uv+vec2(dx,2.0*dy),shadowCoord.z),f.y)+mix(mix(texture2DCompare(shadowMap,uv+vec2(-dx,-dy),shadowCoord.z),texture2DCompare(shadowMap,uv+vec2(2.0*dx,-dy),shadowCoord.z),f.x),mix(texture2DCompare(shadowMap,uv+vec2(-dx,2.0*dy),shadowCoord.z),texture2DCompare(shadowMap,uv+vec2(2.0*dx,2.0*dy),shadowCoord.z),f.x),f.y))*(1.0/9.0);\n#elif defined(SHADOWMAP_TYPE_VSM)\nshadow=VSMShadow(shadowMap,shadowCoord.xy,shadowCoord.z);\n#else\nshadow=texture2DCompare(shadowMap,shadowCoord.xy,shadowCoord.z);\n#endif\n}return shadow;}vec2 cubeToUV(vec3 v,float texelSizeY){vec3 absV=abs(v);float scaleToCube=1.0/max(absV.x,max(absV.y,absV.z));absV*=scaleToCube;v*=scaleToCube*(1.0-2.0*texelSizeY);vec2 planar=v.xy;float almostATexel=1.5*texelSizeY;float almostOne=1.0-almostATexel;if(absV.z>=almostOne){if(v.z>0.0)planar.x=4.0-v.x;}else if(absV.x>=almostOne){float signX=sign(v.x);planar.x=v.z*signX+2.0*signX;}else if(absV.y>=almostOne){float signY=sign(v.y);planar.x=v.x+2.0*signY+2.0;planar.y=v.z*signY-2.0;}return vec2(0.125,0.25)*planar+vec2(0.375,0.75);}float getPointShadow(sampler2D shadowMap,vec2 shadowMapSize,float shadowBias,float shadowRadius,vec4 shadowCoord,float shadowCameraNear,float shadowCameraFar){vec2 texelSize=vec2(1.0)/(shadowMapSize*vec2(4.0,2.0));vec3 lightToPosition=shadowCoord.xyz;float dp=(length(lightToPosition)-shadowCameraNear)/(shadowCameraFar-shadowCameraNear);dp+=shadowBias;vec3 bd3D=normalize(lightToPosition);\n#if defined(SHADOWMAP_TYPE_PCF)||defined(SHADOWMAP_TYPE_PCF_SOFT)||defined(SHADOWMAP_TYPE_VSM)\nvec2 offset=vec2(-1,1)*shadowRadius*texelSize.y;return(texture2DCompare(shadowMap,cubeToUV(bd3D+offset.xyy,texelSize.y),dp)+texture2DCompare(shadowMap,cubeToUV(bd3D+offset.yyy,texelSize.y),dp)+texture2DCompare(shadowMap,cubeToUV(bd3D+offset.xyx,texelSize.y),dp)+texture2DCompare(shadowMap,cubeToUV(bd3D+offset.yyx,texelSize.y),dp)+texture2DCompare(shadowMap,cubeToUV(bd3D,texelSize.y),dp)+texture2DCompare(shadowMap,cubeToUV(bd3D+offset.xxy,texelSize.y),dp)+texture2DCompare(shadowMap,cubeToUV(bd3D+offset.yxy,texelSize.y),dp)+texture2DCompare(shadowMap,cubeToUV(bd3D+offset.xxx,texelSize.y),dp)+texture2DCompare(shadowMap,cubeToUV(bd3D+offset.yxx,texelSize.y),dp))*(1.0/9.0);\n#else\nreturn texture2DCompare(shadowMap,cubeToUV(bd3D,texelSize.y),dp);\n#endif\n}\n#endif",shadowmap_pars_vertex:"#ifdef USE_SHADOWMAP\n#if NUM_DIR_LIGHT_SHADOWS>0\nuniform mat4 directionalShadowMatrix[NUM_DIR_LIGHT_SHADOWS];varying vec4 vDirectionalShadowCoord[NUM_DIR_LIGHT_SHADOWS];struct DirectionalLightShadow{float shadowBias;float shadowNormalBias;float shadowRadius;vec2 shadowMapSize;};uniform DirectionalLightShadow directionalLightShadows[NUM_DIR_LIGHT_SHADOWS];\n#endif\n#if NUM_SPOT_LIGHT_SHADOWS>0\nuniform mat4 spotShadowMatrix[NUM_SPOT_LIGHT_SHADOWS];varying vec4 vSpotShadowCoord[NUM_SPOT_LIGHT_SHADOWS];struct SpotLightShadow{float shadowBias;float shadowNormalBias;float shadowRadius;vec2 shadowMapSize;};uniform SpotLightShadow spotLightShadows[NUM_SPOT_LIGHT_SHADOWS];\n#endif\n#if NUM_POINT_LIGHT_SHADOWS>0\nuniform mat4 pointShadowMatrix[NUM_POINT_LIGHT_SHADOWS];varying vec4 vPointShadowCoord[NUM_POINT_LIGHT_SHADOWS];struct PointLightShadow{float shadowBias;float shadowNormalBias;float shadowRadius;vec2 shadowMapSize;float shadowCameraNear;float shadowCameraFar;};uniform PointLightShadow pointLightShadows[NUM_POINT_LIGHT_SHADOWS];\n#endif\n#endif",shadowmap_vertex:"#ifdef USE_SHADOWMAP\n#if NUM_DIR_LIGHT_SHADOWS>0||NUM_SPOT_LIGHT_SHADOWS>0||NUM_POINT_LIGHT_SHADOWS>0\nvec3 shadowWorldNormal=inverseTransformDirection(transformedNormal,viewMatrix);vec4 shadowWorldPosition;\n#endif\n#if NUM_DIR_LIGHT_SHADOWS>0\n#pragma unroll_loop_start\nfor(int i=0;i<NUM_DIR_LIGHT_SHADOWS;i++){shadowWorldPosition=worldPosition+vec4(shadowWorldNormal*directionalLightShadows[i].shadowNormalBias,0);vDirectionalShadowCoord[i]=directionalShadowMatrix[i]*shadowWorldPosition;}\n#pragma unroll_loop_end\n#endif\n#if NUM_SPOT_LIGHT_SHADOWS>0\n#pragma unroll_loop_start\nfor(int i=0;i<NUM_SPOT_LIGHT_SHADOWS;i++){shadowWorldPosition=worldPosition+vec4(shadowWorldNormal*spotLightShadows[i].shadowNormalBias,0);vSpotShadowCoord[i]=spotShadowMatrix[i]*shadowWorldPosition;}\n#pragma unroll_loop_end\n#endif\n#if NUM_POINT_LIGHT_SHADOWS>0\n#pragma unroll_loop_start\nfor(int i=0;i<NUM_POINT_LIGHT_SHADOWS;i++){shadowWorldPosition=worldPosition+vec4(shadowWorldNormal*pointLightShadows[i].shadowNormalBias,0);vPointShadowCoord[i]=pointShadowMatrix[i]*shadowWorldPosition;}\n#pragma unroll_loop_end\n#endif\n#endif",shadowmask_pars_fragment:"float getShadowMask(){float shadow=1.0;\n#ifdef USE_SHADOWMAP\n#if NUM_DIR_LIGHT_SHADOWS>0\nDirectionalLightShadow directionalLight;\n#pragma unroll_loop_start\nfor(int i=0;i<NUM_DIR_LIGHT_SHADOWS;i++){directionalLight=directionalLightShadows[i];shadow*=receiveShadow?getShadow(directionalShadowMap[i],directionalLight.shadowMapSize,directionalLight.shadowBias,directionalLight.shadowRadius,vDirectionalShadowCoord[i]):1.0;}\n#pragma unroll_loop_end\n#endif\n#if NUM_SPOT_LIGHT_SHADOWS>0\nSpotLightShadow spotLight;\n#pragma unroll_loop_start\nfor(int i=0;i<NUM_SPOT_LIGHT_SHADOWS;i++){spotLight=spotLightShadows[i];shadow*=receiveShadow?getShadow(spotShadowMap[i],spotLight.shadowMapSize,spotLight.shadowBias,spotLight.shadowRadius,vSpotShadowCoord[i]):1.0;}\n#pragma unroll_loop_end\n#endif\n#if NUM_POINT_LIGHT_SHADOWS>0\nPointLightShadow pointLight;\n#pragma unroll_loop_start\nfor(int i=0;i<NUM_POINT_LIGHT_SHADOWS;i++){pointLight=pointLightShadows[i];shadow*=receiveShadow?getPointShadow(pointShadowMap[i],pointLight.shadowMapSize,pointLight.shadowBias,pointLight.shadowRadius,vPointShadowCoord[i],pointLight.shadowCameraNear,pointLight.shadowCameraFar):1.0;}\n#pragma unroll_loop_end\n#endif\n#endif\nreturn shadow;}",skinbase_vertex:"#ifdef USE_SKINNING\nmat4 boneMatX=getBoneMatrix(skinIndex.x);mat4 boneMatY=getBoneMatrix(skinIndex.y);mat4 boneMatZ=getBoneMatrix(skinIndex.z);mat4 boneMatW=getBoneMatrix(skinIndex.w);\n#endif",skinning_pars_vertex:"#ifdef USE_SKINNING\nuniform mat4 bindMatrix;uniform mat4 bindMatrixInverse;\n#ifdef BONE_TEXTURE\nuniform highp sampler2D boneTexture;uniform int boneTextureSize;mat4 getBoneMatrix(const in float i){float j=i*4.0;float x=mod(j,float(boneTextureSize));float y=floor(j/float(boneTextureSize));float dx=1.0/float(boneTextureSize);float dy=1.0/float(boneTextureSize);y=dy*(y+0.5);vec4 v1=texture2D(boneTexture,vec2(dx*(x+0.5),y));vec4 v2=texture2D(boneTexture,vec2(dx*(x+1.5),y));vec4 v3=texture2D(boneTexture,vec2(dx*(x+2.5),y));vec4 v4=texture2D(boneTexture,vec2(dx*(x+3.5),y));mat4 bone=mat4(v1,v2,v3,v4);return bone;}\n#else\nuniform mat4 boneMatrices[MAX_BONES];mat4 getBoneMatrix(const in float i){mat4 bone=boneMatrices[int(i)];return bone;}\n#endif\n#endif",skinning_vertex:"#ifdef USE_SKINNING\nvec4 skinVertex=bindMatrix*vec4(transformed,1.0);vec4 skinned=vec4(0.0);skinned+=boneMatX*skinVertex*skinWeight.x;skinned+=boneMatY*skinVertex*skinWeight.y;skinned+=boneMatZ*skinVertex*skinWeight.z;skinned+=boneMatW*skinVertex*skinWeight.w;transformed=(bindMatrixInverse*skinned).xyz;\n#endif",skinnormal_vertex:"#ifdef USE_SKINNING\nmat4 skinMatrix=mat4(0.0);skinMatrix+=skinWeight.x*boneMatX;skinMatrix+=skinWeight.y*boneMatY;skinMatrix+=skinWeight.z*boneMatZ;skinMatrix+=skinWeight.w*boneMatW;skinMatrix=bindMatrixInverse*skinMatrix*bindMatrix;objectNormal=vec4(skinMatrix*vec4(objectNormal,0.0)).xyz;\n#ifdef USE_TANGENT\nobjectTangent=vec4(skinMatrix*vec4(objectTangent,0.0)).xyz;\n#endif\n#endif",specularmap_fragment:"float specularStrength;\n#ifdef USE_SPECULARMAP\nvec4 texelSpecular=texture2D(specularMap,vUv);specularStrength=texelSpecular.r;\n#else\nspecularStrength=1.0;\n#endif",specularmap_pars_fragment:"#ifdef USE_SPECULARMAP\nuniform sampler2D specularMap;\n#endif",tonemapping_fragment:"#if defined(TONE_MAPPING)\ngl_FragColor.rgb=toneMapping(gl_FragColor.rgb);\n#endif",tonemapping_pars_fragment:"#ifndef saturate\n#define saturate(a)clamp(a,0.0,1.0)\n#endif\nuniform float toneMappingExposure;vec3 LinearToneMapping(vec3 color){return toneMappingExposure*color;}vec3 ReinhardToneMapping(vec3 color){color*=toneMappingExposure;return saturate(color/(vec3(1.0)+color));}vec3 OptimizedCineonToneMapping(vec3 color){color*=toneMappingExposure;color=max(vec3(0.0),color-0.004);return pow((color*(6.2*color+0.5))/(color*(6.2*color+1.7)+0.06),vec3(2.2));}vec3 RRTAndODTFit(vec3 v){vec3 a=v*(v+0.0245786)-0.000090537;vec3 b=v*(0.983729*v+0.4329510)+0.238081;return a/b;}vec3 ACESFilmicToneMapping(vec3 color){const mat3 ACESInputMat=mat3(vec3(0.59719,0.07600,0.02840),vec3(0.35458,0.90834,0.13383),vec3(0.04823,0.01566,0.83777));const mat3 ACESOutputMat=mat3(vec3(1.60475,-0.10208,-0.00327),vec3(-0.53108,1.10813,-0.07276),vec3(-0.07367,-0.00605,1.07602));color*=toneMappingExposure/0.6;color=ACESInputMat*color;color=RRTAndODTFit(color);color=ACESOutputMat*color;return saturate(color);}vec3 CustomToneMapping(vec3 color){return color;}",transmission_fragment:"#ifdef USE_TRANSMISSION\nfloat transmissionAlpha=1.0;float transmissionFactor=transmission;float thicknessFactor=thickness;\n#ifdef USE_TRANSMISSIONMAP\ntransmissionFactor*=texture2D(transmissionMap,vUv).r;\n#endif\n#ifdef USE_THICKNESSMAP\nthicknessFactor*=texture2D(thicknessMap,vUv).g;\n#endif\nvec3 pos=vWorldPosition;vec3 v=normalize(cameraPosition-pos);vec3 n=inverseTransformDirection(normal,viewMatrix);vec4 transmission=getIBLVolumeRefraction(n,v,roughnessFactor,material.diffuseColor,material.specularColor,material.specularF90,pos,modelMatrix,viewMatrix,projectionMatrix,ior,thicknessFactor,attenuationTint,attenuationDistance);totalDiffuse=mix(totalDiffuse,transmission.rgb,transmissionFactor);transmissionAlpha=mix(transmissionAlpha,transmission.a,transmissionFactor);\n#endif",transmission_pars_fragment:"#ifdef USE_TRANSMISSION\nuniform float transmission;uniform float thickness;uniform float attenuationDistance;uniform vec3 attenuationTint;\n#ifdef USE_TRANSMISSIONMAP\nuniform sampler2D transmissionMap;\n#endif\n#ifdef USE_THICKNESSMAP\nuniform sampler2D thicknessMap;\n#endif\nuniform vec2 transmissionSamplerSize;uniform sampler2D transmissionSamplerMap;uniform mat4 modelMatrix;uniform mat4 projectionMatrix;varying vec3 vWorldPosition;vec3 getVolumeTransmissionRay(vec3 n,vec3 v,float thickness,float ior,mat4 modelMatrix){vec3 refractionVector=refract(-v,normalize(n),1.0/ior);vec3 modelScale;modelScale.x=length(vec3(modelMatrix[0].xyz));modelScale.y=length(vec3(modelMatrix[1].xyz));modelScale.z=length(vec3(modelMatrix[2].xyz));return normalize(refractionVector)*thickness*modelScale;}float applyIorToRoughness(float roughness,float ior){return roughness*clamp(ior*2.0-2.0,0.0,1.0);}vec4 getTransmissionSample(vec2 fragCoord,float roughness,float ior){float framebufferLod=log2(transmissionSamplerSize.x)*applyIorToRoughness(roughness,ior);\n#ifdef TEXTURE_LOD_EXT\nreturn texture2DLodEXT(transmissionSamplerMap,fragCoord.xy,framebufferLod);\n#else\nreturn texture2D(transmissionSamplerMap,fragCoord.xy,framebufferLod);\n#endif\n}vec3 applyVolumeAttenuation(vec3 radiance,float transmissionDistance,vec3 attenuationColor,float attenuationDistance){if(attenuationDistance==0.0){return radiance;}else{vec3 attenuationCoefficient=-log(attenuationColor)/attenuationDistance;vec3 transmittance=exp(-attenuationCoefficient*transmissionDistance);return transmittance*radiance;}}vec4 getIBLVolumeRefraction(vec3 n,vec3 v,float roughness,vec3 diffuseColor,vec3 specularColor,float specularF90,vec3 position,mat4 modelMatrix,mat4 viewMatrix,mat4 projMatrix,float ior,float thickness,vec3 attenuationColor,float attenuationDistance){vec3 transmissionRay=getVolumeTransmissionRay(n,v,thickness,ior,modelMatrix);vec3 refractedRayExit=position+transmissionRay;vec4 ndcPos=projMatrix*viewMatrix*vec4(refractedRayExit,1.0);vec2 refractionCoords=ndcPos.xy/ndcPos.w;refractionCoords+=1.0;refractionCoords/=2.0;vec4 transmittedLight=getTransmissionSample(refractionCoords,roughness,ior);vec3 attenuatedColor=applyVolumeAttenuation(transmittedLight.rgb,length(transmissionRay),attenuationColor,attenuationDistance);vec3 F=EnvironmentBRDF(n,v,specularColor,specularF90,roughness);return vec4((1.0-F)*attenuatedColor*diffuseColor,transmittedLight.a);}\n#endif",uv_pars_fragment:"#if (defined(USE_UV)&&!defined(UVS_VERTEX_ONLY))\nvarying vec2 vUv;\n#endif",uv_pars_vertex:"#ifdef USE_UV\n#ifdef UVS_VERTEX_ONLY\nvec2 vUv;\n#else\nvarying vec2 vUv;\n#endif\nuniform mat3 uvTransform;\n#endif",uv_vertex:"#ifdef USE_UV\nvUv=(uvTransform*vec3(uv,1)).xy;\n#endif",uv2_pars_fragment:"#if defined(USE_LIGHTMAP)||defined(USE_AOMAP)\nvarying vec2 vUv2;\n#endif",uv2_pars_vertex:"#if defined(USE_LIGHTMAP)||defined(USE_AOMAP)\nattribute vec2 uv2;varying vec2 vUv2;uniform mat3 uv2Transform;\n#endif",uv2_vertex:"#if defined(USE_LIGHTMAP)||defined(USE_AOMAP)\nvUv2=(uv2Transform*vec3(uv2,1)).xy;\n#endif",worldpos_vertex:"#if defined(USE_ENVMAP)||defined(DISTANCE)||defined(USE_SHADOWMAP)||defined(USE_TRANSMISSION)\nvec4 worldPosition=vec4(transformed,1.0);\n#ifdef USE_INSTANCING\nworldPosition=instanceMatrix*worldPosition;\n#endif\nworldPosition=modelMatrix*worldPosition;\n#endif",background_vert:"varying vec2 vUv;uniform mat3 uvTransform;void main(){vUv=(uvTransform*vec3(uv,1)).xy;gl_Position=vec4(position.xy,1.0,1.0);}",background_frag:"uniform sampler2D t2D;varying vec2 vUv;void main(){vec4 texColor=texture2D(t2D,vUv);gl_FragColor=mapTexelToLinear(texColor);\n#include <tonemapping_fragment>\n#include <encodings_fragment>\n}",cube_vert:"varying vec3 vWorldDirection;\n#include <common>\nvoid main(){vWorldDirection=transformDirection(position,modelMatrix);\n#include <begin_vertex>\n#include <project_vertex>\ngl_Position.z=gl_Position.w;}",cube_frag:"#include <envmap_common_pars_fragment>\nuniform float opacity;varying vec3 vWorldDirection;\n#include <cube_uv_reflection_fragment>\nvoid main(){vec3 vReflect=vWorldDirection;\n#include <envmap_fragment>\ngl_FragColor=envColor;gl_FragColor.a*=opacity;\n#include <tonemapping_fragment>\n#include <encodings_fragment>\n}",depth_vert:"#include <common>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvarying vec2 vHighPrecisionZW;void main(){\n#include <uv_vertex>\n#include <skinbase_vertex>\n#ifdef USE_DISPLACEMENTMAP\n#include <beginnormal_vertex>\n#include <morphnormal_vertex>\n#include <skinnormal_vertex>\n#endif\n#include <begin_vertex>\n#include <morphtarget_vertex>\n#include <skinning_vertex>\n#include <displacementmap_vertex>\n#include <project_vertex>\n#include <logdepthbuf_vertex>\n#include <clipping_planes_vertex>\nvHighPrecisionZW=gl_Position.zw;}",depth_frag:"#if DEPTH_PACKING==3200\nuniform float opacity;\n#endif\n#include <common>\n#include <packing>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvarying vec2 vHighPrecisionZW;void main(){\n#include <clipping_planes_fragment>\nvec4 diffuseColor=vec4(1.0);\n#if DEPTH_PACKING==3200\ndiffuseColor.a=opacity;\n#endif\n#include <map_fragment>\n#include <alphamap_fragment>\n#include <alphatest_fragment>\n#include <logdepthbuf_fragment>\nfloat fragCoordZ=0.5*vHighPrecisionZW[0]/vHighPrecisionZW[1]+0.5;\n#if DEPTH_PACKING==3200\ngl_FragColor=vec4(vec3(1.0-fragCoordZ),opacity);\n#elif DEPTH_PACKING==3201\ngl_FragColor=packDepthToRGBA(fragCoordZ);\n#endif\n}",distanceRGBA_vert:"#define DISTANCE\nvarying vec3 vWorldPosition;\n#include <common>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main(){\n#include <uv_vertex>\n#include <skinbase_vertex>\n#ifdef USE_DISPLACEMENTMAP\n#include <beginnormal_vertex>\n#include <morphnormal_vertex>\n#include <skinnormal_vertex>\n#endif\n#include <begin_vertex>\n#include <morphtarget_vertex>\n#include <skinning_vertex>\n#include <displacementmap_vertex>\n#include <project_vertex>\n#include <worldpos_vertex>\n#include <clipping_planes_vertex>\nvWorldPosition=worldPosition.xyz;}",distanceRGBA_frag:"#define DISTANCE\nuniform vec3 referencePosition;uniform float nearDistance;uniform float farDistance;varying vec3 vWorldPosition;\n#include <common>\n#include <packing>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main(){\n#include <clipping_planes_fragment>\nvec4 diffuseColor=vec4(1.0);\n#include <map_fragment>\n#include <alphamap_fragment>\n#include <alphatest_fragment>\nfloat dist=length(vWorldPosition-referencePosition);dist=(dist-nearDistance)/(farDistance-nearDistance);dist=saturate(dist);gl_FragColor=packDepthToRGBA(dist);}",equirect_vert:"varying vec3 vWorldDirection;\n#include <common>\nvoid main(){vWorldDirection=transformDirection(position,modelMatrix);\n#include <begin_vertex>\n#include <project_vertex>\n}",equirect_frag:"uniform sampler2D tEquirect;varying vec3 vWorldDirection;\n#include <common>\nvoid main(){vec3 direction=normalize(vWorldDirection);vec2 sampleUV=equirectUv(direction);vec4 texColor=texture2D(tEquirect,sampleUV);gl_FragColor=mapTexelToLinear(texColor);\n#include <tonemapping_fragment>\n#include <encodings_fragment>\n}",linedashed_vert:"uniform float scale;attribute float lineDistance;varying float vLineDistance;\n#include <common>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main(){vLineDistance=scale*lineDistance;\n#include <color_vertex>\n#include <begin_vertex>\n#include <morphtarget_vertex>\n#include <project_vertex>\n#include <logdepthbuf_vertex>\n#include <clipping_planes_vertex>\n#include <fog_vertex>\n}",linedashed_frag:"uniform vec3 diffuse;uniform float opacity;uniform float dashSize;uniform float totalSize;varying float vLineDistance;\n#include <common>\n#include <color_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main(){\n#include <clipping_planes_fragment>\nif(mod(vLineDistance,totalSize)>dashSize){discard;}vec3 outgoingLight=vec3(0.0);vec4 diffuseColor=vec4(diffuse,opacity);\n#include <logdepthbuf_fragment>\n#include <color_fragment>\noutgoingLight=diffuseColor.rgb;\n#include <output_fragment>\n#include <tonemapping_fragment>\n#include <encodings_fragment>\n#include <fog_fragment>\n#include <premultiplied_alpha_fragment>\n}",meshbasic_vert:"#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main(){\n#include <uv_vertex>\n#include <uv2_vertex>\n#include <color_vertex>\n#if defined(USE_ENVMAP)||defined(USE_SKINNING)\n#include <beginnormal_vertex>\n#include <morphnormal_vertex>\n#include <skinbase_vertex>\n#include <skinnormal_vertex>\n#include <defaultnormal_vertex>\n#endif\n#include <begin_vertex>\n#include <morphtarget_vertex>\n#include <skinning_vertex>\n#include <project_vertex>\n#include <logdepthbuf_vertex>\n#include <clipping_planes_vertex>\n#include <worldpos_vertex>\n#include <envmap_vertex>\n#include <fog_vertex>\n}",meshbasic_frag:"uniform vec3 diffuse;uniform float opacity;\n#ifndef FLAT_SHADED\nvarying vec3 vNormal;\n#endif\n#include <common>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_pars_fragment>\n#include <cube_uv_reflection_fragment>\n#include <fog_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main(){\n#include <clipping_planes_fragment>\nvec4 diffuseColor=vec4(diffuse,opacity);\n#include <logdepthbuf_fragment>\n#include <map_fragment>\n#include <color_fragment>\n#include <alphamap_fragment>\n#include <alphatest_fragment>\n#include <specularmap_fragment>\nReflectedLight reflectedLight=ReflectedLight(vec3(0.0),vec3(0.0),vec3(0.0),vec3(0.0));\n#ifdef USE_LIGHTMAP\nvec4 lightMapTexel=texture2D(lightMap,vUv2);reflectedLight.indirectDiffuse+=lightMapTexelToLinear(lightMapTexel).rgb*lightMapIntensity;\n#else\nreflectedLight.indirectDiffuse+=vec3(1.0);\n#endif\n#include <aomap_fragment>\nreflectedLight.indirectDiffuse*=diffuseColor.rgb;vec3 outgoingLight=reflectedLight.indirectDiffuse;\n#include <envmap_fragment>\n#include <output_fragment>\n#include <tonemapping_fragment>\n#include <encodings_fragment>\n#include <fog_fragment>\n#include <premultiplied_alpha_fragment>\n#include <dithering_fragment>\n}",meshlambert_vert:"#define LAMBERT\nvarying vec3 vLightFront;varying vec3 vIndirectFront;\n#ifdef DOUBLE_SIDED\nvarying vec3 vLightBack;varying vec3 vIndirectBack;\n#endif\n#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <envmap_pars_vertex>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main(){\n#include <uv_vertex>\n#include <uv2_vertex>\n#include <color_vertex>\n#include <beginnormal_vertex>\n#include <morphnormal_vertex>\n#include <skinbase_vertex>\n#include <skinnormal_vertex>\n#include <defaultnormal_vertex>\n#include <begin_vertex>\n#include <morphtarget_vertex>\n#include <skinning_vertex>\n#include <project_vertex>\n#include <logdepthbuf_vertex>\n#include <clipping_planes_vertex>\n#include <worldpos_vertex>\n#include <envmap_vertex>\n#include <lights_lambert_vertex>\n#include <shadowmap_vertex>\n#include <fog_vertex>\n}",meshlambert_frag:"uniform vec3 diffuse;uniform vec3 emissive;uniform float opacity;varying vec3 vLightFront;varying vec3 vIndirectFront;\n#ifdef DOUBLE_SIDED\nvarying vec3 vLightBack;varying vec3 vIndirectBack;\n#endif\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_pars_fragment>\n#include <cube_uv_reflection_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <fog_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <shadowmask_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main(){\n#include <clipping_planes_fragment>\nvec4 diffuseColor=vec4(diffuse,opacity);ReflectedLight reflectedLight=ReflectedLight(vec3(0.0),vec3(0.0),vec3(0.0),vec3(0.0));vec3 totalEmissiveRadiance=emissive;\n#include <logdepthbuf_fragment>\n#include <map_fragment>\n#include <color_fragment>\n#include <alphamap_fragment>\n#include <alphatest_fragment>\n#include <specularmap_fragment>\n#include <emissivemap_fragment>\n#ifdef DOUBLE_SIDED\nreflectedLight.indirectDiffuse+=(gl_FrontFacing)?vIndirectFront:vIndirectBack;\n#else\nreflectedLight.indirectDiffuse+=vIndirectFront;\n#endif\n#include <lightmap_fragment>\nreflectedLight.indirectDiffuse*=BRDF_Lambert(diffuseColor.rgb);\n#ifdef DOUBLE_SIDED\nreflectedLight.directDiffuse=(gl_FrontFacing)?vLightFront:vLightBack;\n#else\nreflectedLight.directDiffuse=vLightFront;\n#endif\nreflectedLight.directDiffuse*=BRDF_Lambert(diffuseColor.rgb)*getShadowMask();\n#include <aomap_fragment>\nvec3 outgoingLight=reflectedLight.directDiffuse+reflectedLight.indirectDiffuse+totalEmissiveRadiance;\n#include <envmap_fragment>\n#include <output_fragment>\n#include <tonemapping_fragment>\n#include <encodings_fragment>\n#include <fog_fragment>\n#include <premultiplied_alpha_fragment>\n#include <dithering_fragment>\n}",meshmatcap_vert:"#define MATCAP\nvarying vec3 vViewPosition;\n#include <common>\n#include <uv_pars_vertex>\n#include <color_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main(){\n#include <uv_vertex>\n#include <color_vertex>\n#include <beginnormal_vertex>\n#include <morphnormal_vertex>\n#include <skinbase_vertex>\n#include <skinnormal_vertex>\n#include <defaultnormal_vertex>\n#include <normal_vertex>\n#include <begin_vertex>\n#include <morphtarget_vertex>\n#include <skinning_vertex>\n#include <displacementmap_vertex>\n#include <project_vertex>\n#include <logdepthbuf_vertex>\n#include <clipping_planes_vertex>\n#include <fog_vertex>\nvViewPosition=-mvPosition.xyz;}",meshmatcap_frag:"#define MATCAP\nuniform vec3 diffuse;uniform float opacity;uniform sampler2D matcap;varying vec3 vViewPosition;\n#include <common>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <fog_pars_fragment>\n#include <normal_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main(){\n#include <clipping_planes_fragment>\nvec4 diffuseColor=vec4(diffuse,opacity);\n#include <logdepthbuf_fragment>\n#include <map_fragment>\n#include <color_fragment>\n#include <alphamap_fragment>\n#include <alphatest_fragment>\n#include <normal_fragment_begin>\n#include <normal_fragment_maps>\nvec3 viewDir=normalize(vViewPosition);vec3 x=normalize(vec3(viewDir.z,0.0,-viewDir.x));vec3 y=cross(viewDir,x);vec2 uv=vec2(dot(x,normal),dot(y,normal))*0.495+0.5;\n#ifdef USE_MATCAP\nvec4 matcapColor=texture2D(matcap,uv);matcapColor=matcapTexelToLinear(matcapColor);\n#else\nvec4 matcapColor=vec4(1.0);\n#endif\nvec3 outgoingLight=diffuseColor.rgb*matcapColor.rgb;\n#include <output_fragment>\n#include <tonemapping_fragment>\n#include <encodings_fragment>\n#include <fog_fragment>\n#include <premultiplied_alpha_fragment>\n#include <dithering_fragment>\n}",meshnormal_vert:"#define NORMAL\n#if defined(FLAT_SHADED)||defined(USE_BUMPMAP)||defined(TANGENTSPACE_NORMALMAP)\nvarying vec3 vViewPosition;\n#endif\n#include <common>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main(){\n#include <uv_vertex>\n#include <beginnormal_vertex>\n#include <morphnormal_vertex>\n#include <skinbase_vertex>\n#include <skinnormal_vertex>\n#include <defaultnormal_vertex>\n#include <normal_vertex>\n#include <begin_vertex>\n#include <morphtarget_vertex>\n#include <skinning_vertex>\n#include <displacementmap_vertex>\n#include <project_vertex>\n#include <logdepthbuf_vertex>\n#include <clipping_planes_vertex>\n#if defined(FLAT_SHADED)||defined(USE_BUMPMAP)||defined(TANGENTSPACE_NORMALMAP)\nvViewPosition=-mvPosition.xyz;\n#endif\n}",meshnormal_frag:"#define NORMAL\nuniform float opacity;\n#if defined(FLAT_SHADED)||defined(USE_BUMPMAP)||defined(TANGENTSPACE_NORMALMAP)\nvarying vec3 vViewPosition;\n#endif\n#include <packing>\n#include <uv_pars_fragment>\n#include <normal_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main(){\n#include <clipping_planes_fragment>\n#include <logdepthbuf_fragment>\n#include <normal_fragment_begin>\n#include <normal_fragment_maps>\ngl_FragColor=vec4(packNormalToRGB(normal),opacity);}",meshphong_vert:"#define PHONG\nvarying vec3 vViewPosition;\n#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main(){\n#include <uv_vertex>\n#include <uv2_vertex>\n#include <color_vertex>\n#include <beginnormal_vertex>\n#include <morphnormal_vertex>\n#include <skinbase_vertex>\n#include <skinnormal_vertex>\n#include <defaultnormal_vertex>\n#include <normal_vertex>\n#include <begin_vertex>\n#include <morphtarget_vertex>\n#include <skinning_vertex>\n#include <displacementmap_vertex>\n#include <project_vertex>\n#include <logdepthbuf_vertex>\n#include <clipping_planes_vertex>\nvViewPosition=-mvPosition.xyz;\n#include <worldpos_vertex>\n#include <envmap_vertex>\n#include <shadowmap_vertex>\n#include <fog_vertex>\n}",meshphong_frag:"#define PHONG\nuniform vec3 diffuse;uniform vec3 emissive;uniform vec3 specular;uniform float shininess;uniform float opacity;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_pars_fragment>\n#include <cube_uv_reflection_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_phong_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main(){\n#include <clipping_planes_fragment>\nvec4 diffuseColor=vec4(diffuse,opacity);ReflectedLight reflectedLight=ReflectedLight(vec3(0.0),vec3(0.0),vec3(0.0),vec3(0.0));vec3 totalEmissiveRadiance=emissive;\n#include <logdepthbuf_fragment>\n#include <map_fragment>\n#include <color_fragment>\n#include <alphamap_fragment>\n#include <alphatest_fragment>\n#include <specularmap_fragment>\n#include <normal_fragment_begin>\n#include <normal_fragment_maps>\n#include <emissivemap_fragment>\n#include <lights_phong_fragment>\n#include <lights_fragment_begin>\n#include <lights_fragment_maps>\n#include <lights_fragment_end>\n#include <aomap_fragment>\nvec3 outgoingLight=reflectedLight.directDiffuse+reflectedLight.indirectDiffuse+reflectedLight.directSpecular+reflectedLight.indirectSpecular+totalEmissiveRadiance;\n#include <envmap_fragment>\n#include <output_fragment>\n#include <tonemapping_fragment>\n#include <encodings_fragment>\n#include <fog_fragment>\n#include <premultiplied_alpha_fragment>\n#include <dithering_fragment>\n}",meshphysical_vert:"#define STANDARD\nvarying vec3 vViewPosition;\n#ifdef USE_TRANSMISSION\nvarying vec3 vWorldPosition;\n#endif\n#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main(){\n#include <uv_vertex>\n#include <uv2_vertex>\n#include <color_vertex>\n#include <beginnormal_vertex>\n#include <morphnormal_vertex>\n#include <skinbase_vertex>\n#include <skinnormal_vertex>\n#include <defaultnormal_vertex>\n#include <normal_vertex>\n#include <begin_vertex>\n#include <morphtarget_vertex>\n#include <skinning_vertex>\n#include <displacementmap_vertex>\n#include <project_vertex>\n#include <logdepthbuf_vertex>\n#include <clipping_planes_vertex>\nvViewPosition=-mvPosition.xyz;\n#include <worldpos_vertex>\n#include <shadowmap_vertex>\n#include <fog_vertex>\n#ifdef USE_TRANSMISSION\nvWorldPosition=worldPosition.xyz;\n#endif\n}",meshphysical_frag:"#define STANDARD\n#ifdef PHYSICAL\n#define IOR\n#define SPECULAR\n#endif\nuniform vec3 diffuse;uniform vec3 emissive;uniform float roughness;uniform float metalness;uniform float opacity;\n#ifdef IOR\nuniform float ior;\n#endif\n#ifdef SPECULAR\nuniform float specularIntensity;uniform vec3 specularTint;\n#ifdef USE_SPECULARINTENSITYMAP\nuniform sampler2D specularIntensityMap;\n#endif\n#ifdef USE_SPECULARTINTMAP\nuniform sampler2D specularTintMap;\n#endif\n#endif\n#ifdef USE_CLEARCOAT\nuniform float clearcoat;uniform float clearcoatRoughness;\n#endif\n#ifdef USE_SHEEN\nuniform vec3 sheenTint;uniform float sheenRoughness;\n#endif\nvarying vec3 vViewPosition;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <bsdfs>\n#include <cube_uv_reflection_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_physical_pars_fragment>\n#include <fog_pars_fragment>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_physical_pars_fragment>\n#include <transmission_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <clearcoat_pars_fragment>\n#include <roughnessmap_pars_fragment>\n#include <metalnessmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main(){\n#include <clipping_planes_fragment>\nvec4 diffuseColor=vec4(diffuse,opacity);ReflectedLight reflectedLight=ReflectedLight(vec3(0.0),vec3(0.0),vec3(0.0),vec3(0.0));vec3 totalEmissiveRadiance=emissive;\n#include <logdepthbuf_fragment>\n#include <map_fragment>\n#include <color_fragment>\n#include <alphamap_fragment>\n#include <alphatest_fragment>\n#include <roughnessmap_fragment>\n#include <metalnessmap_fragment>\n#include <normal_fragment_begin>\n#include <normal_fragment_maps>\n#include <clearcoat_normal_fragment_begin>\n#include <clearcoat_normal_fragment_maps>\n#include <emissivemap_fragment>\n#include <lights_physical_fragment>\n#include <lights_fragment_begin>\n#include <lights_fragment_maps>\n#include <lights_fragment_end>\n#include <aomap_fragment>\nvec3 totalDiffuse=reflectedLight.directDiffuse+reflectedLight.indirectDiffuse;vec3 totalSpecular=reflectedLight.directSpecular+reflectedLight.indirectSpecular;\n#include <transmission_fragment>\nvec3 outgoingLight=totalDiffuse+totalSpecular+totalEmissiveRadiance;\n#ifdef USE_CLEARCOAT\nfloat dotNVcc=saturate(dot(geometry.clearcoatNormal,geometry.viewDir));vec3 Fcc=F_Schlick(material.clearcoatF0,material.clearcoatF90,dotNVcc);outgoingLight=outgoingLight*(1.0-clearcoat*Fcc)+clearcoatSpecular*clearcoat;\n#endif\n#include <output_fragment>\n#include <tonemapping_fragment>\n#include <encodings_fragment>\n#include <fog_fragment>\n#include <premultiplied_alpha_fragment>\n#include <dithering_fragment>\n}",meshtoon_vert:"#define TOON\nvarying vec3 vViewPosition;\n#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main(){\n#include <uv_vertex>\n#include <uv2_vertex>\n#include <color_vertex>\n#include <beginnormal_vertex>\n#include <morphnormal_vertex>\n#include <skinbase_vertex>\n#include <skinnormal_vertex>\n#include <defaultnormal_vertex>\n#include <normal_vertex>\n#include <begin_vertex>\n#include <morphtarget_vertex>\n#include <skinning_vertex>\n#include <displacementmap_vertex>\n#include <project_vertex>\n#include <logdepthbuf_vertex>\n#include <clipping_planes_vertex>\nvViewPosition=-mvPosition.xyz;\n#include <worldpos_vertex>\n#include <shadowmap_vertex>\n#include <fog_vertex>\n}",meshtoon_frag:"#define TOON\nuniform vec3 diffuse;uniform vec3 emissive;uniform float opacity;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <gradientmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_toon_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main(){\n#include <clipping_planes_fragment>\nvec4 diffuseColor=vec4(diffuse,opacity);ReflectedLight reflectedLight=ReflectedLight(vec3(0.0),vec3(0.0),vec3(0.0),vec3(0.0));vec3 totalEmissiveRadiance=emissive;\n#include <logdepthbuf_fragment>\n#include <map_fragment>\n#include <color_fragment>\n#include <alphamap_fragment>\n#include <alphatest_fragment>\n#include <normal_fragment_begin>\n#include <normal_fragment_maps>\n#include <emissivemap_fragment>\n#include <lights_toon_fragment>\n#include <lights_fragment_begin>\n#include <lights_fragment_maps>\n#include <lights_fragment_end>\n#include <aomap_fragment>\nvec3 outgoingLight=reflectedLight.directDiffuse+reflectedLight.indirectDiffuse+totalEmissiveRadiance;\n#include <output_fragment>\n#include <tonemapping_fragment>\n#include <encodings_fragment>\n#include <fog_fragment>\n#include <premultiplied_alpha_fragment>\n#include <dithering_fragment>\n}",points_vert:"uniform float size;uniform float scale;\n#include <common>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main(){\n#include <color_vertex>\n#include <begin_vertex>\n#include <morphtarget_vertex>\n#include <project_vertex>\ngl_PointSize=size;\n#ifdef USE_SIZEATTENUATION\nbool isPerspective=isPerspectiveMatrix(projectionMatrix);if(isPerspective)gl_PointSize*=(scale/-mvPosition.z);\n#endif\n#include <logdepthbuf_vertex>\n#include <clipping_planes_vertex>\n#include <worldpos_vertex>\n#include <fog_vertex>\n}",points_frag:"uniform vec3 diffuse;uniform float opacity;\n#include <common>\n#include <color_pars_fragment>\n#include <map_particle_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main(){\n#include <clipping_planes_fragment>\nvec3 outgoingLight=vec3(0.0);vec4 diffuseColor=vec4(diffuse,opacity);\n#include <logdepthbuf_fragment>\n#include <map_particle_fragment>\n#include <color_fragment>\n#include <alphatest_fragment>\noutgoingLight=diffuseColor.rgb;\n#include <output_fragment>\n#include <tonemapping_fragment>\n#include <encodings_fragment>\n#include <fog_fragment>\n#include <premultiplied_alpha_fragment>\n}",shadow_vert:"#include <common>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\nvoid main(){\n#include <beginnormal_vertex>\n#include <morphnormal_vertex>\n#include <skinbase_vertex>\n#include <skinnormal_vertex>\n#include <defaultnormal_vertex>\n#include <begin_vertex>\n#include <morphtarget_vertex>\n#include <skinning_vertex>\n#include <project_vertex>\n#include <worldpos_vertex>\n#include <shadowmap_vertex>\n#include <fog_vertex>\n}",shadow_frag:"uniform vec3 color;uniform float opacity;\n#include <common>\n#include <packing>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <shadowmap_pars_fragment>\n#include <shadowmask_pars_fragment>\nvoid main(){gl_FragColor=vec4(color,opacity*(1.0-getShadowMask()));\n#include <tonemapping_fragment>\n#include <encodings_fragment>\n#include <fog_fragment>\n}",sprite_vert:"uniform float rotation;uniform vec2 center;\n#include <common>\n#include <uv_pars_vertex>\n#include <fog_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main(){\n#include <uv_vertex>\nvec4 mvPosition=modelViewMatrix*vec4(0.0,0.0,0.0,1.0);vec2 scale;scale.x=length(vec3(modelMatrix[0].x,modelMatrix[0].y,modelMatrix[0].z));scale.y=length(vec3(modelMatrix[1].x,modelMatrix[1].y,modelMatrix[1].z));\n#ifndef USE_SIZEATTENUATION\nbool isPerspective=isPerspectiveMatrix(projectionMatrix);if(isPerspective)scale*=-mvPosition.z;\n#endif\nvec2 alignedPosition=(position.xy-(center-vec2(0.5)))*scale;vec2 rotatedPosition;rotatedPosition.x=cos(rotation)*alignedPosition.x-sin(rotation)*alignedPosition.y;rotatedPosition.y=sin(rotation)*alignedPosition.x+cos(rotation)*alignedPosition.y;mvPosition.xy+=rotatedPosition;gl_Position=projectionMatrix*mvPosition;\n#include <logdepthbuf_vertex>\n#include <clipping_planes_vertex>\n#include <fog_vertex>\n}",sprite_frag:"uniform vec3 diffuse;uniform float opacity;\n#include <common>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main(){\n#include <clipping_planes_fragment>\nvec3 outgoingLight=vec3(0.0);vec4 diffuseColor=vec4(diffuse,opacity);\n#include <logdepthbuf_fragment>\n#include <map_fragment>\n#include <alphamap_fragment>\n#include <alphatest_fragment>\noutgoingLight=diffuseColor.rgb;\n#include <output_fragment>\n#include <tonemapping_fragment>\n#include <encodings_fragment>\n#include <fog_fragment>\n}"},nn={common:{diffuse:{value:new $t(16777215)},opacity:{value:1},map:{value:null},uvTransform:{value:new _e},uv2Transform:{value:new _e},alphaMap:{value:null},alphaTest:{value:0}},specularmap:{specularMap:{value:null}},envmap:{envMap:{value:null},flipEnvMap:{value:-1},reflectivity:{value:1},ior:{value:1.5},refractionRatio:{value:.98},maxMipLevel:{value:0}},aomap:{aoMap:{value:null},aoMapIntensity:{value:1}},lightmap:{lightMap:{value:null},lightMapIntensity:{value:1}},emissivemap:{emissiveMap:{value:null}},bumpmap:{bumpMap:{value:null},bumpScale:{value:1}},normalmap:{normalMap:{value:null},normalScale:{value:new xe(1,1)}},displacementmap:{displacementMap:{value:null},displacementScale:{value:1},displacementBias:{value:0}},roughnessmap:{roughnessMap:{value:null}},metalnessmap:{metalnessMap:{value:null}},gradientmap:{gradientMap:{value:null}},fog:{fogDensity:{value:25e-5},fogNear:{value:1},fogFar:{value:2e3},fogColor:{value:new $t(16777215)}},lights:{ambientLightColor:{value:[]},lightProbe:{value:[]},directionalLights:{value:[],properties:{direction:{},color:{}}},directionalLightShadows:{value:[],properties:{shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{}}},directionalShadowMap:{value:[]},directionalShadowMatrix:{value:[]},spotLights:{value:[],properties:{color:{},position:{},direction:{},distance:{},coneCos:{},penumbraCos:{},decay:{}}},spotLightShadows:{value:[],properties:{shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{}}},spotShadowMap:{value:[]},spotShadowMatrix:{value:[]},pointLights:{value:[],properties:{color:{},position:{},decay:{},distance:{}}},pointLightShadows:{value:[],properties:{shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{},shadowCameraNear:{},shadowCameraFar:{}}},pointShadowMap:{value:[]},pointShadowMatrix:{value:[]},hemisphereLights:{value:[],properties:{direction:{},skyColor:{},groundColor:{}}},rectAreaLights:{value:[],properties:{color:{},position:{},width:{},height:{}}},ltc_1:{value:null},ltc_2:{value:null}},points:{diffuse:{value:new $t(16777215)},opacity:{value:1},size:{value:1},scale:{value:1},map:{value:null},alphaMap:{value:null},alphaTest:{value:0},uvTransform:{value:new _e}},sprite:{diffuse:{value:new $t(16777215)},opacity:{value:1},center:{value:new xe(.5,.5)},rotation:{value:0},map:{value:null},alphaMap:{value:null},alphaTest:{value:0},uvTransform:{value:new _e}}},rn={basic:{uniforms:Fi([nn.common,nn.specularmap,nn.envmap,nn.aomap,nn.lightmap,nn.fog]),vertexShader:tn.meshbasic_vert,fragmentShader:tn.meshbasic_frag},lambert:{uniforms:Fi([nn.common,nn.specularmap,nn.envmap,nn.aomap,nn.lightmap,nn.emissivemap,nn.fog,nn.lights,{emissive:{value:new $t(0)}}]),vertexShader:tn.meshlambert_vert,fragmentShader:tn.meshlambert_frag},phong:{uniforms:Fi([nn.common,nn.specularmap,nn.envmap,nn.aomap,nn.lightmap,nn.emissivemap,nn.bumpmap,nn.normalmap,nn.displacementmap,nn.fog,nn.lights,{emissive:{value:new $t(0)},specular:{value:new $t(1118481)},shininess:{value:30}}]),vertexShader:tn.meshphong_vert,fragmentShader:tn.meshphong_frag},standard:{uniforms:Fi([nn.common,nn.envmap,nn.aomap,nn.lightmap,nn.emissivemap,nn.bumpmap,nn.normalmap,nn.displacementmap,nn.roughnessmap,nn.metalnessmap,nn.fog,nn.lights,{emissive:{value:new $t(0)},roughness:{value:1},metalness:{value:0},envMapIntensity:{value:1}}]),vertexShader:tn.meshphysical_vert,fragmentShader:tn.meshphysical_frag},toon:{uniforms:Fi([nn.common,nn.aomap,nn.lightmap,nn.emissivemap,nn.bumpmap,nn.normalmap,nn.displacementmap,nn.gradientmap,nn.fog,nn.lights,{emissive:{value:new $t(0)}}]),vertexShader:tn.meshtoon_vert,fragmentShader:tn.meshtoon_frag},matcap:{uniforms:Fi([nn.common,nn.bumpmap,nn.normalmap,nn.displacementmap,nn.fog,{matcap:{value:null}}]),vertexShader:tn.meshmatcap_vert,fragmentShader:tn.meshmatcap_frag},points:{uniforms:Fi([nn.points,nn.fog]),vertexShader:tn.points_vert,fragmentShader:tn.points_frag},dashed:{uniforms:Fi([nn.common,nn.fog,{scale:{value:1},dashSize:{value:1},totalSize:{value:2}}]),vertexShader:tn.linedashed_vert,fragmentShader:tn.linedashed_frag},depth:{uniforms:Fi([nn.common,nn.displacementmap]),vertexShader:tn.depth_vert,fragmentShader:tn.depth_frag},normal:{uniforms:Fi([nn.common,nn.bumpmap,nn.normalmap,nn.displacementmap,{opacity:{value:1}}]),vertexShader:tn.meshnormal_vert,fragmentShader:tn.meshnormal_frag},sprite:{uniforms:Fi([nn.sprite,nn.fog]),vertexShader:tn.sprite_vert,fragmentShader:tn.sprite_frag},background:{uniforms:{uvTransform:{value:new _e},t2D:{value:null}},vertexShader:tn.background_vert,fragmentShader:tn.background_frag},cube:{uniforms:Fi([nn.envmap,{opacity:{value:1}}]),vertexShader:tn.cube_vert,fragmentShader:tn.cube_frag},equirect:{uniforms:{tEquirect:{value:null}},vertexShader:tn.equirect_vert,fragmentShader:tn.equirect_frag},distanceRGBA:{uniforms:Fi([nn.common,nn.displacementmap,{referencePosition:{value:new De},nearDistance:{value:1},farDistance:{value:1e3}}]),vertexShader:tn.distanceRGBA_vert,fragmentShader:tn.distanceRGBA_frag},shadow:{uniforms:Fi([nn.lights,nn.fog,{color:{value:new $t(0)},opacity:{value:1}}]),vertexShader:tn.shadow_vert,fragmentShader:tn.shadow_frag}};function sn(e,t,i,n,r){const s=new $t(0);let a,o,l=0,c=null,u=0,h=null;function d(e,t){i.buffers.color.setClear(e.r,e.g,e.b,t,r)}return{getClearColor:function(){return s},setClearColor:function(e,t=1){s.set(e),l=t,d(s,l)},getClearAlpha:function(){return l},setClearAlpha:function(e){l=e,d(s,l)},render:function(i,r){let p=!1,m=!0===r.isScene?r.background:null;m&&m.isTexture&&(m=t.get(m));const f=e.xr,g=f.getSession&&f.getSession();g&&"additive"===g.environmentBlendMode&&(m=null),null===m?d(s,l):m&&m.isColor&&(d(m,1),p=!0),(e.autoClear||p)&&e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil),m&&(m.isCubeTexture||306===m.mapping)?(void 0===o&&(o=new Ri(new Ni(1,1,1),new ki({name:"BackgroundCubeMaterial",uniforms:Oi(rn.cube.uniforms),vertexShader:rn.cube.vertexShader,fragmentShader:rn.cube.fragmentShader,side:1,depthTest:!1,depthWrite:!1,fog:!1})),o.geometry.deleteAttribute("normal"),o.geometry.deleteAttribute("uv"),o.onBeforeRender=function(e,t,i){this.matrixWorld.copyPosition(i.matrixWorld)},Object.defineProperty(o.material,"envMap",{get:function(){return this.uniforms.envMap.value}}),n.update(o)),o.material.uniforms.envMap.value=m,o.material.uniforms.flipEnvMap.value=m.isCubeTexture&&!1===m.isRenderTargetTexture?-1:1,c===m&&u===m.version&&h===e.toneMapping||(o.material.needsUpdate=!0,c=m,u=m.version,h=e.toneMapping),i.unshift(o,o.geometry,o.material,0,0,null)):m&&m.isTexture&&(void 0===a&&(a=new Ri(new en(2,2),new ki({name:"BackgroundMaterial",uniforms:Oi(rn.background.uniforms),vertexShader:rn.background.vertexShader,fragmentShader:rn.background.fragmentShader,side:0,depthTest:!1,depthWrite:!1,fog:!1})),a.geometry.deleteAttribute("normal"),Object.defineProperty(a.material,"map",{get:function(){return this.uniforms.t2D.value}}),n.update(a)),a.material.uniforms.t2D.value=m,!0===m.matrixAutoUpdate&&m.updateMatrix(),a.material.uniforms.uvTransform.value.copy(m.matrix),c===m&&u===m.version&&h===e.toneMapping||(a.material.needsUpdate=!0,c=m,u=m.version,h=e.toneMapping),i.unshift(a,a.geometry,a.material,0,0,null))}}}function an(e,t,i,n){const r=e.getParameter(34921),s=n.isWebGL2?null:t.get("OES_vertex_array_object"),a=n.isWebGL2||null!==s,o={},l=d(null);let c=l;function u(t){return n.isWebGL2?e.bindVertexArray(t):s.bindVertexArrayOES(t)}function h(t){return n.isWebGL2?e.deleteVertexArray(t):s.deleteVertexArrayOES(t)}function d(e){const t=[],i=[],n=[];for(let s=0;s<r;s++)t[s]=0,i[s]=0,n[s]=0;return{geometry:null,program:null,wireframe:!1,newAttributes:t,enabledAttributes:i,attributeDivisors:n,object:e,attributes:{},index:null}}function p(){const e=c.newAttributes;for(let t=0,i=e.length;t<i;t++)e[t]=0}function m(e){f(e,0)}function f(i,r){const s=c.newAttributes,a=c.enabledAttributes,o=c.attributeDivisors;if(s[i]=1,0===a[i]&&(e.enableVertexAttribArray(i),a[i]=1),o[i]!==r){(n.isWebGL2?e:t.get("ANGLE_instanced_arrays"))[n.isWebGL2?"vertexAttribDivisor":"vertexAttribDivisorANGLE"](i,r),o[i]=r}}function g(){const t=c.newAttributes,i=c.enabledAttributes;for(let n=0,r=i.length;n<r;n++)i[n]!==t[n]&&(e.disableVertexAttribArray(n),i[n]=0)}function v(t,i,r,s,a,o){!0!==n.isWebGL2||5124!==r&&5125!==r?e.vertexAttribPointer(t,i,r,s,a,o):e.vertexAttribIPointer(t,i,r,a,o)}function y(){x(),c!==l&&(c=l,u(c.object))}function x(){l.geometry=null,l.program=null,l.wireframe=!1}return{setup:function(r,l,h,y,x){let _=!1;if(a){const t=function(t,i,r){const a=!0===r.wireframe;let l=o[t.id];void 0===l&&(l={},o[t.id]=l);let c=l[i.id];void 0===c&&(c={},l[i.id]=c);let u=c[a];void 0===u&&(u=d(n.isWebGL2?e.createVertexArray():s.createVertexArrayOES()),c[a]=u);return u}(y,h,l);c!==t&&(c=t,u(c.object)),_=function(e,t){const i=c.attributes,n=e.attributes;let r=0;for(const s in n){const e=i[s],t=n[s];if(void 0===e)return!0;if(e.attribute!==t)return!0;if(e.data!==t.data)return!0;r++}return c.attributesNum!==r||c.index!==t}(y,x),_&&function(e,t){const i={},n=e.attributes;let r=0;for(const s in n){const e=n[s],t={};t.attribute=e,e.data&&(t.data=e.data),i[s]=t,r++}c.attributes=i,c.attributesNum=r,c.index=t}(y,x)}else{const e=!0===l.wireframe;c.geometry===y.id&&c.program===h.id&&c.wireframe===e||(c.geometry=y.id,c.program=h.id,c.wireframe=e,_=!0)}!0===r.isInstancedMesh&&(_=!0),null!==x&&i.update(x,34963),_&&(!function(r,s,a,o){if(!1===n.isWebGL2&&(r.isInstancedMesh||o.isInstancedBufferGeometry)&&null===t.get("ANGLE_instanced_arrays"))return;p();const l=o.attributes,c=a.getAttributes(),u=s.defaultAttributeValues;for(const t in c){const n=c[t];if(n.location>=0){let s=l[t];if(void 0===s&&("instanceMatrix"===t&&r.instanceMatrix&&(s=r.instanceMatrix),"instanceColor"===t&&r.instanceColor&&(s=r.instanceColor)),void 0!==s){const t=s.normalized,a=s.itemSize,l=i.get(s);if(void 0===l)continue;const c=l.buffer,u=l.type,h=l.bytesPerElement;if(s.isInterleavedBufferAttribute){const i=s.data,l=i.stride,d=s.offset;if(i&&i.isInstancedInterleavedBuffer){for(let e=0;e<n.locationSize;e++)f(n.location+e,i.meshPerAttribute);!0!==r.isInstancedMesh&&void 0===o._maxInstanceCount&&(o._maxInstanceCount=i.meshPerAttribute*i.count)}else for(let e=0;e<n.locationSize;e++)m(n.location+e);e.bindBuffer(34962,c);for(let e=0;e<n.locationSize;e++)v(n.location+e,a/n.locationSize,u,t,l*h,(d+a/n.locationSize*e)*h)}else{if(s.isInstancedBufferAttribute){for(let e=0;e<n.locationSize;e++)f(n.location+e,s.meshPerAttribute);!0!==r.isInstancedMesh&&void 0===o._maxInstanceCount&&(o._maxInstanceCount=s.meshPerAttribute*s.count)}else for(let e=0;e<n.locationSize;e++)m(n.location+e);e.bindBuffer(34962,c);for(let e=0;e<n.locationSize;e++)v(n.location+e,a/n.locationSize,u,t,a*h,a/n.locationSize*e*h)}}else if(void 0!==u){const i=u[t];if(void 0!==i)switch(i.length){case 2:e.vertexAttrib2fv(n.location,i);break;case 3:e.vertexAttrib3fv(n.location,i);break;case 4:e.vertexAttrib4fv(n.location,i);break;default:e.vertexAttrib1fv(n.location,i)}}}}g()}(r,l,h,y),null!==x&&e.bindBuffer(34963,i.get(x).buffer))},reset:y,resetDefaultState:x,dispose:function(){y();for(const e in o){const t=o[e];for(const e in t){const i=t[e];for(const e in i)h(i[e].object),delete i[e];delete t[e]}delete o[e]}},releaseStatesOfGeometry:function(e){if(void 0===o[e.id])return;const t=o[e.id];for(const i in t){const e=t[i];for(const t in e)h(e[t].object),delete e[t];delete t[i]}delete o[e.id]},releaseStatesOfProgram:function(e){for(const t in o){const i=o[t];if(void 0===i[e.id])continue;const n=i[e.id];for(const e in n)h(n[e].object),delete n[e];delete i[e.id]}},initAttributes:p,enableAttribute:m,disableUnusedAttributes:g}}function on(e,t,i,n){const r=n.isWebGL2;let s;this.setMode=function(e){s=e},this.render=function(t,n){e.drawArrays(s,t,n),i.update(n,s,1)},this.renderInstances=function(n,a,o){if(0===o)return;let l,c;if(r)l=e,c="drawArraysInstanced";else if(l=t.get("ANGLE_instanced_arrays"),c="drawArraysInstancedANGLE",null===l)return;l[c](s,n,a,o),i.update(a,s,o)}}function ln(e,t,i){let n;function r(t){if("highp"===t){if(e.getShaderPrecisionFormat(35633,36338).precision>0&&e.getShaderPrecisionFormat(35632,36338).precision>0)return"highp";t="mediump"}return"mediump"===t&&e.getShaderPrecisionFormat(35633,36337).precision>0&&e.getShaderPrecisionFormat(35632,36337).precision>0?"mediump":"lowp"}const s="undefined"!=typeof WebGL2RenderingContext&&e instanceof WebGL2RenderingContext||"undefined"!=typeof WebGL2ComputeRenderingContext&&e instanceof WebGL2ComputeRenderingContext;let a=void 0!==i.precision?i.precision:"highp";const o=r(a);o!==a&&(a=o);const l=s||t.has("WEBGL_draw_buffers"),c=!0===i.logarithmicDepthBuffer,u=e.getParameter(34930),h=e.getParameter(35660),d=e.getParameter(3379),p=e.getParameter(34076),m=e.getParameter(34921),f=e.getParameter(36347),g=e.getParameter(36348),v=e.getParameter(36349),y=h>0,x=s||t.has("OES_texture_float");return{isWebGL2:s,drawBuffers:l,getMaxAnisotropy:function(){if(void 0!==n)return n;if(!0===t.has("EXT_texture_filter_anisotropic")){const i=t.get("EXT_texture_filter_anisotropic");n=e.getParameter(i.MAX_TEXTURE_MAX_ANISOTROPY_EXT)}else n=0;return n},getMaxPrecision:r,precision:a,logarithmicDepthBuffer:c,maxTextures:u,maxVertexTextures:h,maxTextureSize:d,maxCubemapSize:p,maxAttributes:m,maxVertexUniforms:f,maxVaryings:g,maxFragmentUniforms:v,vertexTextures:y,floatFragmentTextures:x,floatVertexTextures:y&&x,maxSamples:s?e.getParameter(36183):0}}function cn(e){const t=this;let i=null,n=0,r=!1,s=!1;const a=new Yi,o=new _e,l={value:null,needsUpdate:!1};function c(){l.value!==i&&(l.value=i,l.needsUpdate=n>0),t.numPlanes=n,t.numIntersection=0}function u(e,i,n,r){const s=null!==e?e.length:0;let c=null;if(0!==s){if(c=l.value,!0!==r||null===c){const t=n+4*s,r=i.matrixWorldInverse;o.getNormalMatrix(r),(null===c||c.length<t)&&(c=new Float32Array(t));for(let i=0,l=n;i!==s;++i,l+=4)a.copy(e[i]).applyMatrix4(r,o),a.normal.toArray(c,l),c[l+3]=a.constant}l.value=c,l.needsUpdate=!0}return t.numPlanes=s,t.numIntersection=0,c}this.uniform=l,this.numPlanes=0,this.numIntersection=0,this.init=function(e,t,s){const a=0!==e.length||t||0!==n||r;return r=t,i=u(e,s,0),n=e.length,a},this.beginShadows=function(){s=!0,u(null)},this.endShadows=function(){s=!1,c()},this.setState=function(t,a,o){const h=t.clippingPlanes,d=t.clipIntersection,p=t.clipShadows,m=e.get(t);if(!r||null===h||0===h.length||s&&!p)s?u(null):c();else{const e=s?0:n,t=4*e;let r=m.clippingState||null;l.value=r,r=u(h,a,t,o);for(let n=0;n!==t;++n)r[n]=i[n];m.clippingState=r,this.numIntersection=d?this.numPlanes:0,this.numPlanes+=e}}}function un(e){let t=new WeakMap;function i(e,t){return 303===t?e.mapping=301:304===t&&(e.mapping=302),e}function n(e){const i=e.target;i.removeEventListener("dispose",n);const r=t.get(i);void 0!==r&&(t.delete(i),r.dispose())}return{get:function(r){if(r&&r.isTexture&&!1===r.isRenderTargetTexture){const s=r.mapping;if(303===s||304===s){if(t.has(r)){return i(t.get(r).texture,r.mapping)}{const s=r.image;if(s&&s.height>0){const a=e.getRenderTarget(),o=new Hi(s.height/2);return o.fromEquirectangularTexture(e,r),t.set(r,o),e.setRenderTarget(a),r.addEventListener("dispose",n),i(o.texture,r.mapping)}return null}}}return r},dispose:function(){t=new WeakMap}}}rn.physical={uniforms:Fi([rn.standard.uniforms,{clearcoat:{value:0},clearcoatMap:{value:null},clearcoatRoughness:{value:0},clearcoatRoughnessMap:{value:null},clearcoatNormalScale:{value:new xe(1,1)},clearcoatNormalMap:{value:null},sheen:{value:0},sheenTint:{value:new $t(0)},sheenRoughness:{value:0},transmission:{value:0},transmissionMap:{value:null},transmissionSamplerSize:{value:new xe},transmissionSamplerMap:{value:null},thickness:{value:0},thicknessMap:{value:null},attenuationDistance:{value:0},attenuationTint:{value:new $t(0)},specularIntensity:{value:0},specularIntensityMap:{value:null},specularTint:{value:new $t(1,1,1)},specularTintMap:{value:null}}]),vertexShader:tn.meshphysical_vert,fragmentShader:tn.meshphysical_frag};class hn extends Bi{constructor(e=-1,t=1,i=1,n=-1,r=.1,s=2e3){super(),this.type="OrthographicCamera",this.zoom=1,this.view=null,this.left=e,this.right=t,this.top=i,this.bottom=n,this.near=r,this.far=s,this.updateProjectionMatrix()}copy(e,t){return super.copy(e,t),this.left=e.left,this.right=e.right,this.top=e.top,this.bottom=e.bottom,this.near=e.near,this.far=e.far,this.zoom=e.zoom,this.view=null===e.view?null:Object.assign({},e.view),this}setViewOffset(e,t,i,n,r,s){null===this.view&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=e,this.view.fullHeight=t,this.view.offsetX=i,this.view.offsetY=n,this.view.width=r,this.view.height=s,this.updateProjectionMatrix()}clearViewOffset(){null!==this.view&&(this.view.enabled=!1),this.updateProjectionMatrix()}updateProjectionMatrix(){const e=(this.right-this.left)/(2*this.zoom),t=(this.top-this.bottom)/(2*this.zoom),i=(this.right+this.left)/2,n=(this.top+this.bottom)/2;let r=i-e,s=i+e,a=n+t,o=n-t;if(null!==this.view&&this.view.enabled){const e=(this.right-this.left)/this.view.fullWidth/this.zoom,t=(this.top-this.bottom)/this.view.fullHeight/this.zoom;r+=e*this.view.offsetX,s=r+e*this.view.width,a-=t*this.view.offsetY,o=a-t*this.view.height}this.projectionMatrix.makeOrthographic(r,s,a,o,this.near,this.far),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()}toJSON(e){const t=super.toJSON(e);return t.object.zoom=this.zoom,t.object.left=this.left,t.object.right=this.right,t.object.top=this.top,t.object.bottom=this.bottom,t.object.near=this.near,t.object.far=this.far,null!==this.view&&(t.object.view=Object.assign({},this.view)),t}}hn.prototype.isOrthographicCamera=!0;class dn extends ki{constructor(e){super(e),this.type="RawShaderMaterial"}}dn.prototype.isRawShaderMaterial=!0;const pn=Math.pow(2,8),mn=[.125,.215,.35,.446,.526,.582],fn=5+mn.length,gn={3e3:0,3001:1,3002:2,3004:3,3005:4,3006:5,3007:6},vn=new hn,{_lodPlanes:yn,_sizeLods:xn,_sigmas:_n}=Ln(),bn=new $t;let wn=null;const Mn=(1+Math.sqrt(5))/2,Sn=1/Mn,Tn=[new De(1,1,1),new De(-1,1,1),new De(1,1,-1),new De(-1,1,-1),new De(0,Mn,Sn),new De(0,Mn,-Sn),new De(Sn,0,Mn),new De(-Sn,0,Mn),new De(Mn,Sn,0),new De(-Mn,Sn,0)];class An{constructor(e){this._renderer=e,this._pingPongRenderTarget=null,this._blurMaterial=function(e){const t=new Float32Array(e),i=new De(0,1,0);return new dn({name:"SphericalGaussianBlur",defines:{n:e},uniforms:{envMap:{value:null},samples:{value:1},weights:{value:t},latitudinal:{value:!1},dTheta:{value:0},mipInt:{value:0},poleAxis:{value:i},inputEncoding:{value:gn[3e3]},outputEncoding:{value:gn[3e3]}},vertexShader:Rn(),fragmentShader:`precision mediump float;precision mediump int;varying vec3 vOutputDirection;uniform sampler2D envMap;uniform int samples;uniform float weights[n];uniform bool latitudinal;uniform float dTheta;uniform float mipInt;uniform vec3 poleAxis;\n${zn()}\n#define ENVMAP_TYPE_CUBE_UV\n#include <cube_uv_reflection_fragment>\nvec3 getSample(float theta,vec3 axis){float cosTheta=cos(theta);vec3 sampleDirection=vOutputDirection*cosTheta+cross(axis,vOutputDirection)*sin(theta)+axis*dot(axis,vOutputDirection)*(1.0-cosTheta);return bilinearCubeUV(envMap,sampleDirection,mipInt);}void main(){vec3 axis=latitudinal?poleAxis:cross(poleAxis,vOutputDirection);if(all(equal(axis,vec3(0.0)))){axis=vec3(vOutputDirection.z,0.0,-vOutputDirection.x);}axis=normalize(axis);gl_FragColor=vec4(0.0,0.0,0.0,1.0);gl_FragColor.rgb+=weights[0]*getSample(0.0,axis);for(int i=1;i<n;i++){if(i>=samples){break;}float theta=dTheta*float(i);gl_FragColor.rgb+=weights[i]*getSample(-1.0*theta,axis);gl_FragColor.rgb+=weights[i]*getSample(theta,axis);}gl_FragColor=linearToOutputTexel(gl_FragColor);}`,blending:0,depthTest:!1,depthWrite:!1})}(20),this._equirectShader=null,this._cubemapShader=null,this._compileMaterial(this._blurMaterial)}fromScene(e,t=0,i=.1,n=100){wn=this._renderer.getRenderTarget();const r=this._allocateTargets();return this._sceneToCubeUV(e,i,n,r),t>0&&this._blur(r,0,0,t),this._applyPMREM(r),this._cleanup(r),r}fromEquirectangular(e){return this._fromTexture(e)}fromCubemap(e){return this._fromTexture(e)}compileCubemapShader(){null===this._cubemapShader&&(this._cubemapShader=In(),this._compileMaterial(this._cubemapShader))}compileEquirectangularShader(){null===this._equirectShader&&(this._equirectShader=Dn(),this._compileMaterial(this._equirectShader))}dispose(){this._blurMaterial.dispose(),null!==this._cubemapShader&&this._cubemapShader.dispose(),null!==this._equirectShader&&this._equirectShader.dispose();for(let e=0;e<yn.length;e++)yn[e].dispose()}_cleanup(e){this._pingPongRenderTarget.dispose(),this._renderer.setRenderTarget(wn),e.scissorTest=!1,En(e,0,0,e.width,e.height)}_fromTexture(e){wn=this._renderer.getRenderTarget();const t=this._allocateTargets(e);return this._textureToCubeUV(e,t),this._applyPMREM(t),this._cleanup(t),t}_allocateTargets(e){const t={magFilter:1003,minFilter:1003,generateMipmaps:!1,type:1009,format:1023,encoding:Cn(e)?e.encoding:3002,depthBuffer:!1},i=Pn(t);return i.depthBuffer=!e,this._pingPongRenderTarget=Pn(t),i}_compileMaterial(e){const t=new Ri(yn[0],e);this._renderer.compile(t,vn)}_sceneToCubeUV(e,t,i,n){const r=new Vi(90,1,t,i),s=[1,-1,1,1,1,1],a=[1,1,1,-1,-1,-1],o=this._renderer,l=o.autoClear,c=o.outputEncoding,u=o.toneMapping;o.getClearColor(bn),o.toneMapping=0,o.outputEncoding=3e3,o.autoClear=!1;const h=new ei({name:"PMREM.Background",side:1,depthWrite:!1,depthTest:!1}),d=new Ri(new Ni,h);let p=!1;const m=e.background;m?m.isColor&&(h.color.copy(m),e.background=null,p=!0):(h.color.copy(bn),p=!0);for(let f=0;f<6;f++){const t=f%3;0==t?(r.up.set(0,s[f],0),r.lookAt(a[f],0,0)):1==t?(r.up.set(0,0,s[f]),r.lookAt(0,a[f],0)):(r.up.set(0,s[f],0),r.lookAt(0,0,a[f])),En(n,t*pn,f>2?pn:0,pn,pn),o.setRenderTarget(n),p&&o.render(d,r),o.render(e,r)}d.geometry.dispose(),d.material.dispose(),o.toneMapping=u,o.outputEncoding=c,o.autoClear=l,e.background=m}_setEncoding(e,t){!0===this._renderer.capabilities.isWebGL2&&1023===t.format&&1009===t.type&&3001===t.encoding?e.value=gn[3e3]:e.value=gn[t.encoding]}_textureToCubeUV(e,t){const i=this._renderer;e.isCubeTexture?null==this._cubemapShader&&(this._cubemapShader=In()):null==this._equirectShader&&(this._equirectShader=Dn());const n=e.isCubeTexture?this._cubemapShader:this._equirectShader,r=new Ri(yn[0],n),s=n.uniforms;s.envMap.value=e,e.isCubeTexture||s.texelSize.value.set(1/e.image.width,1/e.image.height),this._setEncoding(s.inputEncoding,e),this._setEncoding(s.outputEncoding,t.texture),En(t,0,0,3*pn,2*pn),i.setRenderTarget(t),i.render(r,vn)}_applyPMREM(e){const t=this._renderer,i=t.autoClear;t.autoClear=!1;for(let n=1;n<fn;n++){const t=Math.sqrt(_n[n]*_n[n]-_n[n-1]*_n[n-1]),i=Tn[(n-1)%Tn.length];this._blur(e,n-1,n,t,i)}t.autoClear=i}_blur(e,t,i,n,r){const s=this._pingPongRenderTarget;this._halfBlur(e,s,t,i,n,"latitudinal",r),this._halfBlur(s,e,i,i,n,"longitudinal",r)}_halfBlur(e,t,i,n,r,s,a){const o=this._renderer,l=this._blurMaterial,c=new Ri(yn[n],l),u=l.uniforms,h=xn[i]-1,d=isFinite(r)?Math.PI/(2*h):2*Math.PI/39,p=r/d,m=isFinite(r)?1+Math.floor(3*p):20,f=[];let g=0;for(let y=0;y<20;++y){const e=y/p,t=Math.exp(-e*e/2);f.push(t),0==y?g+=t:y<m&&(g+=2*t)}for(let y=0;y<f.length;y++)f[y]=f[y]/g;u.envMap.value=e.texture,u.samples.value=m,u.weights.value=f,u.latitudinal.value="latitudinal"===s,a&&(u.poleAxis.value=a),u.dTheta.value=d,u.mipInt.value=8-i,this._setEncoding(u.inputEncoding,e.texture),this._setEncoding(u.outputEncoding,e.texture);const v=xn[n];En(t,3*Math.max(0,pn-2*v),(0===n?0:2*pn)+2*v*(n>4?n-8+4:0),3*v,2*v),o.setRenderTarget(t),o.render(c,vn)}}function Cn(e){return void 0!==e&&1009===e.type&&(3e3===e.encoding||3001===e.encoding||3007===e.encoding)}function Ln(){const e=[],t=[],i=[];let n=8;for(let r=0;r<fn;r++){const s=Math.pow(2,n);t.push(s);let a=1/s;r>4?a=mn[r-8+4-1]:0==r&&(a=0),i.push(a);const o=1/(s-1),l=-o/2,c=1+o/2,u=[l,l,c,l,c,c,l,l,c,c,l,c],h=6,d=6,p=3,m=2,f=1,g=new Float32Array(p*d*h),v=new Float32Array(m*d*h),y=new Float32Array(f*d*h);for(let e=0;e<h;e++){const t=e%3*2/3-1,i=e>2?0:-1,n=[t,i,0,t+2/3,i,0,t+2/3,i+1,0,t,i,0,t+2/3,i+1,0,t,i+1,0];g.set(n,p*d*e),v.set(u,m*d*e);const r=[e,e,e,e,e,e];y.set(r,f*d*e)}const x=new fi;x.setAttribute("position",new ni(g,p)),x.setAttribute("uv",new ni(v,m)),x.setAttribute("faceIndex",new ni(y,f)),e.push(x),n>4&&n--}return{_lodPlanes:e,_sizeLods:t,_sigmas:i}}function Pn(e){const t=new Le(3*pn,3*pn,e);return t.texture.mapping=306,t.texture.name="PMREM.cubeUv",t.scissorTest=!0,t}function En(e,t,i,n,r){e.viewport.set(t,i,n,r),e.scissor.set(t,i,n,r)}function Dn(){const e=new xe(1,1);return new dn({name:"EquirectangularToCubeUV",uniforms:{envMap:{value:null},texelSize:{value:e},inputEncoding:{value:gn[3e3]},outputEncoding:{value:gn[3e3]}},vertexShader:Rn(),fragmentShader:`precision mediump float;precision mediump int;varying vec3 vOutputDirection;uniform sampler2D envMap;uniform vec2 texelSize;\n${zn()}\n#include <common>\nvoid main(){gl_FragColor=vec4(0.0,0.0,0.0,1.0);vec3 outputDirection=normalize(vOutputDirection);vec2 uv=equirectUv(outputDirection);vec2 f=fract(uv/texelSize-0.5);uv-=f*texelSize;vec3 tl=envMapTexelToLinear(texture2D(envMap,uv)).rgb;uv.x+=texelSize.x;vec3 tr=envMapTexelToLinear(texture2D(envMap,uv)).rgb;uv.y+=texelSize.y;vec3 br=envMapTexelToLinear(texture2D(envMap,uv)).rgb;uv.x-=texelSize.x;vec3 bl=envMapTexelToLinear(texture2D(envMap,uv)).rgb;vec3 tm=mix(tl,tr,f.x);vec3 bm=mix(bl,br,f.x);gl_FragColor.rgb=mix(tm,bm,f.y);gl_FragColor=linearToOutputTexel(gl_FragColor);}`,blending:0,depthTest:!1,depthWrite:!1})}function In(){return new dn({name:"CubemapToCubeUV",uniforms:{envMap:{value:null},inputEncoding:{value:gn[3e3]},outputEncoding:{value:gn[3e3]}},vertexShader:Rn(),fragmentShader:`precision mediump float;precision mediump int;varying vec3 vOutputDirection;uniform samplerCube envMap;\n${zn()}\nvoid main(){gl_FragColor=vec4(0.0,0.0,0.0,1.0);gl_FragColor.rgb=envMapTexelToLinear(textureCube(envMap,vec3(-vOutputDirection.x,vOutputDirection.yz))).rgb;gl_FragColor=linearToOutputTexel(gl_FragColor);}`,blending:0,depthTest:!1,depthWrite:!1})}function Rn(){return"precision mediump float;precision mediump int;attribute vec3 position;attribute vec2 uv;attribute float faceIndex;varying vec3 vOutputDirection;vec3 getDirection(vec2 uv,float face){uv=2.0*uv-1.0;vec3 direction=vec3(uv,1.0);if(face==0.0){direction=direction.zyx;}else if(face==1.0){direction=direction.xzy;direction.xz*=-1.0;}else if(face==2.0){direction.x*=-1.0;}else if(face==3.0){direction=direction.zyx;direction.xz*=-1.0;}else if(face==4.0){direction=direction.xzy;direction.xy*=-1.0;}else if(face==5.0){direction.z*=-1.0;}return direction;}void main(){vOutputDirection=getDirection(uv,faceIndex);gl_Position=vec4(position,1.0);}"}function zn(){return"uniform int inputEncoding;uniform int outputEncoding;\n#include <encodings_pars_fragment>\nvec4 inputTexelToLinear(vec4 value){if(inputEncoding==0){return value;}else if(inputEncoding==1){return sRGBToLinear(value);}else if(inputEncoding==2){return RGBEToLinear(value);}else if(inputEncoding==3){return RGBMToLinear(value,7.0);}else if(inputEncoding==4){return RGBMToLinear(value,16.0);}else if(inputEncoding==5){return RGBDToLinear(value,256.0);}else{return GammaToLinear(value,2.2);}}vec4 linearToOutputTexel(vec4 value){if(outputEncoding==0){return value;}else if(outputEncoding==1){return LinearTosRGB(value);}else if(outputEncoding==2){return LinearToRGBE(value);}else if(outputEncoding==3){return LinearToRGBM(value,7.0);}else if(outputEncoding==4){return LinearToRGBM(value,16.0);}else if(outputEncoding==5){return LinearToRGBD(value,256.0);}else{return LinearToGamma(value,2.2);}}vec4 envMapTexelToLinear(vec4 color){return inputTexelToLinear(color);}"}function Nn(e){let t=new WeakMap,i=null;function n(e){const i=e.target;i.removeEventListener("dispose",n);const r=t.get(i);void 0!==r&&(t.delete(i),r.dispose())}return{get:function(r){if(r&&r.isTexture&&!1===r.isRenderTargetTexture){const s=r.mapping,a=303===s||304===s,o=301===s||302===s;if(a||o){if(t.has(r))return t.get(r).texture;{const s=r.image;if(a&&s&&s.height>0||o&&s&&function(e){let t=0;const i=6;for(let n=0;n<i;n++)void 0!==e[n]&&t++;return t===i}(s)){const s=e.getRenderTarget();null===i&&(i=new An(e));const o=a?i.fromEquirectangular(r):i.fromCubemap(r);return t.set(r,o),e.setRenderTarget(s),r.addEventListener("dispose",n),o.texture}return null}}}return r},dispose:function(){t=new WeakMap,null!==i&&(i.dispose(),i=null)}}}function On(e){const t={};function i(i){if(void 0!==t[i])return t[i];let n;switch(i){case"WEBGL_depth_texture":n=e.getExtension("WEBGL_depth_texture")||e.getExtension("MOZ_WEBGL_depth_texture")||e.getExtension("WEBKIT_WEBGL_depth_texture");break;case"EXT_texture_filter_anisotropic":n=e.getExtension("EXT_texture_filter_anisotropic")||e.getExtension("MOZ_EXT_texture_filter_anisotropic")||e.getExtension("WEBKIT_EXT_texture_filter_anisotropic");break;case"WEBGL_compressed_texture_s3tc":n=e.getExtension("WEBGL_compressed_texture_s3tc")||e.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||e.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc");break;case"WEBGL_compressed_texture_pvrtc":n=e.getExtension("WEBGL_compressed_texture_pvrtc")||e.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc");break;default:n=e.getExtension(i)}return t[i]=n,n}return{has:function(e){return null!==i(e)},init:function(e){e.isWebGL2?i("EXT_color_buffer_float"):(i("WEBGL_depth_texture"),i("OES_texture_float"),i("OES_texture_half_float"),i("OES_texture_half_float_linear"),i("OES_standard_derivatives"),i("OES_element_index_uint"),i("OES_vertex_array_object"),i("ANGLE_instanced_arrays")),i("OES_texture_float_linear"),i("EXT_color_buffer_half_float"),i("EXT_multisampled_render_to_texture")},get:function(e){const t=i(e);return t}}}function Fn(e,t,i,n){const r={},s=new WeakMap;function a(e){const o=e.target;null!==o.index&&t.remove(o.index);for(const i in o.attributes)t.remove(o.attributes[i]);o.removeEventListener("dispose",a),delete r[o.id];const l=s.get(o);l&&(t.remove(l),s.delete(o)),n.releaseStatesOfGeometry(o),!0===o.isInstancedBufferGeometry&&delete o._maxInstanceCount,i.memory.geometries--}function o(e){const i=[],n=e.index,r=e.attributes.position;let a=0;if(null!==n){const e=n.array;a=n.version;for(let t=0,n=e.length;t<n;t+=3){const n=e[t+0],r=e[t+1],s=e[t+2];i.push(n,r,r,s,s,n)}}else{const e=r.array;a=r.version;for(let t=0,n=e.length/3-1;t<n;t+=3){const e=t+0,n=t+1,r=t+2;i.push(e,n,n,r,r,e)}}const o=new(be(i)>65535?ai:si)(i,1);o.version=a;const l=s.get(e);l&&t.remove(l),s.set(e,o)}return{get:function(e,t){return!0===r[t.id]||(t.addEventListener("dispose",a),r[t.id]=!0,i.memory.geometries++),t},update:function(e){const i=e.attributes;for(const r in i)t.update(i[r],34962);const n=e.morphAttributes;for(const r in n){const e=n[r];for(let i=0,n=e.length;i<n;i++)t.update(e[i],34962)}},getWireframeAttribute:function(e){const t=s.get(e);if(t){const i=e.index;null!==i&&t.version<i.version&&o(e)}else o(e);return s.get(e)}}}function Un(e,t,i,n){const r=n.isWebGL2;let s,a,o;this.setMode=function(e){s=e},this.setIndex=function(e){a=e.type,o=e.bytesPerElement},this.render=function(t,n){e.drawElements(s,n,a,t*o),i.update(n,s,1)},this.renderInstances=function(n,l,c){if(0===c)return;let u,h;if(r)u=e,h="drawElementsInstanced";else if(u=t.get("ANGLE_instanced_arrays"),h="drawElementsInstancedANGLE",null===u)return;u[h](s,l,a,n*o,c),i.update(l,s,c)}}function kn(e){const t={frame:0,calls:0,triangles:0,points:0,lines:0};return{memory:{geometries:0,textures:0},render:t,programs:null,autoReset:!0,reset:function(){t.frame++,t.calls=0,t.triangles=0,t.points=0,t.lines=0},update:function(e,i,n){switch(t.calls++,i){case 4:t.triangles+=n*(e/3);break;case 1:t.lines+=n*(e/2);break;case 3:t.lines+=n*(e-1);break;case 2:t.lines+=n*e;break;case 0:t.points+=n*e}}}}class Bn extends Te{constructor(e=null,t=1,i=1,n=1){super(null),this.image={data:e,width:t,height:i,depth:n},this.magFilter=1003,this.minFilter=1003,this.wrapR=1001,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1,this.needsUpdate=!0}}function Vn(e,t){return e[0]-t[0]}function Gn(e,t){return Math.abs(t[1])-Math.abs(e[1])}function Wn(e,t){let i=1;const n=t.isInterleavedBufferAttribute?t.data.array:t.array;n instanceof Int8Array?i=127:n instanceof Int16Array?i=32767:n instanceof Int32Array&&(i=2147483647),e.divideScalar(i)}function Hn(e,t,i){const n={},r=new Float32Array(8),s=new WeakMap,a=new De,o=[];for(let l=0;l<8;l++)o[l]=[l,0];return{update:function(l,c,u,h){const d=l.morphTargetInfluences;if(!0===t.isWebGL2){const n=c.morphAttributes.position.length;let r=s.get(c);if(void 0===r||r.count!==n){void 0!==r&&r.texture.dispose();const e=void 0!==c.morphAttributes.normal,i=c.morphAttributes.position,o=c.morphAttributes.normal||[],l=!0===e?2:1;let u=c.attributes.position.count*l,h=1;u>t.maxTextureSize&&(h=Math.ceil(u/t.maxTextureSize),u=t.maxTextureSize);const d=new Float32Array(u*h*4*n),p=new Bn(d,u,h,n);p.format=1023,p.type=1015;const m=4*l;for(let t=0;t<n;t++){const n=i[t],r=o[t],s=u*h*4*t;for(let t=0;t<n.count;t++){a.fromBufferAttribute(n,t),!0===n.normalized&&Wn(a,n);const i=t*m;d[s+i+0]=a.x,d[s+i+1]=a.y,d[s+i+2]=a.z,d[s+i+3]=0,!0===e&&(a.fromBufferAttribute(r,t),!0===r.normalized&&Wn(a,r),d[s+i+4]=a.x,d[s+i+5]=a.y,d[s+i+6]=a.z,d[s+i+7]=0)}}r={count:n,texture:p,size:new xe(u,h)},s.set(c,r)}let o=0;for(let e=0;e<d.length;e++)o+=d[e];const l=c.morphTargetsRelative?1:1-o;h.getUniforms().setValue(e,"morphTargetBaseInfluence",l),h.getUniforms().setValue(e,"morphTargetInfluences",d),h.getUniforms().setValue(e,"morphTargetsTexture",r.texture,i),h.getUniforms().setValue(e,"morphTargetsTextureSize",r.size)}else{const t=void 0===d?0:d.length;let i=n[c.id];if(void 0===i||i.length!==t){i=[];for(let e=0;e<t;e++)i[e]=[e,0];n[c.id]=i}for(let e=0;e<t;e++){const t=i[e];t[0]=e,t[1]=d[e]}i.sort(Gn);for(let e=0;e<8;e++)e<t&&i[e][1]?(o[e][0]=i[e][0],o[e][1]=i[e][1]):(o[e][0]=Number.MAX_SAFE_INTEGER,o[e][1]=0);o.sort(Vn);const s=c.morphAttributes.position,a=c.morphAttributes.normal;let l=0;for(let e=0;e<8;e++){const t=o[e],i=t[0],n=t[1];i!==Number.MAX_SAFE_INTEGER&&n?(s&&c.getAttribute("morphTarget"+e)!==s[i]&&c.setAttribute("morphTarget"+e,s[i]),a&&c.getAttribute("morphNormal"+e)!==a[i]&&c.setAttribute("morphNormal"+e,a[i]),r[e]=n,l+=n):(s&&!0===c.hasAttribute("morphTarget"+e)&&c.deleteAttribute("morphTarget"+e),a&&!0===c.hasAttribute("morphNormal"+e)&&c.deleteAttribute("morphNormal"+e),r[e]=0)}const u=c.morphTargetsRelative?1:1-l;h.getUniforms().setValue(e,"morphTargetBaseInfluence",u),h.getUniforms().setValue(e,"morphTargetInfluences",r)}}}}function jn(e,t,i,n){let r=new WeakMap;function s(e){const t=e.target;t.removeEventListener("dispose",s),i.remove(t.instanceMatrix),null!==t.instanceColor&&i.remove(t.instanceColor)}return{update:function(e){const a=n.render.frame,o=e.geometry,l=t.get(e,o);return r.get(l)!==a&&(t.update(l),r.set(l,a)),e.isInstancedMesh&&(!1===e.hasEventListener("dispose",s)&&e.addEventListener("dispose",s),i.update(e.instanceMatrix,34962),null!==e.instanceColor&&i.update(e.instanceColor,34962)),l},dispose:function(){r=new WeakMap}}}Bn.prototype.isDataTexture2DArray=!0;class qn extends Te{constructor(e=null,t=1,i=1,n=1){super(null),this.image={data:e,width:t,height:i,depth:n},this.magFilter=1003,this.minFilter=1003,this.wrapR=1001,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1,this.needsUpdate=!0}}qn.prototype.isDataTexture3D=!0;const Xn=new Te,Yn=new Bn,Zn=new qn,Jn=new Wi,Qn=[],Kn=[],$n=new Float32Array(16),er=new Float32Array(9),tr=new Float32Array(4);function ir(e,t,i){const n=e[0];if(n<=0||n>0)return e;const r=t*i;let s=Qn[r];if(void 0===s&&(s=new Float32Array(r),Qn[r]=s),0!==t){n.toArray(s,0);for(let n=1,r=0;n!==t;++n)r+=i,e[n].toArray(s,r)}return s}function nr(e,t){if(e.length!==t.length)return!1;for(let i=0,n=e.length;i<n;i++)if(e[i]!==t[i])return!1;return!0}function rr(e,t){for(let i=0,n=t.length;i<n;i++)e[i]=t[i]}function sr(e,t){let i=Kn[t];void 0===i&&(i=new Int32Array(t),Kn[t]=i);for(let n=0;n!==t;++n)i[n]=e.allocateTextureUnit();return i}function ar(e,t){const i=this.cache;i[0]!==t&&(e.uniform1f(this.addr,t),i[0]=t)}function or(e,t){const i=this.cache;if(void 0!==t.x)i[0]===t.x&&i[1]===t.y||(e.uniform2f(this.addr,t.x,t.y),i[0]=t.x,i[1]=t.y);else{if(nr(i,t))return;e.uniform2fv(this.addr,t),rr(i,t)}}function lr(e,t){const i=this.cache;if(void 0!==t.x)i[0]===t.x&&i[1]===t.y&&i[2]===t.z||(e.uniform3f(this.addr,t.x,t.y,t.z),i[0]=t.x,i[1]=t.y,i[2]=t.z);else if(void 0!==t.r)i[0]===t.r&&i[1]===t.g&&i[2]===t.b||(e.uniform3f(this.addr,t.r,t.g,t.b),i[0]=t.r,i[1]=t.g,i[2]=t.b);else{if(nr(i,t))return;e.uniform3fv(this.addr,t),rr(i,t)}}function cr(e,t){const i=this.cache;if(void 0!==t.x)i[0]===t.x&&i[1]===t.y&&i[2]===t.z&&i[3]===t.w||(e.uniform4f(this.addr,t.x,t.y,t.z,t.w),i[0]=t.x,i[1]=t.y,i[2]=t.z,i[3]=t.w);else{if(nr(i,t))return;e.uniform4fv(this.addr,t),rr(i,t)}}function ur(e,t){const i=this.cache,n=t.elements;if(void 0===n){if(nr(i,t))return;e.uniformMatrix2fv(this.addr,!1,t),rr(i,t)}else{if(nr(i,n))return;tr.set(n),e.uniformMatrix2fv(this.addr,!1,tr),rr(i,n)}}function hr(e,t){const i=this.cache,n=t.elements;if(void 0===n){if(nr(i,t))return;e.uniformMatrix3fv(this.addr,!1,t),rr(i,t)}else{if(nr(i,n))return;er.set(n),e.uniformMatrix3fv(this.addr,!1,er),rr(i,n)}}function dr(e,t){const i=this.cache,n=t.elements;if(void 0===n){if(nr(i,t))return;e.uniformMatrix4fv(this.addr,!1,t),rr(i,t)}else{if(nr(i,n))return;$n.set(n),e.uniformMatrix4fv(this.addr,!1,$n),rr(i,n)}}function pr(e,t){const i=this.cache;i[0]!==t&&(e.uniform1i(this.addr,t),i[0]=t)}function mr(e,t){const i=this.cache;nr(i,t)||(e.uniform2iv(this.addr,t),rr(i,t))}function fr(e,t){const i=this.cache;nr(i,t)||(e.uniform3iv(this.addr,t),rr(i,t))}function gr(e,t){const i=this.cache;nr(i,t)||(e.uniform4iv(this.addr,t),rr(i,t))}function vr(e,t){const i=this.cache;i[0]!==t&&(e.uniform1ui(this.addr,t),i[0]=t)}function yr(e,t){const i=this.cache;nr(i,t)||(e.uniform2uiv(this.addr,t),rr(i,t))}function xr(e,t){const i=this.cache;nr(i,t)||(e.uniform3uiv(this.addr,t),rr(i,t))}function _r(e,t){const i=this.cache;nr(i,t)||(e.uniform4uiv(this.addr,t),rr(i,t))}function br(e,t,i){const n=this.cache,r=i.allocateTextureUnit();n[0]!==r&&(e.uniform1i(this.addr,r),n[0]=r),i.safeSetTexture2D(t||Xn,r)}function wr(e,t,i){const n=this.cache,r=i.allocateTextureUnit();n[0]!==r&&(e.uniform1i(this.addr,r),n[0]=r),i.setTexture3D(t||Zn,r)}function Mr(e,t,i){const n=this.cache,r=i.allocateTextureUnit();n[0]!==r&&(e.uniform1i(this.addr,r),n[0]=r),i.safeSetTextureCube(t||Jn,r)}function Sr(e,t,i){const n=this.cache,r=i.allocateTextureUnit();n[0]!==r&&(e.uniform1i(this.addr,r),n[0]=r),i.setTexture2DArray(t||Yn,r)}function Tr(e,t){e.uniform1fv(this.addr,t)}function Ar(e,t){const i=ir(t,this.size,2);e.uniform2fv(this.addr,i)}function Cr(e,t){const i=ir(t,this.size,3);e.uniform3fv(this.addr,i)}function Lr(e,t){const i=ir(t,this.size,4);e.uniform4fv(this.addr,i)}function Pr(e,t){const i=ir(t,this.size,4);e.uniformMatrix2fv(this.addr,!1,i)}function Er(e,t){const i=ir(t,this.size,9);e.uniformMatrix3fv(this.addr,!1,i)}function Dr(e,t){const i=ir(t,this.size,16);e.uniformMatrix4fv(this.addr,!1,i)}function Ir(e,t){e.uniform1iv(this.addr,t)}function Rr(e,t){e.uniform2iv(this.addr,t)}function zr(e,t){e.uniform3iv(this.addr,t)}function Nr(e,t){e.uniform4iv(this.addr,t)}function Or(e,t){e.uniform1uiv(this.addr,t)}function Fr(e,t){e.uniform2uiv(this.addr,t)}function Ur(e,t){e.uniform3uiv(this.addr,t)}function kr(e,t){e.uniform4uiv(this.addr,t)}function Br(e,t,i){const n=t.length,r=sr(i,n);e.uniform1iv(this.addr,r);for(let s=0;s!==n;++s)i.safeSetTexture2D(t[s]||Xn,r[s])}function Vr(e,t,i){const n=t.length,r=sr(i,n);e.uniform1iv(this.addr,r);for(let s=0;s!==n;++s)i.safeSetTextureCube(t[s]||Jn,r[s])}function Gr(e,t,i){this.id=e,this.addr=i,this.cache=[],this.setValue=function(e){switch(e){case 5126:return ar;case 35664:return or;case 35665:return lr;case 35666:return cr;case 35674:return ur;case 35675:return hr;case 35676:return dr;case 5124:case 35670:return pr;case 35667:case 35671:return mr;case 35668:case 35672:return fr;case 35669:case 35673:return gr;case 5125:return vr;case 36294:return yr;case 36295:return xr;case 36296:return _r;case 35678:case 36198:case 36298:case 36306:case 35682:return br;case 35679:case 36299:case 36307:return wr;case 35680:case 36300:case 36308:case 36293:return Mr;case 36289:case 36303:case 36311:case 36292:return Sr}}(t.type)}function Wr(e,t,i){this.id=e,this.addr=i,this.cache=[],this.size=t.size,this.setValue=function(e){switch(e){case 5126:return Tr;case 35664:return Ar;case 35665:return Cr;case 35666:return Lr;case 35674:return Pr;case 35675:return Er;case 35676:return Dr;case 5124:case 35670:return Ir;case 35667:case 35671:return Rr;case 35668:case 35672:return zr;case 35669:case 35673:return Nr;case 5125:return Or;case 36294:return Fr;case 36295:return Ur;case 36296:return kr;case 35678:case 36198:case 36298:case 36306:case 35682:return Br;case 35680:case 36300:case 36308:case 36293:return Vr}}(t.type)}function Hr(e){this.id=e,this.seq=[],this.map={}}Wr.prototype.updateCache=function(e){const t=this.cache;e instanceof Float32Array&&t.length!==e.length&&(this.cache=new Float32Array(e.length)),rr(t,e)},Hr.prototype.setValue=function(e,t,i){const n=this.seq;for(let r=0,s=n.length;r!==s;++r){const s=n[r];s.setValue(e,t[s.id],i)}};const jr=/(\w+)(\])?(\[|\.)?/g;function qr(e,t){e.seq.push(t),e.map[t.id]=t}function Xr(e,t,i){const n=e.name,r=n.length;for(jr.lastIndex=0;;){const s=jr.exec(n),a=jr.lastIndex;let o=s[1];const l="]"===s[2],c=s[3];if(l&&(o|=0),void 0===c||"["===c&&a+2===r){qr(i,void 0===c?new Gr(o,e,t):new Wr(o,e,t));break}{let e=i.map[o];void 0===e&&(e=new Hr(o),qr(i,e)),i=e}}}function Yr(e,t){this.seq=[],this.map={};const i=e.getProgramParameter(t,35718);for(let n=0;n<i;++n){const i=e.getActiveUniform(t,n);Xr(i,e.getUniformLocation(t,i.name),this)}}function Zr(e,t,i){const n=e.createShader(t);return e.shaderSource(n,i),e.compileShader(n),n}Yr.prototype.setValue=function(e,t,i,n){const r=this.map[t];void 0!==r&&r.setValue(e,i,n)},Yr.prototype.setOptional=function(e,t,i){const n=t[i];void 0!==n&&this.setValue(e,i,n)},Yr.upload=function(e,t,i,n){for(let r=0,s=t.length;r!==s;++r){const s=t[r],a=i[s.id];!1!==a.needsUpdate&&s.setValue(e,a.value,n)}},Yr.seqWithValue=function(e,t){const i=[];for(let n=0,r=e.length;n!==r;++n){const r=e[n];r.id in t&&i.push(r)}return i};let Jr=0;function Qr(e){switch(e){case 3e3:default:return["Linear","( value )"];case 3001:return["sRGB","( value )"];case 3002:return["RGBE","( value )"];case 3004:return["RGBM","( value, 7.0 )"];case 3005:return["RGBM","( value, 16.0 )"];case 3006:return["RGBD","( value, 256.0 )"];case 3007:return["Gamma","( value, float( GAMMA_FACTOR ) )"];case 3003:return["LogLuv","( value )"]}}function Kr(e,t,i){const n=e.getShaderParameter(t,35713),r=e.getShaderInfoLog(t).trim();return n&&""===r?"":i.toUpperCase()+"\n\n"+r+"\n\n"+function(e){const t=e.split("\n");for(let i=0;i<t.length;i++)t[i]=i+1+": "+t[i];return t.join("\n")}(e.getShaderSource(t))}function $r(e,t){const i=Qr(t);return"vec4 "+e+"( vec4 value ) { return "+i[0]+"ToLinear"+i[1]+"; }"}function es(e,t){const i=Qr(t);return"vec4 "+e+"( vec4 value ) { return LinearTo"+i[0]+i[1]+"; }"}function ts(e,t){let i;switch(t){case 1:default:i="Linear";break;case 2:i="Reinhard";break;case 3:i="OptimizedCineon";break;case 4:i="ACESFilmic";break;case 5:i="Custom"}return"vec3 "+e+"( vec3 color ) { return "+i+"ToneMapping( color ); }"}function is(e){return""!==e}function ns(e,t){return e.replace(/NUM_DIR_LIGHTS/g,t.numDirLights).replace(/NUM_SPOT_LIGHTS/g,t.numSpotLights).replace(/NUM_RECT_AREA_LIGHTS/g,t.numRectAreaLights).replace(/NUM_POINT_LIGHTS/g,t.numPointLights).replace(/NUM_HEMI_LIGHTS/g,t.numHemiLights).replace(/NUM_DIR_LIGHT_SHADOWS/g,t.numDirLightShadows).replace(/NUM_SPOT_LIGHT_SHADOWS/g,t.numSpotLightShadows).replace(/NUM_POINT_LIGHT_SHADOWS/g,t.numPointLightShadows)}function rs(e,t){return e.replace(/NUM_CLIPPING_PLANES/g,t.numClippingPlanes).replace(/UNION_CLIPPING_PLANES/g,t.numClippingPlanes-t.numClipIntersection)}const ss=/^[ \t]*#include +<([\w\d./]+)>/gm;function as(e){return e.replace(ss,os)}function os(e,t){const i=tn[t];if(void 0===i)throw new Error("Can not resolve #include <"+t+">");return as(i)}const ls=/#pragma unroll_loop[\s]+?for \( int i \= (\d+)\; i < (\d+)\; i \+\+ \) \{([\s\S]+?)(?=\})\}/g,cs=/#pragma unroll_loop_start\s+for\s*\(\s*int\s+i\s*=\s*(\d+)\s*;\s*i\s*<\s*(\d+)\s*;\s*i\s*\+\+\s*\)\s*{([\s\S]+?)}\s+#pragma unroll_loop_end/g;function us(e){return e.replace(cs,ds).replace(ls,hs)}function hs(e,t,i,n){return ds(e,t,i,n)}function ds(e,t,i,n){let r="";for(let s=parseInt(t);s<parseInt(i);s++)r+=n.replace(/\[\s*i\s*\]/g,"[ "+s+" ]").replace(/UNROLLED_LOOP_INDEX/g,s);return r}function ps(e){let t="precision "+e.precision+" float;\nprecision "+e.precision+" int;";return"highp"===e.precision?t+="\n#define HIGH_PRECISION":"mediump"===e.precision?t+="\n#define MEDIUM_PRECISION":"lowp"===e.precision&&(t+="\n#define LOW_PRECISION"),t}function ms(e,t,i,n){const r=e.getContext(),s=i.defines;let a=i.vertexShader,o=i.fragmentShader;const l=function(e){let t="SHADOWMAP_TYPE_BASIC";return 1===e.shadowMapType?t="SHADOWMAP_TYPE_PCF":2===e.shadowMapType?t="SHADOWMAP_TYPE_PCF_SOFT":3===e.shadowMapType&&(t="SHADOWMAP_TYPE_VSM"),t}(i),c=function(e){let t="ENVMAP_TYPE_CUBE";if(e.envMap)switch(e.envMapMode){case 301:case 302:t="ENVMAP_TYPE_CUBE";break;case 306:case 307:t="ENVMAP_TYPE_CUBE_UV"}return t}(i),u=function(e){let t="ENVMAP_MODE_REFLECTION";if(e.envMap)switch(e.envMapMode){case 302:case 307:t="ENVMAP_MODE_REFRACTION"}return t}(i),h=function(e){let t="ENVMAP_BLENDING_NONE";if(e.envMap)switch(e.combine){case 0:t="ENVMAP_BLENDING_MULTIPLY";break;case 1:t="ENVMAP_BLENDING_MIX";break;case 2:t="ENVMAP_BLENDING_ADD"}return t}(i),d=e.gammaFactor>0?e.gammaFactor:1,p=i.isWebGL2?"":function(e){return[e.extensionDerivatives||e.envMapCubeUV||e.bumpMap||e.tangentSpaceNormalMap||e.clearcoatNormalMap||e.flatShading||"physical"===e.shaderID?"#extension GL_OES_standard_derivatives : enable":"",(e.extensionFragDepth||e.logarithmicDepthBuffer)&&e.rendererExtensionFragDepth?"#extension GL_EXT_frag_depth : enable":"",e.extensionDrawBuffers&&e.rendererExtensionDrawBuffers?"#extension GL_EXT_draw_buffers : require":"",(e.extensionShaderTextureLOD||e.envMap||e.transmission)&&e.rendererExtensionShaderTextureLod?"#extension GL_EXT_shader_texture_lod : enable":""].filter(is).join("\n")}(i),m=function(e){const t=[];for(const i in e){const n=e[i];!1!==n&&t.push("#define "+i+" "+n)}return t.join("\n")}(s),f=r.createProgram();let g,v,y=i.glslVersion?"#version "+i.glslVersion+"\n":"";i.isRawShaderMaterial?(g=[m].filter(is).join("\n"),g.length>0&&(g+="\n"),v=[p,m].filter(is).join("\n"),v.length>0&&(v+="\n")):(g=[ps(i),"#define SHADER_NAME "+i.shaderName,m,i.instancing?"#define USE_INSTANCING":"",i.instancingColor?"#define USE_INSTANCING_COLOR":"",i.supportsVertexTextures?"#define VERTEX_TEXTURES":"","#define GAMMA_FACTOR "+d,"#define MAX_BONES "+i.maxBones,i.useFog&&i.fog?"#define USE_FOG":"",i.useFog&&i.fogExp2?"#define FOG_EXP2":"",i.map?"#define USE_MAP":"",i.envMap?"#define USE_ENVMAP":"",i.envMap?"#define "+u:"",i.lightMap?"#define USE_LIGHTMAP":"",i.aoMap?"#define USE_AOMAP":"",i.emissiveMap?"#define USE_EMISSIVEMAP":"",i.bumpMap?"#define USE_BUMPMAP":"",i.normalMap?"#define USE_NORMALMAP":"",i.normalMap&&i.objectSpaceNormalMap?"#define OBJECTSPACE_NORMALMAP":"",i.normalMap&&i.tangentSpaceNormalMap?"#define TANGENTSPACE_NORMALMAP":"",i.clearcoatMap?"#define USE_CLEARCOATMAP":"",i.clearcoatRoughnessMap?"#define USE_CLEARCOAT_ROUGHNESSMAP":"",i.clearcoatNormalMap?"#define USE_CLEARCOAT_NORMALMAP":"",i.displacementMap&&i.supportsVertexTextures?"#define USE_DISPLACEMENTMAP":"",i.specularMap?"#define USE_SPECULARMAP":"",i.specularIntensityMap?"#define USE_SPECULARINTENSITYMAP":"",i.specularTintMap?"#define USE_SPECULARTINTMAP":"",i.roughnessMap?"#define USE_ROUGHNESSMAP":"",i.metalnessMap?"#define USE_METALNESSMAP":"",i.alphaMap?"#define USE_ALPHAMAP":"",i.transmission?"#define USE_TRANSMISSION":"",i.transmissionMap?"#define USE_TRANSMISSIONMAP":"",i.thicknessMap?"#define USE_THICKNESSMAP":"",i.vertexTangents?"#define USE_TANGENT":"",i.vertexColors?"#define USE_COLOR":"",i.vertexAlphas?"#define USE_COLOR_ALPHA":"",i.vertexUvs?"#define USE_UV":"",i.uvsVertexOnly?"#define UVS_VERTEX_ONLY":"",i.flatShading?"#define FLAT_SHADED":"",i.skinning?"#define USE_SKINNING":"",i.useVertexTexture?"#define BONE_TEXTURE":"",i.morphTargets?"#define USE_MORPHTARGETS":"",i.morphNormals&&!1===i.flatShading?"#define USE_MORPHNORMALS":"",i.morphTargets&&i.isWebGL2?"#define MORPHTARGETS_TEXTURE":"",i.morphTargets&&i.isWebGL2?"#define MORPHTARGETS_COUNT "+i.morphTargetsCount:"",i.doubleSided?"#define DOUBLE_SIDED":"",i.flipSided?"#define FLIP_SIDED":"",i.shadowMapEnabled?"#define USE_SHADOWMAP":"",i.shadowMapEnabled?"#define "+l:"",i.sizeAttenuation?"#define USE_SIZEATTENUATION":"",i.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",i.logarithmicDepthBuffer&&i.rendererExtensionFragDepth?"#define USE_LOGDEPTHBUF_EXT":"","uniform mat4 modelMatrix;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 viewMatrix;","uniform mat3 normalMatrix;","uniform vec3 cameraPosition;","uniform bool isOrthographic;","#ifdef USE_INSTANCING","\tattribute mat4 instanceMatrix;","#endif","#ifdef USE_INSTANCING_COLOR","\tattribute vec3 instanceColor;","#endif","attribute vec3 position;","attribute vec3 normal;","attribute vec2 uv;","#ifdef USE_TANGENT","\tattribute vec4 tangent;","#endif","#if defined( USE_COLOR_ALPHA )","\tattribute vec4 color;","#elif defined( USE_COLOR )","\tattribute vec3 color;","#endif","#if ( defined( USE_MORPHTARGETS ) && ! defined( MORPHTARGETS_TEXTURE ) )","\tattribute vec3 morphTarget0;","\tattribute vec3 morphTarget1;","\tattribute vec3 morphTarget2;","\tattribute vec3 morphTarget3;","\t#ifdef USE_MORPHNORMALS","\t\tattribute vec3 morphNormal0;","\t\tattribute vec3 morphNormal1;","\t\tattribute vec3 morphNormal2;","\t\tattribute vec3 morphNormal3;","\t#else","\t\tattribute vec3 morphTarget4;","\t\tattribute vec3 morphTarget5;","\t\tattribute vec3 morphTarget6;","\t\tattribute vec3 morphTarget7;","\t#endif","#endif","#ifdef USE_SKINNING","\tattribute vec4 skinIndex;","\tattribute vec4 skinWeight;","#endif","\n"].filter(is).join("\n"),v=[p,ps(i),"#define SHADER_NAME "+i.shaderName,m,"#define GAMMA_FACTOR "+d,i.useFog&&i.fog?"#define USE_FOG":"",i.useFog&&i.fogExp2?"#define FOG_EXP2":"",i.map?"#define USE_MAP":"",i.matcap?"#define USE_MATCAP":"",i.envMap?"#define USE_ENVMAP":"",i.envMap?"#define "+c:"",i.envMap?"#define "+u:"",i.envMap?"#define "+h:"",i.lightMap?"#define USE_LIGHTMAP":"",i.aoMap?"#define USE_AOMAP":"",i.emissiveMap?"#define USE_EMISSIVEMAP":"",i.bumpMap?"#define USE_BUMPMAP":"",i.normalMap?"#define USE_NORMALMAP":"",i.normalMap&&i.objectSpaceNormalMap?"#define OBJECTSPACE_NORMALMAP":"",i.normalMap&&i.tangentSpaceNormalMap?"#define TANGENTSPACE_NORMALMAP":"",i.clearcoat?"#define USE_CLEARCOAT":"",i.clearcoatMap?"#define USE_CLEARCOATMAP":"",i.clearcoatRoughnessMap?"#define USE_CLEARCOAT_ROUGHNESSMAP":"",i.clearcoatNormalMap?"#define USE_CLEARCOAT_NORMALMAP":"",i.specularMap?"#define USE_SPECULARMAP":"",i.specularIntensityMap?"#define USE_SPECULARINTENSITYMAP":"",i.specularTintMap?"#define USE_SPECULARTINTMAP":"",i.roughnessMap?"#define USE_ROUGHNESSMAP":"",i.metalnessMap?"#define USE_METALNESSMAP":"",i.alphaMap?"#define USE_ALPHAMAP":"",i.alphaTest?"#define USE_ALPHATEST":"",i.sheen?"#define USE_SHEEN":"",i.transmission?"#define USE_TRANSMISSION":"",i.transmissionMap?"#define USE_TRANSMISSIONMAP":"",i.thicknessMap?"#define USE_THICKNESSMAP":"",i.vertexTangents?"#define USE_TANGENT":"",i.vertexColors||i.instancingColor?"#define USE_COLOR":"",i.vertexAlphas?"#define USE_COLOR_ALPHA":"",i.vertexUvs?"#define USE_UV":"",i.uvsVertexOnly?"#define UVS_VERTEX_ONLY":"",i.gradientMap?"#define USE_GRADIENTMAP":"",i.flatShading?"#define FLAT_SHADED":"",i.doubleSided?"#define DOUBLE_SIDED":"",i.flipSided?"#define FLIP_SIDED":"",i.shadowMapEnabled?"#define USE_SHADOWMAP":"",i.shadowMapEnabled?"#define "+l:"",i.premultipliedAlpha?"#define PREMULTIPLIED_ALPHA":"",i.physicallyCorrectLights?"#define PHYSICALLY_CORRECT_LIGHTS":"",i.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",i.logarithmicDepthBuffer&&i.rendererExtensionFragDepth?"#define USE_LOGDEPTHBUF_EXT":"",(i.extensionShaderTextureLOD||i.envMap)&&i.rendererExtensionShaderTextureLod?"#define TEXTURE_LOD_EXT":"","uniform mat4 viewMatrix;","uniform vec3 cameraPosition;","uniform bool isOrthographic;",0!==i.toneMapping?"#define TONE_MAPPING":"",0!==i.toneMapping?tn.tonemapping_pars_fragment:"",0!==i.toneMapping?ts("toneMapping",i.toneMapping):"",i.dithering?"#define DITHERING":"",1022===i.format?"#define OPAQUE":"",tn.encodings_pars_fragment,i.map?$r("mapTexelToLinear",i.mapEncoding):"",i.matcap?$r("matcapTexelToLinear",i.matcapEncoding):"",i.envMap?$r("envMapTexelToLinear",i.envMapEncoding):"",i.emissiveMap?$r("emissiveMapTexelToLinear",i.emissiveMapEncoding):"",i.specularTintMap?$r("specularTintMapTexelToLinear",i.specularTintMapEncoding):"",i.lightMap?$r("lightMapTexelToLinear",i.lightMapEncoding):"",es("linearToOutputTexel",i.outputEncoding),i.depthPacking?"#define DEPTH_PACKING "+i.depthPacking:"","\n"].filter(is).join("\n")),a=as(a),a=ns(a,i),a=rs(a,i),o=as(o),o=ns(o,i),o=rs(o,i),a=us(a),o=us(o),i.isWebGL2&&!0!==i.isRawShaderMaterial&&(y="#version 300 es\n",g=["precision mediump sampler2DArray;","#define attribute in","#define varying out","#define texture2D texture"].join("\n")+"\n"+g,v=["#define varying in","300 es"===i.glslVersion?"":"out highp vec4 pc_fragColor;","300 es"===i.glslVersion?"":"#define gl_FragColor pc_fragColor","#define gl_FragDepthEXT gl_FragDepth","#define texture2D texture","#define textureCube texture","#define texture2DProj textureProj","#define texture2DLodEXT textureLod","#define texture2DProjLodEXT textureProjLod","#define textureCubeLodEXT textureLod","#define texture2DGradEXT textureGrad","#define texture2DProjGradEXT textureProjGrad","#define textureCubeGradEXT textureGrad"].join("\n")+"\n"+v);const x=y+v+o,_=Zr(r,35633,y+g+a),b=Zr(r,35632,x);if(r.attachShader(f,_),r.attachShader(f,b),void 0!==i.index0AttributeName?r.bindAttribLocation(f,0,i.index0AttributeName):!0===i.morphTargets&&r.bindAttribLocation(f,0,"position"),r.linkProgram(f),e.debug.checkShaderErrors){const e=r.getProgramInfoLog(f).trim(),t=r.getShaderInfoLog(_).trim(),i=r.getShaderInfoLog(b).trim();let n=!0,s=!0;if(!1===r.getProgramParameter(f,35714)){n=!1;Kr(r,_,"vertex"),Kr(r,b,"fragment")}else""!==e||""!==t&&""!==i||(s=!1);s&&(this.diagnostics={runnable:n,programLog:e,vertexShader:{log:t,prefix:g},fragmentShader:{log:i,prefix:v}})}let w,M;return r.deleteShader(_),r.deleteShader(b),this.getUniforms=function(){return void 0===w&&(w=new Yr(r,f)),w},this.getAttributes=function(){return void 0===M&&(M=function(e,t){const i={},n=e.getProgramParameter(t,35721);for(let r=0;r<n;r++){const n=e.getActiveAttrib(t,r),s=n.name;let a=1;35674===n.type&&(a=2),35675===n.type&&(a=3),35676===n.type&&(a=4),i[s]={type:n.type,location:e.getAttribLocation(t,s),locationSize:a}}return i}(r,f)),M},this.destroy=function(){n.releaseStatesOfProgram(this),r.deleteProgram(f),this.program=void 0},this.name=i.shaderName,this.id=Jr++,this.cacheKey=t,this.usedTimes=1,this.program=f,this.vertexShader=_,this.fragmentShader=b,this}function fs(e,t,i,n,r,s,a){const o=[],l=r.isWebGL2,c=r.logarithmicDepthBuffer,u=r.floatVertexTextures,h=r.maxVertexUniforms,d=r.vertexTextures;let p=r.precision;const m={MeshDepthMaterial:"depth",MeshDistanceMaterial:"distanceRGBA",MeshNormalMaterial:"normal",MeshBasicMaterial:"basic",MeshLambertMaterial:"lambert",MeshPhongMaterial:"phong",MeshToonMaterial:"toon",MeshStandardMaterial:"physical",MeshPhysicalMaterial:"physical",MeshMatcapMaterial:"matcap",LineBasicMaterial:"basic",LineDashedMaterial:"dashed",PointsMaterial:"points",ShadowMaterial:"shadow",SpriteMaterial:"sprite"},f=["precision","isWebGL2","supportsVertexTextures","outputEncoding","instancing","instancingColor","map","mapEncoding","matcap","matcapEncoding","envMap","envMapMode","envMapEncoding","envMapCubeUV","lightMap","lightMapEncoding","aoMap","emissiveMap","emissiveMapEncoding","bumpMap","normalMap","objectSpaceNormalMap","tangentSpaceNormalMap","clearcoat","clearcoatMap","clearcoatRoughnessMap","clearcoatNormalMap","displacementMap","specularMap","specularIntensityMap","specularTintMap","specularTintMapEncoding","roughnessMap","metalnessMap","gradientMap","alphaMap","alphaTest","combine","vertexColors","vertexAlphas","vertexTangents","vertexUvs","uvsVertexOnly","fog","useFog","fogExp2","flatShading","sizeAttenuation","logarithmicDepthBuffer","skinning","maxBones","useVertexTexture","morphTargets","morphNormals","morphTargetsCount","premultipliedAlpha","numDirLights","numPointLights","numSpotLights","numHemiLights","numRectAreaLights","numDirLightShadows","numPointLightShadows","numSpotLightShadows","shadowMapEnabled","shadowMapType","toneMapping","physicallyCorrectLights","doubleSided","flipSided","numClippingPlanes","numClipIntersection","depthPacking","dithering","format","sheen","transmission","transmissionMap","thicknessMap"];function g(e){let t;return t=e&&e.isTexture?e.encoding:e&&e.isWebGLRenderTarget?e.texture.encoding:3e3,l&&e&&e.isTexture&&1023===e.format&&1009===e.type&&3001===e.encoding&&(t=3e3),t}return{getParameters:function(s,o,f,v,y){const x=v.fog,_=s.isMeshStandardMaterial?v.environment:null,b=(s.isMeshStandardMaterial?i:t).get(s.envMap||_),w=m[s.type],M=y.isSkinnedMesh?function(e){const t=e.skeleton.bones;if(u)return 1024;{const e=h,i=Math.floor((e-20)/4),n=Math.min(i,t.length);return n<t.length?0:n}}(y):0;let S,T;if(null!==s.precision&&(p=r.getMaxPrecision(s.precision),s.precision),w){const e=rn[w];S=e.vertexShader,T=e.fragmentShader}else S=s.vertexShader,T=s.fragmentShader;const A=e.getRenderTarget(),C=s.alphaTest>0,L=s.clearcoat>0;return{isWebGL2:l,shaderID:w,shaderName:s.type,vertexShader:S,fragmentShader:T,defines:s.defines,isRawShaderMaterial:!0===s.isRawShaderMaterial,glslVersion:s.glslVersion,precision:p,instancing:!0===y.isInstancedMesh,instancingColor:!0===y.isInstancedMesh&&null!==y.instanceColor,supportsVertexTextures:d,outputEncoding:null!==A?g(A.texture):e.outputEncoding,map:!!s.map,mapEncoding:g(s.map),matcap:!!s.matcap,matcapEncoding:g(s.matcap),envMap:!!b,envMapMode:b&&b.mapping,envMapEncoding:g(b),envMapCubeUV:!!b&&(306===b.mapping||307===b.mapping),lightMap:!!s.lightMap,lightMapEncoding:g(s.lightMap),aoMap:!!s.aoMap,emissiveMap:!!s.emissiveMap,emissiveMapEncoding:g(s.emissiveMap),bumpMap:!!s.bumpMap,normalMap:!!s.normalMap,objectSpaceNormalMap:1===s.normalMapType,tangentSpaceNormalMap:0===s.normalMapType,clearcoat:L,clearcoatMap:L&&!!s.clearcoatMap,clearcoatRoughnessMap:L&&!!s.clearcoatRoughnessMap,clearcoatNormalMap:L&&!!s.clearcoatNormalMap,displacementMap:!!s.displacementMap,roughnessMap:!!s.roughnessMap,metalnessMap:!!s.metalnessMap,specularMap:!!s.specularMap,specularIntensityMap:!!s.specularIntensityMap,specularTintMap:!!s.specularTintMap,specularTintMapEncoding:g(s.specularTintMap),alphaMap:!!s.alphaMap,alphaTest:C,gradientMap:!!s.gradientMap,sheen:s.sheen>0,transmission:s.transmission>0,transmissionMap:!!s.transmissionMap,thicknessMap:!!s.thicknessMap,combine:s.combine,vertexTangents:!!s.normalMap&&!!y.geometry&&!!y.geometry.attributes.tangent,vertexColors:s.vertexColors,vertexAlphas:!0===s.vertexColors&&!!y.geometry&&!!y.geometry.attributes.color&&4===y.geometry.attributes.color.itemSize,vertexUvs:!!(s.map||s.bumpMap||s.normalMap||s.specularMap||s.alphaMap||s.emissiveMap||s.roughnessMap||s.metalnessMap||s.clearcoatMap||s.clearcoatRoughnessMap||s.clearcoatNormalMap||s.displacementMap||s.transmissionMap||s.thicknessMap||s.specularIntensityMap||s.specularTintMap),uvsVertexOnly:!(s.map||s.bumpMap||s.normalMap||s.specularMap||s.alphaMap||s.emissiveMap||s.roughnessMap||s.metalnessMap||s.clearcoatNormalMap||s.transmission>0||s.transmissionMap||s.thicknessMap||s.specularIntensityMap||s.specularTintMap||!s.displacementMap),fog:!!x,useFog:s.fog,fogExp2:x&&x.isFogExp2,flatShading:!!s.flatShading,sizeAttenuation:s.sizeAttenuation,logarithmicDepthBuffer:c,skinning:!0===y.isSkinnedMesh&&M>0,maxBones:M,useVertexTexture:u,morphTargets:!!y.geometry&&!!y.geometry.morphAttributes.position,morphNormals:!!y.geometry&&!!y.geometry.morphAttributes.normal,morphTargetsCount:y.geometry&&y.geometry.morphAttributes.position?y.geometry.morphAttributes.position.length:0,numDirLights:o.directional.length,numPointLights:o.point.length,numSpotLights:o.spot.length,numRectAreaLights:o.rectArea.length,numHemiLights:o.hemi.length,numDirLightShadows:o.directionalShadowMap.length,numPointLightShadows:o.pointShadowMap.length,numSpotLightShadows:o.spotShadowMap.length,numClippingPlanes:a.numPlanes,numClipIntersection:a.numIntersection,format:s.format,dithering:s.dithering,shadowMapEnabled:e.shadowMap.enabled&&f.length>0,shadowMapType:e.shadowMap.type,toneMapping:s.toneMapped?e.toneMapping:0,physicallyCorrectLights:e.physicallyCorrectLights,premultipliedAlpha:s.premultipliedAlpha,doubleSided:2===s.side,flipSided:1===s.side,depthPacking:void 0!==s.depthPacking&&s.depthPacking,index0AttributeName:s.index0AttributeName,extensionDerivatives:s.extensions&&s.extensions.derivatives,extensionFragDepth:s.extensions&&s.extensions.fragDepth,extensionDrawBuffers:s.extensions&&s.extensions.drawBuffers,extensionShaderTextureLOD:s.extensions&&s.extensions.shaderTextureLOD,rendererExtensionFragDepth:l||n.has("EXT_frag_depth"),rendererExtensionDrawBuffers:l||n.has("WEBGL_draw_buffers"),rendererExtensionShaderTextureLod:l||n.has("EXT_shader_texture_lod"),customProgramCacheKey:s.customProgramCacheKey()}},getProgramCacheKey:function(t){const i=[];if(t.shaderID?i.push(t.shaderID):(i.push(t.fragmentShader),i.push(t.vertexShader)),void 0!==t.defines)for(const e in t.defines)i.push(e),i.push(t.defines[e]);if(!1===t.isRawShaderMaterial){for(let e=0;e<f.length;e++)i.push(t[f[e]]);i.push(e.outputEncoding),i.push(e.gammaFactor)}return i.push(t.customProgramCacheKey),i.join()},getUniforms:function(e){const t=m[e.type];let i;if(t){const e=rn[t];i=Ui.clone(e.uniforms)}else i=e.uniforms;return i},acquireProgram:function(t,i){let n;for(let e=0,r=o.length;e<r;e++){const t=o[e];if(t.cacheKey===i){n=t,++n.usedTimes;break}}return void 0===n&&(n=new ms(e,i,t,s),o.push(n)),n},releaseProgram:function(e){if(0==--e.usedTimes){const t=o.indexOf(e);o[t]=o[o.length-1],o.pop(),e.destroy()}},programs:o}}function gs(){let e=new WeakMap;return{get:function(t){let i=e.get(t);return void 0===i&&(i={},e.set(t,i)),i},remove:function(t){e.delete(t)},update:function(t,i,n){e.get(t)[i]=n},dispose:function(){e=new WeakMap}}}function vs(e,t){return e.groupOrder!==t.groupOrder?e.groupOrder-t.groupOrder:e.renderOrder!==t.renderOrder?e.renderOrder-t.renderOrder:e.program!==t.program?e.program.id-t.program.id:e.material.id!==t.material.id?e.material.id-t.material.id:e.z!==t.z?e.z-t.z:e.id-t.id}function ys(e,t){return e.groupOrder!==t.groupOrder?e.groupOrder-t.groupOrder:e.renderOrder!==t.renderOrder?e.renderOrder-t.renderOrder:e.z!==t.z?t.z-e.z:e.id-t.id}function xs(e){const t=[];let i=0;const n=[],r=[],s=[],a={id:-1};function o(n,r,s,o,l,c){let u=t[i];const h=e.get(s);return void 0===u?(u={id:n.id,object:n,geometry:r,material:s,program:h.program||a,groupOrder:o,renderOrder:n.renderOrder,z:l,group:c},t[i]=u):(u.id=n.id,u.object=n,u.geometry=r,u.material=s,u.program=h.program||a,u.groupOrder=o,u.renderOrder=n.renderOrder,u.z=l,u.group=c),i++,u}return{opaque:n,transmissive:r,transparent:s,init:function(){i=0,n.length=0,r.length=0,s.length=0},push:function(e,t,i,a,l,c){const u=o(e,t,i,a,l,c);i.transmission>0?r.push(u):!0===i.transparent?s.push(u):n.push(u)},unshift:function(e,t,i,a,l,c){const u=o(e,t,i,a,l,c);i.transmission>0?r.unshift(u):!0===i.transparent?s.unshift(u):n.unshift(u)},finish:function(){for(let e=i,n=t.length;e<n;e++){const i=t[e];if(null===i.id)break;i.id=null,i.object=null,i.geometry=null,i.material=null,i.program=null,i.group=null}},sort:function(e,t){n.length>1&&n.sort(e||vs),r.length>1&&r.sort(t||ys),s.length>1&&s.sort(t||ys)}}}function _s(e){let t=new WeakMap;return{get:function(i,n){let r;return!1===t.has(i)?(r=new xs(e),t.set(i,[r])):n>=t.get(i).length?(r=new xs(e),t.get(i).push(r)):r=t.get(i)[n],r},dispose:function(){t=new WeakMap}}}function bs(){const e={};return{get:function(t){if(void 0!==e[t.id])return e[t.id];let i;switch(t.type){case"DirectionalLight":i={direction:new De,color:new $t};break;case"SpotLight":i={position:new De,direction:new De,color:new $t,distance:0,coneCos:0,penumbraCos:0,decay:0};break;case"PointLight":i={position:new De,color:new $t,distance:0,decay:0};break;case"HemisphereLight":i={direction:new De,skyColor:new $t,groundColor:new $t};break;case"RectAreaLight":i={color:new $t,position:new De,halfWidth:new De,halfHeight:new De}}return e[t.id]=i,i}}}let ws=0;function Ms(e,t){return(t.castShadow?1:0)-(e.castShadow?1:0)}function Ss(e,t){const i=new bs,n=function(){const e={};return{get:function(t){if(void 0!==e[t.id])return e[t.id];let i;switch(t.type){case"DirectionalLight":case"SpotLight":i={shadowBias:0,shadowNormalBias:0,shadowRadius:1,shadowMapSize:new xe};break;case"PointLight":i={shadowBias:0,shadowNormalBias:0,shadowRadius:1,shadowMapSize:new xe,shadowCameraNear:1,shadowCameraFar:1e3}}return e[t.id]=i,i}}}(),r={version:0,hash:{directionalLength:-1,pointLength:-1,spotLength:-1,rectAreaLength:-1,hemiLength:-1,numDirectionalShadows:-1,numPointShadows:-1,numSpotShadows:-1},ambient:[0,0,0],probe:[],directional:[],directionalShadow:[],directionalShadowMap:[],directionalShadowMatrix:[],spot:[],spotShadow:[],spotShadowMap:[],spotShadowMatrix:[],rectArea:[],rectAreaLTC1:null,rectAreaLTC2:null,point:[],pointShadow:[],pointShadowMap:[],pointShadowMatrix:[],hemi:[]};for(let l=0;l<9;l++)r.probe.push(new De);const s=new De,a=new lt,o=new lt;return{setup:function(s,a){let o=0,l=0,c=0;for(let e=0;e<9;e++)r.probe[e].set(0,0,0);let u=0,h=0,d=0,p=0,m=0,f=0,g=0,v=0;s.sort(Ms);const y=!0!==a?Math.PI:1;for(let e=0,t=s.length;e<t;e++){const t=s[e],a=t.color,x=t.intensity,_=t.distance,b=t.shadow&&t.shadow.map?t.shadow.map.texture:null;if(t.isAmbientLight)o+=a.r*x*y,l+=a.g*x*y,c+=a.b*x*y;else if(t.isLightProbe)for(let e=0;e<9;e++)r.probe[e].addScaledVector(t.sh.coefficients[e],x);else if(t.isDirectionalLight){const e=i.get(t);if(e.color.copy(t.color).multiplyScalar(t.intensity*y),t.castShadow){const e=t.shadow,i=n.get(t);i.shadowBias=e.bias,i.shadowNormalBias=e.normalBias,i.shadowRadius=e.radius,i.shadowMapSize=e.mapSize,r.directionalShadow[u]=i,r.directionalShadowMap[u]=b,r.directionalShadowMatrix[u]=t.shadow.matrix,f++}r.directional[u]=e,u++}else if(t.isSpotLight){const e=i.get(t);if(e.position.setFromMatrixPosition(t.matrixWorld),e.color.copy(a).multiplyScalar(x*y),e.distance=_,e.coneCos=Math.cos(t.angle),e.penumbraCos=Math.cos(t.angle*(1-t.penumbra)),e.decay=t.decay,t.castShadow){const e=t.shadow,i=n.get(t);i.shadowBias=e.bias,i.shadowNormalBias=e.normalBias,i.shadowRadius=e.radius,i.shadowMapSize=e.mapSize,r.spotShadow[d]=i,r.spotShadowMap[d]=b,r.spotShadowMatrix[d]=t.shadow.matrix,v++}r.spot[d]=e,d++}else if(t.isRectAreaLight){const e=i.get(t);e.color.copy(a).multiplyScalar(x),e.halfWidth.set(.5*t.width,0,0),e.halfHeight.set(0,.5*t.height,0),r.rectArea[p]=e,p++}else if(t.isPointLight){const e=i.get(t);if(e.color.copy(t.color).multiplyScalar(t.intensity*y),e.distance=t.distance,e.decay=t.decay,t.castShadow){const e=t.shadow,i=n.get(t);i.shadowBias=e.bias,i.shadowNormalBias=e.normalBias,i.shadowRadius=e.radius,i.shadowMapSize=e.mapSize,i.shadowCameraNear=e.camera.near,i.shadowCameraFar=e.camera.far,r.pointShadow[h]=i,r.pointShadowMap[h]=b,r.pointShadowMatrix[h]=t.shadow.matrix,g++}r.point[h]=e,h++}else if(t.isHemisphereLight){const e=i.get(t);e.skyColor.copy(t.color).multiplyScalar(x*y),e.groundColor.copy(t.groundColor).multiplyScalar(x*y),r.hemi[m]=e,m++}}p>0&&(t.isWebGL2||!0===e.has("OES_texture_float_linear")?(r.rectAreaLTC1=nn.LTC_FLOAT_1,r.rectAreaLTC2=nn.LTC_FLOAT_2):!0===e.has("OES_texture_half_float_linear")&&(r.rectAreaLTC1=nn.LTC_HALF_1,r.rectAreaLTC2=nn.LTC_HALF_2)),r.ambient[0]=o,r.ambient[1]=l,r.ambient[2]=c;const x=r.hash;x.directionalLength===u&&x.pointLength===h&&x.spotLength===d&&x.rectAreaLength===p&&x.hemiLength===m&&x.numDirectionalShadows===f&&x.numPointShadows===g&&x.numSpotShadows===v||(r.directional.length=u,r.spot.length=d,r.rectArea.length=p,r.point.length=h,r.hemi.length=m,r.directionalShadow.length=f,r.directionalShadowMap.length=f,r.pointShadow.length=g,r.pointShadowMap.length=g,r.spotShadow.length=v,r.spotShadowMap.length=v,r.directionalShadowMatrix.length=f,r.pointShadowMatrix.length=g,r.spotShadowMatrix.length=v,x.directionalLength=u,x.pointLength=h,x.spotLength=d,x.rectAreaLength=p,x.hemiLength=m,x.numDirectionalShadows=f,x.numPointShadows=g,x.numSpotShadows=v,r.version=ws++)},setupView:function(e,t){let i=0,n=0,l=0,c=0,u=0;const h=t.matrixWorldInverse;for(let d=0,p=e.length;d<p;d++){const t=e[d];if(t.isDirectionalLight){const e=r.directional[i];e.direction.setFromMatrixPosition(t.matrixWorld),s.setFromMatrixPosition(t.target.matrixWorld),e.direction.sub(s),e.direction.transformDirection(h),i++}else if(t.isSpotLight){const e=r.spot[l];e.position.setFromMatrixPosition(t.matrixWorld),e.position.applyMatrix4(h),e.direction.setFromMatrixPosition(t.matrixWorld),s.setFromMatrixPosition(t.target.matrixWorld),e.direction.sub(s),e.direction.transformDirection(h),l++}else if(t.isRectAreaLight){const e=r.rectArea[c];e.position.setFromMatrixPosition(t.matrixWorld),e.position.applyMatrix4(h),o.identity(),a.copy(t.matrixWorld),a.premultiply(h),o.extractRotation(a),e.halfWidth.set(.5*t.width,0,0),e.halfHeight.set(0,.5*t.height,0),e.halfWidth.applyMatrix4(o),e.halfHeight.applyMatrix4(o),c++}else if(t.isPointLight){const e=r.point[n];e.position.setFromMatrixPosition(t.matrixWorld),e.position.applyMatrix4(h),n++}else if(t.isHemisphereLight){const e=r.hemi[u];e.direction.setFromMatrixPosition(t.matrixWorld),e.direction.transformDirection(h),e.direction.normalize(),u++}}},state:r}}function Ts(e,t){const i=new Ss(e,t),n=[],r=[];return{init:function(){n.length=0,r.length=0},state:{lightsArray:n,shadowsArray:r,lights:i},setupLights:function(e){i.setup(n,e)},setupLightsView:function(e){i.setupView(n,e)},pushLight:function(e){n.push(e)},pushShadow:function(e){r.push(e)}}}function As(e,t){let i=new WeakMap;return{get:function(n,r=0){let s;return!1===i.has(n)?(s=new Ts(e,t),i.set(n,[s])):r>=i.get(n).length?(s=new Ts(e,t),i.get(n).push(s)):s=i.get(n)[r],s},dispose:function(){i=new WeakMap}}}class Cs extends qt{constructor(e){super(),this.type="MeshDepthMaterial",this.depthPacking=3200,this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.setValues(e)}copy(e){return super.copy(e),this.depthPacking=e.depthPacking,this.map=e.map,this.alphaMap=e.alphaMap,this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this}}Cs.prototype.isMeshDepthMaterial=!0;class Ls extends qt{constructor(e){super(),this.type="MeshDistanceMaterial",this.referencePosition=new De,this.nearDistance=1,this.farDistance=1e3,this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.fog=!1,this.setValues(e)}copy(e){return super.copy(e),this.referencePosition.copy(e.referencePosition),this.nearDistance=e.nearDistance,this.farDistance=e.farDistance,this.map=e.map,this.alphaMap=e.alphaMap,this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this}}Ls.prototype.isMeshDistanceMaterial=!0;function Ps(e,t,i){let n=new Qi;const r=new xe,s=new xe,a=new Ce,o=new Cs({depthPacking:3201}),l=new Ls,c={},u=i.maxTextureSize,h={0:1,1:0,2:2},d=new ki({uniforms:{shadow_pass:{value:null},resolution:{value:new xe},radius:{value:4},samples:{value:8}},vertexShader:"void main(){gl_Position=vec4(position,1.0);}",fragmentShader:"uniform sampler2D shadow_pass;uniform vec2 resolution;uniform float radius;uniform float samples;\n#include <packing>\nvoid main(){float mean=0.0;float squared_mean=0.0;float uvStride=samples<=1.0?0.0:2.0/(samples-1.0);float uvStart=samples<=1.0?0.0:-1.0;for(float i=0.0;i<samples;i++){float uvOffset=uvStart+i*uvStride;\n#ifdef HORIZONTAL_PASS\nvec2 distribution=unpackRGBATo2Half(texture2D(shadow_pass,(gl_FragCoord.xy+vec2(uvOffset,0.0)*radius)/resolution));mean+=distribution.x;squared_mean+=distribution.y*distribution.y+distribution.x*distribution.x;\n#else\nfloat depth=unpackRGBAToDepth(texture2D(shadow_pass,(gl_FragCoord.xy+vec2(0.0,uvOffset)*radius)/resolution));mean+=depth;squared_mean+=depth*depth;\n#endif\n}mean=mean/samples;squared_mean=squared_mean/samples;float std_dev=sqrt(squared_mean-mean*mean);gl_FragColor=pack2HalfToRGBA(vec2(mean,std_dev));}"}),p=d.clone();p.defines.HORIZONTAL_PASS=1;const m=new fi;m.setAttribute("position",new ni(new Float32Array([-1,-1,.5,3,-1,.5,-1,3,.5]),3));const f=new Ri(m,d),g=this;function v(i,n){const r=t.update(f);d.uniforms.shadow_pass.value=i.map.texture,d.uniforms.resolution.value=i.mapSize,d.uniforms.radius.value=i.radius,d.uniforms.samples.value=i.blurSamples,e.setRenderTarget(i.mapPass),e.clear(),e.renderBufferDirect(n,null,r,d,f,null),p.uniforms.shadow_pass.value=i.mapPass.texture,p.uniforms.resolution.value=i.mapSize,p.uniforms.radius.value=i.radius,p.uniforms.samples.value=i.blurSamples,e.setRenderTarget(i.map),e.clear(),e.renderBufferDirect(n,null,r,p,f,null)}function y(t,i,n,r,s,a,u){let d=null;const p=!0===r.isPointLight?t.customDistanceMaterial:t.customDepthMaterial;if(d=void 0!==p?p:!0===r.isPointLight?l:o,e.localClippingEnabled&&!0===n.clipShadows&&0!==n.clippingPlanes.length||n.displacementMap&&0!==n.displacementScale||n.alphaMap&&n.alphaTest>0){const e=d.uuid,t=n.uuid;let i=c[e];void 0===i&&(i={},c[e]=i);let r=i[t];void 0===r&&(r=d.clone(),i[t]=r),d=r}return d.visible=n.visible,d.wireframe=n.wireframe,d.side=3===u?null!==n.shadowSide?n.shadowSide:n.side:null!==n.shadowSide?n.shadowSide:h[n.side],d.alphaMap=n.alphaMap,d.alphaTest=n.alphaTest,d.clipShadows=n.clipShadows,d.clippingPlanes=n.clippingPlanes,d.clipIntersection=n.clipIntersection,d.displacementMap=n.displacementMap,d.displacementScale=n.displacementScale,d.displacementBias=n.displacementBias,d.wireframeLinewidth=n.wireframeLinewidth,d.linewidth=n.linewidth,!0===r.isPointLight&&!0===d.isMeshDistanceMaterial&&(d.referencePosition.setFromMatrixPosition(r.matrixWorld),d.nearDistance=s,d.farDistance=a),d}function x(i,r,s,a,o){if(!1===i.visible)return;if(i.layers.test(r.layers)&&(i.isMesh||i.isLine||i.isPoints)&&(i.castShadow||i.receiveShadow&&3===o)&&(!i.frustumCulled||n.intersectsObject(i))){i.modelViewMatrix.multiplyMatrices(s.matrixWorldInverse,i.matrixWorld);const n=t.update(i),r=i.material;if(Array.isArray(r)){const t=n.groups;for(let l=0,c=t.length;l<c;l++){const c=t[l],u=r[c.materialIndex];if(u&&u.visible){const t=y(i,0,u,a,s.near,s.far,o);e.renderBufferDirect(s,null,n,t,i,c)}}}else if(r.visible){const t=y(i,0,r,a,s.near,s.far,o);e.renderBufferDirect(s,null,n,t,i,null)}}const l=i.children;for(let e=0,t=l.length;e<t;e++)x(l[e],r,s,a,o)}this.enabled=!1,this.autoUpdate=!0,this.needsUpdate=!1,this.type=1,this.render=function(t,i,o){if(!1===g.enabled)return;if(!1===g.autoUpdate&&!1===g.needsUpdate)return;if(0===t.length)return;const l=e.getRenderTarget(),c=e.getActiveCubeFace(),h=e.getActiveMipmapLevel(),d=e.state;d.setBlending(0),d.buffers.color.setClear(1,1,1,1),d.buffers.depth.setTest(!0),d.setScissorTest(!1);for(let p=0,m=t.length;p<m;p++){const l=t[p],c=l.shadow;if(void 0===c)continue;if(!1===c.autoUpdate&&!1===c.needsUpdate)continue;r.copy(c.mapSize);const h=c.getFrameExtents();if(r.multiply(h),s.copy(c.mapSize),(r.x>u||r.y>u)&&(r.x>u&&(s.x=Math.floor(u/h.x),r.x=s.x*h.x,c.mapSize.x=s.x),r.y>u&&(s.y=Math.floor(u/h.y),r.y=s.y*h.y,c.mapSize.y=s.y)),null===c.map&&!c.isPointLightShadow&&3===this.type){const e={minFilter:1006,magFilter:1006,format:1023};c.map=new Le(r.x,r.y,e),c.map.texture.name=l.name+".shadowMap",c.mapPass=new Le(r.x,r.y,e),c.camera.updateProjectionMatrix()}if(null===c.map){const e={minFilter:1003,magFilter:1003,format:1023};c.map=new Le(r.x,r.y,e),c.map.texture.name=l.name+".shadowMap",c.camera.updateProjectionMatrix()}e.setRenderTarget(c.map),e.clear();const m=c.getViewportCount();for(let e=0;e<m;e++){const t=c.getViewport(e);a.set(s.x*t.x,s.y*t.y,s.x*t.z,s.y*t.w),d.viewport(a),c.updateMatrices(l,e),n=c.getFrustum(),x(i,o,c.camera,l,this.type)}c.isPointLightShadow||3!==this.type||v(c,o),c.needsUpdate=!1}g.needsUpdate=!1,e.setRenderTarget(l,c,h)}}function Es(e,t,i){const n=i.isWebGL2;const r=new function(){let t=!1;const i=new Ce;let n=null;const r=new Ce(0,0,0,0);return{setMask:function(i){n===i||t||(e.colorMask(i,i,i,i),n=i)},setLocked:function(e){t=e},setClear:function(t,n,s,a,o){!0===o&&(t*=a,n*=a,s*=a),i.set(t,n,s,a),!1===r.equals(i)&&(e.clearColor(t,n,s,a),r.copy(i))},reset:function(){t=!1,n=null,r.set(-1,0,0,0)}}},s=new function(){let t=!1,i=null,n=null,r=null;return{setTest:function(e){e?F(2929):U(2929)},setMask:function(n){i===n||t||(e.depthMask(n),i=n)},setFunc:function(t){if(n!==t){if(t)switch(t){case 0:e.depthFunc(512);break;case 1:e.depthFunc(519);break;case 2:e.depthFunc(513);break;case 3:default:e.depthFunc(515);break;case 4:e.depthFunc(514);break;case 5:e.depthFunc(518);break;case 6:e.depthFunc(516);break;case 7:e.depthFunc(517)}else e.depthFunc(515);n=t}},setLocked:function(e){t=e},setClear:function(t){r!==t&&(e.clearDepth(t),r=t)},reset:function(){t=!1,i=null,n=null,r=null}}},a=new function(){let t=!1,i=null,n=null,r=null,s=null,a=null,o=null,l=null,c=null;return{setTest:function(e){t||(e?F(2960):U(2960))},setMask:function(n){i===n||t||(e.stencilMask(n),i=n)},setFunc:function(t,i,a){n===t&&r===i&&s===a||(e.stencilFunc(t,i,a),n=t,r=i,s=a)},setOp:function(t,i,n){a===t&&o===i&&l===n||(e.stencilOp(t,i,n),a=t,o=i,l=n)},setLocked:function(e){t=e},setClear:function(t){c!==t&&(e.clearStencil(t),c=t)},reset:function(){t=!1,i=null,n=null,r=null,s=null,a=null,o=null,l=null,c=null}}};let o={},l=null,c={},u=null,h=!1,d=null,p=null,m=null,f=null,g=null,v=null,y=null,x=!1,_=null,b=null,w=null,M=null,S=null;const T=e.getParameter(35661);let A=!1,C=0;const L=e.getParameter(7938);-1!==L.indexOf("WebGL")?(C=parseFloat(/^WebGL (\d)/.exec(L)[1]),A=C>=1):-1!==L.indexOf("OpenGL ES")&&(C=parseFloat(/^OpenGL ES (\d)/.exec(L)[1]),A=C>=2);let P=null,E={};const D=e.getParameter(3088),I=e.getParameter(2978),R=(new Ce).fromArray(D),z=(new Ce).fromArray(I);function N(t,i,n){const r=new Uint8Array(4),s=e.createTexture();e.bindTexture(t,s),e.texParameteri(t,10241,9728),e.texParameteri(t,10240,9728);for(let a=0;a<n;a++)e.texImage2D(i+a,0,6408,1,1,0,6408,5121,r);return s}const O={};function F(t){!0!==o[t]&&(e.enable(t),o[t]=!0)}function U(t){!1!==o[t]&&(e.disable(t),o[t]=!1)}O[3553]=N(3553,3553,1),O[34067]=N(34067,34069,6),r.setClear(0,0,0,1),s.setClear(1),a.setClear(0),F(2929),s.setFunc(3),G(!1),W(1),F(2884),V(0);const k={100:32774,101:32778,102:32779};if(n)k[103]=32775,k[104]=32776;else{const e=t.get("EXT_blend_minmax");null!==e&&(k[103]=e.MIN_EXT,k[104]=e.MAX_EXT)}const B={200:0,201:1,202:768,204:770,210:776,208:774,206:772,203:769,205:771,209:775,207:773};function V(t,i,n,r,s,a,o,l){if(0!==t){if(!1===h&&(F(3042),h=!0),5===t)s=s||i,a=a||n,o=o||r,i===p&&s===g||(e.blendEquationSeparate(k[i],k[s]),p=i,g=s),n===m&&r===f&&a===v&&o===y||(e.blendFuncSeparate(B[n],B[r],B[a],B[o]),m=n,f=r,v=a,y=o),d=t,x=null;else if(t!==d||l!==x){if(100===p&&100===g||(e.blendEquation(32774),p=100,g=100),l)switch(t){case 1:e.blendFuncSeparate(1,771,1,771);break;case 2:e.blendFunc(1,1);break;case 3:e.blendFuncSeparate(0,0,769,771);break;case 4:e.blendFuncSeparate(0,768,0,770)}else switch(t){case 1:e.blendFuncSeparate(770,771,1,771);break;case 2:e.blendFunc(770,1);break;case 3:e.blendFunc(0,769);break;case 4:e.blendFunc(0,768)}m=null,f=null,v=null,y=null,d=t,x=l}}else!0===h&&(U(3042),h=!1)}function G(t){_!==t&&(t?e.frontFace(2304):e.frontFace(2305),_=t)}function W(t){0!==t?(F(2884),t!==b&&(1===t?e.cullFace(1029):2===t?e.cullFace(1028):e.cullFace(1032))):U(2884),b=t}function H(t,i,n){t?(F(32823),M===i&&S===n||(e.polygonOffset(i,n),M=i,S=n)):U(32823)}function j(t){void 0===t&&(t=33984+T-1),P!==t&&(e.activeTexture(t),P=t)}return{buffers:{color:r,depth:s,stencil:a},enable:F,disable:U,bindFramebuffer:function(t,i){return null===i&&null!==l&&(i=l),c[t]!==i&&(e.bindFramebuffer(t,i),c[t]=i,n&&(36009===t&&(c[36160]=i),36160===t&&(c[36009]=i)),!0)},bindXRFramebuffer:function(t){t!==l&&(e.bindFramebuffer(36160,t),l=t)},useProgram:function(t){return u!==t&&(e.useProgram(t),u=t,!0)},setBlending:V,setMaterial:function(e,t){2===e.side?U(2884):F(2884);let i=1===e.side;t&&(i=!i),G(i),1===e.blending&&!1===e.transparent?V(0):V(e.blending,e.blendEquation,e.blendSrc,e.blendDst,e.blendEquationAlpha,e.blendSrcAlpha,e.blendDstAlpha,e.premultipliedAlpha),s.setFunc(e.depthFunc),s.setTest(e.depthTest),s.setMask(e.depthWrite),r.setMask(e.colorWrite);const n=e.stencilWrite;a.setTest(n),n&&(a.setMask(e.stencilWriteMask),a.setFunc(e.stencilFunc,e.stencilRef,e.stencilFuncMask),a.setOp(e.stencilFail,e.stencilZFail,e.stencilZPass)),H(e.polygonOffset,e.polygonOffsetFactor,e.polygonOffsetUnits),!0===e.alphaToCoverage?F(32926):U(32926)},setFlipSided:G,setCullFace:W,setLineWidth:function(t){t!==w&&(A&&e.lineWidth(t),w=t)},setPolygonOffset:H,setScissorTest:function(e){e?F(3089):U(3089)},activeTexture:j,bindTexture:function(t,i){null===P&&j();let n=E[P];void 0===n&&(n={type:void 0,texture:void 0},E[P]=n),n.type===t&&n.texture===i||(e.bindTexture(t,i||O[t]),n.type=t,n.texture=i)},unbindTexture:function(){const t=E[P];void 0!==t&&void 0!==t.type&&(e.bindTexture(t.type,null),t.type=void 0,t.texture=void 0)},compressedTexImage2D:function(){try{e.compressedTexImage2D.apply(e,arguments)}catch(t){}},texImage2D:function(){try{e.texImage2D.apply(e,arguments)}catch(t){}},texImage3D:function(){try{e.texImage3D.apply(e,arguments)}catch(t){}},scissor:function(t){!1===R.equals(t)&&(e.scissor(t.x,t.y,t.z,t.w),R.copy(t))},viewport:function(t){!1===z.equals(t)&&(e.viewport(t.x,t.y,t.z,t.w),z.copy(t))},reset:function(){e.disable(3042),e.disable(2884),e.disable(2929),e.disable(32823),e.disable(3089),e.disable(2960),e.disable(32926),e.blendEquation(32774),e.blendFunc(1,0),e.blendFuncSeparate(1,0,1,0),e.colorMask(!0,!0,!0,!0),e.clearColor(0,0,0,0),e.depthMask(!0),e.depthFunc(513),e.clearDepth(1),e.stencilMask(4294967295),e.stencilFunc(519,0,4294967295),e.stencilOp(7680,7680,7680),e.clearStencil(0),e.cullFace(1029),e.frontFace(2305),e.polygonOffset(0,0),e.activeTexture(33984),e.bindFramebuffer(36160,null),!0===n&&(e.bindFramebuffer(36009,null),e.bindFramebuffer(36008,null)),e.useProgram(null),e.lineWidth(1),e.scissor(0,0,e.canvas.width,e.canvas.height),e.viewport(0,0,e.canvas.width,e.canvas.height),o={},P=null,E={},l=null,c={},u=null,h=!1,d=null,p=null,m=null,f=null,g=null,v=null,y=null,x=!1,_=null,b=null,w=null,M=null,S=null,R.set(0,0,e.canvas.width,e.canvas.height),z.set(0,0,e.canvas.width,e.canvas.height),r.reset(),s.reset(),a.reset()}}}function Ds(e,t,i,n,r,s,a){const o=r.isWebGL2,l=(r.maxTextures,r.maxCubemapSize),c=r.maxTextureSize,u=r.maxSamples,h=new WeakMap;let d,p=!1;try{p="undefined"!=typeof OffscreenCanvas&&null!==new OffscreenCanvas(1,1).getContext("2d")}catch(F){}function m(e,t){return p?new OffscreenCanvas(e,t):we("canvas")}function f(e,t,i,n){let r=1;if((e.width>n||e.height>n)&&(r=n/Math.max(e.width,e.height)),r<1||!0===t){if("undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap){const n=t?ye:Math.floor,s=n(r*e.width),a=n(r*e.height);void 0===d&&(d=m(s,a));const o=i?m(s,a):d;o.width=s,o.height=a;return o.getContext("2d").drawImage(e,0,0,s,a),o}return e}return e}function g(e){return ve(e.width)&&ve(e.height)}function v(e,t){return e.generateMipmaps&&t&&1003!==e.minFilter&&1006!==e.minFilter}function y(t,i,r,s,a=1){e.generateMipmap(t);n.get(i).__maxMipLevel=Math.log2(Math.max(r,s,a))}function x(i,n,r,s){if(!1===o)return n;if(null!==i&&void 0!==e[i])return e[i];let a=n;return 6403===n&&(5126===r&&(a=33326),5131===r&&(a=33325),5121===r&&(a=33321)),6407===n&&(5126===r&&(a=34837),5131===r&&(a=34843),5121===r&&(a=32849)),6408===n&&(5126===r&&(a=34836),5131===r&&(a=34842),5121===r&&(a=3001===s?35907:32856)),33325!==a&&33326!==a&&34842!==a&&34836!==a||t.get("EXT_color_buffer_float"),a}function _(e){return 1003===e||1004===e||1005===e?9728:9729}function b(t){const i=t.target;i.removeEventListener("dispose",b),function(t){const i=n.get(t);if(void 0===i.__webglInit)return;e.deleteTexture(i.__webglTexture),n.remove(t)}(i),i.isVideoTexture&&h.delete(i),a.memory.textures--}function w(t){const i=t.target;i.removeEventListener("dispose",w),function(t){const i=t.texture,r=n.get(t),s=n.get(i);if(!t)return;void 0!==s.__webglTexture&&(e.deleteTexture(s.__webglTexture),a.memory.textures--);t.depthTexture&&t.depthTexture.dispose();if(t.isWebGLCubeRenderTarget)for(let n=0;n<6;n++)e.deleteFramebuffer(r.__webglFramebuffer[n]),r.__webglDepthbuffer&&e.deleteRenderbuffer(r.__webglDepthbuffer[n]);else e.deleteFramebuffer(r.__webglFramebuffer),r.__webglDepthbuffer&&e.deleteRenderbuffer(r.__webglDepthbuffer),r.__webglMultisampledFramebuffer&&e.deleteFramebuffer(r.__webglMultisampledFramebuffer),r.__webglColorRenderbuffer&&e.deleteRenderbuffer(r.__webglColorRenderbuffer),r.__webglDepthRenderbuffer&&e.deleteRenderbuffer(r.__webglDepthRenderbuffer);if(t.isWebGLMultipleRenderTargets)for(let o=0,l=i.length;o<l;o++){const t=n.get(i[o]);t.__webglTexture&&(e.deleteTexture(t.__webglTexture),a.memory.textures--),n.remove(i[o])}n.remove(i),n.remove(t)}(i)}let M=0;function S(e,t){const r=n.get(e);if(e.isVideoTexture&&function(e){const t=a.render.frame;h.get(e)!==t&&(h.set(e,t),e.update())}(e),e.version>0&&r.__version!==e.version){const i=e.image;if(void 0===i);else if(!1!==i.complete)return void E(r,e,t)}i.activeTexture(33984+t),i.bindTexture(3553,r.__webglTexture)}function T(t,r){const a=n.get(t);t.version>0&&a.__version!==t.version?function(t,n,r){if(6!==n.image.length)return;P(t,n),i.activeTexture(33984+r),i.bindTexture(34067,t.__webglTexture),e.pixelStorei(37440,n.flipY),e.pixelStorei(37441,n.premultiplyAlpha),e.pixelStorei(3317,n.unpackAlignment),e.pixelStorei(37443,0);const a=n&&(n.isCompressedTexture||n.image[0].isCompressedTexture),c=n.image[0]&&n.image[0].isDataTexture,u=[];for(let e=0;e<6;e++)u[e]=a||c?c?n.image[e].image:n.image[e]:f(n.image[e],!1,!0,l);const h=u[0],d=g(h)||o,p=s.convert(n.format),m=s.convert(n.type),_=x(n.internalFormat,p,m,n.encoding);let b;if(L(34067,n,d),a){for(let e=0;e<6;e++){b=u[e].mipmaps;for(let t=0;t<b.length;t++){const r=b[t];1023!==n.format&&1022!==n.format?null!==p&&i.compressedTexImage2D(34069+e,t,_,r.width,r.height,0,r.data):i.texImage2D(34069+e,t,_,r.width,r.height,0,p,m,r.data)}}t.__maxMipLevel=b.length-1}else{b=n.mipmaps;for(let e=0;e<6;e++)if(c){i.texImage2D(34069+e,0,_,u[e].width,u[e].height,0,p,m,u[e].data);for(let t=0;t<b.length;t++){const n=b[t].image[e].image;i.texImage2D(34069+e,t+1,_,n.width,n.height,0,p,m,n.data)}}else{i.texImage2D(34069+e,0,_,p,m,u[e]);for(let t=0;t<b.length;t++){const n=b[t];i.texImage2D(34069+e,t+1,_,p,m,n.image[e])}}t.__maxMipLevel=b.length}v(n,d)&&y(34067,n,h.width,h.height);t.__version=n.version,n.onUpdate&&n.onUpdate(n)}(a,t,r):(i.activeTexture(33984+r),i.bindTexture(34067,a.__webglTexture))}const A={1e3:10497,1001:33071,1002:33648},C={1003:9728,1004:9984,1005:9986,1006:9729,1007:9985,1008:9987};function L(i,s,a){if(a?(e.texParameteri(i,10242,A[s.wrapS]),e.texParameteri(i,10243,A[s.wrapT]),32879!==i&&35866!==i||e.texParameteri(i,32882,A[s.wrapR]),e.texParameteri(i,10240,C[s.magFilter]),e.texParameteri(i,10241,C[s.minFilter])):(e.texParameteri(i,10242,33071),e.texParameteri(i,10243,33071),32879!==i&&35866!==i||e.texParameteri(i,32882,33071),1001!==s.wrapS||s.wrapT,e.texParameteri(i,10240,_(s.magFilter)),e.texParameteri(i,10241,_(s.minFilter)),1003!==s.minFilter&&s.minFilter),!0===t.has("EXT_texture_filter_anisotropic")){const a=t.get("EXT_texture_filter_anisotropic");if(1015===s.type&&!1===t.has("OES_texture_float_linear"))return;if(!1===o&&1016===s.type&&!1===t.has("OES_texture_half_float_linear"))return;(s.anisotropy>1||n.get(s).__currentAnisotropy)&&(e.texParameterf(i,a.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(s.anisotropy,r.getMaxAnisotropy())),n.get(s).__currentAnisotropy=s.anisotropy)}}function P(t,i){void 0===t.__webglInit&&(t.__webglInit=!0,i.addEventListener("dispose",b),t.__webglTexture=e.createTexture(),a.memory.textures++)}function E(t,n,r){let a=3553;n.isDataTexture2DArray&&(a=35866),n.isDataTexture3D&&(a=32879),P(t,n),i.activeTexture(33984+r),i.bindTexture(a,t.__webglTexture),e.pixelStorei(37440,n.flipY),e.pixelStorei(37441,n.premultiplyAlpha),e.pixelStorei(3317,n.unpackAlignment),e.pixelStorei(37443,0);const l=function(e){return!o&&(1001!==e.wrapS||1001!==e.wrapT||1003!==e.minFilter&&1006!==e.minFilter)}(n)&&!1===g(n.image),u=f(n.image,l,!1,c),h=g(u)||o,d=s.convert(n.format);let p,m=s.convert(n.type),_=x(n.internalFormat,d,m,n.encoding);L(a,n,h);const b=n.mipmaps;if(n.isDepthTexture)_=6402,o?_=1015===n.type?36012:1014===n.type?33190:1020===n.type?35056:33189:n.type,1026===n.format&&6402===_&&1012!==n.type&&1014!==n.type&&(n.type=1012,m=s.convert(n.type)),1027===n.format&&6402===_&&(_=34041,1020!==n.type&&(n.type=1020,m=s.convert(n.type))),i.texImage2D(3553,0,_,u.width,u.height,0,d,m,null);else if(n.isDataTexture)if(b.length>0&&h){for(let e=0,t=b.length;e<t;e++)p=b[e],i.texImage2D(3553,e,_,p.width,p.height,0,d,m,p.data);n.generateMipmaps=!1,t.__maxMipLevel=b.length-1}else i.texImage2D(3553,0,_,u.width,u.height,0,d,m,u.data),t.__maxMipLevel=0;else if(n.isCompressedTexture){for(let e=0,t=b.length;e<t;e++)p=b[e],1023!==n.format&&1022!==n.format?null!==d&&i.compressedTexImage2D(3553,e,_,p.width,p.height,0,p.data):i.texImage2D(3553,e,_,p.width,p.height,0,d,m,p.data);t.__maxMipLevel=b.length-1}else if(n.isDataTexture2DArray)i.texImage3D(35866,0,_,u.width,u.height,u.depth,0,d,m,u.data),t.__maxMipLevel=0;else if(n.isDataTexture3D)i.texImage3D(32879,0,_,u.width,u.height,u.depth,0,d,m,u.data),t.__maxMipLevel=0;else if(b.length>0&&h){for(let e=0,t=b.length;e<t;e++)p=b[e],i.texImage2D(3553,e,_,d,m,p);n.generateMipmaps=!1,t.__maxMipLevel=b.length-1}else i.texImage2D(3553,0,_,d,m,u),t.__maxMipLevel=0;v(n,h)&&y(a,n,u.width,u.height),t.__version=n.version,n.onUpdate&&n.onUpdate(n)}function D(t,r,a,o,l){const c=s.convert(a.format),u=s.convert(a.type),h=x(a.internalFormat,c,u,a.encoding);32879===l||35866===l?i.texImage3D(l,0,h,r.width,r.height,r.depth,0,c,u,null):i.texImage2D(l,0,h,r.width,r.height,0,c,u,null),i.bindFramebuffer(36160,t),e.framebufferTexture2D(36160,o,l,n.get(a).__webglTexture,0),i.bindFramebuffer(36160,null)}function I(t,i,n){if(e.bindRenderbuffer(36161,t),i.depthBuffer&&!i.stencilBuffer){let r=33189;if(n){const t=i.depthTexture;t&&t.isDepthTexture&&(1015===t.type?r=36012:1014===t.type&&(r=33190));const n=z(i);e.renderbufferStorageMultisample(36161,n,r,i.width,i.height)}else e.renderbufferStorage(36161,r,i.width,i.height);e.framebufferRenderbuffer(36160,36096,36161,t)}else if(i.depthBuffer&&i.stencilBuffer){if(n){const t=z(i);e.renderbufferStorageMultisample(36161,t,35056,i.width,i.height)}else e.renderbufferStorage(36161,34041,i.width,i.height);e.framebufferRenderbuffer(36160,33306,36161,t)}else{const t=!0===i.isWebGLMultipleRenderTargets?i.texture[0]:i.texture,r=s.convert(t.format),a=s.convert(t.type),o=x(t.internalFormat,r,a,t.encoding);if(n){const t=z(i);e.renderbufferStorageMultisample(36161,t,o,i.width,i.height)}else e.renderbufferStorage(36161,o,i.width,i.height)}e.bindRenderbuffer(36161,null)}function R(t){const r=n.get(t),s=!0===t.isWebGLCubeRenderTarget;if(t.depthTexture){if(s)throw new Error("target.depthTexture not supported in Cube render targets");!function(t,r){if(r&&r.isWebGLCubeRenderTarget)throw new Error("Depth Texture with cube render targets is not supported");if(i.bindFramebuffer(36160,t),!r.depthTexture||!r.depthTexture.isDepthTexture)throw new Error("renderTarget.depthTexture must be an instance of THREE.DepthTexture");n.get(r.depthTexture).__webglTexture&&r.depthTexture.image.width===r.width&&r.depthTexture.image.height===r.height||(r.depthTexture.image.width=r.width,r.depthTexture.image.height=r.height,r.depthTexture.needsUpdate=!0),S(r.depthTexture,0);const s=n.get(r.depthTexture).__webglTexture;if(1026===r.depthTexture.format)e.framebufferTexture2D(36160,36096,3553,s,0);else{if(1027!==r.depthTexture.format)throw new Error("Unknown depthTexture format");e.framebufferTexture2D(36160,33306,3553,s,0)}}(r.__webglFramebuffer,t)}else if(s){r.__webglDepthbuffer=[];for(let n=0;n<6;n++)i.bindFramebuffer(36160,r.__webglFramebuffer[n]),r.__webglDepthbuffer[n]=e.createRenderbuffer(),I(r.__webglDepthbuffer[n],t,!1)}else i.bindFramebuffer(36160,r.__webglFramebuffer),r.__webglDepthbuffer=e.createRenderbuffer(),I(r.__webglDepthbuffer,t,!1);i.bindFramebuffer(36160,null)}function z(e){return o&&e.isWebGLMultisampleRenderTarget?Math.min(u,e.samples):0}let N=!1,O=!1;this.allocateTextureUnit=function(){const e=M;return M+=1,e},this.resetTextureUnits=function(){M=0},this.setTexture2D=S,this.setTexture2DArray=function(e,t){const r=n.get(e);e.version>0&&r.__version!==e.version?E(r,e,t):(i.activeTexture(33984+t),i.bindTexture(35866,r.__webglTexture))},this.setTexture3D=function(e,t){const r=n.get(e);e.version>0&&r.__version!==e.version?E(r,e,t):(i.activeTexture(33984+t),i.bindTexture(32879,r.__webglTexture))},this.setTextureCube=T,this.setupRenderTarget=function(t){const l=t.texture,c=n.get(t),u=n.get(l);t.addEventListener("dispose",w),!0!==t.isWebGLMultipleRenderTargets&&(u.__webglTexture=e.createTexture(),u.__version=l.version,a.memory.textures++);const h=!0===t.isWebGLCubeRenderTarget,d=!0===t.isWebGLMultipleRenderTargets,p=!0===t.isWebGLMultisampleRenderTarget,m=l.isDataTexture3D||l.isDataTexture2DArray,f=g(t)||o;if(!o||1022!==l.format||1015!==l.type&&1016!==l.type||(l.format=1023),h){c.__webglFramebuffer=[];for(let t=0;t<6;t++)c.__webglFramebuffer[t]=e.createFramebuffer()}else if(c.__webglFramebuffer=e.createFramebuffer(),d){if(r.drawBuffers){const i=t.texture;for(let t=0,r=i.length;t<r;t++){const r=n.get(i[t]);void 0===r.__webglTexture&&(r.__webglTexture=e.createTexture(),a.memory.textures++)}}}else if(p&&o){c.__webglMultisampledFramebuffer=e.createFramebuffer(),c.__webglColorRenderbuffer=e.createRenderbuffer(),e.bindRenderbuffer(36161,c.__webglColorRenderbuffer);const n=s.convert(l.format),r=s.convert(l.type),a=x(l.internalFormat,n,r,l.encoding),o=z(t);e.renderbufferStorageMultisample(36161,o,a,t.width,t.height),i.bindFramebuffer(36160,c.__webglMultisampledFramebuffer),e.framebufferRenderbuffer(36160,36064,36161,c.__webglColorRenderbuffer),e.bindRenderbuffer(36161,null),t.depthBuffer&&(c.__webglDepthRenderbuffer=e.createRenderbuffer(),I(c.__webglDepthRenderbuffer,t,!0)),i.bindFramebuffer(36160,null)}if(h){i.bindTexture(34067,u.__webglTexture),L(34067,l,f);for(let e=0;e<6;e++)D(c.__webglFramebuffer[e],t,l,36064,34069+e);v(l,f)&&y(34067,l,t.width,t.height),i.unbindTexture()}else if(d){const e=t.texture;for(let r=0,s=e.length;r<s;r++){const s=e[r],a=n.get(s);i.bindTexture(3553,a.__webglTexture),L(3553,s,f),D(c.__webglFramebuffer,t,s,36064+r,3553),v(s,f)&&y(3553,s,t.width,t.height)}i.unbindTexture()}else{let e=3553;if(m&&o){e=l.isDataTexture3D?32879:35866}i.bindTexture(e,u.__webglTexture),L(e,l,f),D(c.__webglFramebuffer,t,l,36064,e),v(l,f)&&y(e,l,t.width,t.height,t.depth),i.unbindTexture()}t.depthBuffer&&R(t)},this.updateRenderTargetMipmap=function(e){const t=g(e)||o,r=!0===e.isWebGLMultipleRenderTargets?e.texture:[e.texture];for(let s=0,a=r.length;s<a;s++){const a=r[s];if(v(a,t)){const t=e.isWebGLCubeRenderTarget?34067:3553,r=n.get(a).__webglTexture;i.bindTexture(t,r),y(t,a,e.width,e.height),i.unbindTexture()}}},this.updateMultisampleRenderTarget=function(t){if(t.isWebGLMultisampleRenderTarget&&o){const r=t.width,s=t.height;let a=16384;t.depthBuffer&&(a|=256),t.stencilBuffer&&(a|=1024);const o=n.get(t);i.bindFramebuffer(36008,o.__webglMultisampledFramebuffer),i.bindFramebuffer(36009,o.__webglFramebuffer),e.blitFramebuffer(0,0,r,s,0,0,r,s,a,9728),i.bindFramebuffer(36008,null),i.bindFramebuffer(36009,o.__webglMultisampledFramebuffer)}},this.safeSetTexture2D=function(e,t){e&&e.isWebGLRenderTarget&&(!1===N&&(N=!0),e=e.texture),S(e,t)},this.safeSetTextureCube=function(e,t){e&&e.isWebGLCubeRenderTarget&&(!1===O&&(O=!0),e=e.texture),T(e,t)}}function Is(e,t,i){const n=i.isWebGL2;return{convert:function(e){let i;if(1009===e)return 5121;if(1017===e)return 32819;if(1018===e)return 32820;if(1019===e)return 33635;if(1010===e)return 5120;if(1011===e)return 5122;if(1012===e)return 5123;if(1013===e)return 5124;if(1014===e)return 5125;if(1015===e)return 5126;if(1016===e)return n?5131:(i=t.get("OES_texture_half_float"),null!==i?i.HALF_FLOAT_OES:null);if(1021===e)return 6406;if(1022===e)return 6407;if(1023===e)return 6408;if(1024===e)return 6409;if(1025===e)return 6410;if(1026===e)return 6402;if(1027===e)return 34041;if(1028===e)return 6403;if(1029===e)return 36244;if(1030===e)return 33319;if(1031===e)return 33320;if(1032===e)return 36248;if(1033===e)return 36249;if(33776===e||33777===e||33778===e||33779===e){if(i=t.get("WEBGL_compressed_texture_s3tc"),null===i)return null;if(33776===e)return i.COMPRESSED_RGB_S3TC_DXT1_EXT;if(33777===e)return i.COMPRESSED_RGBA_S3TC_DXT1_EXT;if(33778===e)return i.COMPRESSED_RGBA_S3TC_DXT3_EXT;if(33779===e)return i.COMPRESSED_RGBA_S3TC_DXT5_EXT}if(35840===e||35841===e||35842===e||35843===e){if(i=t.get("WEBGL_compressed_texture_pvrtc"),null===i)return null;if(35840===e)return i.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;if(35841===e)return i.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;if(35842===e)return i.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;if(35843===e)return i.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG}if(36196===e)return i=t.get("WEBGL_compressed_texture_etc1"),null!==i?i.COMPRESSED_RGB_ETC1_WEBGL:null;if((37492===e||37496===e)&&(i=t.get("WEBGL_compressed_texture_etc"),null!==i)){if(37492===e)return i.COMPRESSED_RGB8_ETC2;if(37496===e)return i.COMPRESSED_RGBA8_ETC2_EAC}return 37808===e||37809===e||37810===e||37811===e||37812===e||37813===e||37814===e||37815===e||37816===e||37817===e||37818===e||37819===e||37820===e||37821===e||37840===e||37841===e||37842===e||37843===e||37844===e||37845===e||37846===e||37847===e||37848===e||37849===e||37850===e||37851===e||37852===e||37853===e?(i=t.get("WEBGL_compressed_texture_astc"),null!==i?e:null):36492===e?(i=t.get("EXT_texture_compression_bptc"),null!==i?e:null):1020===e?n?34042:(i=t.get("WEBGL_depth_texture"),null!==i?i.UNSIGNED_INT_24_8_WEBGL:null):void 0}}}class Rs extends Vi{constructor(e=[]){super(),this.cameras=e}}Rs.prototype.isArrayCamera=!0;class zs extends Rt{constructor(){super(),this.type="Group"}}zs.prototype.isGroup=!0;const Ns={type:"move"};class Os{constructor(){this._targetRay=null,this._grip=null,this._hand=null}getHandSpace(){return null===this._hand&&(this._hand=new zs,this._hand.matrixAutoUpdate=!1,this._hand.visible=!1,this._hand.joints={},this._hand.inputState={pinching:!1}),this._hand}getTargetRaySpace(){return null===this._targetRay&&(this._targetRay=new zs,this._targetRay.matrixAutoUpdate=!1,this._targetRay.visible=!1,this._targetRay.hasLinearVelocity=!1,this._targetRay.linearVelocity=new De,this._targetRay.hasAngularVelocity=!1,this._targetRay.angularVelocity=new De),this._targetRay}getGripSpace(){return null===this._grip&&(this._grip=new zs,this._grip.matrixAutoUpdate=!1,this._grip.visible=!1,this._grip.hasLinearVelocity=!1,this._grip.linearVelocity=new De,this._grip.hasAngularVelocity=!1,this._grip.angularVelocity=new De),this._grip}dispatchEvent(e){return null!==this._targetRay&&this._targetRay.dispatchEvent(e),null!==this._grip&&this._grip.dispatchEvent(e),null!==this._hand&&this._hand.dispatchEvent(e),this}disconnect(e){return this.dispatchEvent({type:"disconnected",data:e}),null!==this._targetRay&&(this._targetRay.visible=!1),null!==this._grip&&(this._grip.visible=!1),null!==this._hand&&(this._hand.visible=!1),this}update(e,t,i){let n=null,r=null,s=null;const a=this._targetRay,o=this._grip,l=this._hand;if(e&&"visible-blurred"!==t.session.visibilityState)if(null!==a&&(n=t.getPose(e.targetRaySpace,i),null!==n&&(a.matrix.fromArray(n.transform.matrix),a.matrix.decompose(a.position,a.rotation,a.scale),n.linearVelocity?(a.hasLinearVelocity=!0,a.linearVelocity.copy(n.linearVelocity)):a.hasLinearVelocity=!1,n.angularVelocity?(a.hasAngularVelocity=!0,a.angularVelocity.copy(n.angularVelocity)):a.hasAngularVelocity=!1,this.dispatchEvent(Ns))),l&&e.hand){s=!0;for(const s of e.hand.values()){const e=t.getJointPose(s,i);if(void 0===l.joints[s.jointName]){const e=new zs;e.matrixAutoUpdate=!1,e.visible=!1,l.joints[s.jointName]=e,l.add(e)}const n=l.joints[s.jointName];null!==e&&(n.matrix.fromArray(e.transform.matrix),n.matrix.decompose(n.position,n.rotation,n.scale),n.jointRadius=e.radius),n.visible=null!==e}const n=l.joints["index-finger-tip"],r=l.joints["thumb-tip"],a=n.position.distanceTo(r.position),o=.02,c=.005;l.inputState.pinching&&a>o+c?(l.inputState.pinching=!1,this.dispatchEvent({type:"pinchend",handedness:e.handedness,target:this})):!l.inputState.pinching&&a<=o-c&&(l.inputState.pinching=!0,this.dispatchEvent({type:"pinchstart",handedness:e.handedness,target:this}))}else null!==o&&e.gripSpace&&(r=t.getPose(e.gripSpace,i),null!==r&&(o.matrix.fromArray(r.transform.matrix),o.matrix.decompose(o.position,o.rotation,o.scale),r.linearVelocity?(o.hasLinearVelocity=!0,o.linearVelocity.copy(r.linearVelocity)):o.hasLinearVelocity=!1,r.angularVelocity?(o.hasAngularVelocity=!0,o.angularVelocity.copy(r.angularVelocity)):o.hasAngularVelocity=!1));return null!==a&&(a.visible=null!==n),null!==o&&(o.visible=null!==r),null!==l&&(l.visible=null!==s),this}}class Fs extends ce{constructor(e,t){super();const i=this,n=e.state;let r=null,s=1,a=null,o="local-floor",l=null,c=null,u=null,h=null,d=null,p=!1,m=null,f=null,g=null,v=null,y=null,x=null;const _=e.extensions.has("EXT_multisampled_render_to_texture");let b=null;const w=[],M=new Map,S=new Vi;S.layers.enable(1),S.viewport=new Ce;const T=new Vi;T.layers.enable(2),T.viewport=new Ce;const A=[S,T],C=new Rs;C.layers.enable(1),C.layers.enable(2);let L=null,P=null;function E(e){const t=M.get(e.inputSource);t&&t.dispatchEvent({type:e.type,data:e.inputSource})}function D(){M.forEach((function(e,t){e.disconnect(t)})),M.clear(),L=null,P=null,n.bindXRFramebuffer(null),e.setRenderTarget(e.getRenderTarget()),u&&t.deleteFramebuffer(u),m&&t.deleteFramebuffer(m),f&&t.deleteRenderbuffer(f),g&&t.deleteRenderbuffer(g),u=null,m=null,f=null,g=null,d=null,h=null,c=null,r=null,F.stop(),i.isPresenting=!1,i.dispatchEvent({type:"sessionend"})}function I(e){const t=r.inputSources;for(let i=0;i<w.length;i++)M.set(t[i],w[i]);for(let i=0;i<e.removed.length;i++){const t=e.removed[i],n=M.get(t);n&&(n.dispatchEvent({type:"disconnected",data:t}),M.delete(t))}for(let i=0;i<e.added.length;i++){const t=e.added[i],n=M.get(t);n&&n.dispatchEvent({type:"connected",data:t})}}this.cameraAutoUpdate=!0,this.enabled=!1,this.isPresenting=!1,this.getController=function(e){let t=w[e];return void 0===t&&(t=new Os,w[e]=t),t.getTargetRaySpace()},this.getControllerGrip=function(e){let t=w[e];return void 0===t&&(t=new Os,w[e]=t),t.getGripSpace()},this.getHand=function(e){let t=w[e];return void 0===t&&(t=new Os,w[e]=t),t.getHandSpace()},this.setFramebufferScaleFactor=function(e){s=e,i.isPresenting},this.setReferenceSpaceType=function(e){o=e,i.isPresenting},this.getReferenceSpace=function(){return a},this.getBaseLayer=function(){return null!==h?h:d},this.getBinding=function(){return c},this.getFrame=function(){return v},this.getSession=function(){return r},this.setSession=async function(l){if(r=l,null!==r){r.addEventListener("select",E),r.addEventListener("selectstart",E),r.addEventListener("selectend",E),r.addEventListener("squeeze",E),r.addEventListener("squeezestart",E),r.addEventListener("squeezeend",E),r.addEventListener("end",D),r.addEventListener("inputsourceschange",I);const l=t.getContextAttributes();if(!0!==l.xrCompatible&&await t.makeXRCompatible(),void 0===r.renderState.layers){const e={antialias:l.antialias,alpha:l.alpha,depth:l.depth,stencil:l.stencil,framebufferScaleFactor:s};d=new XRWebGLLayer(r,t,e),r.updateRenderState({baseLayer:d})}else if(t instanceof WebGLRenderingContext){const e={antialias:!0,alpha:l.alpha,depth:l.depth,stencil:l.stencil,framebufferScaleFactor:s};d=new XRWebGLLayer(r,t,e),r.updateRenderState({layers:[d]})}else{p=l.antialias;let i=null;l.depth&&(x=256,l.stencil&&(x|=1024),y=l.stencil?33306:36096,i=l.stencil?35056:33190);const a={colorFormat:l.alpha?32856:32849,depthFormat:i,scaleFactor:s};c=new XRWebGLBinding(r,t),h=c.createProjectionLayer(a),u=t.createFramebuffer(),r.updateRenderState({layers:[h]}),p&&_?b=e.extensions.get("EXT_multisampled_render_to_texture"):p&&(m=t.createFramebuffer(),f=t.createRenderbuffer(),t.bindRenderbuffer(36161,f),t.renderbufferStorageMultisample(36161,4,32856,h.textureWidth,h.textureHeight),n.bindFramebuffer(36160,m),t.framebufferRenderbuffer(36160,36064,36161,f),t.bindRenderbuffer(36161,null),null!==i&&(g=t.createRenderbuffer(),t.bindRenderbuffer(36161,g),t.renderbufferStorageMultisample(36161,4,i,h.textureWidth,h.textureHeight),t.framebufferRenderbuffer(36160,y,36161,g),t.bindRenderbuffer(36161,null)),n.bindFramebuffer(36160,null))}a=await r.requestReferenceSpace(o),F.setContext(r),F.start(),i.isPresenting=!0,i.dispatchEvent({type:"sessionstart"})}};const R=new De,z=new De;function N(e,t){null===t?e.matrixWorld.copy(e.matrix):e.matrixWorld.multiplyMatrices(t.matrixWorld,e.matrix),e.matrixWorldInverse.copy(e.matrixWorld).invert()}this.updateCamera=function(e){if(null===r)return;C.near=T.near=S.near=e.near,C.far=T.far=S.far=e.far,L===C.near&&P===C.far||(r.updateRenderState({depthNear:C.near,depthFar:C.far}),L=C.near,P=C.far);const t=e.parent,i=C.cameras;N(C,t);for(let r=0;r<i.length;r++)N(i[r],t);C.matrixWorld.decompose(C.position,C.quaternion,C.scale),e.position.copy(C.position),e.quaternion.copy(C.quaternion),e.scale.copy(C.scale),e.matrix.copy(C.matrix),e.matrixWorld.copy(C.matrixWorld);const n=e.children;for(let r=0,s=n.length;r<s;r++)n[r].updateMatrixWorld(!0);2===i.length?function(e,t,i){R.setFromMatrixPosition(t.matrixWorld),z.setFromMatrixPosition(i.matrixWorld);const n=R.distanceTo(z),r=t.projectionMatrix.elements,s=i.projectionMatrix.elements,a=r[14]/(r[10]-1),o=r[14]/(r[10]+1),l=(r[9]+1)/r[5],c=(r[9]-1)/r[5],u=(r[8]-1)/r[0],h=(s[8]+1)/s[0],d=a*u,p=a*h,m=n/(-u+h),f=m*-u;t.matrixWorld.decompose(e.position,e.quaternion,e.scale),e.translateX(f),e.translateZ(m),e.matrixWorld.compose(e.position,e.quaternion,e.scale),e.matrixWorldInverse.copy(e.matrixWorld).invert();const g=a+m,v=o+m,y=d-f,x=p+(n-f),_=l*o/v*g,b=c*o/v*g;e.projectionMatrix.makePerspective(y,x,_,b,g,v)}(C,S,T):C.projectionMatrix.copy(S.projectionMatrix)},this.getCamera=function(){return C},this.getFoveation=function(){return null!==h?h.fixedFoveation:null!==d?d.fixedFoveation:void 0},this.setFoveation=function(e){null!==h&&(h.fixedFoveation=e),null!==d&&void 0!==d.fixedFoveation&&(d.fixedFoveation=e)};let O=null;const F=new Ki;F.setAnimationLoop((function(e,i){if(l=i.getViewerPose(a),v=i,null!==l){const e=l.views;null!==d&&n.bindXRFramebuffer(d.framebuffer);let i=!1;e.length!==C.cameras.length&&(C.cameras.length=0,i=!0);for(let r=0;r<e.length;r++){const s=e[r];let a=null;if(null!==d)a=d.getViewport(s);else{const e=c.getViewSubImage(h,s);n.bindXRFramebuffer(u),p&&_?(void 0!==e.depthStencilTexture&&b.framebufferTexture2DMultisampleEXT(36160,y,3553,e.depthStencilTexture,0,4),b.framebufferTexture2DMultisampleEXT(36160,36064,3553,e.colorTexture,0,4)):(void 0!==e.depthStencilTexture&&t.framebufferTexture2D(36160,y,3553,e.depthStencilTexture,0),t.framebufferTexture2D(36160,36064,3553,e.colorTexture,0)),a=e.viewport}const o=A[r];o.matrix.fromArray(s.transform.matrix),o.projectionMatrix.fromArray(s.projectionMatrix),o.viewport.set(a.x,a.y,a.width,a.height),0===r&&C.matrix.copy(o.matrix),!0===i&&C.cameras.push(o)}p&&!_&&(n.bindXRFramebuffer(m),null!==x&&t.clear(x))}const s=r.inputSources;for(let t=0;t<w.length;t++){const e=w[t],n=s[t];e.update(n,i,a)}if(O&&O(e,i),p&&!_){const e=h.textureWidth,i=h.textureHeight;n.bindFramebuffer(36008,m),n.bindFramebuffer(36009,u),t.invalidateFramebuffer(36008,[y]),t.invalidateFramebuffer(36009,[y]),t.blitFramebuffer(0,0,e,i,0,0,e,i,16384,9728),t.invalidateFramebuffer(36008,[36064]),n.bindFramebuffer(36008,null),n.bindFramebuffer(36009,null),n.bindFramebuffer(36160,m)}v=null})),this.setAnimationLoop=function(e){O=e},this.dispose=function(){}}}function Us(e){function t(t,i){t.opacity.value=i.opacity,i.color&&t.diffuse.value.copy(i.color),i.emissive&&t.emissive.value.copy(i.emissive).multiplyScalar(i.emissiveIntensity),i.map&&(t.map.value=i.map),i.alphaMap&&(t.alphaMap.value=i.alphaMap),i.specularMap&&(t.specularMap.value=i.specularMap),i.alphaTest>0&&(t.alphaTest.value=i.alphaTest);const n=e.get(i).envMap;if(n){t.envMap.value=n,t.flipEnvMap.value=n.isCubeTexture&&!1===n.isRenderTargetTexture?-1:1,t.reflectivity.value=i.reflectivity,t.ior.value=i.ior,t.refractionRatio.value=i.refractionRatio;const r=e.get(n).__maxMipLevel;void 0!==r&&(t.maxMipLevel.value=r)}let r,s;i.lightMap&&(t.lightMap.value=i.lightMap,t.lightMapIntensity.value=i.lightMapIntensity),i.aoMap&&(t.aoMap.value=i.aoMap,t.aoMapIntensity.value=i.aoMapIntensity),i.map?r=i.map:i.specularMap?r=i.specularMap:i.displacementMap?r=i.displacementMap:i.normalMap?r=i.normalMap:i.bumpMap?r=i.bumpMap:i.roughnessMap?r=i.roughnessMap:i.metalnessMap?r=i.metalnessMap:i.alphaMap?r=i.alphaMap:i.emissiveMap?r=i.emissiveMap:i.clearcoatMap?r=i.clearcoatMap:i.clearcoatNormalMap?r=i.clearcoatNormalMap:i.clearcoatRoughnessMap?r=i.clearcoatRoughnessMap:i.specularIntensityMap?r=i.specularIntensityMap:i.specularTintMap?r=i.specularTintMap:i.transmissionMap?r=i.transmissionMap:i.thicknessMap&&(r=i.thicknessMap),void 0!==r&&(r.isWebGLRenderTarget&&(r=r.texture),!0===r.matrixAutoUpdate&&r.updateMatrix(),t.uvTransform.value.copy(r.matrix)),i.aoMap?s=i.aoMap:i.lightMap&&(s=i.lightMap),void 0!==s&&(s.isWebGLRenderTarget&&(s=s.texture),!0===s.matrixAutoUpdate&&s.updateMatrix(),t.uv2Transform.value.copy(s.matrix))}function i(t,i){t.roughness.value=i.roughness,t.metalness.value=i.metalness,i.roughnessMap&&(t.roughnessMap.value=i.roughnessMap),i.metalnessMap&&(t.metalnessMap.value=i.metalnessMap),i.emissiveMap&&(t.emissiveMap.value=i.emissiveMap),i.bumpMap&&(t.bumpMap.value=i.bumpMap,t.bumpScale.value=i.bumpScale,1===i.side&&(t.bumpScale.value*=-1)),i.normalMap&&(t.normalMap.value=i.normalMap,t.normalScale.value.copy(i.normalScale),1===i.side&&t.normalScale.value.negate()),i.displacementMap&&(t.displacementMap.value=i.displacementMap,t.displacementScale.value=i.displacementScale,t.displacementBias.value=i.displacementBias);e.get(i).envMap&&(t.envMapIntensity.value=i.envMapIntensity)}return{refreshFogUniforms:function(e,t){e.fogColor.value.copy(t.color),t.isFog?(e.fogNear.value=t.near,e.fogFar.value=t.far):t.isFogExp2&&(e.fogDensity.value=t.density)},refreshMaterialUniforms:function(e,n,r,s,a){n.isMeshBasicMaterial?t(e,n):n.isMeshLambertMaterial?(t(e,n),function(e,t){t.emissiveMap&&(e.emissiveMap.value=t.emissiveMap)}(e,n)):n.isMeshToonMaterial?(t(e,n),function(e,t){t.gradientMap&&(e.gradientMap.value=t.gradientMap);t.emissiveMap&&(e.emissiveMap.value=t.emissiveMap);t.bumpMap&&(e.bumpMap.value=t.bumpMap,e.bumpScale.value=t.bumpScale,1===t.side&&(e.bumpScale.value*=-1));t.normalMap&&(e.normalMap.value=t.normalMap,e.normalScale.value.copy(t.normalScale),1===t.side&&e.normalScale.value.negate());t.displacementMap&&(e.displacementMap.value=t.displacementMap,e.displacementScale.value=t.displacementScale,e.displacementBias.value=t.displacementBias)}(e,n)):n.isMeshPhongMaterial?(t(e,n),function(e,t){e.specular.value.copy(t.specular),e.shininess.value=Math.max(t.shininess,1e-4),t.emissiveMap&&(e.emissiveMap.value=t.emissiveMap);t.bumpMap&&(e.bumpMap.value=t.bumpMap,e.bumpScale.value=t.bumpScale,1===t.side&&(e.bumpScale.value*=-1));t.normalMap&&(e.normalMap.value=t.normalMap,e.normalScale.value.copy(t.normalScale),1===t.side&&e.normalScale.value.negate());t.displacementMap&&(e.displacementMap.value=t.displacementMap,e.displacementScale.value=t.displacementScale,e.displacementBias.value=t.displacementBias)}(e,n)):n.isMeshStandardMaterial?(t(e,n),n.isMeshPhysicalMaterial?function(e,t,n){i(e,t),e.ior.value=t.ior,t.sheen>0&&(e.sheenTint.value.copy(t.sheenTint).multiplyScalar(t.sheen),e.sheenRoughness.value=t.sheenRoughness);t.clearcoat>0&&(e.clearcoat.value=t.clearcoat,e.clearcoatRoughness.value=t.clearcoatRoughness,t.clearcoatMap&&(e.clearcoatMap.value=t.clearcoatMap),t.clearcoatRoughnessMap&&(e.clearcoatRoughnessMap.value=t.clearcoatRoughnessMap),t.clearcoatNormalMap&&(e.clearcoatNormalScale.value.copy(t.clearcoatNormalScale),e.clearcoatNormalMap.value=t.clearcoatNormalMap,1===t.side&&e.clearcoatNormalScale.value.negate()));t.transmission>0&&(e.transmission.value=t.transmission,e.transmissionSamplerMap.value=n.texture,e.transmissionSamplerSize.value.set(n.width,n.height),t.transmissionMap&&(e.transmissionMap.value=t.transmissionMap),e.thickness.value=t.thickness,t.thicknessMap&&(e.thicknessMap.value=t.thicknessMap),e.attenuationDistance.value=t.attenuationDistance,e.attenuationTint.value.copy(t.attenuationTint));e.specularIntensity.value=t.specularIntensity,e.specularTint.value.copy(t.specularTint),t.specularIntensityMap&&(e.specularIntensityMap.value=t.specularIntensityMap);t.specularTintMap&&(e.specularTintMap.value=t.specularTintMap)}(e,n,a):i(e,n)):n.isMeshMatcapMaterial?(t(e,n),function(e,t){t.matcap&&(e.matcap.value=t.matcap);t.bumpMap&&(e.bumpMap.value=t.bumpMap,e.bumpScale.value=t.bumpScale,1===t.side&&(e.bumpScale.value*=-1));t.normalMap&&(e.normalMap.value=t.normalMap,e.normalScale.value.copy(t.normalScale),1===t.side&&e.normalScale.value.negate());t.displacementMap&&(e.displacementMap.value=t.displacementMap,e.displacementScale.value=t.displacementScale,e.displacementBias.value=t.displacementBias)}(e,n)):n.isMeshDepthMaterial?(t(e,n),function(e,t){t.displacementMap&&(e.displacementMap.value=t.displacementMap,e.displacementScale.value=t.displacementScale,e.displacementBias.value=t.displacementBias)}(e,n)):n.isMeshDistanceMaterial?(t(e,n),function(e,t){t.displacementMap&&(e.displacementMap.value=t.displacementMap,e.displacementScale.value=t.displacementScale,e.displacementBias.value=t.displacementBias);e.referencePosition.value.copy(t.referencePosition),e.nearDistance.value=t.nearDistance,e.farDistance.value=t.farDistance}(e,n)):n.isMeshNormalMaterial?(t(e,n),function(e,t){t.bumpMap&&(e.bumpMap.value=t.bumpMap,e.bumpScale.value=t.bumpScale,1===t.side&&(e.bumpScale.value*=-1));t.normalMap&&(e.normalMap.value=t.normalMap,e.normalScale.value.copy(t.normalScale),1===t.side&&e.normalScale.value.negate());t.displacementMap&&(e.displacementMap.value=t.displacementMap,e.displacementScale.value=t.displacementScale,e.displacementBias.value=t.displacementBias)}(e,n)):n.isLineBasicMaterial?(function(e,t){e.diffuse.value.copy(t.color),e.opacity.value=t.opacity}(e,n),n.isLineDashedMaterial&&function(e,t){e.dashSize.value=t.dashSize,e.totalSize.value=t.dashSize+t.gapSize,e.scale.value=t.scale}(e,n)):n.isPointsMaterial?function(e,t,i,n){e.diffuse.value.copy(t.color),e.opacity.value=t.opacity,e.size.value=t.size*i,e.scale.value=.5*n,t.map&&(e.map.value=t.map);t.alphaMap&&(e.alphaMap.value=t.alphaMap);t.alphaTest>0&&(e.alphaTest.value=t.alphaTest);let r;t.map?r=t.map:t.alphaMap&&(r=t.alphaMap);void 0!==r&&(!0===r.matrixAutoUpdate&&r.updateMatrix(),e.uvTransform.value.copy(r.matrix))}(e,n,r,s):n.isSpriteMaterial?function(e,t){e.diffuse.value.copy(t.color),e.opacity.value=t.opacity,e.rotation.value=t.rotation,t.map&&(e.map.value=t.map);t.alphaMap&&(e.alphaMap.value=t.alphaMap);t.alphaTest>0&&(e.alphaTest.value=t.alphaTest);let i;t.map?i=t.map:t.alphaMap&&(i=t.alphaMap);void 0!==i&&(!0===i.matrixAutoUpdate&&i.updateMatrix(),e.uvTransform.value.copy(i.matrix))}(e,n):n.isShadowMaterial?(e.color.value.copy(n.color),e.opacity.value=n.opacity):n.isShaderMaterial&&(n.uniformsNeedUpdate=!1)}}}function ks(e={}){const t=void 0!==e.canvas?e.canvas:function(){const e=we("canvas");return e.style.display="block",e}(),i=void 0!==e.context?e.context:null,n=void 0!==e.alpha&&e.alpha,r=void 0===e.depth||e.depth,s=void 0===e.stencil||e.stencil,a=void 0!==e.antialias&&e.antialias,o=void 0===e.premultipliedAlpha||e.premultipliedAlpha,l=void 0!==e.preserveDrawingBuffer&&e.preserveDrawingBuffer,c=void 0!==e.powerPreference?e.powerPreference:"default",u=void 0!==e.failIfMajorPerformanceCaveat&&e.failIfMajorPerformanceCaveat;let h=null,d=null;const p=[],m=[];this.domElement=t,this.debug={checkShaderErrors:!0},this.autoClear=!0,this.autoClearColor=!0,this.autoClearDepth=!0,this.autoClearStencil=!0,this.sortObjects=!0,this.clippingPlanes=[],this.localClippingEnabled=!1,this.gammaFactor=2,this.outputEncoding=3e3,this.physicallyCorrectLights=!1,this.toneMapping=0,this.toneMappingExposure=1;const f=this;let g=!1,v=0,y=0,x=null,_=-1,b=null;const w=new Ce,M=new Ce;let S=null,T=t.width,A=t.height,C=1,L=null,P=null;const E=new Ce(0,0,T,A),D=new Ce(0,0,T,A);let I=!1;const R=[],z=new Qi;let N=!1,O=!1,F=null;const U=new lt,k=new De,B={background:null,fog:null,environment:null,overrideMaterial:null,isScene:!0};function V(){return null===x?C:1}let G,W,H,j,q,X,Y,Z,J,Q,K,$,ee,te,ie,ne,re,se,ae,oe,le,ce,ue,he=i;function de(e,i){for(let n=0;n<e.length;n++){const r=e[n],s=t.getContext(r,i);if(null!==s)return s}return null}try{const e={alpha:n,depth:r,stencil:s,antialias:a,premultipliedAlpha:o,preserveDrawingBuffer:l,powerPreference:c,failIfMajorPerformanceCaveat:u};if(t.addEventListener("webglcontextlost",fe,!1),t.addEventListener("webglcontextrestored",ge,!1),null===he){const t=["webgl2","webgl","experimental-webgl"];if(!0===f.isWebGL1Renderer&&t.shift(),he=de(t,e),null===he)throw de(t)?new Error("Error creating WebGL context with your selected attributes."):new Error("Error creating WebGL context.")}void 0===he.getShaderPrecisionFormat&&(he.getShaderPrecisionFormat=function(){return{rangeMin:1,rangeMax:1,precision:1}})}catch(ze){throw ze}function pe(){G=new On(he),W=new ln(he,G,e),G.init(W),ce=new Is(he,G,W),H=new Es(he,G,W),R[0]=1029,j=new kn(he),q=new gs,X=new Ds(he,G,H,q,W,ce,j),Y=new un(f),Z=new Nn(f),J=new $i(he,W),ue=new an(he,G,J,W),Q=new Fn(he,J,j,ue),K=new jn(he,Q,J,j),ae=new Hn(he,W,X),ne=new cn(q),$=new fs(f,Y,Z,G,W,ue,ne),ee=new Us(q),te=new _s(q),ie=new As(G,W),se=new sn(f,Y,H,K,o),re=new Ps(f,K,W),oe=new on(he,G,j,W),le=new Un(he,G,j,W),j.programs=$.programs,f.capabilities=W,f.extensions=G,f.properties=q,f.renderLists=te,f.shadowMap=re,f.state=H,f.info=j}pe();const me=new Fs(f,he);function fe(e){e.preventDefault(),g=!0}function ge(){g=!1;const e=j.autoReset,t=re.enabled,i=re.autoUpdate,n=re.needsUpdate,r=re.type;pe(),j.autoReset=e,re.enabled=t,re.autoUpdate=i,re.needsUpdate=n,re.type=r}function ve(e){const t=e.target;t.removeEventListener("dispose",ve),function(e){(function(e){const t=q.get(e).programs;void 0!==t&&t.forEach((function(e){$.releaseProgram(e)}))})(e),q.remove(e)}(t)}this.xr=me,this.getContext=function(){return he},this.getContextAttributes=function(){return he.getContextAttributes()},this.forceContextLoss=function(){const e=G.get("WEBGL_lose_context");e&&e.loseContext()},this.forceContextRestore=function(){const e=G.get("WEBGL_lose_context");e&&e.restoreContext()},this.getPixelRatio=function(){return C},this.setPixelRatio=function(e){void 0!==e&&(C=e,this.setSize(T,A,!1))},this.getSize=function(e){return e.set(T,A)},this.setSize=function(e,i,n){me.isPresenting||(T=e,A=i,t.width=Math.floor(e*C),t.height=Math.floor(i*C),!1!==n&&(t.style.width=e+"px",t.style.height=i+"px"),this.setViewport(0,0,e,i))},this.getDrawingBufferSize=function(e){return e.set(T*C,A*C).floor()},this.setDrawingBufferSize=function(e,i,n){T=e,A=i,C=n,t.width=Math.floor(e*n),t.height=Math.floor(i*n),this.setViewport(0,0,e,i)},this.getCurrentViewport=function(e){return e.copy(w)},this.getViewport=function(e){return e.copy(E)},this.setViewport=function(e,t,i,n){e.isVector4?E.set(e.x,e.y,e.z,e.w):E.set(e,t,i,n),H.viewport(w.copy(E).multiplyScalar(C).floor())},this.getScissor=function(e){return e.copy(D)},this.setScissor=function(e,t,i,n){e.isVector4?D.set(e.x,e.y,e.z,e.w):D.set(e,t,i,n),H.scissor(M.copy(D).multiplyScalar(C).floor())},this.getScissorTest=function(){return I},this.setScissorTest=function(e){H.setScissorTest(I=e)},this.setOpaqueSort=function(e){L=e},this.setTransparentSort=function(e){P=e},this.getClearColor=function(e){return e.copy(se.getClearColor())},this.setClearColor=function(){se.setClearColor.apply(se,arguments)},this.getClearAlpha=function(){return se.getClearAlpha()},this.setClearAlpha=function(){se.setClearAlpha.apply(se,arguments)},this.clear=function(e,t,i){let n=0;(void 0===e||e)&&(n|=16384),(void 0===t||t)&&(n|=256),(void 0===i||i)&&(n|=1024),he.clear(n)},this.clearColor=function(){this.clear(!0,!1,!1)},this.clearDepth=function(){this.clear(!1,!0,!1)},this.clearStencil=function(){this.clear(!1,!1,!0)},this.dispose=function(){t.removeEventListener("webglcontextlost",fe,!1),t.removeEventListener("webglcontextrestored",ge,!1),te.dispose(),ie.dispose(),q.dispose(),Y.dispose(),Z.dispose(),K.dispose(),ue.dispose(),me.dispose(),me.removeEventListener("sessionstart",xe),me.removeEventListener("sessionend",_e),F&&(F.dispose(),F=null),be.stop()},this.renderBufferImmediate=function(e,t){ue.initAttributes();const i=q.get(e);e.hasPositions&&!i.position&&(i.position=he.createBuffer()),e.hasNormals&&!i.normal&&(i.normal=he.createBuffer()),e.hasUvs&&!i.uv&&(i.uv=he.createBuffer()),e.hasColors&&!i.color&&(i.color=he.createBuffer());const n=t.getAttributes();e.hasPositions&&(he.bindBuffer(34962,i.position),he.bufferData(34962,e.positionArray,35048),ue.enableAttribute(n.position.location),he.vertexAttribPointer(n.position.location,3,5126,!1,0,0)),e.hasNormals&&(he.bindBuffer(34962,i.normal),he.bufferData(34962,e.normalArray,35048),ue.enableAttribute(n.normal.location),he.vertexAttribPointer(n.normal.location,3,5126,!1,0,0)),e.hasUvs&&(he.bindBuffer(34962,i.uv),he.bufferData(34962,e.uvArray,35048),ue.enableAttribute(n.uv.location),he.vertexAttribPointer(n.uv.location,2,5126,!1,0,0)),e.hasColors&&(he.bindBuffer(34962,i.color),he.bufferData(34962,e.colorArray,35048),ue.enableAttribute(n.color.location),he.vertexAttribPointer(n.color.location,3,5126,!1,0,0)),ue.disableUnusedAttributes(),he.drawArrays(4,0,e.count),e.count=0},this.renderBufferDirect=function(e,t,i,n,r,s){null===t&&(t=B);const a=r.isMesh&&r.matrixWorld.determinant()<0,o=Re(e,t,n,r);H.setMaterial(n,a);let l=i.index;const c=i.attributes.position;if(null===l){if(void 0===c||0===c.count)return}else if(0===l.count)return;let u,h=1;!0===n.wireframe&&(l=Q.getWireframeAttribute(i),h=2),void 0===i.morphAttributes.position&&void 0===i.morphAttributes.normal||ae.update(r,i,n,o),ue.setup(r,n,o,i,l);let d=oe;null!==l&&(u=J.get(l),d=le,d.setIndex(u));const p=null!==l?l.count:c.count,m=i.drawRange.start*h,f=i.drawRange.count*h,g=null!==s?s.start*h:0,v=null!==s?s.count*h:Infinity,y=Math.max(m,g),x=Math.min(p,m+f,g+v)-1,_=Math.max(0,x-y+1);if(0!==_){if(r.isMesh)!0===n.wireframe?(H.setLineWidth(n.wireframeLinewidth*V()),d.setMode(1)):d.setMode(4);else if(r.isLine){let e=n.linewidth;void 0===e&&(e=1),H.setLineWidth(e*V()),r.isLineSegments?d.setMode(1):r.isLineLoop?d.setMode(2):d.setMode(3)}else r.isPoints?d.setMode(0):r.isSprite&&d.setMode(4);if(r.isInstancedMesh)d.renderInstances(y,_,r.count);else if(i.isInstancedBufferGeometry){const e=Math.min(i.instanceCount,i._maxInstanceCount);d.renderInstances(y,_,e)}else d.render(y,_)}},this.compile=function(e,t){d=ie.get(e),d.init(),m.push(d),e.traverseVisible((function(e){e.isLight&&e.layers.test(t.layers)&&(d.pushLight(e),e.castShadow&&d.pushShadow(e))})),d.setupLights(f.physicallyCorrectLights),e.traverse((function(t){const i=t.material;if(i)if(Array.isArray(i))for(let n=0;n<i.length;n++){Ee(i[n],e,t)}else Ee(i,e,t)})),m.pop(),d=null};let ye=null;function xe(){be.stop()}function _e(){be.start()}const be=new Ki;function Me(e,t,i,n){if(!1===e.visible)return;if(e.layers.test(t.layers))if(e.isGroup)i=e.renderOrder;else if(e.isLOD)!0===e.autoUpdate&&e.update(t);else if(e.isLight)d.pushLight(e),e.castShadow&&d.pushShadow(e);else if(e.isSprite){if(!e.frustumCulled||z.intersectsSprite(e)){n&&k.setFromMatrixPosition(e.matrixWorld).applyMatrix4(U);const t=K.update(e),r=e.material;r.visible&&h.push(e,t,r,i,k.z,null)}}else if(e.isImmediateRenderObject)n&&k.setFromMatrixPosition(e.matrixWorld).applyMatrix4(U),h.push(e,null,e.material,i,k.z,null);else if((e.isMesh||e.isLine||e.isPoints)&&(e.isSkinnedMesh&&e.skeleton.frame!==j.render.frame&&(e.skeleton.update(),e.skeleton.frame=j.render.frame),!e.frustumCulled||z.intersectsObject(e))){n&&k.setFromMatrixPosition(e.matrixWorld).applyMatrix4(U);const t=K.update(e),r=e.material;if(Array.isArray(r)){const n=t.groups;for(let s=0,a=n.length;s<a;s++){const a=n[s],o=r[a.materialIndex];o&&o.visible&&h.push(e,t,o,i,k.z,a)}}else r.visible&&h.push(e,t,r,i,k.z,null)}const r=e.children;for(let s=0,a=r.length;s<a;s++)Me(r[s],t,i,n)}function Se(e,t,i,n){const r=e.opaque,s=e.transmissive,o=e.transparent;d.setupLightsView(i),s.length>0&&function(e,t,i){if(null===F){const e=!0===a&&!0===W.isWebGL2;F=new(e?Pe:Le)(1024,1024,{generateMipmaps:!0,type:null!==ce.convert(1016)?1016:1009,minFilter:1008,magFilter:1003,wrapS:1001,wrapT:1001})}const n=f.getRenderTarget();f.setRenderTarget(F),f.clear();const r=f.toneMapping;f.toneMapping=0,Te(e,t,i),f.toneMapping=r,X.updateMultisampleRenderTarget(F),X.updateRenderTargetMipmap(F),f.setRenderTarget(n)}(r,t,i),n&&H.viewport(w.copy(n)),r.length>0&&Te(r,t,i),s.length>0&&Te(s,t,i),o.length>0&&Te(o,t,i)}function Te(e,t,i){const n=!0===t.isScene?t.overrideMaterial:null;for(let r=0,s=e.length;r<s;r++){const s=e[r],a=s.object,o=s.geometry,l=null===n?s.material:n,c=s.group;a.layers.test(i.layers)&&Ae(a,t,i,o,l,c)}}function Ae(e,t,i,n,r,s){if(e.onBeforeRender(f,t,i,n,r,s),e.modelViewMatrix.multiplyMatrices(i.matrixWorldInverse,e.matrixWorld),e.normalMatrix.getNormalMatrix(e.modelViewMatrix),r.onBeforeRender(f,t,i,n,e,s),e.isImmediateRenderObject){const n=Re(i,t,r,e);H.setMaterial(r),ue.reset(),function(e,t){e.render((function(e){f.renderBufferImmediate(e,t)}))}(e,n)}else!0===r.transparent&&2===r.side?(r.side=1,r.needsUpdate=!0,f.renderBufferDirect(i,t,n,r,e,s),r.side=0,r.needsUpdate=!0,f.renderBufferDirect(i,t,n,r,e,s),r.side=2):f.renderBufferDirect(i,t,n,r,e,s);e.onAfterRender(f,t,i,n,r,s)}function Ee(e,t,i){!0!==t.isScene&&(t=B);const n=q.get(e),r=d.state.lights,s=d.state.shadowsArray,a=r.state.version,o=$.getParameters(e,r.state,s,t,i),l=$.getProgramCacheKey(o);let c=n.programs;n.environment=e.isMeshStandardMaterial?t.environment:null,n.fog=t.fog,n.envMap=(e.isMeshStandardMaterial?Z:Y).get(e.envMap||n.environment),void 0===c&&(e.addEventListener("dispose",ve),c=new Map,n.programs=c);let u=c.get(l);if(void 0!==u){if(n.currentProgram===u&&n.lightsStateVersion===a)return Ie(e,o),u}else o.uniforms=$.getUniforms(e),e.onBuild(o,f),e.onBeforeCompile(o,f),u=$.acquireProgram(o,l),c.set(l,u),n.uniforms=o.uniforms;const h=n.uniforms;(e.isShaderMaterial||e.isRawShaderMaterial)&&!0!==e.clipping||(h.clippingPlanes=ne.uniform),Ie(e,o),n.needsLights=function(e){return e.isMeshLambertMaterial||e.isMeshToonMaterial||e.isMeshPhongMaterial||e.isMeshStandardMaterial||e.isShadowMaterial||e.isShaderMaterial&&!0===e.lights}(e),n.lightsStateVersion=a,n.needsLights&&(h.ambientLightColor.value=r.state.ambient,h.lightProbe.value=r.state.probe,h.directionalLights.value=r.state.directional,h.directionalLightShadows.value=r.state.directionalShadow,h.spotLights.value=r.state.spot,h.spotLightShadows.value=r.state.spotShadow,h.rectAreaLights.value=r.state.rectArea,h.ltc_1.value=r.state.rectAreaLTC1,h.ltc_2.value=r.state.rectAreaLTC2,h.pointLights.value=r.state.point,h.pointLightShadows.value=r.state.pointShadow,h.hemisphereLights.value=r.state.hemi,h.directionalShadowMap.value=r.state.directionalShadowMap,h.directionalShadowMatrix.value=r.state.directionalShadowMatrix,h.spotShadowMap.value=r.state.spotShadowMap,h.spotShadowMatrix.value=r.state.spotShadowMatrix,h.pointShadowMap.value=r.state.pointShadowMap,h.pointShadowMatrix.value=r.state.pointShadowMatrix);const p=u.getUniforms(),m=Yr.seqWithValue(p.seq,h);return n.currentProgram=u,n.uniformsList=m,u}function Ie(e,t){const i=q.get(e);i.outputEncoding=t.outputEncoding,i.instancing=t.instancing,i.skinning=t.skinning,i.morphTargets=t.morphTargets,i.morphNormals=t.morphNormals,i.morphTargetsCount=t.morphTargetsCount,i.numClippingPlanes=t.numClippingPlanes,i.numIntersection=t.numClipIntersection,i.vertexAlphas=t.vertexAlphas,i.vertexTangents=t.vertexTangents}function Re(e,t,i,n){!0!==t.isScene&&(t=B),X.resetTextureUnits();const r=t.fog,s=i.isMeshStandardMaterial?t.environment:null,a=null===x?f.outputEncoding:x.texture.encoding,o=(i.isMeshStandardMaterial?Z:Y).get(i.envMap||s),l=!0===i.vertexColors&&!!n.geometry&&!!n.geometry.attributes.color&&4===n.geometry.attributes.color.itemSize,c=!!i.normalMap&&!!n.geometry&&!!n.geometry.attributes.tangent,u=!!n.geometry&&!!n.geometry.morphAttributes.position,h=!!n.geometry&&!!n.geometry.morphAttributes.normal,p=n.geometry&&n.geometry.morphAttributes.position?n.geometry.morphAttributes.position.length:0,m=q.get(i),g=d.state.lights;if(!0===N&&(!0===O||e!==b)){const t=e===b&&i.id===_;ne.setState(i,e,t)}let v=!1;i.version===m.__version?m.needsLights&&m.lightsStateVersion!==g.state.version||m.outputEncoding!==a||n.isInstancedMesh&&!1===m.instancing?v=!0:n.isInstancedMesh||!0!==m.instancing?n.isSkinnedMesh&&!1===m.skinning?v=!0:n.isSkinnedMesh||!0!==m.skinning?m.envMap!==o||i.fog&&m.fog!==r?v=!0:void 0===m.numClippingPlanes||m.numClippingPlanes===ne.numPlanes&&m.numIntersection===ne.numIntersection?(m.vertexAlphas!==l||m.vertexTangents!==c||m.morphTargets!==u||m.morphNormals!==h||!0===W.isWebGL2&&m.morphTargetsCount!==p)&&(v=!0):v=!0:v=!0:v=!0:(v=!0,m.__version=i.version);let y=m.currentProgram;!0===v&&(y=Ee(i,t,n));let w=!1,M=!1,S=!1;const T=y.getUniforms(),L=m.uniforms;if(H.useProgram(y.program)&&(w=!0,M=!0,S=!0),i.id!==_&&(_=i.id,M=!0),w||b!==e){if(T.setValue(he,"projectionMatrix",e.projectionMatrix),W.logarithmicDepthBuffer&&T.setValue(he,"logDepthBufFC",2/(Math.log(e.far+1)/Math.LN2)),b!==e&&(b=e,M=!0,S=!0),i.isShaderMaterial||i.isMeshPhongMaterial||i.isMeshToonMaterial||i.isMeshStandardMaterial||i.envMap){const t=T.map.cameraPosition;void 0!==t&&t.setValue(he,k.setFromMatrixPosition(e.matrixWorld))}(i.isMeshPhongMaterial||i.isMeshToonMaterial||i.isMeshLambertMaterial||i.isMeshBasicMaterial||i.isMeshStandardMaterial||i.isShaderMaterial)&&T.setValue(he,"isOrthographic",!0===e.isOrthographicCamera),(i.isMeshPhongMaterial||i.isMeshToonMaterial||i.isMeshLambertMaterial||i.isMeshBasicMaterial||i.isMeshStandardMaterial||i.isShaderMaterial||i.isShadowMaterial||n.isSkinnedMesh)&&T.setValue(he,"viewMatrix",e.matrixWorldInverse)}if(n.isSkinnedMesh){T.setOptional(he,n,"bindMatrix"),T.setOptional(he,n,"bindMatrixInverse");const e=n.skeleton;e&&(W.floatVertexTextures?(null===e.boneTexture&&e.computeBoneTexture(),T.setValue(he,"boneTexture",e.boneTexture,X),T.setValue(he,"boneTextureSize",e.boneTextureSize)):T.setOptional(he,e,"boneMatrices"))}var P,E;return(M||m.receiveShadow!==n.receiveShadow)&&(m.receiveShadow=n.receiveShadow,T.setValue(he,"receiveShadow",n.receiveShadow)),M&&(T.setValue(he,"toneMappingExposure",f.toneMappingExposure),m.needsLights&&(E=S,(P=L).ambientLightColor.needsUpdate=E,P.lightProbe.needsUpdate=E,P.directionalLights.needsUpdate=E,P.directionalLightShadows.needsUpdate=E,P.pointLights.needsUpdate=E,P.pointLightShadows.needsUpdate=E,P.spotLights.needsUpdate=E,P.spotLightShadows.needsUpdate=E,P.rectAreaLights.needsUpdate=E,P.hemisphereLights.needsUpdate=E),r&&i.fog&&ee.refreshFogUniforms(L,r),ee.refreshMaterialUniforms(L,i,C,A,F),Yr.upload(he,m.uniformsList,L,X)),i.isShaderMaterial&&!0===i.uniformsNeedUpdate&&(Yr.upload(he,m.uniformsList,L,X),i.uniformsNeedUpdate=!1),i.isSpriteMaterial&&T.setValue(he,"center",n.center),T.setValue(he,"modelViewMatrix",n.modelViewMatrix),T.setValue(he,"normalMatrix",n.normalMatrix),T.setValue(he,"modelMatrix",n.matrixWorld),y}be.setAnimationLoop((function(e){ye&&ye(e)})),"undefined"!=typeof window&&be.setContext(window),this.setAnimationLoop=function(e){ye=e,me.setAnimationLoop(e),null===e?be.stop():be.start()},me.addEventListener("sessionstart",xe),me.addEventListener("sessionend",_e),this.render=function(e,t){if(void 0!==t&&!0!==t.isCamera)return;if(!0===g)return;!0===e.autoUpdate&&e.updateMatrixWorld(),null===t.parent&&t.updateMatrixWorld(),!0===me.enabled&&!0===me.isPresenting&&(!0===me.cameraAutoUpdate&&me.updateCamera(t),t=me.getCamera()),!0===e.isScene&&e.onBeforeRender(f,e,t,x),d=ie.get(e,m.length),d.init(),m.push(d),U.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse),z.setFromProjectionMatrix(U),O=this.localClippingEnabled,N=ne.init(this.clippingPlanes,O,t),h=te.get(e,p.length),h.init(),p.push(h),Me(e,t,0,f.sortObjects),h.finish(),!0===f.sortObjects&&h.sort(L,P),!0===N&&ne.beginShadows();const i=d.state.shadowsArray;if(re.render(i,e,t),!0===N&&ne.endShadows(),!0===this.info.autoReset&&this.info.reset(),se.render(h,e),d.setupLights(f.physicallyCorrectLights),t.isArrayCamera){const i=t.cameras;for(let t=0,n=i.length;t<n;t++){const n=i[t];Se(h,e,n,n.viewport)}}else Se(h,e,t);null!==x&&(X.updateMultisampleRenderTarget(x),X.updateRenderTargetMipmap(x)),!0===e.isScene&&e.onAfterRender(f,e,t),H.buffers.depth.setTest(!0),H.buffers.depth.setMask(!0),H.buffers.color.setMask(!0),H.setPolygonOffset(!1),ue.resetDefaultState(),_=-1,b=null,m.pop(),d=m.length>0?m[m.length-1]:null,p.pop(),h=p.length>0?p[p.length-1]:null},this.getActiveCubeFace=function(){return v},this.getActiveMipmapLevel=function(){return y},this.getRenderTarget=function(){return x},this.setRenderTarget=function(e,t=0,i=0){x=e,v=t,y=i,e&&void 0===q.get(e).__webglFramebuffer&&X.setupRenderTarget(e);let n=null,r=!1,s=!1;if(e){const i=e.texture;(i.isDataTexture3D||i.isDataTexture2DArray)&&(s=!0);const a=q.get(e).__webglFramebuffer;e.isWebGLCubeRenderTarget?(n=a[t],r=!0):n=e.isWebGLMultisampleRenderTarget?q.get(e).__webglMultisampledFramebuffer:a,w.copy(e.viewport),M.copy(e.scissor),S=e.scissorTest}else w.copy(E).multiplyScalar(C).floor(),M.copy(D).multiplyScalar(C).floor(),S=I;if(H.bindFramebuffer(36160,n)&&W.drawBuffers){let t=!1;if(e)if(e.isWebGLMultipleRenderTargets){const i=e.texture;if(R.length!==i.length||36064!==R[0]){for(let e=0,t=i.length;e<t;e++)R[e]=36064+e;R.length=i.length,t=!0}}else 1===R.length&&36064===R[0]||(R[0]=36064,R.length=1,t=!0);else 1===R.length&&1029===R[0]||(R[0]=1029,R.length=1,t=!0);t&&(W.isWebGL2?he.drawBuffers(R):G.get("WEBGL_draw_buffers").drawBuffersWEBGL(R))}if(H.viewport(w),H.scissor(M),H.setScissorTest(S),r){const n=q.get(e.texture);he.framebufferTexture2D(36160,36064,34069+t,n.__webglTexture,i)}else if(s){const n=q.get(e.texture),r=t||0;he.framebufferTextureLayer(36160,36064,n.__webglTexture,i||0,r)}_=-1},this.readRenderTargetPixels=function(e,t,i,n,r,s,a){if(!e||!e.isWebGLRenderTarget)return;let o=q.get(e).__webglFramebuffer;if(e.isWebGLCubeRenderTarget&&void 0!==a&&(o=o[a]),o){H.bindFramebuffer(36160,o);try{const a=e.texture,o=a.format,l=a.type;if(1023!==o&&ce.convert(o)!==he.getParameter(35739))return;const c=1016===l&&(G.has("EXT_color_buffer_half_float")||W.isWebGL2&&G.has("EXT_color_buffer_float"));if(!(1009===l||ce.convert(l)===he.getParameter(35738)||1015===l&&(W.isWebGL2||G.has("OES_texture_float")||G.has("WEBGL_color_buffer_float"))||c))return;36053===he.checkFramebufferStatus(36160)&&t>=0&&t<=e.width-n&&i>=0&&i<=e.height-r&&he.readPixels(t,i,n,r,ce.convert(o),ce.convert(l),s)}finally{const e=null!==x?q.get(x).__webglFramebuffer:null;H.bindFramebuffer(36160,e)}}},this.copyFramebufferToTexture=function(e,t,i=0){const n=Math.pow(2,-i),r=Math.floor(t.image.width*n),s=Math.floor(t.image.height*n);let a=ce.convert(t.format);W.isWebGL2&&(6407===a&&(a=32849),6408===a&&(a=32856)),X.setTexture2D(t,0),he.copyTexImage2D(3553,i,a,e.x,e.y,r,s,0),H.unbindTexture()},this.copyTextureToTexture=function(e,t,i,n=0){const r=t.image.width,s=t.image.height,a=ce.convert(i.format),o=ce.convert(i.type);X.setTexture2D(i,0),he.pixelStorei(37440,i.flipY),he.pixelStorei(37441,i.premultiplyAlpha),he.pixelStorei(3317,i.unpackAlignment),t.isDataTexture?he.texSubImage2D(3553,n,e.x,e.y,r,s,a,o,t.image.data):t.isCompressedTexture?he.compressedTexSubImage2D(3553,n,e.x,e.y,t.mipmaps[0].width,t.mipmaps[0].height,a,t.mipmaps[0].data):he.texSubImage2D(3553,n,e.x,e.y,a,o,t.image),0===n&&i.generateMipmaps&&he.generateMipmap(3553),H.unbindTexture()},this.copyTextureToTexture3D=function(e,t,i,n,r=0){if(f.isWebGL1Renderer)return;const s=e.max.x-e.min.x+1,a=e.max.y-e.min.y+1,o=e.max.z-e.min.z+1,l=ce.convert(n.format),c=ce.convert(n.type);let u;if(n.isDataTexture3D)X.setTexture3D(n,0),u=32879;else{if(!n.isDataTexture2DArray)return;X.setTexture2DArray(n,0),u=35866}he.pixelStorei(37440,n.flipY),he.pixelStorei(37441,n.premultiplyAlpha),he.pixelStorei(3317,n.unpackAlignment);const h=he.getParameter(3314),d=he.getParameter(32878),p=he.getParameter(3316),m=he.getParameter(3315),g=he.getParameter(32877),v=i.isCompressedTexture?i.mipmaps[0]:i.image;he.pixelStorei(3314,v.width),he.pixelStorei(32878,v.height),he.pixelStorei(3316,e.min.x),he.pixelStorei(3315,e.min.y),he.pixelStorei(32877,e.min.z),i.isDataTexture||i.isDataTexture3D?he.texSubImage3D(u,r,t.x,t.y,t.z,s,a,o,l,c,v.data):i.isCompressedTexture?he.compressedTexSubImage3D(u,r,t.x,t.y,t.z,s,a,o,l,v.data):he.texSubImage3D(u,r,t.x,t.y,t.z,s,a,o,l,c,v),he.pixelStorei(3314,h),he.pixelStorei(32878,d),he.pixelStorei(3316,p),he.pixelStorei(3315,m),he.pixelStorei(32877,g),0===r&&n.generateMipmaps&&he.generateMipmap(u),H.unbindTexture()},this.initTexture=function(e){X.setTexture2D(e,0),H.unbindTexture()},this.resetState=function(){v=0,y=0,x=null,H.reset(),ue.reset()},"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))}class Bs{constructor(e,t=1,i=1e3){this.name="",this.color=new $t(e),this.near=t,this.far=i}clone(){return new Bs(this.color,this.near,this.far)}toJSON(){return{type:"Fog",color:this.color.getHex(),near:this.near,far:this.far}}}Bs.prototype.isFog=!0;class Vs extends Rt{constructor(){super(),this.type="Scene",this.background=null,this.environment=null,this.fog=null,this.overrideMaterial=null,this.autoUpdate=!0,"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))}copy(e,t){return super.copy(e,t),null!==e.background&&(this.background=e.background.clone()),null!==e.environment&&(this.environment=e.environment.clone()),null!==e.fog&&(this.fog=e.fog.clone()),null!==e.overrideMaterial&&(this.overrideMaterial=e.overrideMaterial.clone()),this.autoUpdate=e.autoUpdate,this.matrixAutoUpdate=e.matrixAutoUpdate,this}toJSON(e){const t=super.toJSON(e);return null!==this.fog&&(t.object.fog=this.fog.toJSON()),t}}Vs.prototype.isScene=!0;class Gs{constructor(e,t){this.array=e,this.stride=t,this.count=void 0!==e?e.length/t:0,this.usage=35044,this.updateRange={offset:0,count:-1},this.version=0,this.uuid=me()}onUploadCallback(){}set needsUpdate(e){!0===e&&this.version++}setUsage(e){return this.usage=e,this}copy(e){return this.array=new e.array.constructor(e.array),this.count=e.count,this.stride=e.stride,this.usage=e.usage,this}copyAt(e,t,i){e*=this.stride,i*=t.stride;for(let n=0,r=this.stride;n<r;n++)this.array[e+n]=t.array[i+n];return this}set(e,t=0){return this.array.set(e,t),this}clone(e){void 0===e.arrayBuffers&&(e.arrayBuffers={}),void 0===this.array.buffer._uuid&&(this.array.buffer._uuid=me()),void 0===e.arrayBuffers[this.array.buffer._uuid]&&(e.arrayBuffers[this.array.buffer._uuid]=this.array.slice(0).buffer);const t=new this.array.constructor(e.arrayBuffers[this.array.buffer._uuid]),i=new this.constructor(t,this.stride);return i.setUsage(this.usage),i}onUpload(e){return this.onUploadCallback=e,this}toJSON(e){return void 0===e.arrayBuffers&&(e.arrayBuffers={}),void 0===this.array.buffer._uuid&&(this.array.buffer._uuid=me()),void 0===e.arrayBuffers[this.array.buffer._uuid]&&(e.arrayBuffers[this.array.buffer._uuid]=Array.prototype.slice.call(new Uint32Array(this.array.buffer))),{uuid:this.uuid,buffer:this.array.buffer._uuid,type:this.array.constructor.name,stride:this.stride}}}Gs.prototype.isInterleavedBuffer=!0;const Ws=new De;class Hs{constructor(e,t,i,n=!1){this.name="",this.data=e,this.itemSize=t,this.offset=i,this.normalized=!0===n}get count(){return this.data.count}get array(){return this.data.array}set needsUpdate(e){this.data.needsUpdate=e}applyMatrix4(e){for(let t=0,i=this.data.count;t<i;t++)Ws.x=this.getX(t),Ws.y=this.getY(t),Ws.z=this.getZ(t),Ws.applyMatrix4(e),this.setXYZ(t,Ws.x,Ws.y,Ws.z);return this}applyNormalMatrix(e){for(let t=0,i=this.count;t<i;t++)Ws.x=this.getX(t),Ws.y=this.getY(t),Ws.z=this.getZ(t),Ws.applyNormalMatrix(e),this.setXYZ(t,Ws.x,Ws.y,Ws.z);return this}transformDirection(e){for(let t=0,i=this.count;t<i;t++)Ws.x=this.getX(t),Ws.y=this.getY(t),Ws.z=this.getZ(t),Ws.transformDirection(e),this.setXYZ(t,Ws.x,Ws.y,Ws.z);return this}setX(e,t){return this.data.array[e*this.data.stride+this.offset]=t,this}setY(e,t){return this.data.array[e*this.data.stride+this.offset+1]=t,this}setZ(e,t){return this.data.array[e*this.data.stride+this.offset+2]=t,this}setW(e,t){return this.data.array[e*this.data.stride+this.offset+3]=t,this}getX(e){return this.data.array[e*this.data.stride+this.offset]}getY(e){return this.data.array[e*this.data.stride+this.offset+1]}getZ(e){return this.data.array[e*this.data.stride+this.offset+2]}getW(e){return this.data.array[e*this.data.stride+this.offset+3]}setXY(e,t,i){return e=e*this.data.stride+this.offset,this.data.array[e+0]=t,this.data.array[e+1]=i,this}setXYZ(e,t,i,n){return e=e*this.data.stride+this.offset,this.data.array[e+0]=t,this.data.array[e+1]=i,this.data.array[e+2]=n,this}setXYZW(e,t,i,n,r){return e=e*this.data.stride+this.offset,this.data.array[e+0]=t,this.data.array[e+1]=i,this.data.array[e+2]=n,this.data.array[e+3]=r,this}clone(e){if(void 0===e){const e=[];for(let t=0;t<this.count;t++){const i=t*this.data.stride+this.offset;for(let t=0;t<this.itemSize;t++)e.push(this.data.array[i+t])}return new ni(new this.array.constructor(e),this.itemSize,this.normalized)}return void 0===e.interleavedBuffers&&(e.interleavedBuffers={}),void 0===e.interleavedBuffers[this.data.uuid]&&(e.interleavedBuffers[this.data.uuid]=this.data.clone(e)),new Hs(e.interleavedBuffers[this.data.uuid],this.itemSize,this.offset,this.normalized)}toJSON(e){if(void 0===e){const e=[];for(let t=0;t<this.count;t++){const i=t*this.data.stride+this.offset;for(let t=0;t<this.itemSize;t++)e.push(this.data.array[i+t])}return{itemSize:this.itemSize,type:this.array.constructor.name,array:e,normalized:this.normalized}}return void 0===e.interleavedBuffers&&(e.interleavedBuffers={}),void 0===e.interleavedBuffers[this.data.uuid]&&(e.interleavedBuffers[this.data.uuid]=this.data.toJSON(e)),{isInterleavedBufferAttribute:!0,itemSize:this.itemSize,data:this.data.uuid,offset:this.offset,normalized:this.normalized}}}Hs.prototype.isInterleavedBufferAttribute=!0;const js=new De,qs=new Ce,Xs=new Ce,Ys=new De,Zs=new lt;class Js extends Ri{constructor(e,t){super(e,t),this.type="SkinnedMesh",this.bindMode="attached",this.bindMatrix=new lt,this.bindMatrixInverse=new lt}copy(e){return super.copy(e),this.bindMode=e.bindMode,this.bindMatrix.copy(e.bindMatrix),this.bindMatrixInverse.copy(e.bindMatrixInverse),this.skeleton=e.skeleton,this}bind(e,t){this.skeleton=e,void 0===t&&(this.updateMatrixWorld(!0),this.skeleton.calculateInverses(),t=this.matrixWorld),this.bindMatrix.copy(t),this.bindMatrixInverse.copy(t).invert()}pose(){this.skeleton.pose()}normalizeSkinWeights(){const e=new Ce,t=this.geometry.attributes.skinWeight;for(let i=0,n=t.count;i<n;i++){e.x=t.getX(i),e.y=t.getY(i),e.z=t.getZ(i),e.w=t.getW(i);const n=1/e.manhattanLength();Infinity!==n?e.multiplyScalar(n):e.set(1,0,0,0),t.setXYZW(i,e.x,e.y,e.z,e.w)}}updateMatrixWorld(e){super.updateMatrixWorld(e),"attached"===this.bindMode?this.bindMatrixInverse.copy(this.matrixWorld).invert():"detached"===this.bindMode&&this.bindMatrixInverse.copy(this.bindMatrix).invert()}boneTransform(e,t){const i=this.skeleton,n=this.geometry;qs.fromBufferAttribute(n.attributes.skinIndex,e),Xs.fromBufferAttribute(n.attributes.skinWeight,e),js.copy(t).applyMatrix4(this.bindMatrix),t.set(0,0,0);for(let r=0;r<4;r++){const e=Xs.getComponent(r);if(0!==e){const n=qs.getComponent(r);Zs.multiplyMatrices(i.bones[n].matrixWorld,i.boneInverses[n]),t.addScaledVector(Ys.copy(js).applyMatrix4(Zs),e)}}return t.applyMatrix4(this.bindMatrixInverse)}}Js.prototype.isSkinnedMesh=!0;class Qs extends Rt{constructor(){super(),this.type="Bone"}}Qs.prototype.isBone=!0;class Ks extends Te{constructor(e=null,t=1,i=1,n,r,s,a,o,l=1003,c=1003,u,h){super(null,s,a,o,l,c,n,r,u,h),this.image={data:e,width:t,height:i},this.magFilter=l,this.minFilter=c,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1,this.needsUpdate=!0}}Ks.prototype.isDataTexture=!0;const $s=new lt,ea=new lt;class ta{constructor(e=[],t=[]){this.uuid=me(),this.bones=e.slice(0),this.boneInverses=t,this.boneMatrices=null,this.boneTexture=null,this.boneTextureSize=0,this.frame=-1,this.init()}init(){const e=this.bones,t=this.boneInverses;if(this.boneMatrices=new Float32Array(16*e.length),0===t.length)this.calculateInverses();else if(e.length!==t.length){this.boneInverses=[];for(let e=0,t=this.bones.length;e<t;e++)this.boneInverses.push(new lt)}}calculateInverses(){this.boneInverses.length=0;for(let e=0,t=this.bones.length;e<t;e++){const t=new lt;this.bones[e]&&t.copy(this.bones[e].matrixWorld).invert(),this.boneInverses.push(t)}}pose(){for(let e=0,t=this.bones.length;e<t;e++){const t=this.bones[e];t&&t.matrixWorld.copy(this.boneInverses[e]).invert()}for(let e=0,t=this.bones.length;e<t;e++){const t=this.bones[e];t&&(t.parent&&t.parent.isBone?(t.matrix.copy(t.parent.matrixWorld).invert(),t.matrix.multiply(t.matrixWorld)):t.matrix.copy(t.matrixWorld),t.matrix.decompose(t.position,t.quaternion,t.scale))}}update(){const e=this.bones,t=this.boneInverses,i=this.boneMatrices,n=this.boneTexture;for(let r=0,s=e.length;r<s;r++){const n=e[r]?e[r].matrixWorld:ea;$s.multiplyMatrices(n,t[r]),$s.toArray(i,16*r)}null!==n&&(n.needsUpdate=!0)}clone(){return new ta(this.bones,this.boneInverses)}computeBoneTexture(){let e=Math.sqrt(4*this.bones.length);var t;t=e,e=Math.pow(2,Math.ceil(Math.log(t)/Math.LN2)),e=Math.max(e,4);const i=new Float32Array(e*e*4);i.set(this.boneMatrices);const n=new Ks(i,e,e,1023,1015);return this.boneMatrices=i,this.boneTexture=n,this.boneTextureSize=e,this}getBoneByName(e){for(let t=0,i=this.bones.length;t<i;t++){const i=this.bones[t];if(i.name===e)return i}}dispose(){null!==this.boneTexture&&(this.boneTexture.dispose(),this.boneTexture=null)}fromJSON(e,t){this.uuid=e.uuid;for(let i=0,n=e.bones.length;i<n;i++){let n=t[e.bones[i]];void 0===n&&(n=new Qs),this.bones.push(n),this.boneInverses.push((new lt).fromArray(e.boneInverses[i]))}return this.init(),this}toJSON(){const e={metadata:{version:4.5,type:"Skeleton",generator:"Skeleton.toJSON"},bones:[],boneInverses:[]};e.uuid=this.uuid;const t=this.bones,i=this.boneInverses;for(let n=0,r=t.length;n<r;n++){const r=t[n];e.bones.push(r.uuid);const s=i[n];e.boneInverses.push(s.toArray())}return e}}class ia extends ni{constructor(e,t,i,n=1){"number"==typeof i&&(n=i,i=!1),super(e,t,i),this.meshPerAttribute=n}copy(e){return super.copy(e),this.meshPerAttribute=e.meshPerAttribute,this}toJSON(){const e=super.toJSON();return e.meshPerAttribute=this.meshPerAttribute,e.isInstancedBufferAttribute=!0,e}}ia.prototype.isInstancedBufferAttribute=!0;const na=new lt,ra=new lt,sa=[],aa=new Ri;class oa extends Ri{constructor(e,t,i){super(e,t),this.instanceMatrix=new ia(new Float32Array(16*i),16),this.instanceColor=null,this.count=i,this.frustumCulled=!1}copy(e){return super.copy(e),this.instanceMatrix.copy(e.instanceMatrix),null!==e.instanceColor&&(this.instanceColor=e.instanceColor.clone()),this.count=e.count,this}getColorAt(e,t){t.fromArray(this.instanceColor.array,3*e)}getMatrixAt(e,t){t.fromArray(this.instanceMatrix.array,16*e)}raycast(e,t){const i=this.matrixWorld,n=this.count;if(aa.geometry=this.geometry,aa.material=this.material,void 0!==aa.material)for(let r=0;r<n;r++){this.getMatrixAt(r,na),ra.multiplyMatrices(i,na),aa.matrixWorld=ra,aa.raycast(e,sa);for(let e=0,i=sa.length;e<i;e++){const i=sa[e];i.instanceId=r,i.object=this,t.push(i)}sa.length=0}}setColorAt(e,t){null===this.instanceColor&&(this.instanceColor=new ia(new Float32Array(3*this.instanceMatrix.count),3)),t.toArray(this.instanceColor.array,3*e)}setMatrixAt(e,t){t.toArray(this.instanceMatrix.array,16*e)}updateMorphTargets(){}dispose(){this.dispatchEvent({type:"dispose"})}}oa.prototype.isInstancedMesh=!0;class la extends qt{constructor(e){super(),this.type="LineBasicMaterial",this.color=new $t(16777215),this.linewidth=1,this.linecap="round",this.linejoin="round",this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.linewidth=e.linewidth,this.linecap=e.linecap,this.linejoin=e.linejoin,this}}la.prototype.isLineBasicMaterial=!0;const ca=new De,ua=new De,ha=new lt,da=new ot,pa=new $e;class ma extends Rt{constructor(e=new fi,t=new la){super(),this.type="Line",this.geometry=e,this.material=t,this.updateMorphTargets()}copy(e){return super.copy(e),this.material=e.material,this.geometry=e.geometry,this}computeLineDistances(){const e=this.geometry;if(e.isBufferGeometry){if(null===e.index){const t=e.attributes.position,i=[0];for(let e=1,n=t.count;e<n;e++)ca.fromBufferAttribute(t,e-1),ua.fromBufferAttribute(t,e),i[e]=i[e-1],i[e]+=ca.distanceTo(ua);e.setAttribute("lineDistance",new oi(i,1))}}else e.isGeometry;return this}raycast(e,t){const i=this.geometry,n=this.matrixWorld,r=e.params.Line.threshold,s=i.drawRange;if(null===i.boundingSphere&&i.computeBoundingSphere(),pa.copy(i.boundingSphere),pa.applyMatrix4(n),pa.radius+=r,!1===e.ray.intersectsSphere(pa))return;ha.copy(n).invert(),da.copy(e.ray).applyMatrix4(ha);const a=r/((this.scale.x+this.scale.y+this.scale.z)/3),o=a*a,l=new De,c=new De,u=new De,h=new De,d=this.isLineSegments?2:1;if(i.isBufferGeometry){const n=i.index,r=i.attributes.position;if(null!==n){for(let i=Math.max(0,s.start),a=Math.min(n.count,s.start+s.count)-1;i<a;i+=d){const s=n.getX(i),a=n.getX(i+1);l.fromBufferAttribute(r,s),c.fromBufferAttribute(r,a);if(da.distanceSqToSegment(l,c,h,u)>o)continue;h.applyMatrix4(this.matrixWorld);const d=e.ray.origin.distanceTo(h);d<e.near||d>e.far||t.push({distance:d,point:u.clone().applyMatrix4(this.matrixWorld),index:i,face:null,faceIndex:null,object:this})}}else{for(let i=Math.max(0,s.start),n=Math.min(r.count,s.start+s.count)-1;i<n;i+=d){l.fromBufferAttribute(r,i),c.fromBufferAttribute(r,i+1);if(da.distanceSqToSegment(l,c,h,u)>o)continue;h.applyMatrix4(this.matrixWorld);const n=e.ray.origin.distanceTo(h);n<e.near||n>e.far||t.push({distance:n,point:u.clone().applyMatrix4(this.matrixWorld),index:i,face:null,faceIndex:null,object:this})}}}else i.isGeometry}updateMorphTargets(){const e=this.geometry;if(e.isBufferGeometry){const t=e.morphAttributes,i=Object.keys(t);if(i.length>0){const e=t[i[0]];if(void 0!==e){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let t=0,i=e.length;t<i;t++){const i=e[t].name||String(t);this.morphTargetInfluences.push(0),this.morphTargetDictionary[i]=t}}}}else{const t=e.morphTargets;void 0!==t&&t.length}}}ma.prototype.isLine=!0;const fa=new De,ga=new De;class va extends ma{constructor(e,t){super(e,t),this.type="LineSegments"}computeLineDistances(){const e=this.geometry;if(e.isBufferGeometry){if(null===e.index){const t=e.attributes.position,i=[];for(let e=0,n=t.count;e<n;e+=2)fa.fromBufferAttribute(t,e),ga.fromBufferAttribute(t,e+1),i[e]=0===e?0:i[e-1],i[e+1]=i[e]+fa.distanceTo(ga);e.setAttribute("lineDistance",new oi(i,1))}}else e.isGeometry;return this}}va.prototype.isLineSegments=!0;class ya extends ma{constructor(e,t){super(e,t),this.type="LineLoop"}}ya.prototype.isLineLoop=!0;class xa extends qt{constructor(e){super(),this.type="PointsMaterial",this.color=new $t(16777215),this.map=null,this.alphaMap=null,this.size=1,this.sizeAttenuation=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.alphaMap=e.alphaMap,this.size=e.size,this.sizeAttenuation=e.sizeAttenuation,this}}xa.prototype.isPointsMaterial=!0;const _a=new lt,ba=new ot,wa=new $e,Ma=new De;class Sa extends Rt{constructor(e=new fi,t=new xa){super(),this.type="Points",this.geometry=e,this.material=t,this.updateMorphTargets()}copy(e){return super.copy(e),this.material=e.material,this.geometry=e.geometry,this}raycast(e,t){const i=this.geometry,n=this.matrixWorld,r=e.params.Points.threshold,s=i.drawRange;if(null===i.boundingSphere&&i.computeBoundingSphere(),wa.copy(i.boundingSphere),wa.applyMatrix4(n),wa.radius+=r,!1===e.ray.intersectsSphere(wa))return;_a.copy(n).invert(),ba.copy(e.ray).applyMatrix4(_a);const a=r/((this.scale.x+this.scale.y+this.scale.z)/3),o=a*a;if(i.isBufferGeometry){const r=i.index,a=i.attributes.position;if(null!==r){for(let i=Math.max(0,s.start),l=Math.min(r.count,s.start+s.count);i<l;i++){const s=r.getX(i);Ma.fromBufferAttribute(a,s),Ta(Ma,s,o,n,e,t,this)}}else{for(let i=Math.max(0,s.start),r=Math.min(a.count,s.start+s.count);i<r;i++)Ma.fromBufferAttribute(a,i),Ta(Ma,i,o,n,e,t,this)}}}updateMorphTargets(){const e=this.geometry;if(e.isBufferGeometry){const t=e.morphAttributes,i=Object.keys(t);if(i.length>0){const e=t[i[0]];if(void 0!==e){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let t=0,i=e.length;t<i;t++){const i=e[t].name||String(t);this.morphTargetInfluences.push(0),this.morphTargetDictionary[i]=t}}}}else{const t=e.morphTargets;void 0!==t&&t.length}}}function Ta(e,t,i,n,r,s,a){const o=ba.distanceSqToPoint(e);if(o<i){const i=new De;ba.closestPointToPoint(e,i),i.applyMatrix4(n);const l=r.ray.origin.distanceTo(i);if(l<r.near||l>r.far)return;s.push({distance:l,distanceToRay:Math.sqrt(o),point:i,index:t,face:null,object:a})}}Sa.prototype.isPoints=!0;class Aa{constructor(){this.type="Curve",this.arcLengthDivisions=200}getPoint(){return null}getPointAt(e,t){const i=this.getUtoTmapping(e);return this.getPoint(i,t)}getPoints(e=5){const t=[];for(let i=0;i<=e;i++)t.push(this.getPoint(i/e));return t}getSpacedPoints(e=5){const t=[];for(let i=0;i<=e;i++)t.push(this.getPointAt(i/e));return t}getLength(){const e=this.getLengths();return e[e.length-1]}getLengths(e=this.arcLengthDivisions){if(this.cacheArcLengths&&this.cacheArcLengths.length===e+1&&!this.needsUpdate)return this.cacheArcLengths;this.needsUpdate=!1;const t=[];let i,n=this.getPoint(0),r=0;t.push(0);for(let s=1;s<=e;s++)i=this.getPoint(s/e),r+=i.distanceTo(n),t.push(r),n=i;return this.cacheArcLengths=t,t}updateArcLengths(){this.needsUpdate=!0,this.getLengths()}getUtoTmapping(e,t){const i=this.getLengths();let n=0;const r=i.length;let s;s=t||e*i[r-1];let a,o=0,l=r-1;for(;o<=l;)if(n=Math.floor(o+(l-o)/2),a=i[n]-s,a<0)o=n+1;else{if(!(a>0)){l=n;break}l=n-1}if(n=l,i[n]===s)return n/(r-1);const c=i[n];return(n+(s-c)/(i[n+1]-c))/(r-1)}getTangent(e,t){const i=1e-4;let n=e-i,r=e+i;n<0&&(n=0),r>1&&(r=1);const s=this.getPoint(n),a=this.getPoint(r),o=t||(s.isVector2?new xe:new De);return o.copy(a).sub(s).normalize(),o}getTangentAt(e,t){const i=this.getUtoTmapping(e);return this.getTangent(i,t)}computeFrenetFrames(e,t){const i=new De,n=[],r=[],s=[],a=new De,o=new lt;for(let d=0;d<=e;d++){const t=d/e;n[d]=this.getTangentAt(t,new De)}r[0]=new De,s[0]=new De;let l=Number.MAX_VALUE;const c=Math.abs(n[0].x),u=Math.abs(n[0].y),h=Math.abs(n[0].z);c<=l&&(l=c,i.set(1,0,0)),u<=l&&(l=u,i.set(0,1,0)),h<=l&&i.set(0,0,1),a.crossVectors(n[0],i).normalize(),r[0].crossVectors(n[0],a),s[0].crossVectors(n[0],r[0]);for(let d=1;d<=e;d++){if(r[d]=r[d-1].clone(),s[d]=s[d-1].clone(),a.crossVectors(n[d-1],n[d]),a.length()>Number.EPSILON){a.normalize();const e=Math.acos(fe(n[d-1].dot(n[d]),-1,1));r[d].applyMatrix4(o.makeRotationAxis(a,e))}s[d].crossVectors(n[d],r[d])}if(!0===t){let t=Math.acos(fe(r[0].dot(r[e]),-1,1));t/=e,n[0].dot(a.crossVectors(r[0],r[e]))>0&&(t=-t);for(let i=1;i<=e;i++)r[i].applyMatrix4(o.makeRotationAxis(n[i],t*i)),s[i].crossVectors(n[i],r[i])}return{tangents:n,normals:r,binormals:s}}clone(){return(new this.constructor).copy(this)}copy(e){return this.arcLengthDivisions=e.arcLengthDivisions,this}toJSON(){const e={metadata:{version:4.5,type:"Curve",generator:"Curve.toJSON"}};return e.arcLengthDivisions=this.arcLengthDivisions,e.type=this.type,e}fromJSON(e){return this.arcLengthDivisions=e.arcLengthDivisions,this}}class Ca extends Aa{constructor(e=0,t=0,i=1,n=1,r=0,s=2*Math.PI,a=!1,o=0){super(),this.type="EllipseCurve",this.aX=e,this.aY=t,this.xRadius=i,this.yRadius=n,this.aStartAngle=r,this.aEndAngle=s,this.aClockwise=a,this.aRotation=o}getPoint(e,t){const i=t||new xe,n=2*Math.PI;let r=this.aEndAngle-this.aStartAngle;const s=Math.abs(r)<Number.EPSILON;for(;r<0;)r+=n;for(;r>n;)r-=n;r<Number.EPSILON&&(r=s?0:n),!0!==this.aClockwise||s||(r===n?r=-n:r-=n);const a=this.aStartAngle+e*r;let o=this.aX+this.xRadius*Math.cos(a),l=this.aY+this.yRadius*Math.sin(a);if(0!==this.aRotation){const e=Math.cos(this.aRotation),t=Math.sin(this.aRotation),i=o-this.aX,n=l-this.aY;o=i*e-n*t+this.aX,l=i*t+n*e+this.aY}return i.set(o,l)}copy(e){return super.copy(e),this.aX=e.aX,this.aY=e.aY,this.xRadius=e.xRadius,this.yRadius=e.yRadius,this.aStartAngle=e.aStartAngle,this.aEndAngle=e.aEndAngle,this.aClockwise=e.aClockwise,this.aRotation=e.aRotation,this}toJSON(){const e=super.toJSON();return e.aX=this.aX,e.aY=this.aY,e.xRadius=this.xRadius,e.yRadius=this.yRadius,e.aStartAngle=this.aStartAngle,e.aEndAngle=this.aEndAngle,e.aClockwise=this.aClockwise,e.aRotation=this.aRotation,e}fromJSON(e){return super.fromJSON(e),this.aX=e.aX,this.aY=e.aY,this.xRadius=e.xRadius,this.yRadius=e.yRadius,this.aStartAngle=e.aStartAngle,this.aEndAngle=e.aEndAngle,this.aClockwise=e.aClockwise,this.aRotation=e.aRotation,this}}Ca.prototype.isEllipseCurve=!0;class La extends Ca{constructor(e,t,i,n,r,s){super(e,t,i,i,n,r,s),this.type="ArcCurve"}}function Pa(){let e=0,t=0,i=0,n=0;function r(r,s,a,o){e=r,t=a,i=-3*r+3*s-2*a-o,n=2*r-2*s+a+o}return{initCatmullRom:function(e,t,i,n,s){r(t,i,s*(i-e),s*(n-t))},initNonuniformCatmullRom:function(e,t,i,n,s,a,o){let l=(t-e)/s-(i-e)/(s+a)+(i-t)/a,c=(i-t)/a-(n-t)/(a+o)+(n-i)/o;l*=a,c*=a,r(t,i,l,c)},calc:function(r){const s=r*r;return e+t*r+i*s+n*(s*r)}}}La.prototype.isArcCurve=!0;const Ea=new De,Da=new Pa,Ia=new Pa,Ra=new Pa;class za extends Aa{constructor(e=[],t=!1,i="centripetal",n=.5){super(),this.type="CatmullRomCurve3",this.points=e,this.closed=t,this.curveType=i,this.tension=n}getPoint(e,t=new De){const i=t,n=this.points,r=n.length,s=(r-(this.closed?0:1))*e;let a,o,l=Math.floor(s),c=s-l;this.closed?l+=l>0?0:(Math.floor(Math.abs(l)/r)+1)*r:0===c&&l===r-1&&(l=r-2,c=1),this.closed||l>0?a=n[(l-1)%r]:(Ea.subVectors(n[0],n[1]).add(n[0]),a=Ea);const u=n[l%r],h=n[(l+1)%r];if(this.closed||l+2<r?o=n[(l+2)%r]:(Ea.subVectors(n[r-1],n[r-2]).add(n[r-1]),o=Ea),"centripetal"===this.curveType||"chordal"===this.curveType){const e="chordal"===this.curveType?.5:.25;let t=Math.pow(a.distanceToSquared(u),e),i=Math.pow(u.distanceToSquared(h),e),n=Math.pow(h.distanceToSquared(o),e);i<1e-4&&(i=1),t<1e-4&&(t=i),n<1e-4&&(n=i),Da.initNonuniformCatmullRom(a.x,u.x,h.x,o.x,t,i,n),Ia.initNonuniformCatmullRom(a.y,u.y,h.y,o.y,t,i,n),Ra.initNonuniformCatmullRom(a.z,u.z,h.z,o.z,t,i,n)}else"catmullrom"===this.curveType&&(Da.initCatmullRom(a.x,u.x,h.x,o.x,this.tension),Ia.initCatmullRom(a.y,u.y,h.y,o.y,this.tension),Ra.initCatmullRom(a.z,u.z,h.z,o.z,this.tension));return i.set(Da.calc(c),Ia.calc(c),Ra.calc(c)),i}copy(e){super.copy(e),this.points=[];for(let t=0,i=e.points.length;t<i;t++){const i=e.points[t];this.points.push(i.clone())}return this.closed=e.closed,this.curveType=e.curveType,this.tension=e.tension,this}toJSON(){const e=super.toJSON();e.points=[];for(let t=0,i=this.points.length;t<i;t++){const i=this.points[t];e.points.push(i.toArray())}return e.closed=this.closed,e.curveType=this.curveType,e.tension=this.tension,e}fromJSON(e){super.fromJSON(e),this.points=[];for(let t=0,i=e.points.length;t<i;t++){const i=e.points[t];this.points.push((new De).fromArray(i))}return this.closed=e.closed,this.curveType=e.curveType,this.tension=e.tension,this}}function Na(e,t,i,n,r){const s=.5*(n-t),a=.5*(r-i),o=e*e;return(2*i-2*n+s+a)*(e*o)+(-3*i+3*n-2*s-a)*o+s*e+i}function Oa(e,t,i,n){return function(e,t){const i=1-e;return i*i*t}(e,t)+function(e,t){return 2*(1-e)*e*t}(e,i)+function(e,t){return e*e*t}(e,n)}function Fa(e,t,i,n,r){return function(e,t){const i=1-e;return i*i*i*t}(e,t)+function(e,t){const i=1-e;return 3*i*i*e*t}(e,i)+function(e,t){return 3*(1-e)*e*e*t}(e,n)+function(e,t){return e*e*e*t}(e,r)}za.prototype.isCatmullRomCurve3=!0;class Ua extends Aa{constructor(e=new xe,t=new xe,i=new xe,n=new xe){super(),this.type="CubicBezierCurve",this.v0=e,this.v1=t,this.v2=i,this.v3=n}getPoint(e,t=new xe){const i=t,n=this.v0,r=this.v1,s=this.v2,a=this.v3;return i.set(Fa(e,n.x,r.x,s.x,a.x),Fa(e,n.y,r.y,s.y,a.y)),i}copy(e){return super.copy(e),this.v0.copy(e.v0),this.v1.copy(e.v1),this.v2.copy(e.v2),this.v3.copy(e.v3),this}toJSON(){const e=super.toJSON();return e.v0=this.v0.toArray(),e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e.v3=this.v3.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v0.fromArray(e.v0),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this.v3.fromArray(e.v3),this}}Ua.prototype.isCubicBezierCurve=!0;class ka extends Aa{constructor(e=new De,t=new De,i=new De,n=new De){super(),this.type="CubicBezierCurve3",this.v0=e,this.v1=t,this.v2=i,this.v3=n}getPoint(e,t=new De){const i=t,n=this.v0,r=this.v1,s=this.v2,a=this.v3;return i.set(Fa(e,n.x,r.x,s.x,a.x),Fa(e,n.y,r.y,s.y,a.y),Fa(e,n.z,r.z,s.z,a.z)),i}copy(e){return super.copy(e),this.v0.copy(e.v0),this.v1.copy(e.v1),this.v2.copy(e.v2),this.v3.copy(e.v3),this}toJSON(){const e=super.toJSON();return e.v0=this.v0.toArray(),e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e.v3=this.v3.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v0.fromArray(e.v0),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this.v3.fromArray(e.v3),this}}ka.prototype.isCubicBezierCurve3=!0;class Ba extends Aa{constructor(e=new xe,t=new xe){super(),this.type="LineCurve",this.v1=e,this.v2=t}getPoint(e,t=new xe){const i=t;return 1===e?i.copy(this.v2):(i.copy(this.v2).sub(this.v1),i.multiplyScalar(e).add(this.v1)),i}getPointAt(e,t){return this.getPoint(e,t)}getTangent(e,t){const i=t||new xe;return i.copy(this.v2).sub(this.v1).normalize(),i}copy(e){return super.copy(e),this.v1.copy(e.v1),this.v2.copy(e.v2),this}toJSON(){const e=super.toJSON();return e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this}}Ba.prototype.isLineCurve=!0;class Va extends Aa{constructor(e=new xe,t=new xe,i=new xe){super(),this.type="QuadraticBezierCurve",this.v0=e,this.v1=t,this.v2=i}getPoint(e,t=new xe){const i=t,n=this.v0,r=this.v1,s=this.v2;return i.set(Oa(e,n.x,r.x,s.x),Oa(e,n.y,r.y,s.y)),i}copy(e){return super.copy(e),this.v0.copy(e.v0),this.v1.copy(e.v1),this.v2.copy(e.v2),this}toJSON(){const e=super.toJSON();return e.v0=this.v0.toArray(),e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v0.fromArray(e.v0),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this}}Va.prototype.isQuadraticBezierCurve=!0;class Ga extends Aa{constructor(e=new De,t=new De,i=new De){super(),this.type="QuadraticBezierCurve3",this.v0=e,this.v1=t,this.v2=i}getPoint(e,t=new De){const i=t,n=this.v0,r=this.v1,s=this.v2;return i.set(Oa(e,n.x,r.x,s.x),Oa(e,n.y,r.y,s.y),Oa(e,n.z,r.z,s.z)),i}copy(e){return super.copy(e),this.v0.copy(e.v0),this.v1.copy(e.v1),this.v2.copy(e.v2),this}toJSON(){const e=super.toJSON();return e.v0=this.v0.toArray(),e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v0.fromArray(e.v0),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this}}Ga.prototype.isQuadraticBezierCurve3=!0;class Wa extends Aa{constructor(e=[]){super(),this.type="SplineCurve",this.points=e}getPoint(e,t=new xe){const i=t,n=this.points,r=(n.length-1)*e,s=Math.floor(r),a=r-s,o=n[0===s?s:s-1],l=n[s],c=n[s>n.length-2?n.length-1:s+1],u=n[s>n.length-3?n.length-1:s+2];return i.set(Na(a,o.x,l.x,c.x,u.x),Na(a,o.y,l.y,c.y,u.y)),i}copy(e){super.copy(e),this.points=[];for(let t=0,i=e.points.length;t<i;t++){const i=e.points[t];this.points.push(i.clone())}return this}toJSON(){const e=super.toJSON();e.points=[];for(let t=0,i=this.points.length;t<i;t++){const i=this.points[t];e.points.push(i.toArray())}return e}fromJSON(e){super.fromJSON(e),this.points=[];for(let t=0,i=e.points.length;t<i;t++){const i=e.points[t];this.points.push((new xe).fromArray(i))}return this}}Wa.prototype.isSplineCurve=!0;var Ha=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",ArcCurve:La,CatmullRomCurve3:za,CubicBezierCurve:Ua,CubicBezierCurve3:ka,EllipseCurve:Ca,LineCurve:Ba,LineCurve3:class extends Aa{constructor(e=new De,t=new De){super(),this.type="LineCurve3",this.isLineCurve3=!0,this.v1=e,this.v2=t}getPoint(e,t=new De){const i=t;return 1===e?i.copy(this.v2):(i.copy(this.v2).sub(this.v1),i.multiplyScalar(e).add(this.v1)),i}getPointAt(e,t){return this.getPoint(e,t)}copy(e){return super.copy(e),this.v1.copy(e.v1),this.v2.copy(e.v2),this}toJSON(){const e=super.toJSON();return e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this}},QuadraticBezierCurve:Va,QuadraticBezierCurve3:Ga,SplineCurve:Wa});class ja extends Aa{constructor(){super(),this.type="CurvePath",this.curves=[],this.autoClose=!1}add(e){this.curves.push(e)}closePath(){const e=this.curves[0].getPoint(0),t=this.curves[this.curves.length-1].getPoint(1);e.equals(t)||this.curves.push(new Ba(t,e))}getPoint(e,t){const i=e*this.getLength(),n=this.getCurveLengths();let r=0;for(;r<n.length;){if(n[r]>=i){const e=n[r]-i,s=this.curves[r],a=s.getLength(),o=0===a?0:1-e/a;return s.getPointAt(o,t)}r++}return null}getLength(){const e=this.getCurveLengths();return e[e.length-1]}updateArcLengths(){this.needsUpdate=!0,this.cacheLengths=null,this.getCurveLengths()}getCurveLengths(){if(this.cacheLengths&&this.cacheLengths.length===this.curves.length)return this.cacheLengths;const e=[];let t=0;for(let i=0,n=this.curves.length;i<n;i++)t+=this.curves[i].getLength(),e.push(t);return this.cacheLengths=e,e}getSpacedPoints(e=40){const t=[];for(let i=0;i<=e;i++)t.push(this.getPoint(i/e));return this.autoClose&&t.push(t[0]),t}getPoints(e=12){const t=[];let i;for(let n=0,r=this.curves;n<r.length;n++){const s=r[n],a=s&&s.isEllipseCurve?2*e:s&&(s.isLineCurve||s.isLineCurve3)?1:s&&s.isSplineCurve?e*s.points.length:e,o=s.getPoints(a);for(let e=0;e<o.length;e++){const n=o[e];i&&i.equals(n)||(t.push(n),i=n)}}return this.autoClose&&t.length>1&&!t[t.length-1].equals(t[0])&&t.push(t[0]),t}copy(e){super.copy(e),this.curves=[];for(let t=0,i=e.curves.length;t<i;t++){const i=e.curves[t];this.curves.push(i.clone())}return this.autoClose=e.autoClose,this}toJSON(){const e=super.toJSON();e.autoClose=this.autoClose,e.curves=[];for(let t=0,i=this.curves.length;t<i;t++){const i=this.curves[t];e.curves.push(i.toJSON())}return e}fromJSON(e){super.fromJSON(e),this.autoClose=e.autoClose,this.curves=[];for(let t=0,i=e.curves.length;t<i;t++){const i=e.curves[t];this.curves.push((new Ha[i.type]).fromJSON(i))}return this}}class qa extends qt{constructor(e){super(),this.defines={STANDARD:""},this.type="MeshStandardMaterial",this.color=new $t(16777215),this.roughness=1,this.metalness=0,this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new $t(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=0,this.normalScale=new xe(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.roughnessMap=null,this.metalnessMap=null,this.alphaMap=null,this.envMap=null,this.envMapIntensity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.flatShading=!1,this.setValues(e)}copy(e){return super.copy(e),this.defines={STANDARD:""},this.color.copy(e.color),this.roughness=e.roughness,this.metalness=e.metalness,this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.roughnessMap=e.roughnessMap,this.metalnessMap=e.metalnessMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.envMapIntensity=e.envMapIntensity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.flatShading=e.flatShading,this}}qa.prototype.isMeshStandardMaterial=!0;class Xa extends qa{constructor(e){super(),this.defines={STANDARD:"",PHYSICAL:""},this.type="MeshPhysicalMaterial",this.clearcoatMap=null,this.clearcoatRoughness=0,this.clearcoatRoughnessMap=null,this.clearcoatNormalScale=new xe(1,1),this.clearcoatNormalMap=null,this.ior=1.5,Object.defineProperty(this,"reflectivity",{get:function(){return fe(2.5*(this.ior-1)/(this.ior+1),0,1)},set:function(e){this.ior=(1+.4*e)/(1-.4*e)}}),this.sheenTint=new $t(0),this.sheenRoughness=1,this.transmissionMap=null,this.thickness=.01,this.thicknessMap=null,this.attenuationDistance=0,this.attenuationTint=new $t(1,1,1),this.specularIntensity=1,this.specularIntensityMap=null,this.specularTint=new $t(1,1,1),this.specularTintMap=null,this._sheen=0,this._clearcoat=0,this._transmission=0,this.setValues(e)}get sheen(){return this._sheen}set sheen(e){this._sheen>0!=e>0&&this.version++,this._sheen=e}get clearcoat(){return this._clearcoat}set clearcoat(e){this._clearcoat>0!=e>0&&this.version++,this._clearcoat=e}get transmission(){return this._transmission}set transmission(e){this._transmission>0!=e>0&&this.version++,this._transmission=e}copy(e){return super.copy(e),this.defines={STANDARD:"",PHYSICAL:""},this.clearcoat=e.clearcoat,this.clearcoatMap=e.clearcoatMap,this.clearcoatRoughness=e.clearcoatRoughness,this.clearcoatRoughnessMap=e.clearcoatRoughnessMap,this.clearcoatNormalMap=e.clearcoatNormalMap,this.clearcoatNormalScale.copy(e.clearcoatNormalScale),this.ior=e.ior,this.sheen=e.sheen,this.sheenTint.copy(e.sheenTint),this.sheenRoughness=e.sheenRoughness,this.transmission=e.transmission,this.transmissionMap=e.transmissionMap,this.thickness=e.thickness,this.thicknessMap=e.thicknessMap,this.attenuationDistance=e.attenuationDistance,this.attenuationTint.copy(e.attenuationTint),this.specularIntensity=e.specularIntensity,this.specularIntensityMap=e.specularIntensityMap,this.specularTint.copy(e.specularTint),this.specularTintMap=e.specularTintMap,this}}Xa.prototype.isMeshPhysicalMaterial=!0;class Ya extends qt{constructor(e){super(),this.type="MeshNormalMaterial",this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=0,this.normalScale=new xe(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.flatShading=!1,this.setValues(e)}copy(e){return super.copy(e),this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.flatShading=e.flatShading,this}}Ya.prototype.isMeshNormalMaterial=!0;const Za={arraySlice:function(e,t,i){return Za.isTypedArray(e)?new e.constructor(e.subarray(t,void 0!==i?i:e.length)):e.slice(t,i)},convertArray:function(e,t,i){return!e||!i&&e.constructor===t?e:"number"==typeof t.BYTES_PER_ELEMENT?new t(e):Array.prototype.slice.call(e)},isTypedArray:function(e){return ArrayBuffer.isView(e)&&!(e instanceof DataView)},getKeyframeOrder:function(e){const t=e.length,i=new Array(t);for(let n=0;n!==t;++n)i[n]=n;return i.sort((function(t,i){return e[t]-e[i]})),i},sortedArray:function(e,t,i){const n=e.length,r=new e.constructor(n);for(let s=0,a=0;a!==n;++s){const n=i[s]*t;for(let i=0;i!==t;++i)r[a++]=e[n+i]}return r},flattenJSON:function(e,t,i,n){let r=1,s=e[0];for(;void 0!==s&&void 0===s[n];)s=e[r++];if(void 0===s)return;let a=s[n];if(void 0!==a)if(Array.isArray(a))do{a=s[n],void 0!==a&&(t.push(s.time),i.push.apply(i,a)),s=e[r++]}while(void 0!==s);else if(void 0!==a.toArray)do{a=s[n],void 0!==a&&(t.push(s.time),a.toArray(i,i.length)),s=e[r++]}while(void 0!==s);else do{a=s[n],void 0!==a&&(t.push(s.time),i.push(a)),s=e[r++]}while(void 0!==s)},subclip:function(e,t,i,n,r=30){const s=e.clone();s.name=t;const a=[];for(let l=0;l<s.tracks.length;++l){const e=s.tracks[l],t=e.getValueSize(),o=[],c=[];for(let s=0;s<e.times.length;++s){const a=e.times[s]*r;if(!(a<i||a>=n)){o.push(e.times[s]);for(let i=0;i<t;++i)c.push(e.values[s*t+i])}}0!==o.length&&(e.times=Za.convertArray(o,e.times.constructor),e.values=Za.convertArray(c,e.values.constructor),a.push(e))}s.tracks=a;let o=Infinity;for(let l=0;l<s.tracks.length;++l)o>s.tracks[l].times[0]&&(o=s.tracks[l].times[0]);for(let l=0;l<s.tracks.length;++l)s.tracks[l].shift(-1*o);return s.resetDuration(),s},makeClipAdditive:function(e,t=0,i=e,n=30){n<=0&&(n=30);const r=i.tracks.length,s=t/n;for(let a=0;a<r;++a){const t=i.tracks[a],n=t.ValueTypeName;if("bool"===n||"string"===n)continue;const r=e.tracks.find((function(e){return e.name===t.name&&e.ValueTypeName===n}));if(void 0===r)continue;let o=0;const l=t.getValueSize();t.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline&&(o=l/3);let c=0;const u=r.getValueSize();r.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline&&(c=u/3);const h=t.times.length-1;let d;if(s<=t.times[0]){const e=o,i=l-o;d=Za.arraySlice(t.values,e,i)}else if(s>=t.times[h]){const e=h*l+o,i=e+l-o;d=Za.arraySlice(t.values,e,i)}else{const e=t.createInterpolant(),i=o,n=l-o;e.evaluate(s),d=Za.arraySlice(e.resultBuffer,i,n)}if("quaternion"===n){(new Ee).fromArray(d).normalize().conjugate().toArray(d)}const p=r.times.length;for(let e=0;e<p;++e){const t=e*u+c;if("quaternion"===n)Ee.multiplyQuaternionsFlat(r.values,t,d,0,r.values,t);else{const e=u-2*c;for(let i=0;i<e;++i)r.values[t+i]-=d[i]}}}return e.blendMode=2501,e}};class Ja{constructor(e,t,i,n){this.parameterPositions=e,this._cachedIndex=0,this.resultBuffer=void 0!==n?n:new t.constructor(i),this.sampleValues=t,this.valueSize=i,this.settings=null,this.DefaultSettings_={}}evaluate(e){const t=this.parameterPositions;let i=this._cachedIndex,n=t[i],r=t[i-1];e:{t:{let s;i:{n:if(!(e<n)){for(let s=i+2;;){if(void 0===n){if(e<r)break n;return i=t.length,this._cachedIndex=i,this.afterEnd_(i-1,e,r)}if(i===s)break;if(r=n,n=t[++i],e<n)break t}s=t.length;break i}if(e>=r)break e;{const a=t[1];e<a&&(i=2,r=a);for(let s=i-2;;){if(void 0===r)return this._cachedIndex=0,this.beforeStart_(0,e,n);if(i===s)break;if(n=r,r=t[--i-1],e>=r)break t}s=i,i=0}}for(;i<s;){const n=i+s>>>1;e<t[n]?s=n:i=n+1}if(n=t[i],r=t[i-1],void 0===r)return this._cachedIndex=0,this.beforeStart_(0,e,n);if(void 0===n)return i=t.length,this._cachedIndex=i,this.afterEnd_(i-1,r,e)}this._cachedIndex=i,this.intervalChanged_(i,r,n)}return this.interpolate_(i,r,e,n)}getSettings_(){return this.settings||this.DefaultSettings_}copySampleValue_(e){const t=this.resultBuffer,i=this.sampleValues,n=this.valueSize,r=e*n;for(let s=0;s!==n;++s)t[s]=i[r+s];return t}interpolate_(){throw new Error("call to abstract method")}intervalChanged_(){}}Ja.prototype.beforeStart_=Ja.prototype.copySampleValue_,Ja.prototype.afterEnd_=Ja.prototype.copySampleValue_;class Qa extends Ja{constructor(e,t,i,n){super(e,t,i,n),this._weightPrev=-0,this._offsetPrev=-0,this._weightNext=-0,this._offsetNext=-0,this.DefaultSettings_={endingStart:2400,endingEnd:2400}}intervalChanged_(e,t,i){const n=this.parameterPositions;let r=e-2,s=e+1,a=n[r],o=n[s];if(void 0===a)switch(this.getSettings_().endingStart){case 2401:r=e,a=2*t-i;break;case 2402:r=n.length-2,a=t+n[r]-n[r+1];break;default:r=e,a=i}if(void 0===o)switch(this.getSettings_().endingEnd){case 2401:s=e,o=2*i-t;break;case 2402:s=1,o=i+n[1]-n[0];break;default:s=e-1,o=t}const l=.5*(i-t),c=this.valueSize;this._weightPrev=l/(t-a),this._weightNext=l/(o-i),this._offsetPrev=r*c,this._offsetNext=s*c}interpolate_(e,t,i,n){const r=this.resultBuffer,s=this.sampleValues,a=this.valueSize,o=e*a,l=o-a,c=this._offsetPrev,u=this._offsetNext,h=this._weightPrev,d=this._weightNext,p=(i-t)/(n-t),m=p*p,f=m*p,g=-h*f+2*h*m-h*p,v=(1+h)*f+(-1.5-2*h)*m+(-.5+h)*p+1,y=(-1-d)*f+(1.5+d)*m+.5*p,x=d*f-d*m;for(let _=0;_!==a;++_)r[_]=g*s[c+_]+v*s[l+_]+y*s[o+_]+x*s[u+_];return r}}class Ka extends Ja{constructor(e,t,i,n){super(e,t,i,n)}interpolate_(e,t,i,n){const r=this.resultBuffer,s=this.sampleValues,a=this.valueSize,o=e*a,l=o-a,c=(i-t)/(n-t),u=1-c;for(let h=0;h!==a;++h)r[h]=s[l+h]*u+s[o+h]*c;return r}}class $a extends Ja{constructor(e,t,i,n){super(e,t,i,n)}interpolate_(e){return this.copySampleValue_(e-1)}}class eo{constructor(e,t,i,n){if(void 0===e)throw new Error("THREE.KeyframeTrack: track name is undefined");if(void 0===t||0===t.length)throw new Error("THREE.KeyframeTrack: no keyframes in track named "+e);this.name=e,this.times=Za.convertArray(t,this.TimeBufferType),this.values=Za.convertArray(i,this.ValueBufferType),this.setInterpolation(n||this.DefaultInterpolation)}static toJSON(e){const t=e.constructor;let i;if(t.toJSON!==this.toJSON)i=t.toJSON(e);else{i={name:e.name,times:Za.convertArray(e.times,Array),values:Za.convertArray(e.values,Array)};const t=e.getInterpolation();t!==e.DefaultInterpolation&&(i.interpolation=t)}return i.type=e.ValueTypeName,i}InterpolantFactoryMethodDiscrete(e){return new $a(this.times,this.values,this.getValueSize(),e)}InterpolantFactoryMethodLinear(e){return new Ka(this.times,this.values,this.getValueSize(),e)}InterpolantFactoryMethodSmooth(e){return new Qa(this.times,this.values,this.getValueSize(),e)}setInterpolation(e){let t;switch(e){case 2300:t=this.InterpolantFactoryMethodDiscrete;break;case 2301:t=this.InterpolantFactoryMethodLinear;break;case 2302:t=this.InterpolantFactoryMethodSmooth}if(void 0===t){const t="unsupported interpolation for "+this.ValueTypeName+" keyframe track named "+this.name;if(void 0===this.createInterpolant){if(e===this.DefaultInterpolation)throw new Error(t);this.setInterpolation(this.DefaultInterpolation)}return this}return this.createInterpolant=t,this}getInterpolation(){switch(this.createInterpolant){case this.InterpolantFactoryMethodDiscrete:return 2300;case this.InterpolantFactoryMethodLinear:return 2301;case this.InterpolantFactoryMethodSmooth:return 2302}}getValueSize(){return this.values.length/this.times.length}shift(e){if(0!==e){const t=this.times;for(let i=0,n=t.length;i!==n;++i)t[i]+=e}return this}scale(e){if(1!==e){const t=this.times;for(let i=0,n=t.length;i!==n;++i)t[i]*=e}return this}trim(e,t){const i=this.times,n=i.length;let r=0,s=n-1;for(;r!==n&&i[r]<e;)++r;for(;-1!==s&&i[s]>t;)--s;if(++s,0!==r||s!==n){r>=s&&(s=Math.max(s,1),r=s-1);const e=this.getValueSize();this.times=Za.arraySlice(i,r,s),this.values=Za.arraySlice(this.values,r*e,s*e)}return this}validate(){let e=!0;const t=this.getValueSize();t-Math.floor(t)!=0&&(e=!1);const i=this.times,n=this.values,r=i.length;0===r&&(e=!1);let s=null;for(let a=0;a!==r;a++){const t=i[a];if("number"==typeof t&&isNaN(t)){e=!1;break}if(null!==s&&s>t){e=!1;break}s=t}if(void 0!==n&&Za.isTypedArray(n))for(let a=0,o=n.length;a!==o;++a){const t=n[a];if(isNaN(t)){e=!1;break}}return e}optimize(){const e=Za.arraySlice(this.times),t=Za.arraySlice(this.values),i=this.getValueSize(),n=2302===this.getInterpolation(),r=e.length-1;let s=1;for(let a=1;a<r;++a){let r=!1;const o=e[a];if(o!==e[a+1]&&(1!==a||o!==e[0]))if(n)r=!0;else{const e=a*i,n=e-i,s=e+i;for(let a=0;a!==i;++a){const i=t[e+a];if(i!==t[n+a]||i!==t[s+a]){r=!0;break}}}if(r){if(a!==s){e[s]=e[a];const n=a*i,r=s*i;for(let e=0;e!==i;++e)t[r+e]=t[n+e]}++s}}if(r>0){e[s]=e[r];for(let e=r*i,n=s*i,a=0;a!==i;++a)t[n+a]=t[e+a];++s}return s!==e.length?(this.times=Za.arraySlice(e,0,s),this.values=Za.arraySlice(t,0,s*i)):(this.times=e,this.values=t),this}clone(){const e=Za.arraySlice(this.times,0),t=Za.arraySlice(this.values,0),i=new(0,this.constructor)(this.name,e,t);return i.createInterpolant=this.createInterpolant,i}}eo.prototype.TimeBufferType=Float32Array,eo.prototype.ValueBufferType=Float32Array,eo.prototype.DefaultInterpolation=2301;class to extends eo{}to.prototype.ValueTypeName="bool",to.prototype.ValueBufferType=Array,to.prototype.DefaultInterpolation=2300,to.prototype.InterpolantFactoryMethodLinear=void 0,to.prototype.InterpolantFactoryMethodSmooth=void 0;class io extends eo{}io.prototype.ValueTypeName="color";class no extends eo{}no.prototype.ValueTypeName="number";class ro extends Ja{constructor(e,t,i,n){super(e,t,i,n)}interpolate_(e,t,i,n){const r=this.resultBuffer,s=this.sampleValues,a=this.valueSize,o=(i-t)/(n-t);let l=e*a;for(let c=l+a;l!==c;l+=4)Ee.slerpFlat(r,0,s,l-a,s,l,o);return r}}class so extends eo{InterpolantFactoryMethodLinear(e){return new ro(this.times,this.values,this.getValueSize(),e)}}so.prototype.ValueTypeName="quaternion",so.prototype.DefaultInterpolation=2301,so.prototype.InterpolantFactoryMethodSmooth=void 0;class ao extends eo{}ao.prototype.ValueTypeName="string",ao.prototype.ValueBufferType=Array,ao.prototype.DefaultInterpolation=2300,ao.prototype.InterpolantFactoryMethodLinear=void 0,ao.prototype.InterpolantFactoryMethodSmooth=void 0;class oo extends eo{}oo.prototype.ValueTypeName="vector";class lo{constructor(e,t=-1,i,n=2500){this.name=e,this.tracks=i,this.duration=t,this.blendMode=n,this.uuid=me(),this.duration<0&&this.resetDuration()}static parse(e){const t=[],i=e.tracks,n=1/(e.fps||1);for(let s=0,a=i.length;s!==a;++s)t.push(co(i[s]).scale(n));const r=new this(e.name,e.duration,t,e.blendMode);return r.uuid=e.uuid,r}static toJSON(e){const t=[],i=e.tracks,n={name:e.name,duration:e.duration,tracks:t,uuid:e.uuid,blendMode:e.blendMode};for(let r=0,s=i.length;r!==s;++r)t.push(eo.toJSON(i[r]));return n}static CreateFromMorphTargetSequence(e,t,i,n){const r=t.length,s=[];for(let a=0;a<r;a++){let e=[],o=[];e.push((a+r-1)%r,a,(a+1)%r),o.push(0,1,0);const l=Za.getKeyframeOrder(e);e=Za.sortedArray(e,1,l),o=Za.sortedArray(o,1,l),n||0!==e[0]||(e.push(r),o.push(o[0])),s.push(new no(".morphTargetInfluences["+t[a].name+"]",e,o).scale(1/i))}return new this(e,-1,s)}static findByName(e,t){let i=e;if(!Array.isArray(e)){const t=e;i=t.geometry&&t.geometry.animations||t.animations}for(let n=0;n<i.length;n++)if(i[n].name===t)return i[n];return null}static CreateClipsFromMorphTargetSequences(e,t,i){const n={},r=/^([\w-]*?)([\d]+)$/;for(let a=0,o=e.length;a<o;a++){const t=e[a],i=t.name.match(r);if(i&&i.length>1){const e=i[1];let r=n[e];r||(n[e]=r=[]),r.push(t)}}const s=[];for(const a in n)s.push(this.CreateFromMorphTargetSequence(a,n[a],t,i));return s}static parseAnimation(e,t){if(!e)return null;const i=function(e,t,i,n,r){if(0!==i.length){const s=[],a=[];Za.flattenJSON(i,s,a,n),0!==s.length&&r.push(new e(t,s,a))}},n=[],r=e.name||"default",s=e.fps||30,a=e.blendMode;let o=e.length||-1;const l=e.hierarchy||[];for(let c=0;c<l.length;c++){const e=l[c].keys;if(e&&0!==e.length)if(e[0].morphTargets){const t={};let i;for(i=0;i<e.length;i++)if(e[i].morphTargets)for(let n=0;n<e[i].morphTargets.length;n++)t[e[i].morphTargets[n]]=-1;for(const r in t){const t=[],s=[];for(let n=0;n!==e[i].morphTargets.length;++n){const n=e[i];t.push(n.time),s.push(n.morphTarget===r?1:0)}n.push(new no(".morphTargetInfluence["+r+"]",t,s))}o=t.length*(s||1)}else{const r=".bones["+t[c].name+"]";i(oo,r+".position",e,"pos",n),i(so,r+".quaternion",e,"rot",n),i(oo,r+".scale",e,"scl",n)}}if(0===n.length)return null;return new this(r,o,n,a)}resetDuration(){let e=0;for(let t=0,i=this.tracks.length;t!==i;++t){const i=this.tracks[t];e=Math.max(e,i.times[i.times.length-1])}return this.duration=e,this}trim(){for(let e=0;e<this.tracks.length;e++)this.tracks[e].trim(0,this.duration);return this}validate(){let e=!0;for(let t=0;t<this.tracks.length;t++)e=e&&this.tracks[t].validate();return e}optimize(){for(let e=0;e<this.tracks.length;e++)this.tracks[e].optimize();return this}clone(){const e=[];for(let t=0;t<this.tracks.length;t++)e.push(this.tracks[t].clone());return new this.constructor(this.name,this.duration,e,this.blendMode)}toJSON(){return this.constructor.toJSON(this)}}function co(e){if(void 0===e.type)throw new Error("THREE.KeyframeTrack: track type undefined, can not parse");const t=function(e){switch(e.toLowerCase()){case"scalar":case"double":case"float":case"number":case"integer":return no;case"vector":case"vector2":case"vector3":case"vector4":return oo;case"color":return io;case"quaternion":return so;case"bool":case"boolean":return to;case"string":return ao}throw new Error("THREE.KeyframeTrack: Unsupported typeName: "+e)}(e.type);if(void 0===e.times){const t=[],i=[];Za.flattenJSON(e.keys,t,i,"value"),e.times=t,e.values=i}return void 0!==t.parse?t.parse(e):new t(e.name,e.times,e.values,e.interpolation)}const uo={enabled:!1,files:{},add:function(e,t){!1!==this.enabled&&(this.files[e]=t)},get:function(e){if(!1!==this.enabled)return this.files[e]},remove:function(e){delete this.files[e]},clear:function(){this.files={}}};const ho=new class{constructor(e,t,i){const n=this;let r,s=!1,a=0,o=0;const l=[];this.onStart=void 0,this.onLoad=e,this.onProgress=t,this.onError=i,this.itemStart=function(e){o++,!1===s&&void 0!==n.onStart&&n.onStart(e,a,o),s=!0},this.itemEnd=function(e){a++,void 0!==n.onProgress&&n.onProgress(e,a,o),a===o&&(s=!1,void 0!==n.onLoad&&n.onLoad())},this.itemError=function(e){void 0!==n.onError&&n.onError(e)},this.resolveURL=function(e){return r?r(e):e},this.setURLModifier=function(e){return r=e,this},this.addHandler=function(e,t){return l.push(e,t),this},this.removeHandler=function(e){const t=l.indexOf(e);return-1!==t&&l.splice(t,2),this},this.getHandler=function(e){for(let t=0,i=l.length;t<i;t+=2){const i=l[t],n=l[t+1];if(i.global&&(i.lastIndex=0),i.test(e))return n}return null}}};class po{constructor(e){this.manager=void 0!==e?e:ho,this.crossOrigin="anonymous",this.withCredentials=!1,this.path="",this.resourcePath="",this.requestHeader={}}load(){}loadAsync(e,t){const i=this;return new Promise((function(n,r){i.load(e,n,t,r)}))}parse(){}setCrossOrigin(e){return this.crossOrigin=e,this}setWithCredentials(e){return this.withCredentials=e,this}setPath(e){return this.path=e,this}setResourcePath(e){return this.resourcePath=e,this}setRequestHeader(e){return this.requestHeader=e,this}}const mo={};class fo extends po{constructor(e){super(e)}load(e,t,i,n){void 0===e&&(e=""),void 0!==this.path&&(e=this.path+e),e=this.manager.resolveURL(e);const r=this,s=uo.get(e);if(void 0!==s)return r.manager.itemStart(e),setTimeout((function(){t&&t(s),r.manager.itemEnd(e)}),0),s;if(void 0!==mo[e])return void mo[e].push({onLoad:t,onProgress:i,onError:n});const a=e.match(/^data:(.*?)(;base64)?,(.*)$/);let o;if(a){const i=a[1],s=!!a[2];let o=a[3];o=decodeURIComponent(o),s&&(o=atob(o));try{let n;const s=(this.responseType||"").toLowerCase();switch(s){case"arraybuffer":case"blob":const e=new Uint8Array(o.length);for(let i=0;i<o.length;i++)e[i]=o.charCodeAt(i);n="blob"===s?new Blob([e.buffer],{type:i}):e.buffer;break;case"document":const t=new DOMParser;n=t.parseFromString(o,i);break;case"json":n=JSON.parse(o);break;default:n=o}setTimeout((function(){t&&t(n),r.manager.itemEnd(e)}),0)}catch(l){setTimeout((function(){n&&n(l),r.manager.itemError(e),r.manager.itemEnd(e)}),0)}}else{mo[e]=[],mo[e].push({onLoad:t,onProgress:i,onError:n}),o=new XMLHttpRequest,o.open("GET",e,!0),o.addEventListener("load",(function(t){const i=this.response,n=mo[e];if(delete mo[e],200===this.status||0===this.status){this.status,uo.add(e,i);for(let e=0,t=n.length;e<t;e++){const t=n[e];t.onLoad&&t.onLoad(i)}r.manager.itemEnd(e)}else{for(let e=0,i=n.length;e<i;e++){const i=n[e];i.onError&&i.onError(t)}r.manager.itemError(e),r.manager.itemEnd(e)}}),!1),o.addEventListener("progress",(function(t){const i=mo[e];for(let e=0,n=i.length;e<n;e++){const n=i[e];n.onProgress&&n.onProgress(t)}}),!1),o.addEventListener("error",(function(t){const i=mo[e];delete mo[e];for(let e=0,n=i.length;e<n;e++){const n=i[e];n.onError&&n.onError(t)}r.manager.itemError(e),r.manager.itemEnd(e)}),!1),o.addEventListener("abort",(function(t){const i=mo[e];delete mo[e];for(let e=0,n=i.length;e<n;e++){const n=i[e];n.onError&&n.onError(t)}r.manager.itemError(e),r.manager.itemEnd(e)}),!1),void 0!==this.responseType&&(o.responseType=this.responseType),void 0!==this.withCredentials&&(o.withCredentials=this.withCredentials),o.overrideMimeType&&o.overrideMimeType(void 0!==this.mimeType?this.mimeType:"text/plain");for(const e in this.requestHeader)o.setRequestHeader(e,this.requestHeader[e]);o.send(null)}return r.manager.itemStart(e),o}setResponseType(e){return this.responseType=e,this}setMimeType(e){return this.mimeType=e,this}}class go extends po{constructor(e){super(e)}load(e,t,i,n){void 0!==this.path&&(e=this.path+e),e=this.manager.resolveURL(e);const r=this,s=uo.get(e);if(void 0!==s)return r.manager.itemStart(e),setTimeout((function(){t&&t(s),r.manager.itemEnd(e)}),0),s;const a=we("img");function o(){a.removeEventListener("load",o,!1),a.removeEventListener("error",l,!1),uo.add(e,this),t&&t(this),r.manager.itemEnd(e)}function l(t){a.removeEventListener("load",o,!1),a.removeEventListener("error",l,!1),n&&n(t),r.manager.itemError(e),r.manager.itemEnd(e)}return a.addEventListener("load",o,!1),a.addEventListener("error",l,!1),"data:"!==e.substr(0,5)&&void 0!==this.crossOrigin&&(a.crossOrigin=this.crossOrigin),r.manager.itemStart(e),a.src=e,a}}class vo extends po{constructor(e){super(e)}load(e,t,i,n){const r=new Te,s=new go(this.manager);return s.setCrossOrigin(this.crossOrigin),s.setPath(this.path),s.load(e,(function(e){r.image=e,r.needsUpdate=!0,void 0!==t&&t(r)}),i,n),r}}class yo extends Rt{constructor(e,t=1){super(),this.type="Light",this.color=new $t(e),this.intensity=t}dispose(){}copy(e){return super.copy(e),this.color.copy(e.color),this.intensity=e.intensity,this}toJSON(e){const t=super.toJSON(e);return t.object.color=this.color.getHex(),t.object.intensity=this.intensity,void 0!==this.groundColor&&(t.object.groundColor=this.groundColor.getHex()),void 0!==this.distance&&(t.object.distance=this.distance),void 0!==this.angle&&(t.object.angle=this.angle),void 0!==this.decay&&(t.object.decay=this.decay),void 0!==this.penumbra&&(t.object.penumbra=this.penumbra),void 0!==this.shadow&&(t.object.shadow=this.shadow.toJSON()),t}}yo.prototype.isLight=!0;const xo=new lt,_o=new De,bo=new De;class wo{constructor(e){this.camera=e,this.bias=0,this.normalBias=0,this.radius=1,this.blurSamples=8,this.mapSize=new xe(512,512),this.map=null,this.mapPass=null,this.matrix=new lt,this.autoUpdate=!0,this.needsUpdate=!1,this._frustum=new Qi,this._frameExtents=new xe(1,1),this._viewportCount=1,this._viewports=[new Ce(0,0,1,1)]}getViewportCount(){return this._viewportCount}getFrustum(){return this._frustum}updateMatrices(e){const t=this.camera,i=this.matrix;_o.setFromMatrixPosition(e.matrixWorld),t.position.copy(_o),bo.setFromMatrixPosition(e.target.matrixWorld),t.lookAt(bo),t.updateMatrixWorld(),xo.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse),this._frustum.setFromProjectionMatrix(xo),i.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),i.multiply(t.projectionMatrix),i.multiply(t.matrixWorldInverse)}getViewport(e){return this._viewports[e]}getFrameExtents(){return this._frameExtents}dispose(){this.map&&this.map.dispose(),this.mapPass&&this.mapPass.dispose()}copy(e){return this.camera=e.camera.clone(),this.bias=e.bias,this.radius=e.radius,this.mapSize.copy(e.mapSize),this}clone(){return(new this.constructor).copy(this)}toJSON(){const e={};return 0!==this.bias&&(e.bias=this.bias),0!==this.normalBias&&(e.normalBias=this.normalBias),1!==this.radius&&(e.radius=this.radius),512===this.mapSize.x&&512===this.mapSize.y||(e.mapSize=this.mapSize.toArray()),e.camera=this.camera.toJSON(!1).object,delete e.camera.matrix,e}}class Mo extends wo{constructor(){super(new Vi(50,1,.5,500)),this.focus=1}updateMatrices(e){const t=this.camera,i=2*he*e.angle*this.focus,n=this.mapSize.width/this.mapSize.height,r=e.distance||t.far;i===t.fov&&n===t.aspect&&r===t.far||(t.fov=i,t.aspect=n,t.far=r,t.updateProjectionMatrix()),super.updateMatrices(e)}copy(e){return super.copy(e),this.focus=e.focus,this}}Mo.prototype.isSpotLightShadow=!0;class So extends yo{constructor(e,t,i=0,n=Math.PI/3,r=0,s=1){super(e,t),this.type="SpotLight",this.position.copy(Rt.DefaultUp),this.updateMatrix(),this.target=new Rt,this.distance=i,this.angle=n,this.penumbra=r,this.decay=s,this.shadow=new Mo}get power(){return this.intensity*Math.PI}set power(e){this.intensity=e/Math.PI}dispose(){this.shadow.dispose()}copy(e){return super.copy(e),this.distance=e.distance,this.angle=e.angle,this.penumbra=e.penumbra,this.decay=e.decay,this.target=e.target.clone(),this.shadow=e.shadow.clone(),this}}So.prototype.isSpotLight=!0;const To=new lt,Ao=new De,Co=new De;class Lo extends wo{constructor(){super(new Vi(90,1,.5,500)),this._frameExtents=new xe(4,2),this._viewportCount=6,this._viewports=[new Ce(2,1,1,1),new Ce(0,1,1,1),new Ce(3,1,1,1),new Ce(1,1,1,1),new Ce(3,0,1,1),new Ce(1,0,1,1)],this._cubeDirections=[new De(1,0,0),new De(-1,0,0),new De(0,0,1),new De(0,0,-1),new De(0,1,0),new De(0,-1,0)],this._cubeUps=[new De(0,1,0),new De(0,1,0),new De(0,1,0),new De(0,1,0),new De(0,0,1),new De(0,0,-1)]}updateMatrices(e,t=0){const i=this.camera,n=this.matrix,r=e.distance||i.far;r!==i.far&&(i.far=r,i.updateProjectionMatrix()),Ao.setFromMatrixPosition(e.matrixWorld),i.position.copy(Ao),Co.copy(i.position),Co.add(this._cubeDirections[t]),i.up.copy(this._cubeUps[t]),i.lookAt(Co),i.updateMatrixWorld(),n.makeTranslation(-Ao.x,-Ao.y,-Ao.z),To.multiplyMatrices(i.projectionMatrix,i.matrixWorldInverse),this._frustum.setFromProjectionMatrix(To)}}Lo.prototype.isPointLightShadow=!0;class Po extends yo{constructor(e,t,i=0,n=1){super(e,t),this.type="PointLight",this.distance=i,this.decay=n,this.shadow=new Lo}get power(){return 4*this.intensity*Math.PI}set power(e){this.intensity=e/(4*Math.PI)}dispose(){this.shadow.dispose()}copy(e){return super.copy(e),this.distance=e.distance,this.decay=e.decay,this.shadow=e.shadow.clone(),this}}Po.prototype.isPointLight=!0;class Eo extends wo{constructor(){super(new hn(-5,5,5,-5,.5,500))}}Eo.prototype.isDirectionalLightShadow=!0;class Do extends yo{constructor(e,t){super(e,t),this.type="DirectionalLight",this.position.copy(Rt.DefaultUp),this.updateMatrix(),this.target=new Rt,this.shadow=new Eo}dispose(){this.shadow.dispose()}copy(e){return super.copy(e),this.target=e.target.clone(),this.shadow=e.shadow.clone(),this}}Do.prototype.isDirectionalLight=!0;class Io extends yo{constructor(e,t){super(e,t),this.type="AmbientLight"}}Io.prototype.isAmbientLight=!0;class Ro{static decodeText(e){if("undefined"!=typeof TextDecoder)return(new TextDecoder).decode(e);let t="";for(let n=0,r=e.length;n<r;n++)t+=String.fromCharCode(e[n]);try{return decodeURIComponent(escape(t))}catch(i){return t}}static extractUrlBase(e){const t=e.lastIndexOf("/");return-1===t?"./":e.substr(0,t+1)}}class zo extends fi{constructor(){super(),this.type="InstancedBufferGeometry",this.instanceCount=Infinity}copy(e){return super.copy(e),this.instanceCount=e.instanceCount,this}clone(){return(new this.constructor).copy(this)}toJSON(){const e=super.toJSON(this);return e.instanceCount=this.instanceCount,e.isInstancedBufferGeometry=!0,e}}zo.prototype.isInstancedBufferGeometry=!0;class No extends po{constructor(e){super(e),this.options={premultiplyAlpha:"none"}}setOptions(e){return this.options=e,this}load(e,t,i,n){void 0===e&&(e=""),void 0!==this.path&&(e=this.path+e),e=this.manager.resolveURL(e);const r=this,s=uo.get(e);if(void 0!==s)return r.manager.itemStart(e),setTimeout((function(){t&&t(s),r.manager.itemEnd(e)}),0),s;const a={};a.credentials="anonymous"===this.crossOrigin?"same-origin":"include",a.headers=this.requestHeader,fetch(e,a).then((function(e){return e.blob()})).then((function(e){return createImageBitmap(e,Object.assign(r.options,{colorSpaceConversion:"none"}))})).then((function(i){uo.add(e,i),t&&t(i),r.manager.itemEnd(e)})).catch((function(t){n&&n(t),r.manager.itemError(e),r.manager.itemEnd(e)})),r.manager.itemStart(e)}}No.prototype.isImageBitmapLoader=!0;const Oo=new RegExp("[\\[\\]\\.:\\/]","g"),Fo="[^"+"\\[\\]\\.:\\/".replace("\\.","")+"]",Uo=/((?:WC+[\/:])*)/.source.replace("WC","[^\\[\\]\\.:\\/]"),ko=/(WCOD+)?/.source.replace("WCOD",Fo),Bo=/(?:\.(WC+)(?:\[(.+)\])?)?/.source.replace("WC","[^\\[\\]\\.:\\/]"),Vo=/\.(WC+)(?:\[(.+)\])?/.source.replace("WC","[^\\[\\]\\.:\\/]"),Go=new RegExp("^"+Uo+ko+Bo+Vo+"$"),Wo=["material","materials","bones"];class Ho{constructor(e,t,i){this.path=t,this.parsedPath=i||Ho.parseTrackName(t),this.node=Ho.findNode(e,this.parsedPath.nodeName)||e,this.rootNode=e,this.getValue=this._getValue_unbound,this.setValue=this._setValue_unbound}static create(e,t,i){return e&&e.isAnimationObjectGroup?new Ho.Composite(e,t,i):new Ho(e,t,i)}static sanitizeNodeName(e){return e.replace(/\s/g,"_").replace(Oo,"")}static parseTrackName(e){const t=Go.exec(e);if(!t)throw new Error("PropertyBinding: Cannot parse trackName: "+e);const i={nodeName:t[2],objectName:t[3],objectIndex:t[4],propertyName:t[5],propertyIndex:t[6]},n=i.nodeName&&i.nodeName.lastIndexOf(".");if(void 0!==n&&-1!==n){const e=i.nodeName.substring(n+1);-1!==Wo.indexOf(e)&&(i.nodeName=i.nodeName.substring(0,n),i.objectName=e)}if(null===i.propertyName||0===i.propertyName.length)throw new Error("PropertyBinding: can not parse propertyName from trackName: "+e);return i}static findNode(e,t){if(!t||""===t||"."===t||-1===t||t===e.name||t===e.uuid)return e;if(e.skeleton){const i=e.skeleton.getBoneByName(t);if(void 0!==i)return i}if(e.children){const i=function(e){for(let n=0;n<e.length;n++){const r=e[n];if(r.name===t||r.uuid===t)return r;const s=i(r.children);if(s)return s}return null},n=i(e.children);if(n)return n}return null}_getValue_unavailable(){}_setValue_unavailable(){}_getValue_direct(e,t){e[t]=this.targetObject[this.propertyName]}_getValue_array(e,t){const i=this.resolvedProperty;for(let n=0,r=i.length;n!==r;++n)e[t++]=i[n]}_getValue_arrayElement(e,t){e[t]=this.resolvedProperty[this.propertyIndex]}_getValue_toArray(e,t){this.resolvedProperty.toArray(e,t)}_setValue_direct(e,t){this.targetObject[this.propertyName]=e[t]}_setValue_direct_setNeedsUpdate(e,t){this.targetObject[this.propertyName]=e[t],this.targetObject.needsUpdate=!0}_setValue_direct_setMatrixWorldNeedsUpdate(e,t){this.targetObject[this.propertyName]=e[t],this.targetObject.matrixWorldNeedsUpdate=!0}_setValue_array(e,t){const i=this.resolvedProperty;for(let n=0,r=i.length;n!==r;++n)i[n]=e[t++]}_setValue_array_setNeedsUpdate(e,t){const i=this.resolvedProperty;for(let n=0,r=i.length;n!==r;++n)i[n]=e[t++];this.targetObject.needsUpdate=!0}_setValue_array_setMatrixWorldNeedsUpdate(e,t){const i=this.resolvedProperty;for(let n=0,r=i.length;n!==r;++n)i[n]=e[t++];this.targetObject.matrixWorldNeedsUpdate=!0}_setValue_arrayElement(e,t){this.resolvedProperty[this.propertyIndex]=e[t]}_setValue_arrayElement_setNeedsUpdate(e,t){this.resolvedProperty[this.propertyIndex]=e[t],this.targetObject.needsUpdate=!0}_setValue_arrayElement_setMatrixWorldNeedsUpdate(e,t){this.resolvedProperty[this.propertyIndex]=e[t],this.targetObject.matrixWorldNeedsUpdate=!0}_setValue_fromArray(e,t){this.resolvedProperty.fromArray(e,t)}_setValue_fromArray_setNeedsUpdate(e,t){this.resolvedProperty.fromArray(e,t),this.targetObject.needsUpdate=!0}_setValue_fromArray_setMatrixWorldNeedsUpdate(e,t){this.resolvedProperty.fromArray(e,t),this.targetObject.matrixWorldNeedsUpdate=!0}_getValue_unbound(e,t){this.bind(),this.getValue(e,t)}_setValue_unbound(e,t){this.bind(),this.setValue(e,t)}bind(){let e=this.node;const t=this.parsedPath,i=t.objectName,n=t.propertyName;let r=t.propertyIndex;if(e||(e=Ho.findNode(this.rootNode,t.nodeName)||this.rootNode,this.node=e),this.getValue=this._getValue_unavailable,this.setValue=this._setValue_unavailable,!e)return;if(i){let n=t.objectIndex;switch(i){case"materials":if(!e.material)return;if(!e.material.materials)return;e=e.material.materials;break;case"bones":if(!e.skeleton)return;e=e.skeleton.bones;for(let t=0;t<e.length;t++)if(e[t].name===n){n=t;break}break;default:if(void 0===e[i])return;e=e[i]}if(void 0!==n){if(void 0===e[n])return;e=e[n]}}const s=e[n];if(void 0===s){t.nodeName;return}let a=this.Versioning.None;this.targetObject=e,void 0!==e.needsUpdate?a=this.Versioning.NeedsUpdate:void 0!==e.matrixWorldNeedsUpdate&&(a=this.Versioning.MatrixWorldNeedsUpdate);let o=this.BindingType.Direct;if(void 0!==r){if("morphTargetInfluences"===n){if(!e.geometry)return;if(!e.geometry.isBufferGeometry)return;if(!e.geometry.morphAttributes)return;void 0!==e.morphTargetDictionary[r]&&(r=e.morphTargetDictionary[r])}o=this.BindingType.ArrayElement,this.resolvedProperty=s,this.propertyIndex=r}else void 0!==s.fromArray&&void 0!==s.toArray?(o=this.BindingType.HasFromToArray,this.resolvedProperty=s):Array.isArray(s)?(o=this.BindingType.EntireArray,this.resolvedProperty=s):this.propertyName=n;this.getValue=this.GetterByBindingType[o],this.setValue=this.SetterByBindingTypeAndVersioning[o][a]}unbind(){this.node=null,this.getValue=this._getValue_unbound,this.setValue=this._setValue_unbound}}Ho.Composite=class{constructor(e,t,i){const n=i||Ho.parseTrackName(t);this._targetGroup=e,this._bindings=e.subscribe_(t,n)}getValue(e,t){this.bind();const i=this._targetGroup.nCachedObjects_,n=this._bindings[i];void 0!==n&&n.getValue(e,t)}setValue(e,t){const i=this._bindings;for(let n=this._targetGroup.nCachedObjects_,r=i.length;n!==r;++n)i[n].setValue(e,t)}bind(){const e=this._bindings;for(let t=this._targetGroup.nCachedObjects_,i=e.length;t!==i;++t)e[t].bind()}unbind(){const e=this._bindings;for(let t=this._targetGroup.nCachedObjects_,i=e.length;t!==i;++t)e[t].unbind()}},Ho.prototype.BindingType={Direct:0,EntireArray:1,ArrayElement:2,HasFromToArray:3},Ho.prototype.Versioning={None:0,NeedsUpdate:1,MatrixWorldNeedsUpdate:2},Ho.prototype.GetterByBindingType=[Ho.prototype._getValue_direct,Ho.prototype._getValue_array,Ho.prototype._getValue_arrayElement,Ho.prototype._getValue_toArray],Ho.prototype.SetterByBindingTypeAndVersioning=[[Ho.prototype._setValue_direct,Ho.prototype._setValue_direct_setNeedsUpdate,Ho.prototype._setValue_direct_setMatrixWorldNeedsUpdate],[Ho.prototype._setValue_array,Ho.prototype._setValue_array_setNeedsUpdate,Ho.prototype._setValue_array_setMatrixWorldNeedsUpdate],[Ho.prototype._setValue_arrayElement,Ho.prototype._setValue_arrayElement_setNeedsUpdate,Ho.prototype._setValue_arrayElement_setMatrixWorldNeedsUpdate],[Ho.prototype._setValue_fromArray,Ho.prototype._setValue_fromArray_setNeedsUpdate,Ho.prototype._setValue_fromArray_setMatrixWorldNeedsUpdate]];class jo extends Gs{constructor(e,t,i=1){super(e,t),this.meshPerAttribute=i}copy(e){return super.copy(e),this.meshPerAttribute=e.meshPerAttribute,this}clone(e){const t=super.clone(e);return t.meshPerAttribute=this.meshPerAttribute,t}toJSON(e){const t=super.toJSON(e);return t.isInstancedInterleavedBuffer=!0,t.meshPerAttribute=this.meshPerAttribute,t}}jo.prototype.isInstancedInterleavedBuffer=!0;const qo=new De,Xo=new De;class Yo{constructor(e=new De,t=new De){this.start=e,this.end=t}set(e,t){return this.start.copy(e),this.end.copy(t),this}copy(e){return this.start.copy(e.start),this.end.copy(e.end),this}getCenter(e){return e.addVectors(this.start,this.end).multiplyScalar(.5)}delta(e){return e.subVectors(this.end,this.start)}distanceSq(){return this.start.distanceToSquared(this.end)}distance(){return this.start.distanceTo(this.end)}at(e,t){return this.delta(t).multiplyScalar(e).add(this.start)}closestPointToPointParameter(e,t){qo.subVectors(e,this.start),Xo.subVectors(this.end,this.start);const i=Xo.dot(Xo);let n=Xo.dot(qo)/i;return t&&(n=fe(n,0,1)),n}closestPointToPoint(e,t,i){const n=this.closestPointToPointParameter(e,t);return this.delta(i).multiplyScalar(n).add(this.start)}applyMatrix4(e){return this.start.applyMatrix4(e),this.end.applyMatrix4(e),this}equals(e){return e.start.equals(this.start)&&e.end.equals(this.end)}clone(){return(new this.constructor).copy(this)}}class Zo extends ma{constructor(e,t=1,i=16776960){const n=i,r=new fi;r.setAttribute("position",new oi([1,-1,1,-1,1,1,-1,-1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,0,0,1,0,0,0],3)),r.computeBoundingSphere(),super(r,new la({color:n,toneMapped:!1})),this.type="PlaneHelper",this.plane=e,this.size=t;const s=new fi;s.setAttribute("position",new oi([1,1,1,-1,1,1,-1,-1,1,1,1,1,-1,-1,1,1,-1,1],3)),s.computeBoundingSphere(),this.add(new Ri(s,new ei({color:n,opacity:.2,transparent:!0,depthWrite:!1,toneMapped:!1})))}updateMatrixWorld(e){let t=-this.plane.constant;Math.abs(t)<1e-8&&(t=1e-8),this.scale.set(.5*this.size,.5*this.size,t),this.children[0].material.side=t<0?1:0,this.lookAt(this.plane.normal),super.updateMatrixWorld(e)}}function Jo(e){let t;const i=new $t(16711680),n=m(new xe),r=m(1);let s=1,a=2;const o={antialias:!1,alpha:!1,depth:!0,stencil:!1,preserveDrawingBuffer:!1,powerPreference:"high-performance",premultipliedAlpha:!1},l={beforeInit:f(),afterInit:f()};e.renderer={init:function(){o.canvas=e.options.canvas,l.beforeInit.emit(),t=new ks(o),e.renderer.instance=t,e.threeRenderer=t,t.getDrawingBufferSize(n.value),d(),t.setClearColor(i),t.autoClear=!0,t.shadowMap.enabled=!1,t.shadowMap.type=0,t.info.autoReset=!1,e.hooks.beforeFrame.watch((()=>t.info.reset())),l.afterInit.emit(),e.viewport.changed.watch(d)},options:o,hooks:l,clearColor:i,resize:d,setMinPixelRatio:function(e){if(s===e)return;s=e,h()},setMaxPixelRatio:function(e){if(a===e)return;a=e,h()},drawingBufferSize:n,pixelRatio:r};let u=!1;function h(){u||(u=!0,e.hooks.beforeFrame.watchOnce(d))}function d(){u=!1;const i=c(e.viewport.pixelRatio.value,s,a),o=e.viewport.size.value,l=xe.get();t.getSize(l),t.getPixelRatio()!==i&&t.setPixelRatio(i),l.equals(o)||t.setSize(o.x,o.y),function(){const e=n.value,i=xe.get();t.getDrawingBufferSize(i),g(),i.equals(e)||n.set(e.copy(i),!0);r.set(t.getPixelRatio()),i.release(),v()}(),l.release()}}const Qo=Number.MAX_SAFE_INTEGER;function Ko(e){let t=16.67,i=!1,n=performance.now(),r=16.6667,s=0,a=0,o=0;let l=0,u=0;e.hooks.afterInit.watchOnce((()=>{e.viewport&&e.viewport.visible.watch((()=>i=!0))})),e.hooks.afterFrame.watchOnce((()=>{i=!0}));const h=e.time={clampedDt:0,stableDt:16.6667,dt:0,elapsed:0,frameNum:0,paused:!0,init:function(){G.add(d),h.paused=!1},start:function(){h.paused=!1},pause:function(){h.paused=!0},clampTo60Fps:!0};function d(d){const p=n;if(n=performance.now(),0===(d=n-p)&&(d=16.6667),i&&(d=16.6667,o=!0,a=0,s=0,i=!1,l=0,u=0),h.clampTo60Fps){if(l+=d,u++,l<13)return;u>1&&(d=16.666667),l=0,u=0}a+=d,a>=1e3?(o=!1,r=1/s*1e3,a=0,s=0):s++,t=c(o?d:r,4,130),t>30.303030303030305&&t<37.03703703703704?t=33.3333334:t>15.873015873015872&&t<17.543859649122805?t=16.6666667:t>8&&t<9.09090909090909&&(t=8.3333334),h.stableDt=W(h.stableDt,t,i?1:.08),h.clampedDt=c(void 0===d?16.6667:d,1,130),h.dt=d,h.paused||(h.elapsed+=d,h.frameNum=(h.frameNum+1)%Qo,e.frame())}}function $o(e){const t=y(),i=m(new xe(t.width.value,t.height.value)),n=m(i.value.x/i.value.y),r=m(t.pixelRatio.value),s=m(t.visible.value),a=f();e.viewport={size:i,visible:s,pixelRatio:r,changed:a};let o=0,l=0,c=0;const u=x((()=>(o=t.width.value,l=t.height.value,void(c=t.pixelRatio.value))),150);O([t.width,t.height,t.pixelRatio],(()=>{e.options.canvas.style.width=t.width.value+"px",e.options.canvas.style.height=t.height.value+"px",u()}),{immediate:!0}),F((()=>{s.set(t.visible.value)})),e.hooks.beforeFrame.watch((()=>{const e=i.value,t=e.x!==o||e.y!==l,s=r.value!==c;(t||s)&&(g(),t&&(e.set(o,l),i.set(e,!0),n.set(e.x/e.y)),s&&r.set(c),a.emit(),v())}))}function el(e){const t="webgl_quality",i=300;let n=58,r=52,s=30,a=i,o=i,l=0,u=0,h=!1,d=!1,p=0,g=10;const v=new Float64Array(3);let y=0;const x=m(0),_=m(60),b=m(60),w=m(1),M=f();e.hooks.afterInit.watchOnce((function(){const i=H().$device,n=(i&&i.gpu?i.gpu.qualityIndex:2)+1,r=function(){const e=localStorage.getItem(t);return null==e||isNaN(e)?null:0|e}(),s=null!==r?r:n;w.watch((e=>{i&&i.updateQuality(e),function(e){localStorage.setItem(t,e)}(e)})),w.set(s,!0),p=s,e.hooks.beforeFrame.watch(T)})),e.hooks.beforeStart.watchOnce((async function(){e.viewport.visible.watch((()=>S())),e.viewport.changed.watch((()=>S(!0,i,!0))),M.watch((()=>S(!0,300)))}));return e.quality={pingPong:x,fps:_,fpsAverage:b,quality:w,reset:M,current:w,setThresholds:function(e={}){e.high&&(n=e.high);e.low&&(r=e.low);e.critical&&(s=e.critical)}};function S(e,t,i){h=!0,d=d||e,i&&x.set(0),t&&(a=t)}function T(){if(g>0)return g--;const t=e.time.dt;if(!(x.value>=2)){if(h&&(l=0,u=0,d&&(y=0),o=a||i,h=d=!1,a=i),o>0)return o-=t;l+=t,u++,l>=1e3&&(v[y++]=u,_.set(u),u=0,l%=1e3,y>v.length&&function(){const e=function(e=[]){const t=e.slice(0).sort(((e,t)=>e-t)),i=Math.floor(t.length/2);return t.length%2==0?(t[i]+t[i-1])/2:t[i]}(v);let t=w.value;e<=s?t-=2:e<r?t-=1:e>n&&(t+=1),t=c(t,0,5);const i=w.value;t===i?x.set(Math.max(0,x.value-.2)):t!==i&&t!==p?x.set(0):t===p&&x.set(x.value+1),x.value>=2&&(t=Math.min(p,i)),p=i,w.set(t),b.set(e),S(!0)}())}}}function tl(e){!function(e){const t=e.renderLists;if(t._patched)return;t._patched=!0;const i=t.get;t.get=function(e,t){const n=i(e,t);return n._patched||function(e){e._patched=!0;const t=e.push,i=e.unshift;e.push=function(e,i,n,r,s,a){const o=n.transparent&&n.forceOpaque;o&&(n.transparent=!1),t(e,i,n,r,s,a),o&&(n.transparent=!0)},e.unshift=function(e,t,n,r,s,a){const o=n.transparent&&n.forceOpaque;o&&(n.transparent=!1),i(e,t,n,r,s,a),o&&(n.transparent=!0)}}(n),n}}(e)}const il=new hn(-1,1,1,-1,0,1);il.parent=!0;var nl=il;const rl=new Float32Array([-2,0,0,-2,2,2]),sl=new fi;sl.setAttribute("position",new ni(rl,2));const al=["precision highp float;","attribute vec2 position;","varying vec2 vUv;","void main() {","vUv = position;","gl_Position =  vec4(2.0 * position - 1.0, 0.,  1);","}"].join("");let ol;function ll(e){const t=e.renderer;delete e.renderer;const i=new dn(Object.assign({},{vertexShader:al,fragmentShader:"void() { gl_FragColor = vec4(); }",depthTest:!1,depthWrite:!1,transparent:!0},e));ol||(ol=new Ri(sl,i),ol.frustumCulled=!1,ol.matrixAutoUpdate=!1);return{cam:nl,screen:ol,material:i,uniforms:i.uniforms,u:i.uniforms,render(){const e=t.sortObjects,n=t.shadowMap.enabled,r=t.autoclear;t.sortObjects=!1,t.shadowMap.enabled=!1,t.autoclear=!1,ol.material=i,t.render(ol,nl),t.sortObjects=e,t.shadowMap.enabled=n,t.autoclear=r}}}function cl(e,t,i){return{vs:e,fs:t,use:i=>{i.fragmentShader=t,i.vertexShader=e},unuse:()=>{}}}var ul=cl("precision highp float;attribute vec2 position;void main(){gl_Position=vec4(2.0*position-1.0,0.,1);}","precision highp float;\n#include <bg_pars>\nvoid main(){\n#include <bg>\ngl_FragColor=vec4(bgColor,1.);}");const hl={res:{value:new xe},bgCamRotation:{value:new xe}},dl=new De,pl=new De;function ml(){const e=j(),t=ll({renderer:e.threeRenderer,transparent:!1,uniforms:hl});return hl.res=e.renderer.drawingBufferSize,ul.use(t.material),t.update=function(){const t=e.scene.currentCamera.cam,i=t.getWorldDirection(dl),n=t.localToWorld(pl.set(1,0,0)).sub(t.position),r=i.y,s=-n.y;hl.bgCamRotation.value.set(r,s)},t}ml.uniforms=hl;class fl{constructor(e){this.isComponent=!0,this.components=[],this.dynamicComponents=[],this.refs={},this.tweens={},this.timers=[],this.props=e}bind(e,t=0){return this[e]=oe(e,this,t),this[e]}init(){}beforeDestroy(){}add(e){return this.base.add(e),e}remove(e){return this.base.remove(e),null}addComponent(e,t){t||(t={});const i=t.mountTo||this.base;return e.isComponent||(e=new e(t)),~this.components.indexOf(e)||~this.dynamicComponents.indexOf(e)||(e.parentComponent&&e.parentComponent.removeComponent(e),e.parentComponent=this,e.static||this.dynamicComponents.push(e),this.components.push(e),i&&e.base&&i.add(e.base),e.added&&e.added(this)),e}removeComponent(e){const t=this.components.indexOf(e),i=this.dynamicComponents.indexOf(e);if(~t)return e.parentComponent=null,this.components.splice(t,1),~i&&this.dynamicComponents.splice(i,1),this.base&&e.base&&this.base.remove(e.base),e.removed&&e.removed(this),null}update(e){if(this.updateTimers(e),!this.destroyed)for(let t=0,i=this.dynamicComponents.length;t<i;t++)this.dynamicComponents[t]&&this.dynamicComponents[t].update(e)}updateTimers(e){let t=this.timers.length;const i=this.timers;for(;t--;)i[t].update(e),i._stopped&&(i[t].dispose(),i.splice(t,1))}wait(e){return this.timer(e)}timer(e,t){if(!this.destroyed){if(t){const i=q(e,t);return this.timers.push(i),i}return new Promise((t=>{const i=q(e,t);this.timers.push(i)}))}}clearTimers(){for(let e=0,t=this.timers.length;e<t;e++)this.timers[e].dispose();this.timers.length=0}destroy(){if(!this.destroyed){this.hiding=!0,this.beforeDestroy(),this.clearTimers(),this.parentComponent&&this.parentComponent.removeComponent(this);for(let e=this.components.length-1;e>=0;e--)this.components[e].destroy();if(this.base)for(let e=this.base.children.length-1;e>=0;e--)this.base.remove(this.base.children[e]);for(const e in this.tweens)this.tweens[e]&&this.tweens[e].kill();this.tweens=null,this.base&&this.base.parent&&this.base.parent.remove(this.base),this.refs=null,this.props=null,this.base=null,this.destroyed=!0,this.components=null,this.dynamicComponents=null,this.anims=null,this.timers=null}}}class gl extends fl{constructor(e={}){var t;super(e),this.isCamera=!0,e.noInit||this.init(e),this.props||(this.props=e),this.base||((t=this).cam=new Vi(55,window.innerWidth/window.innerHeight,.1,100),t.base=t.cam,t.base.position.set(0,.2,1).multiplyScalar(5),t.base.lookAt(new De(0,0,0)));const i=j().renderer.drawingBufferSize;this.unwatchResize=i.watch(this.resize,this),this.resize(i.value),this.used=!1}afterEnable(){}afterDisable(){}update(){}resize(e){this.cam.aspect=e.x/e.y,this.cam.updateProjectionMatrix()}beforeDestroy(){this.unwatchResize()}destroy(){this.cam=null,super.destroy()}}const vl=function(e,t){e&&e.used!=t&&(e.used=!!t,t?e.afterEnable():e.afterDisable())};class yl extends fl{constructor(e={}){super(e),this.isScene=!0,this.scene=this.base=new Vs,this.background=new $t(0,0,0),e.noInit||this.init(e),this.props||(this.props=e),this.currentCamera||this.fallbackCamera()}fallbackCamera(){this.defaultCamera||(this.defaultCamera=this.addComponent(new gl)),this.useCamera(this.defaultCamera)}useCamera(e){return this.currentCamera&&(this.previousCamera=this.currentCamera),this.currentCamera=e,this.previousCamera!==this.currentCamera&&vl(this.previousCamera,!1),vl(this.currentCamera,!0),this.currentCamera||this.fallbackCamera(),e}usePreviousCamera(){const e=this.currentCamera;this.currentCamera=this.previousCamera,this.previousCamera=e,this.previousCamera!==this.currentCamera&&vl(this.previousCamera,!1),vl(this.currentCamera,!0),this.currentCamera||this.fallbackCamera()}enter(){}exit(){}render(){j().threeRenderer.render(this.base,this.currentCamera.cam)}}var xl=function(e){function t(t){(e=(0|t)%2147483647)<=0&&(e+=2147483646)}function i(){return e=48271*e%2147483647}return t(e),{seed:t,nextInt:i,nextFloat:function(){return(i()-1)/2147483646}}};var _l=function(e=0){let t=xl(e);return t.nextFloat(),t.nextFloat(),{setSeed:function(i){t=xl(e=i)},random:function(){return t.nextFloat()},randomFloat:function(e=0,i=1){return t.nextFloat()*(i-e)+e},randomInt:function(e,i){return Math.floor(t.nextFloat()*(i-e+1))+e},hash2d:i,hash2dInt:function(e,t,n,r){return Math.floor(i(e,t)*(r-n+1))+n}};function i(e,t){return function(e){return e-Math.floor(e)}(43758.5453*Math.sin(e*78.233-12.9898*t))}}(Date.now());const bl=(3-Math.sqrt(3))/6,wl=[[1,1],[-1,1],[1,-1],[-1,-1],[1,0],[-1,0],[1,0],[-1,0],[0,1],[0,-1],[0,1],[0,-1]];function Ml(e=Math.random){const t=new Uint8Array(256);for(let a=0;a<256;a++)t[a]=a;let i,n;for(let a=255;a>0;a--)i=Math.floor((a+1)*e()),n=t[a],t[a]=t[i],t[i]=n;const r=new Uint8Array(512),s=new Uint8Array(512);for(let a=0;a<512;a++)r[a]=t[255&a],s[a]=r[a]%12;return(e,t)=>{const i=.5*(e+t)*(Math.sqrt(3)-1),n=Math.floor(e+i),a=Math.floor(t+i),o=(n+a)*bl,l=e-(n-o),c=t-(a-o),u=l>c?1:0,h=l>c?0:1,d=l-u+bl,p=c-h+bl,m=l-1+2*bl,f=c-1+2*bl,g=255&n,v=255&a,y=wl[s[g+r[v]]],x=wl[s[g+u+r[v+h]]],_=wl[s[g+1+r[v+1]]],b=.5-l*l-c*c,w=.5-d*d-p*p,M=.5-m*m-f*f;return 70.14805770653952*((b<0?0:Math.pow(b,4)*(y[0]*l+y[1]*c))+(w<0?0:Math.pow(w,4)*(x[0]*d+x[1]*p))+(M<0?0:Math.pow(M,4)*(_[0]*m+_[1]*f)))}}function Sl(e){const t=j().time.stableDt;let i=1;return t>39?i=1.4:t>32?i=1.3:t>24?i=1.2:t>19?i=1.1:t>16&&(i=1),e*i}const Tl=Ml(),Al=new De,Cl=new De,Ll=new De,Pl=new De,El=new De,Dl=new De,Il=new Ee,Rl=new Ee;let zl,Nl;class Ol extends gl{init(){zl=j(),Nl=zl.game,zl.gameCam=Nl.gameCam=this,this.turbolineActive=!0,this.cloudParticlesActive=!0;const e=this.cam=new Vi(40,1,.2,180);this.base=this.cam,this.isGameCamera=!0,this.cam.position.set(0,3,10),this.cam.lookAt(new De(0,0,0)),this.cam.updateProjectionMatrix(),this.minVel=10,this.maxVel=40,this.minFov=30,this.maxFov=50,this.targetFov=this.cam.fov,this.baseCam={pos:e.position.clone(),qt:e.quaternion.clone()},this.target={pos:new De,qt:new Ee},this.targetLerp1={pos:new De,qt:new Ee},this.targetLerp2={pos:new De,qt:new Ee},this.road=Nl.createFrameData(),this.veryForwardRoad=Nl.createFrameData(),this.forwardRoad=Nl.createFrameData(),this.behindRoad=Nl.createFrameData(),this.plane=new Yi,this.forwardLine=new Yo,this.carTranslation=0,this.activeInfluence=0,this.shakeState={shaking:!1,maxDuration:0,maxAmplitude:0,currentDuration:0,currentAmplitude:0,freqMult:1,value:[0,0],pos:[0,0],speed:[.006,1e-4]},this.hitPoint=new Rt,this.camPoint=new Rt,zl.viewport.changed.watch(this.updateBaseDistance,this),Nl.hooks.reset.watch(this.reset,this),this.reset(),Nl.turbo.active.watch((e=>{this.shakeTurboTarget=e?1:0,e&&(this.shakeTurbo=this.shakeTurboTarget,this.shake(800,-.15,!0,!0,1.1))})),Nl.ended.watch((e=>{this.endedInfluence=0}))}updateBaseDistance(){const e=zl.viewport.size.value,t=e.x/e.y;this.baseDistance=W(1.65,1.4,c(te(t,.55,.85),0,1))}afterEnable(){this.reset()}afterDisable(){this.activeInfluenceTarget=0,this.activeInfluence=0}reset(){this.baseDistance=1.6,this.updateBaseDistance(),this.turboInfluence=0,this.shakeTurbo=this.shakeTurboTarget=0,this.targetFovSmooth=this.targetFov=70,this.autoInfluence=0,this.endedInfluence=0,this.activeInfluence=0,this.activeInfluenceTarget=this.used?1:0,"game"===X.$route.name&&(this.forwardInfluence=1,this.forwardInfluenceRotate=1),this.update(!0)}updateMatrix(){const e=this.cam;e.updateMatrix(),e.matrixWorld.copy(e.matrix)}updateUp(e){this.cam.up.copy(Pl.set(0,1,0).applyQuaternion(e||this.cam.quaternion))}update(e){Nl.resetting&&(e=!0);const t=zl.time.stableDt,i=Nl.turbo.active.value;this.turboInfluence=Y(this.turboInfluence,i?1:0,i?.1:.06,t),this.distance=this.baseDistance+.15*this.baseDistance*this.turboInfluence,this.activeInfluence=Z(this.activeInfluence,this.activeInfluenceTarget,.08,t,1e-5),this.autoInfluence=W(this.autoInfluence,Nl.autopilot.value?1:0,Nl.autopilot.value?.05:.08);const n=this.cam,r=this.baseCam,s=this.target,a=this.targetLerp1,o=this.targetLerp2,l=this.road,u=this.behindRoad,h=this.forwardRoad,d=this.veryForwardRoad;n.position.copy(r.pos),n.quaternion.copy(r.qt),this.updateMatrix();const p=W(2,15,this.autoInfluence),m=W(8,30,this.autoInfluence);let f=0;const g=Nl.checkpoints.list.finish+7;Nl.ended.value&&Nl.progress>g&&(this.activeInfluenceTarget=0,this.endedInfluence=Y(this.endedInfluence,1,.02,t),f=W(0,g+8*this.endedInfluence-Nl.progress,this.endedInfluence)),Nl.getRelativeRoadData(0+f,l),Nl.getRelativeRoadData(p+f,h),Nl.getRelativeRoadData(m+f,d),Nl.getRelativeRoadData(-this.distance+f,u);const v=Al.copy(d.position),y=Ll.copy(l.position).sub(v).normalize(),x=Cl.copy(y).multiplyScalar(this.distance).add(l.position);this.forwardLine.start.copy(h.position),this.forwardLine.end.copy(x),this.hitPoint.position.copy(x),this.hitPoint.quaternion.copy(l.quaternion),this.hitPoint.updateWorldMatrix(!0),this.camPoint.position.copy(u.position),this.camPoint.quaternion.copy(u.quaternion),this.camPoint.updateWorldMatrix(!0),this.camPoint.worldToLocal(El.copy(this.hitPoint.position)),this.camPoint.translateX(El.x),this.camPoint.translateY(c(El.y,0,10)),this.camPoint.translateZ(El.z),this.camPoint.quaternion.copy(this.hitPoint.quaternion),this.camPoint.updateWorldMatrix(!0),n.position.copy(this.camPoint.position),n.quaternion.copy(this.camPoint.quaternion),this.updateUp(),n.translateY(W(0,-.3,this.autoInfluence));const _=El.y;n.translateY(.2-_),n.lookAt(l.position),Il.copy(n.quaternion),n.translateY(_+.2),n.lookAt(h.position),Rl.copy(n.quaternion),n.quaternion.copy(Rl),n.quaternion.slerp(Il,W(.15*-_,0,this.autoInfluence)),s.pos.copy(n.position),s.qt.copy(n.quaternion),n.position.copy(r.pos),n.quaternion.copy(r.qt);const b=Sl;a.pos.lerp(s.pos,e?1:b(.2)),a.qt.slerp(s.qt,e?1:b(.2)),o.pos.lerp(a.pos,e?1:b(.15)),o.qt.slerp(a.qt,e?1:b(.15)),n.position.lerp(o.pos,e?1:b(.1)),n.quaternion.slerp(o.qt,e?1:b(.1)),e&&n.translateY(.45),El.copy(l.position).sub(n.position).normalize();const w=Dl.copy(El).multiplyScalar(-this.distance).add(l.position);n.position.copy(w),n.translateY(ie(Nl.velocity*t/16.6667,0,10,.05,.08)),r.pos.copy(n.position),r.qt.copy(n.quaternion);const M=zl.scene.road.car;this.carTranslation=W(this.carTranslation,M.base.position.z,e?1:b(.2)),n.rotateZ(-.025*this.carTranslation),n.translateX(this.carTranslation),n.rotateZ(-.025*this.carTranslation);const S=Nl.velocity;this.targetFov=c(ie(S,6,10,70,79),70,95),this.targetFov*=1+.015*i;const T=e?1:.09+.2*this.turboInfluence;if(this.targetFovSmooth=W(n.fov,this.targetFov,T),n.fov=W(n.fov,this.targetFovSmooth,T),this.cam.updateProjectionMatrix(),this.forwardInfluence>1e-5&&(this.cam.translateY(-.2*this.forwardInfluence),this.cam.translateZ(-3*this.forwardInfluence)),this.forwardInfluenceRotate>1e-5&&(this.cam.rotateZ(-.2*this.forwardInfluenceRotate),this.cam.rotateX(-.4*this.forwardInfluenceRotate)),Nl.paused.value)return;this.forwardInfluence>1e-5&&(this.forwardInfluence=Y(this.forwardInfluence,0,.07,t)),this.forwardInfluenceRotate>1e-5&&(this.forwardInfluenceRotate=Y(this.forwardInfluenceRotate,0,.03,t));const A=this.shakeState;if(A.shaking){const e=1-A.currentDuration/A.maxDuration;let i=W(A.speed[0],A.speed[1],e);i*=A.freqMult,A.currentAmplitude=W(A.maxAmplitude,0,e),A.pos[0]+=t*i,A.pos[1]+=t*i,A.value[0]=Math.cos(9*A.pos[0])*A.currentAmplitude*.6,A.value[1]=Tl(10,A.pos[1])*A.currentAmplitude;const n=.9*A.value[0],r=.3*A.value[1],s=A.vertical?r:n,a=A.vertical?n:r;this.base.translateY(a),this.base.translateX(s),this.base.rotateZ(.5*a),this.base.rotateY(.5*s),A.currentDuration=Math.max(0,A.currentDuration-t),0===A.currentDuration&&(A.maxAmplitude=0,A.maxDuration=0,A.shaking=!1)}const C=zl.game.elapsed;if(M.dipShake>.001){const e=Math.cos(.09*C)*M.dipShake+M.dipShake;this.base.translateX(.9*e),this.base.rotateX(.3*e)}if(this.shakeTurbo>.001){this.shakeTurbo=Y(this.shakeTurbo,this.shakeTurboTarget,.08,t);const e=(.5*Math.cos(.079*C)+.5)*this.shakeTurbo*.01;this.base.translateY(1*e),this.base.rotateZ(1.4*e)}}shake(e=500,t=.1,i=!1,n=!1,r=1){const s=this.shakeState;t*=1.07,s.vertical=i,(n||!s.shaking||e>s.maxDuration)&&(s.maxDuration=e,s.currentDuration=e),(n||!s.shaking||t>s.maxAmplitude)&&(s.maxAmplitude=t,s.currentAmplitude=t,s.freqMult=r),(e||t)&&(s.shaking=!0),s.pos[0]=200*Math.PI,s.pos[1]=500*Math.random()}devtools(){const e=zl.scene,t=new Ni;t.scale(.06,.06,.06),this.forwardRuler=e.addComponent(LineHelper,{line:this.forwardLine}),this.planeHelper=e.add(new Zo(this.plane,1e3)),this.cameraHelper=e.add(new CameraHelper(this.cam)),this.hitPoint=e.add(new Ri(t,new ei({color:16776960}))),this.camPoint=e.add(new Ri(t,new ei({color:16777215}))),this.showHelper=re(m(!1),"cam_helper",{type:Boolean}),requestAnimationFrame((()=>{zl.scene.gui.addButton({title:"Shake",label:"Game Camera"}).on("click",(()=>this.shake())),zl.scene.gui.addInput(this,"showHelper",{label:"Cam Helpers",index:1})})),this.showHelper.watchImmediate((e=>{this.cameraHelper.visible=this.forwardRuler.visible=this.planeHelper.visible=this.camPoint.visible=this.hitPoint.visible=e}))}}var Fl=[{fromPos:[175.216669,-.036465,11.9629],fromQt:[.02326362,.92994943,-.05975366,.36205297],toPos:[167.658131,2.232513,20.198758],toQt:[.02326362,.92994943,-.05975366,.36205297],carProgress:450,minDuration:2e3,maxDuration:2e3,shotDuration:4e3,engineMult:1.02,portrait:!0},{fromPos:[187.853648,1.957363,48.003604],fromQt:[.01508246,.86160589,-.02564635,.50670512],toPos:[183.340058,2.267299,49.875425],toQt:[.01670806,.85731853,-.02788102,.51375911],carProgress:490,minDuration:2700,maxDuration:2700,engineMult:1.1,carTowardsCam:!0},{fromPos:[128.718036,4.103217,3.850563],fromQt:[-.02500299,.09774558,.00245647,.99489428],toPos:[125.773766,5.079072,-5.987887],toQt:[.04454532,-.36356677,.01740783,.93033966],carProgress:330,minDuration:2e3,maxDuration:2e3,portrait:!0,selfieMode:!0},{fromPos:[128.718036,4.103217,3.850563],fromQt:[-.02500299,.09774558,.00245647,.99489428],toPos:[125.773766,5.079072,-5.987887],toQt:[.04454532,-.36356677,.01740783,.93033966],carProgress:340,minDuration:2e3,maxDuration:2e3},{fromPos:[225.97637,-.396231,-31.212934],fromQt:[-.00207845,.99464626,-.02041174,-.10128113],toPos:[228.390101,.091184,-19.913308],toQt:[.00430996,.99565115,.06124577,-.07006551],carProgress:592,minDuration:1700,maxDuration:1700,shotDuration:1700,carTowardsCam:!0,portrait:!0},{fromPos:[227.461658,-.290387,-21.434235],fromQt:[-.05747906,-.0279098,-.00160752,.99795522],toPos:[222.675706,-.038329,-63.153271],toQt:[.0892923,-.0343194,.00307859,.99540926],carProgress:605,minDuration:4e3,maxDuration:4e3,engineMult:.95,portrait:!0},{fromPos:[88.076076,6.250712,32.666098],fromQt:[-.00314254,.40548705,.00139402,.91409432],toPos:[84.67264,5.274827,21.484648],toQt:[-.0034374,-.01624803,-5586e-8,.99986208],carProgress:220,minDuration:2e3,maxDuration:2e3,shotDuration:2500,carTowardsCam:!0,engineMult:1.1},{fromPos:[103.419212,-.721882,52.708181],fromQt:[-.11709994,-.53352681,-.07488577,.83428344],toPos:[111.952886,-1.969951,47.591677],toQt:[-.05274749,-.4966684,-.03025847,.8658075],carProgress:135,minDuration:2e3,maxDuration:2e3,engineMult:1.04},{fromPos:[123.084511,-.299156,19.813292],fromQt:[.00560572,.95071188,.01721688,-.30954655],toPos:[115.367267,.175733,9.218633],toQt:[.00560572,.95071188,.01721688,-.30954655],carProgress:160,minDuration:2500,maxDuration:2500,shotDuration:2500,carTowardsCam:!0,portrait:!0},{fromPos:[123.084511,-.299156,19.813292],fromQt:[.00560572,.95071188,.01721688,-.30954655],toPos:[115.367267,.175733,9.218633],toQt:[.00560572,.95071188,.01721688,-.30954655],carProgress:160,minDuration:2500,maxDuration:2500,shotDuration:2500,carTowardsCam:!0,portrait:!0,selfieMode:!0},{fromPos:[254.197647,-.5098,-94.872706],fromQt:[-.02720285,.33842121,.00978791,.94055052],toPos:[244.776459,-.59221,-96.238816],toQt:[.0086017,.52566449,-.00531559,.85063188],carProgress:700,minDuration:1200,maxDuration:1200,carTowardsCam:!0,engineMult:1.1,portrait:!0},{fromPos:[18.68355,.305625,-.552699],fromQt:[.05793902,-.75217683,.06673793,.65300776],toPos:[36.576095,1.201599,-.9713],toQt:[.01251986,-.8333603,.01889228,.55226529],carProgress:18,minDuration:3e3,maxDuration:3e3,shotDuration:3e3,engineMult:1.07,portrait:!0}];function Ul(e){return e[(t=0,i=e.length,Math.floor(Math.random()*(i-t))+t)];var t,i}Ml();const kl=new De,Bl=new De;new De,new Ee,new Ee;const Vl=new Rt;let Gl,Wl;class Hl extends gl{init(){Gl=j(),Wl=Gl.game,this.cam=new Vi(55,1,.2,180),this.base=this.cam,this.forceCarAutopilot=!0,this.forceCarVelocity=8,this.isIdleCamera=!0,this.cam.position.set(0,3,10),this.cam.lookAt(new De(0,0,0)),this.cam.updateProjectionMatrix(),this.enabled=m(!1),this.shot={fromPos:new De,toPos:new De,fromQt:new Ee,toQt:new Ee,lookAt:new De,useLookAt:!1,towardsCam:!1,seflieMode:!1},this.reset()}reset(){this.index=-1,this.shot.fromPos.setScalar(0),this.shot.toPos.setScalar(0),this.shot.useLookAt=!1,this.nextShot(),this.update(!0)}updateMatrix(){const e=this.cam;e.updateMatrix(),e.matrixWorld.copy(e.matrix)}updateUp(e){const t=kl.set(0,1,0).applyQuaternion(e||this.cam.quaternion);this.cam.up.copy(t)}nextShot(e){const t=(this.index+1)%Fl.length,i=Fl[e||t];if(i.fromPos&&this.shot.fromPos.fromArray(i.fromPos),i.toPos&&this.shot.toPos.fromArray(i.toPos),i.fromQt&&this.shot.fromQt.fromArray(i.fromQt),i.toQt&&this.shot.toQt.fromArray(i.toQt),i.lookAt&&this.shot.lookAt.fromArray(i.lookAt),this.shot.selfieMode=!!i.selfieMode,this.carTowardsCam=!!i.carTowardsCam,this.engineMult=null!=i.engineMult?i.engineMult:_l.randomFloat(.98,1.03),this.shot.useLookAt=i.lookAt,this.index=t,this.time=0,this.shotDuration=i.shotDuration||1e4,this.duration=_l.randomFloat(i.minDuration||3e3,i.maxDuration||5e3),this.used){const e=i.carProgress||0;Wl.progress=e}}afterEnable(){this.reset(),"result"===X.$route.name&&this.nextShot(1)}afterDisable(){this.reset()}update(e){if(this.visible=this.used,!e&&!this.visible)return;const t=e?0:Gl.time.stableDt;this.time+=t;const i=this.shot,n=this.cam,r=c(this.time/this.shotDuration,0,1);i.selfieMode?this.selfieMode(n):(n.position.lerpVectors(i.fromPos,i.toPos,r),i.useLookAt?n.lookAt(i.lookAt):n.quaternion.slerpQuaternions(i.fromQt,i.toQt,r)),this.time>=this.duration&&this.nextShot()}selfieMode(e){const t=Gl.game.getRelativeRoadData(1),i=Wl.pointer.base;Vl.position.copy(t.position),Vl.quaternion.copy(i.quaternion),Vl.lookAt(i.position),Vl.rotateY(Math.PI),Vl.updateMatrixWorld();const n=Vl.localToWorld(Bl.set(0,.26,0));Vl.position.copy(n),e.position.copy(Vl.position),e.quaternion.copy(Vl.quaternion)}}class jl extends fl{constructor(e={}){super(e),e.noInit||this.init(e),this.props||(this.props=e),this.base||(this.base=new Rt),void 0===this.static&&(this.static=!1)}destroy(){super.destroy()}}var ql=cl("#define PHONG\nvarying vec3 vViewPosition;\n#include <common>\n#include <uv_pars_vertex>\n#include <envmap_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <shadowmap_pars_vertex>\nvoid main(){\n#include <uv_vertex>\n#include <beginnormal_vertex>\n#include <defaultnormal_vertex>\n#include <normal_vertex>\n#include <begin_vertex>\n#include <project_vertex>\nvViewPosition=-mvPosition.xyz;\n#include <worldpos_vertex>\n#include <envmap_vertex>\n#include <shadowmap_vertex>\n#include <fog_vertex>\n}","#define PHONG\n#define NEON\n#include <common>\n#include <packing>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <cube_uv_reflection_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_phong_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <bg_fog_pars>\n#include <conditionals>\n#include <luma>\nuniform vec3 diffuse;uniform vec3 emissive;uniform vec3 specular;uniform float shininess;uniform float opacity;uniform float speedInfluence;uniform sampler2D data;uniform sampler2D matcaps;void main(){vec3 data=texture2D(data,vUv).rgb;float speedLineInfluence=clamp(smoothstep(0.1,1.,gl_FragCoord.w),0.,1.)*data.b*speedInfluence;vec4 diffuseColor=vec4(diffuse,opacity);float rimLightPower=2.5;float rimLightStrength=0.9;float rightLight=rimLightPower*abs(dot(vNormal,normalize(vViewPosition)));rightLight=1.-smoothstep(.0,1.,rightLight);diffuseColor.rgb+=diffuseColor.rgb*vec3(rightLight*rimLightStrength)*0.5;diffuseColor.rgb+=clamp(vNormal.x*0.9,-1.,0.)*0.7;diffuseColor.rgb-=vNormal.z*0.2;ReflectedLight reflectedLight=ReflectedLight(vec3(0.0),vec3(0.0),vec3(0.0),vec3(0.0));vec3 totalEmissiveRadiance=emissive;\n#include <map_fragment>\nfloat specularStrength=1.0;specularStrength=data.g*10.+speedLineInfluence*8.;\n#include <normal_fragment_begin>\n#include <lights_phong_fragment>\n#include <lights_fragment_begin>\n#include <lights_fragment_maps>\n#include <lights_fragment_end>\nvec3 outgoingLight=reflectedLight.directDiffuse+reflectedLight.indirectDiffuse+reflectedLight.directSpecular+reflectedLight.indirectSpecular+totalEmissiveRadiance;outgoingLight=mix(outgoingLight,outgoingLight*0.5+vec3(1.),speedLineInfluence*1.);float neonIntensity=data.r;outgoingLight.rgb=min(vec3(1.),outgoingLight.rgb+vec3(neonIntensity));\n#include <output_fragment>\n#include <neon_encode>\n#include <bg_fog>\n}");let Xl,Yl,Zl=null;class Jl extends ki{constructor(e={}){super(e);const t=this.uniforms=l(o(o({},Ui.merge([nn.common,nn.specularmap,nn.fog,nn.lights])),ml.uniforms),{map:{value:J.textures.roadDiffuse},data:{value:J.textures.roadData},specular:{value:new $t(1118481)},shininess:{value:130},speedInfluence:{value:0}});this.map=t.map.value,ql.use(this),this.lights=!0,this.fog=!0,this.type="ShaderMaterial",this.isShaderMaterial=!0}}Jl.get=e=>Zl=Zl||new Jl(e);class Ql extends jl{init(){Xl=j(),Yl=Xl.game,Yl.pointer=this,this.base=new Rt}update(){const e=Yl.getRoadData();this.base.position.copy(e.position),this.base.quaternion.copy(e.quaternion),this.base.updateMatrixWorld()}}var Kl=cl("#define PHONG\nvarying vec3 vViewPosition;\n#include <common>\n#include <uv_pars_vertex>\n#include <envmap_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <shadowmap_pars_vertex>\nvoid main(){\n#include <uv_vertex>\n#include <beginnormal_vertex>\n#include <defaultnormal_vertex>\n#include <normal_vertex>\n#include <begin_vertex>\n#include <project_vertex>\nvViewPosition=-mvPosition.xyz;\n#include <worldpos_vertex>\n#include <envmap_vertex>\n#include <shadowmap_vertex>\n#include <fog_vertex>\n}","#define PHONG\n#define NEON\n#define TANGENTSPACE_NORMALMAP\n#include <common>\n#include <packing>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_pars_fragment>\n#include <cube_uv_reflection_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <lights_phong_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bg_fog_pars>\n#include <conditionals>\n#include <luma>\n#include <remap>\n#include <linearstep>\nuniform vec3 diffuse;uniform vec3 emissive;uniform vec3 specular;uniform float shininess;uniform float opacity;uniform float bloomStrength;uniform float turboProgress;uniform vec3 turboColor;uniform sampler2D data;uniform sampler2D matcaps;uniform sampler2D prevFrame;uniform vec2 size;void main(){vec4 diffuseColor=vec4(diffuse,opacity);ReflectedLight reflectedLight=ReflectedLight(vec3(0.0),vec3(0.0),vec3(0.0),vec3(0.0));vec3 totalEmissiveRadiance=emissive;vec2 ruv=gl_FragCoord.xy/size;ruv.x+=vNormal.x*0.3;ruv.y+=-0.13+vNormal.y*0.3;vec2 testb=texture2D(prevFrame,ruv).rb;float test2=smoothstep(testb.r,0.,0.8)*1.9;test2+=smoothstep(testb.g,-0.4,0.7)*9.9;float test=test2*0.8;\n#include <map_fragment>\nif(diffuseColor.a<0.95)discard;float specularStrength=1.0;\n#include <normal_fragment_begin>\nvec3 mapN=texture2D(normalMap,vUv*50.).xyz*2.0-1.0;float scale=1.3;mapN*=vec3(scale,scale,1.);vec3 normalFlakes=perturbNormal2Arb(-vViewPosition,normal,mapN,faceDirection);\n#include <lights_phong_fragment>\n#include <lights_fragment_begin>\n#include <lights_fragment_maps>\n#include <lights_fragment_end>\nvec3 outgoingLight=reflectedLight.directDiffuse+reflectedLight.indirectDiffuse+reflectedLight.directSpecular+reflectedLight.indirectSpecular+totalEmissiveRadiance;\n#include <envmap_fragment>\n#include <output_fragment>\nvec2 uv=vUv;float data=texture2D(data,uv).r;float id=floor(data*8.);float id_x=mod(id,4.)/4.+0.0001;float id_y=(floor(id/4.)/2.)+0.0001;vec2 start=vec2(id_x,id_y);vec2 size=vec2(0.25,0.5);vec3 viewDir=normalize(vViewPosition);vec3 x=normalize(vec3(viewDir.z,0.0,-viewDir.x));vec3 y=cross(viewDir,x);vec2 matcapUV=vec2(dot(x,normal),dot(y,normal))*0.499+0.5;matcapUV.y=1.-matcapUV.y;matcapUV.xy=matcapUV.xy*size+start;vec3 matcapColor=texture2D(matcaps,matcapUV).rgb;vec2 matcapUVFlakes=vec2(dot(x,normalFlakes),dot(y,normalFlakes))*0.499+0.5;matcapUVFlakes.y=1.-matcapUVFlakes.y;matcapUVFlakes.xy=matcapUVFlakes.xy*size+start;vec3 matcapColorFlakes=texture2D(matcaps,matcapUVFlakes).rgb;matcapColor=mix(matcapColor,matcapColorFlakes,smoothstep(0.4,0.,luma(matcapColor))*when_eq(id,4.));float isNotTire=1.-when_eq(id,6.);float isGlass=when_eq(id,5.);float rimLightPower=5.2;float rimLightStrength=0.4*isNotTire;vec3 rimColor=vec3(1.5,1.9,2.5)*0.6;float rightLight=rimLightPower*abs(dot(vNormal,normalize(vViewPosition)));rightLight=1.-smoothstep(.0,1.,rightLight);matcapColor+=matcapColor*vec3(rightLight*rimLightStrength)*0.5;vec3 rim=mix(matcapColor,rimColor,rightLight*rimLightStrength);float glass=luma(envColor.rgb)*(0.55+isGlass*1.8);test+=glass;matcapColor=mix(rim,matcapColor,0.1+0.6*smoothstep(0.2,0.8,luma(matcapColor)));vec3 lMatcapColor=matcapColor*smoothstep(0.,0.06,(luma(reflectedLight.directDiffuse)));matcapColor=mix(lMatcapColor,matcapColor,(0.4+0.6*smoothstep(0.,0.4,luma(matcapColor)))+reflectedLight.directSpecular*3.+isGlass*test*0.6+test*0.12);matcapColor+=test*0.013*isGlass+test*0.02+glass*0.07;float turbo=step(uv.x,turboProgress);vec3 turboShape=mix(vec3(0.1,0.12,0.235)*0.6,turboColor,turbo);float isTurbo=when_eq(id,1.)*when_gt(vUv.x,0.11)*when_lt(vUv.x,0.14);matcapColor=mix(matcapColor,turboShape,isTurbo);float attenuator=smoothstep(-0.85,0.1,vNormal.y);matcapColor=mix(vec3(0.),matcapColor,attenuator);float neonIntensity=when_eq(id,1.)*0.7*bloomStrength;gl_FragColor.rgb=matcapColor;\n#include <neon_encode>\n#include <bg_fog>\n}");let $l=null;class ec extends ki{constructor(e={}){super(e),this.envMap=null,this.envMapIntensity=1;const t=this.uniforms=l(o(o({},Ui.merge([nn.common,nn.envmap,nn.normalmap,nn.fog,nn.lights])),ml.uniforms),{size:J.renderer.drawingBufferSize,prevFrame:J.previousFrame,data:{value:J.textures.carData},matcaps:{value:J.textures.matcaps},specular:{value:new $t(5592405)},turboProgress:{value:0},turboColor:{value:new $t},bloomStrength:{value:.5},shininess:{value:100},reflectivity:{value:1}});this.envMap=t.envMap.value=J.textures.envMap2,this.normalMap=t.normalMap.value=J.textures.flakes,this.normalScale=t.normalScale.value=new xe(1),this.extensions.derivatives={derivatives:!0},Kl.use(this),this.lights=!0,this.fog=!0,this.type="ShaderMaterial",this.isShaderMaterial=!0}}ec.get=e=>$l=$l||new ec(e);const tc=function(){};class ic{constructor({atlas:e,id:t,group:i,sequence:n,loop:r,autoplay:s,frame:a,onUpdate:o,onEnd:l,onEndOnce:c,frameDuration:u,category:h}){this.frames=[],this.onUpdate=o||tc,this.onEndOnce=c||tc,this.onEnd=l||tc,this.id=void 0!==t?t:i+"/"+n,this.group="",this.sequence="",this.loop=!!r,this.autoplay=!!s,this.frame=a||0,this.frameCount=0,this.frameDuration=u||48,this.frameTimer=60*Math.random(),this.currentFrameIndex=0,this.paused=!1,this.ended=!1,this.category=h||"atlas",this.atlas=e,e&&(this.setAtlas(e),this.change({id:this.id,frameDuration:this.frameDuration,autoplay:this.autoplay,loop:this.loop,frame:this.frame}))}setAtlas(e){e&&(this.sprites=e.sprites||e)}change({id:e="circle",group:t,sequence:i,frame:n,frameDuration:r,autoplay:s,loop:a}){if(this.sprites[e]){if(void 0!==e){this.id=e;const t=this.id.split("/");this.sequence=t.pop(),this.group=t.join("/")}else void 0!==i&&(void 0!==t&&(this.group=t),this.sequence=i,this.id=this.group+"/"+this.sequence);this.frames=this.sprites[this.id],this.frameCount=this.frames.length,this.currentFrameIndex=Math.min(n||0,this.frameCount-1),this.frame=this.frames[this.currentFrameIndex],this.loop=!!a,this.autoplay=!!s,this.frameDuration=r||48,this.paused=!this.autoplay,this.frameCount<2?this.end():this.ended=!1,this.onUpdate(this.frame)}}end(){this.ended=!0,this.onEndOnce(this.frame),this.onEndOnce=tc,this.onEnd(this.frame)}play(){this.paused=!1,this.isBackwards=!1,this.ended=!1}playBackwards(){this.paused=!1,this.isBackwards=!0,this.ended=!1}reset(){this.ended=!1,this.paused=!1,this.currentFrameIndex=0}resetFrame(){this.currentFrameIndex=0,this.frame=this.frames[this.currentFrameIndex]}pause(){this.paused=!0}nextFrame(){let e=this.currentFrameIndex+1;if(e>=this.frameCount){if(!this.loop)return void this.end();e=0}e!==this.currentFrameIndex&&(this.currentFrameIndex=e,this.frame=this.frames[this.currentFrameIndex],!this.loop&&e+1>=this.frameCount&&this.end())}previousFrame(){let e=this.currentFrameIndex-1;if(e<0){if(!this.loop)return void this.end();e=this.frameCount}e!==this.currentFrameIndex&&(this.currentFrameIndex=e,this.frame=this.frames[this.currentFrameIndex],!this.loop&&e-1<0&&this.end())}update(e){this.ended||this.paused||(this.frameTimer<=0&&(this.frameTimer=Math.max(0,this.frameDuration+this.frameTimer),this.isBackwards?this.previousFrame():this.nextFrame()),this.frameTimer-=e)}destroy(){this.sprites=this.frames=this.frame=this.onUpdate=null}}const nc=new Rt;let rc,sc,ac,oc,lc;class cc{constructor(e){rc||(rc=j()),this.isComponent=!0,e.batcher&&(this.batcher=e.batcher,e.atlas=this.batcher.atlas,e.batcher=null),this.dummy=nc,this.position=new De,this.scale=new xe(1,1),this.quaternion=new Ee,this.color=new $t(16777215),e.useEuler&&(this.useEuler=!0,this.rotation=new yt),this.alpha=null!=e.alpha?e.alpha:1,this.initialAlpha=this.alpha,this.visible=!0,this.parent=e.parent||null,this.billboard=!!e.billboard,this.angle=0,e.position&&this.position.copy(e.position),null!=e.color&&("number"==typeof e.color?this.color.set(e.color):this.color.copy(e.color)),e.scale&&("number"==typeof e.scale?this.scale.setScalar(e.scale):this.scale.copy(e.scale)),e.quaternion&&this.quaternion.copy(e.quaternion),this.sprite=new ic(l(o({},e),{id:e.sprite||e.id})),this.batcher&&this.batcher.addInstance(this),this.init(e),this.sprite.update(1)}init(){}update(){const e=rc.time.stableDt;this.sprite.update(e)}destroy(){this.batcher&&this.batcher.removeInstance(this),this.parentComponent&&this.parentComponent.removeComponent(this),this.sprite.destroy(),this.sprite=this.batcher=null,this.props=null}}class uc extends cc{constructor(e){sc=j(),ac=sc.game,super({sprite:"raysA",batcher:sc.particles.batcherDepth,parent:e.car.base,useEuler:!0,scale:2.5,alpha:0}),this.bright=new $t(16777215),this.dark=new $t(0),this.color.copy(this.dark),this.car=e.car.base,this.rotation.y=-Math.PI/2,this.position.set(.36,.05,0),this.opacity=0,this.targetOpacity=1,sc.game.hooks.reset.watch(this.reset,this)}reset(){this.opacity=0,this.targetOpacity=0}update(){const e=ac.turbo.hover,t=sc.turboline.getZAt(ac.progress+.2);this.targetOpacity=e?1:0;const i=c(te(Math.abs(t-this.car.position.z),.28,.1),0,1);this.targetOpacity*=i,this.opacity=W(this.opacity,this.targetOpacity,e?.08:.12),this.alpha=1-this.opacity,this.color.lerpColors(this.dark,this.bright,this.opacity),this.position.z=t-this.car.position.z,this.rotation.x+=.02}}const hc=new De,dc=new De,pc=new De,mc=new xe;new Ee;class fc extends jl{init({car:e}){oc=j(),lc=oc.game,this.car=e,this.base=null,this.addComponent(uc,{car:e}),lc.turbo.active.watch(this.onTurbo,this),lc.hooks.reset.watch(this.reset,this),this.reset()}reset(){this.hoverInfluence=0,this.turboInfluence=0}onTurbo(e){e&&(oc.car.base.getWorldPosition(hc),lc.particles.emit("flash",{amount:1,position:hc.set(-.7,.1,0),scale:mc.set(5,3),duration:1200,parent:oc.car.base,power:1,sprite:"raysA"}))}lineEmit(){const e=lc.state.hasEnded()&&oc.gameCam.activeInfluence<.68,t=lc.turbo.active.value,i=lc.turbo.hover,n=e||t?1:this.hoverInfluence;if(!e&&!i&&!t)return;if(!(oc.quality.current.value>=4||oc.time.frameNum%3))return;const r=oc.car.base;let s=(Math.random()>.5?oc.car.ltl:oc.car.rtl).getWorldPosition(pc);if(e){const e=oc.game.progress-oc.game.checkpoints.list.finish,t=.015+.3*c(te(e,10,22),0,1);return void lc.particles.emit("line",{position:pc,sprite:"particleA",scale:mc.setScalar(t),billboard:!0,opacity:.7,velDrag:.99,velocity:hc.set(0,.002,0)})}s=r.worldToLocal(hc.copy(pc));const a=.015;s.x-=.01,s.y+=_l.randomFloat(-.015,a),s.z+=_l.randomFloat(-.015,a);const o=dc.set(t?3:1,0,oc.car.zVelocity*lc.velocity*.02),l=t?mc.set(_l.randomFloat(.03,.05),.06):mc.set(_l.randomFloat(.03,.05),.05);n>1e-4&&lc.particles.emit("line",{position:s,parent:r,sprite:"particleA",scale:l,billboard:!0,opacity:n,velDrag:.99,velocity:o})}tireSmoke(){if(oc.quality.current.value<4)return;const e=oc.car.base,t=Math.random()>.5,i=t?oc.car.ltl:oc.car.rtl,n=te(Math.abs(oc.controls.turn),.3,1)*c(te(Math.abs(oc.car.base.rotation.y),.03,.08),0,1)*.5,r=c(te(lc.velocity,5,15),0,1)*c(lc.turbo.progress,.4,1)*this.hoverInfluence;let s=Math.max(n,r);(lc.turbo.active.value||t&&oc.car.dipLeft||!t&&oc.car.dipRight)&&(s=1),i.getWorldPosition(hc);const a=e.worldToLocal(hc),o=_l.randomFloat(1,6.5);a.x-=.05*o,a.y+=_l.randomFloat(-.02,.02),a.z+=_l.randomFloat(-.04,.04),a.y-=.03,a.z+=t?-.02:.02;const l=dc.set(1.5,0,4*oc.car.zVelocity);l.multiplyScalar(.005*lc.velocity);const u=lc.turbo.active.value?.1:.8;lc.particles.emit("smoke",{position:a,parent:e,sprite:"smoke",scale:mc.setScalar(_l.randomFloat(.2,1)),billboard:!0,angle:_l.randomFloat(0,Math.PI),opacity:.18*s,velDrag:.95,velocity:l.set(3,-u,0).multiplyScalar(.02)})}update(){super.update();const e=oc.time.stableDt;this.hoverInfluence=Z(this.hoverInfluence,lc.turbo.hover?1:0,.2,e,.001),this.turboInfluence=Y(this.turboInfluence,lc.turbo.active.value?1:0,.15,e),lc.turbo.active.value&&(this.hoverInfluence=1);const t=oc.scene.currentCamera;t&&t.isGameCamera&&(this.lineEmit(),this.tireSmoke())}}let gc,vc;const yc=new $t(3355443),xc=new $t(0);Ml();const _c=new De(.4,0,1.01),bc=new De(-.47,0,1.01),wc=new De;class Mc extends jl{init(){gc=j(),vc=gc.game,this.flare=this.addComponent(cc,{sprite:"particleA",parent:gc.pointer.base,position:bc,alpha:.6,color:yc,scale:2.5,batcher:vc.particles.batcher,billboard:!0}),this.reset(),vc.hooks.reset.watch(this.reset,this)}reset(){this.now=this.lastEmit=this.lastFlash=gc.game.elapsed,this.bigFlashed=!1,this.flareOpacity=this.flareOpacityTarget=0}emit(){const e=gc.car,t=W(.06,.1,c(e.dipStrength+e.userDip,0,1)),i=wc.lerpVectors(bc,_c,e.dipStrength);e.dipLeft&&(i.z=-i.z),this.lastEmit=this.now,vc.particles.emit("hitSparkles",{amount:2,position:i,parent:gc.pointer.base,sprite:"particleA",scale:t,velDrag:.99})}bigFlash(){const e=gc.car,t=wc.lerpVectors(bc,_c,e.dipStrength);e.dipLeft&&(t.z=-t.z);const i=e.userDip?2:1,n=c(te(e.dipStrength*i*vc.velocity,2,14),0,1),r=W(5,9,n),s=W(500,800,n);this.bigFlashed=!0,vc.particles.emit("flash",{amount:1,position:t,scale:r,duration:s,parent:gc.pointer.base,power:n,sprite:"particleA"})}update(){const e=gc.time.stableDt,t=gc.car,i=t.userDip?20:85;this.now=gc.game.elapsed,t.dip&&t.dipStrength>.1&&!this.bigFlashed&&this.bigFlash(),t.dip&&this.now-this.lastEmit>i&&this.emit(),t.dip||(this.bigFlashed=!1),this.flareOpacityTarget=0,t.dip&&(this.flareOpacityTarget=1-.12*Math.cos(.07*gc.game.elapsed),t.userDip||(this.flareOpacityTarget*=.4),this.flare.position.z=(t.dipRight?1:-1)*bc.z),this.flareOpacity=Y(this.flareOpacity,this.flareOpacityTarget,t.dip?.3:.1,e),this.flare.alpha=W(1,.5,this.flareOpacity),this.flare.color.lerpColors(xc,yc,this.flareOpacity),this.flare.visible=this.flareOpacity>.001}}let Sc,Tc;Ml();const Ac=2*Math.PI,Cc=new De;new De,new Ee;const Lc=new $t(16777215),Pc=new $t(3433625);U(.295,.03,.99,.555);const Ec=U(0,.59,.29,1);U(.16,.035,.29,.96);class Dc extends jl{init(){Sc=j(),Tc=Sc.game,Sc.car=Tc.car=this,this.base=Sc.meshes.car;const e=this.body=this.base.body,t=this.wheels=this.base.wheels;e.frustumCulled=t.frustumCulled=!1;e.position.x=t.position.x=-.18,e.origPosition=e.position.clone(),t.material=e.material=ec.get(),t.renderOrder=e.renderOrder=Sc.store.renderOrder.car,t.castShadow=e.castShadow=!0,t.receiveShadow=e.receiveShadow=!1,e.rotation.x=0,this.dumWheels=this.base.dummyWheels,this.initWheels(),this.addComponent(fc,{car:this}),this.hitFx=this.addComponent(Mc,{car:this});this.ltl=new Rt,this.ltl.rotation.y=-.5*Math.PI,this.ltl.rotation.z=-.5*Math.PI+.4,this.ltl.position.set(-.47,.2687,-.185),this.ltl.scale.setScalar(.2),this.rtl=new Rt,this.rtl.rotation.y=-.5*Math.PI,this.rtl.rotation.z=-.5*Math.PI-.4,this.rtl.position.set(-.47,.2687,.215),this.rtl.scale.setScalar(.2),this.body.add(this.ltl),this.body.add(this.rtl),this.dipStrength=0,this.bbw=.3*e.scale.z,this.hitline=new Yo,this.turboline=new Yo,this.baseQuaternion=this.base.quaternion.clone(),this.prevWorldPos=new De,this.velocity=new De,this.reset(),Tc.hooks.reset.watch(this.reset,this),Tc.turbo.active.watch(this.onTurbo,this),Sc.store.shadowActive.watchImmediate((i=>{t.castShadow=e.castShadow=i})),Tc.paused.watch((()=>this.resetFrictionSample()))}resetFrictionSample(){this.frictionSample&&this.frictionSample.stop(),this.frictionSample=null,this.lastFrictionDate=0}reset(){Tc.velocity=0,this.prevWorldPos.setScalar(0),this.velocity.setScalar(0),this.prevZ=0,this.zVelocity=0,this.resetFrictionSample(),this.frictionVolume=1,this.bloom=.5,this.bloomTarget=.5,this.dipShake=this.targetDipShake=0,this.dipStrength=0,this.userDip=!1,this.dip=!1,this.camHitShake=!1,this.turboInfluence=0,this.autoInfluence=0,this.accumRotation=0,this.wheelSteering=0,this.bodySteer=0,this.wheelSpin=0,this.wheelSteer=0,this.wheelSpinSpeed=0,this.controlsSteer=0,this.base.position.set(0,0,0),this.noDipTime=0,this.last,this.acceleration=.03,this.maxVel=Tc.minVelocity,this.lastTurbo=-1e5,this.update()}onTurbo(e){e||(this.lastTurbo=Sc.game.elapsed)}updateVelocity(){const e=Sc.time.stableDt,t=Sc.scene.currentCamera;if(t.forceCarVelocity)return void(Tc.velocity=t.forceCarVelocity);if(Tc.state.current<Tc.state.ACTIVE)return void(Tc.velocity=0);const i=Tc.turbo.active.value,n=!i&&!Tc.turbo.cooldownActive,r=Tc.turbo.hover;if(this.acceleration=Y(this.acceleration,i?.08:.03,.1,e),!i){const t=W(Tc.minVelocity,Tc.maxVelocity,Tc.turbo.velProgress);(!r&&n||Tc.turbo.ended||t>this.maxVel)&&(this.maxVel=Y(this.maxVel,t,.1,e))}let s=this.maxVel;if(i&&(s=Tc.turboVelocity),this.dip&&!i&&n){const e=this.dipStrength,t=c(ie(e,.01,.02,0,1),0,1);if(t){const e=.75,i=c(ie(Tc.velocity,2,Tc.maxVelocity,1,e),e,1);s=this.maxVel=W(this.maxVel,this.maxVel*i,t)}else s*=this.userDip?.92:.97}const a=Sc.time.stableDt/16.6667;Tc.velocity<s?Tc.velocity+=this.acceleration*a:Tc.velocity=Y(Tc.velocity,s,.1,e)}update(){if(Tc.isPaused())return;const e=Tc.getRoadData(),t=Tc.velocity;this.autoInfluence=W(this.autoInfluence,Tc.autopilot.value?1:0,Tc.autopilot.value?.07:.14);const i=1-this.autoInfluence;this.base.quaternion.copy(this.baseQuaternion);const n=Tc.velocity/10,r=c(t/10,0,1),s=1-Ec(c(t/4,0,1)),a=Ec(c(t/3,0,1)),o=c(t/3,0,1),l=Sc.controls.keyboard?Sc.controls.steeringMultKeyboard:Sc.controls.steeringMultTouch,u=a*(ie(t/10,0,1,0,.015)+.004*s)*l,h=.15*a*(Sc.controls.keyboard?Sc.controls.rotationMultKeyboard:Sc.controls.rotationMultTouch),d=Tc.getRelativeRoadData(.9);Tc.pointer.base.worldToLocal(Cc.copy(d.position));const p=Sc.time.stableDt,m=p/16.6667,f=Math.atan2(Cc.z,Cc.x)*m;this.accumRotation+=.16*f*n*i,this.base.rotation.y+=this.accumRotation;let g=c(-1+this.base.rotation.y,-1,0),v=c(1+this.base.rotation.y,0,1);this.dipRight&&(v=0),this.dipLeft&&(g=0);let y=Sc.controls.turn*i;y=c(y*u,g,v),this.accumRotation-=y,this.base.rotation.y-=y,this.base.position.z+=this.base.rotation.y*-h*n*m,this.base.rotation.y+=.5*y,this.wheelSteering=y;const x=.5*e.scale.y-this.bbw;this.dipStrength=c(te(Math.abs(this.accumRotation),0,.7),0,1);const _=Sc.controls.turnTarget;if(this.dipLeft=this.base.position.z<-x-0,this.dipRight=this.base.position.z>x+0,this.dip=this.dipLeft||this.dipRight,this.userDip=(this.dipLeft&&_)<0||this.dipRight&&_>0,this.dip&&this.dipStrength>.04&&!this.didImpact?(this.didImpact=!0,Sc.audio.playSound("Car_Impact",{volume:W(.4,1.15,this.dipStrength)})):this.dip||(this.didImpact=!1),this.dip?this.noDipTime=0:this.noDipTime+=p,this.dip&&!this.camHitShake&&this.dipStrength>.007&&!Tc.turbo.active.value){this.camHitShake=!0;const e=Math.min(.22*this.dipStrength*n*1*(this.userDip?1.2:.9),this.userDip?1.25:.75);Sc.gameCam.shake(400+200*e,e,!1,!0)}else this.dip||(this.camHitShake=!1);if(this.dip&&!this.frictionSample&&Sc.game.elapsed-this.lastFrictionDate>500?this.frictionSample=Sc.audio.playSound("Car_Friction_Loop"):this.noDipTime>200&&this.frictionSample&&(this.resetFrictionSample(),this.lastFrictionDate=Sc.game.elapsed),this.frictionSample&&(this.frictionSample.volume=W(this.frictionSample.volume,this.userDip?1.5:.9,.1)),Math.abs(this.base.position.z)>x&&(this.accumRotation+=-.18*this.base.rotation.y*n),this.dip){const e=this.base.position.z;this.base.position.z=c(e,-x,x)}this.autoInfluence>.01&&(this.accumRotation-=.02*this.accumRotation*n*this.autoInfluence,this.base.position.z-=.01*this.base.position.z*this.autoInfluence),Sc.store.carShadow.set(.5*this.base.position.z,this.base.rotation.y),this.base.updateMatrixWorld(),this.updateHitLine(),this.wheelSteer=W(this.wheelSteer,.26*Sc.controls.turn,Sc.controls.active?W(.05,.5,r):.9),this.bodySteer=W(this.bodySteer,Sc.controls.turn*W(.05,.06,r)*o,W(.05,.15,r)),this.body.rotation.x=c(this.bodySteer,-.07,.07),this.body.rotation.z=c(this.body.rotation.z,-.025,.04),this.wheelSpinSpeed=.015*t,this.wheelSteer=c(this.wheelSteer,-.5,.5),this.wheelSpinSpeed=c(this.wheelSpinSpeed,-.1,.1),this.wheelSpin=(this.wheelSpin+this.wheelSpinSpeed)%Ac,this.updateWheels(),this.body.position.copy(this.body.origPosition);const b=Sc.game.elapsed,w=c(te(Tc.velocity,6,15),0,1),M=.01*te(Tc.velocity,7,15),S=.0035*(.5*Math.cos(b*(.07+M))+.5)*w;if(this.body.translateY(S),this.dip||this.dipShake>.001){const e=this.dip?this.userDip?.0038:.0015:0;this.targetDipShake=e,this.dipShake=W(this.dipShake,this.targetDipShake,this.dip?.1:.25);const t=Math.cos(.09*b)*this.dipShake+this.dipShake;this.body.translateY(t)}this.zVelocity=this.base.position.z-this.prevZ,this.prevZ=this.base.position.z,this.updateMaterial(),super.update()}updateHitLine(){this.base.localToWorld(Cc.set(.4,0,-this.bbw-.04)),this.hitline.start.copy(Cc),this.base.localToWorld(Cc.set(.4,0,this.bbw- -.04)),this.hitline.end.copy(Cc),Sc.turboline.testCollision(this.hitline)}initWheels(){for(let e=0,t=this.dumWheels.length;e<t;e++){const t=this.dumWheels[e];t.steerMult=2===e?1:3===e?-1:0,t.rotation.reorder("XZY")}}updateWheels(){for(let e=0,t=this.dumWheels.length;e<t;e++){const t=this.dumWheels[e],i=t.rotation,n=this.wheelSteer*t.steerMult;i.y+=this.wheelSpin,i.z+=n,t.updateWorldMatrix(!0,!1),this.wheels.setMatrixAt(e,t.matrixWorld),i.y-=this.wheelSpin,i.z-=n}this.wheels.instanceMatrix.needsUpdate=!0}updateMaterial(){const e=Sc.time.stableDt,t=this.body.material.uniforms,i=Tc.turbo.progress;t.turboProgress.value=ie(i,0,1,.112,.136),t.turboColor.value.lerpColors(Pc,Lc,i);const n=Tc.state.hasEnded()&&Sc.gameCam.activeInfluence<.7;Sc.scene.currentCamera&&!Sc.scene.currentCamera.isGameCamera||n||Tc.turbo.hover||Tc.turbo.active.value?this.bloomTarget=1:this.bloomTarget=.4,this.bloom=Y(this.bloom,this.bloomTarget,.08,e),t.bloomStrength.value=this.bloom}}var Ic=cl("#include <common>\n#include <uv_pars_vertex>\n#include <fog_pars_vertex>\n#include <shadowmap_pars_vertex>\nvarying vec2 vUv;void main(){vUv=uv;\n#include <beginnormal_vertex>\n#include <defaultnormal_vertex>\n#include <begin_vertex>\n#include <project_vertex>\n#include <worldpos_vertex>\n#include <shadowmap_vertex>\n#include <fog_vertex>\n}","#include <common>\n#include <packing>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <shadowmap_pars_fragment>\n#include <shadowmask_pars_fragment>\nvarying vec2 vUv;uniform float scale;uniform float dirOpacity;uniform vec2 car;vec2 rotate(vec2 v,float a){float s=sin(a);float c=cos(a);mat2 m=mat2(c,-s,s,c);return m*v;}float fakeShadow(vec2 center,vec2 size,float radius){return length(max(abs(center)-size+radius,0.0))-radius;}void main(){vec2 uv=vUv;vec3 color=vec3(0.459,0.2,0.157);float shadow=1.*(1.0-getShadowMask());shadow*=0.2*min(smoothstep(0.5,0.3,abs(uv.x-0.5)),smoothstep(0.5,0.45,abs(uv.y-0.5)))*dirOpacity;float aoacc;float ao;vec2 box;vec2 pivot=vec2(0.5,0.5-car.x);vec2 obox=rotate(vUv-pivot,car.y)+0.5;box=obox-vec2(0.444,0.5);ao=fakeShadow(box,vec2(-0.155,-0.231),-0.28);aoacc+=smoothstep(0.35,0.3,ao)*0.2+smoothstep(0.44,0.22,ao)*0.8;box=obox-vec2(0.305,0.576);ao=fakeShadow(box,vec2(-0.27,-0.29)*1.034,-0.299);aoacc+=smoothstep(0.36,0.277,ao)*0.25;box=obox-vec2(0.305,0.41);ao=fakeShadow(box,vec2(-0.27,-0.29)*1.034,-0.299);aoacc+=smoothstep(0.36,0.277,ao)*0.25;shadow+=aoacc;color=vec3(1.-shadow);gl_FragColor=vec4(color,1.);\n#include <tonemapping_fragment>\n#include <encodings_fragment>\n#include <fog_fragment>\n}");let Rc,zc,Nc=null;class Oc extends ki{constructor(e={}){super(e),this.uniforms=o(o({scale:{value:0},car:{value:J.store.carShadow},dirOpacity:{value:1}},e.uniforms||{}),Ui.clone(rn.shadow.uniforms)),Ic.use(this),this.blending=4,this.opacity=.2,this.color=new $t(0),this.forceOpaque=!0,this.depthTest=!1,this.depthWrite=!1,this.lights=!0,this.isShaderMaterial=!0}}Oc.get=e=>Nc=Nc||new Oc(e);class Fc extends jl{init(){Rc=j(),zc=Rc.game,this.base=new Ri(Rc.geometries.plane,Oc.get()),this.base.renderOrder=Rc.store.renderOrder.carShadow,this.base.receiveShadow=!0,this.base.position.y+=.001,this.base.rotateX(-.5*Math.PI);const e=3*this.props.car.body.scale.x;this.base.scale.x=e}update(){const e=zc.getRoadData().scale.y;this.base.scale.y=e,this.base.material.uniforms.scale.value=e/2}}function Uc(e){e.blending=5,e.blendEquation=100,e.blendSrc=201,e.blendDst=201,e.blendEquationAlpha=103}var kc=cl("attribute float progress;attribute float side;varying float vProgress;varying float vX;void main(){vProgress=progress;vX=side;vec3 transformed=vec3(position);gl_Position=projectionMatrix*modelViewMatrix*vec4(transformed,1.0);}","varying float vProgress;varying float vX;uniform float time;uniform float globalProgress;uniform float width;uniform float opacity;uniform vec2 hitA;uniform vec2 hitB;uniform vec2 clamping;\n#include <conditionals>\nfloat between(float x,vec2 hit){return min(1.,smoothstep(hit.x+0.25,hit.x-0.25,x)+smoothstep(hit.y-0.25,hit.y+0.25,x));}void main(){float x=vX;vec2 uv=vec2(vX,mod(vProgress/width*0.15,1.));vec3 c=vec3(uv,0.);float w=0.1;float alpha=1.;alpha*=(1.-abs(uv.x-0.5)*2.);alpha*=between(vProgress,hitA)*between(vProgress,hitB);alpha*=smoothstep(clamping.x,clamping.x+3.,vProgress);alpha*=smoothstep(clamping.y,clamping.y-5.,vProgress);float fog=(globalProgress-vProgress)*0.05+2.8;alpha*=fog;alpha*=opacity;float intensity=max(0.,alpha-gl_FragCoord.w*1.);gl_FragColor=vec4(vec3(1.,1.,1.)*alpha,1.-intensity);}");let Bc=null;class Vc extends ki{constructor(e={}){super(e),this.uniforms=o({width:{value:.2},globalProgress:{value:0},opacity:{value:1},time:{value:0},hitA:{value:[0,1]},hitB:{value:[0,1]},clamping:{value:[0,1]}},e.uniforms||{}),this.side=2,Uc(this),this.color=new $t,this.transparent=1,this.forceOpaque=!0,kc.use(this),this.isShaderMaterial=!0}set width(e){this.uniforms.width.value=e}get width(){return this.uniforms.width.value}}Vc.get=e=>Bc=Bc||new Vc(e);const Gc=Ml((()=>35410));let Wc,Hc;const jc=new De,qc=new De;new Ee;class Xc extends jl{init(){Wc=j(),Hc=Wc.game,Wc.turboline=Hc.turboline=this,this.line=new Yo,this.lastProgress=-100,this.y=.04,this.segments=120,this.step=.5,this.offset=-3,this.width=.033;const e=2*this.segments,t=this.vertices=e+2;this.geo=new fi,this.buffer=new Float32Array(4*t),this.ibuffer=new Gs(this.buffer,4),this.ibuffer.setUsage(35048),this.geo.setAttribute("position",new Hs(this.ibuffer,3,0,!1)),this.geo.setAttribute("progress",new Hs(this.ibuffer,1,3,!1)),this.geo.setAttribute("side",new ri(t,1)),this.geo.setIndex(new Array(3*e)),this.pts=this.geo.attributes.position.array,this.indexes=this.geo.index.array,this.sides=this.geo.attributes.side.array,this.initGeo(),this.updateGeo(),this.geo.needsUpdate=!0,this.base=new Ri(this.geo,Vc.get()),this.base.frustumCulled=!1,this.base.renderOrder=Wc.store.renderOrder.turboLine,this.base.material.width=this.width,this.collideUniforms=[this.base.material.uniforms.hitA.value,this.base.material.uniforms.hitB.value],this.currentCollideUniform=0,this.colliding=!1,Hc.hooks.reset.watch(this.reset,this),this.reset(),Hc.turbo.active.watch(this.onTurboActive,this);let i=!1;Wc.hooks.beforePrerender.watchOnce((()=>{i=this.base.visible,this.base.visible=!0})),Wc.hooks.afterPrerender.watchOnce((()=>{this.base.visible=i}))}stopHitSample(){this.hitSample&&this.hitSample.stop(),this.hitSample=null}reset(){this.stopHitSample(),this.hitSampleVolume=0,this.turboCount=0,Hc.turbo.ended=!1;for(const t of this.collideUniforms)t[0]=0,t[1]=0;const e=Hc.checkpoints.list;this.base.material.uniforms.clamping.value[0]=e.start+20,this.base.material.uniforms.clamping.value[1]=e.finish-20,this.currentCollideUniform=0,this.colliding=!1,this.update(!0),this.resetting=!0}initGeo(){const e=this.indexes;for(let i=0,n=0;i<e.length;i+=3,n++){const t=n%2;e[i]=t?n+2:n,e[i+1]=n+1,e[i+2]=t?n:n+2}const t=this.sides;for(let i=0;i<this.vertices;i+=2)t[i]=0,t[i+1]=1}getZAt(e){const t=.4*c(te(this.turboCount,2,6),0,1);return.05*Math.cos(.1*e)+Gc(e*(.02+.01*t),1)*t}updateGeo(e){const t=Hc.progress-Hc.progress%(this.offset*this.step);if(!e&&t===this.lastProgress)return;this.lastProgress=t;const i=this.offset,n=this.step,r=this.pts;for(let s=0,a=0;s<this.pts.length;s+=8,a+=1){const e=t+(a+i)*n,o=Hc.normalizeProgress(e),l=Hc.getAbsoluteRoadData(o),c=this.width,u=this.y,h=this.getZAt(e),d=jc.set(0,u,-c+h).applyQuaternion(l.quaternion).add(l.position),p=qc.set(0,u,c+h).applyQuaternion(l.quaternion).add(l.position);r[s]=d.x,r[s+1]=d.y,r[s+2]=d.z,r[s+3]=e,r[s+4]=p.x,r[s+5]=p.y,r[s+6]=p.z,r[s+7]=e}this.geo.attributes.position.needsUpdate=!0}update(e){this.resetting?(this.turboCount=0,this.resetting=!1,this.updateGeo(!0)):this.updateGeo();const t=Wc.scene.currentCamera&&Wc.scene.currentCamera.turbolineActive;this.base.visible=!!t,Hc.turbo.hover!==this.hit&&(this.hit=Hc.turbo.hover,this.hit?this.startCollision():this.endCollision());const i=this.base.material.uniforms;if(i.globalProgress.value=Wc.game.progress,i.time.value=Wc.game.elapsed,this.hit){const e=this.collideUniforms[this.currentCollideUniform],t=Wc.game.progress+.5,i=t-e[1];Wc.game.turbo.addHitDistance(i),e[1]=t}if(!this.hit&&this.hitSample&&this.hitSample.volume<1e-4&&this.stopHitSample(),this.hit&&!this.hitSample&&(this.hitSample=Wc.audio.playSound("Boost_Line_Loop",{volume:.05})),this.hitSample){const e=this.hit&&!Wc.game.paused.value;this.hitSampleVolume=e?1.2:0,this.hitSample.volume=W(this.hitSample.volume,this.hitSampleVolume,e?.12:.07)}const n=Hc.turbo.active.value||Hc.turbo.ended;i.opacity.value=W(i.opacity.value,n?0:1,e?1:.1)}startCollision(){const e=this.collideUniforms[this.currentCollideUniform],t=Wc.game.progress+.5;e[0]=t,e[1]=t}endCollision(){this.currentCollideUniform=(this.currentCollideUniform+1)%this.collideUniforms.length}onTurboActive(e){if(e)return;this.turboCount++;const t=Hc.progress,i=this.base.material.uniforms.clamping.value;i[0]=t+Hc.turbo.cooldown,Math.abs(i[0]-i[1])<Hc.turbo.distanceToFill&&(Hc.turbo.ended=!0),this.updateGeo(!0)}testCollision(e){const t=Hc.progress,i=t-.1,n=t+.8,r=this.getZAt(i),s=this.getZAt(n),a=this.base.material.uniforms.clamping.value;if(!this.base.visible||Hc.turbo.active.value||t<a[0]-1||t>a[1]+1||Hc.turbo.ended)return Hc.turbo.hover=!1;const o=Hc.getAbsoluteRoadData(Hc.normalizeProgress(i));this.line.start.set(0,0,r).applyQuaternion(o.quaternion).add(o.position);const l=Hc.getAbsoluteRoadData(Hc.normalizeProgress(n));this.line.end.set(0,0,s).applyQuaternion(l.quaternion).add(l.position);const c=e,u=this.line;return Hc.turbo.hover=function(e,t,i,n,r,s,a,o){let l,c;const u=(i-e)*(o-s)-(a-r)*(n-t);return 0!==u&&(c=((o-s)*(a-e)+(r-a)*(o-t))/u,l=((t-n)*(a-e)+(i-e)*(o-t))/u,0<c&&c<1&&0<l&&l<1)}(c.start.x,c.start.z,c.end.x,c.end.z,u.start.x,u.start.z,u.end.x,u.end.z)}}var Yc=cl("attribute float dist;attribute float side;varying float vSide;varying float vDist;void main(){vSide=side;vDist=dist;vec3 transformed=vec3(position);gl_Position=projectionMatrix*modelViewMatrix*vec4(transformed,1.0);}","varying float vDist;varying float vSide;uniform float progress;uniform float time;uniform float maxDist;uniform sampler2D noise;uniform float trailLength;void main(){vec3 noiseTexel=texture2D(noise,vec2(vSide*0.2,vDist*0.1+progress*-0.04)).rgb;float len=trailLength;float len2=min(len*1.5,len+0.25);float m=smoothstep(0.4,0.1,noiseTexel.b)*0.5*smoothstep(len2,len2-0.4,vDist);float fallin=smoothstep(0.05,0.1,vDist);float falloff=smoothstep(trailLength+m,trailLength-0.4,vDist);float falloff2=smoothstep(maxDist+0.6,0.,vDist);float size=1.*falloff2;size+=-0.3+cos(time*-0.03+vDist*20.*vDist)*0.07;float offset=(1.-size)*0.5;float side=clamp((vSide-offset)/size,0.,1.);float p=progress*10.;float lim=abs(side-0.5)*2.;float border=pow(lim,3.)*0.5;float lim2=(1.-step(1.,side))*(1.-step(side,0.));float matter=smoothstep(0.4,0.0,noiseTexel.r)*0.5;float matter2=smoothstep(0.9,0.5,noiseTexel.g)*smoothstep(0.4,0.0,vDist);float intensity=max(0.,border+matter*1.+matter2*0.8)*lim2*falloff*fallin;vec3 diffuse=vec3(0.4,0.8,1.1)*intensity*5.;float glow=1.-intensity*0.2;gl_FragColor=vec4(diffuse,glow);}");let Zc,Jc,Qc=null;class Kc extends ki{constructor(e={}){super(e),this.uniforms={time:{value:0},progress:{value:0},maxDist:{value:0},trailLength:{value:0},noise:{value:J.textures.blueNoise}},this.side=2,Uc(this),this.color=new $t,this.transparent=1,this.forceOpaque=!0,Yc.use(this),this.isShaderMaterial=!0}}Kc.get=e=>Qc=Qc||new Kc(e);const $c=new De,eu=new De,tu=e=>Array.from(new Array(e)).map((()=>({qt:new Ee,pos:new De})));class iu extends jl{init(){Zc=j(),Jc=Zc.game,this.turboInfluence=this.hoverInfluence=0,this.car=this.props.car,this.geo=new fi,this.iterations=0,this.segments=8;const e=2*this.segments*2,t=this.vertices=e+4;this.ptsIndex=0,this.leftPts=tu(t/4),this.rightPts=tu(this.leftPts.length);const i=this.bufferDims=4;this.buffer=new Float32Array(t*i),this.ibuffer=new Gs(this.buffer,i),this.geo.setAttribute("position",new Hs(this.ibuffer,3,0,!1)),this.geo.setAttribute("dist",new Hs(this.ibuffer,1,3,!1)),this.ibuffer.setUsage(35048),this.geo.setAttribute("side",new ri(t,1)),this.geo.setIndex(new Array(3*e)),this.indexes=this.geo.index.array,this.sides=this.geo.attributes.side.array,this.initGeo(false),this.initGeo(true),this.mat=Kc.get(),this.base=new Ri(this.geo,this.mat),this.base.renderOrder=Zc.store.renderOrder.carTrails,this.base.frustumCulled=!1,this.maxDist=0,Zc.game.hooks.reset.watch(this.reset,this),this.reset();let n=!1;Zc.hooks.beforePrerender.watchOnce((()=>{n=this.base.visible,this.base.visible=!0})),Zc.hooks.afterPrerender.watchOnce((()=>{this.base.visible=n}))}reset(e){this.car.ltl.updateWorldMatrix(!0,!0),this.car.rtl.updateWorldMatrix(!0,!0);for(let t=0;t<this.leftPts.length;t++)this.appendPts(),this.updateGeo(false),this.updateGeo(true);this.reseting=!e}initGeo(e){const t=this.indexes,i=t.length/2,n=e?i:0,r=e?this.vertices/2:0;for(let a=n,o=r;a<i+n;a+=3,o++){const e=o%2;t[a]=e?o+2:o,t[a+1]=o+1,t[a+2]=e?o:o+2}const s=this.sides;for(let a=r;a<this.vertices/2+r;a+=2)s[a]=0,s[a+1]=1}updateLastPts(){const e=0===this.ptsIndex?this.leftPts.length-1:this.ptsIndex-1,t=this.leftPts[e],i=this.rightPts[e];this.car.ltl.getWorldPosition(t.pos),this.car.ltl.getWorldQuaternion(t.qt),this.car.rtl.getWorldPosition(i.pos),this.car.rtl.getWorldQuaternion(i.qt)}appendPts(){let e=.014+.021*Jc.turbo.progress;e=W(e,.12,this.turboInfluence);Jc.state.hasEnded()&&Zc.gameCam.activeInfluence<.75&&(e=Math.max(e,.028));const t=this.leftPts[this.ptsIndex],i=this.rightPts[this.ptsIndex];this.car.ltl.getWorldPosition(t.pos),this.car.ltl.getWorldQuaternion(t.qt),this.car.rtl.getWorldPosition(i.pos),this.car.rtl.getWorldQuaternion(i.qt),t.width=i.width=e,this.ptsIndex=(this.ptsIndex+1)%this.leftPts.length}updateGeo(e){const t=e?this.rightPts:this.leftPts,i=e?this.buffer.length/2:0,n=this.buffer,r=t.length,s=r-1,a=!e;let o=0;for(let l=s;l>=0;l--){const e=(this.ptsIndex+l)%r,c=t[e];if(a)if(l<s){o+=t[(this.ptsIndex+l+1)%r].pos.distanceTo(c.pos),c.dist=o}else c.dist=0;else c.dist=this.leftPts[e].dist;let u=i+2*l*this.bufferDims;const h=$c.set(-c.width,0,0).applyQuaternion(c.qt).add(c.pos),d=eu.set(c.width,0,0).applyQuaternion(c.qt).add(c.pos);n[u++]=h.x,n[u++]=h.y,n[u++]=h.z,n[u++]=c.dist,n[u++]=d.x,n[u++]=d.y,n[u++]=d.z,n[u++]=c.dist}a&&(this.maxDist=o),this.geo.attributes.position.needsUpdate=!0}update(){this.reseting&&this.reset(!0);const e=Zc.scene.currentCamera;if(!e||!e.isGameCamera)return this.base.visible=!1,void(this.visible=!1);this.base.visible=!0,this.visible=!0,this.appendPts(),this.updateGeo(false),this.updateGeo(true);const t=Zc.time.stableDt,i=this.mat.uniforms;i.time.value=Jc.elapsed,i.progress.value=Jc.progress,i.maxDist.value=this.maxDist;const n=Jc.turbo.hover,r=Jc.turbo.active.value,s=Jc.state.hasEnded()&&Zc.gameCam.activeInfluence<.5;i.trailLength.value=s?Y(i.trailLength.value,3.5,.019,t):Y(i.trailLength.value,r?1:n?.35+.1*Jc.turbo.progress:0,r?.3:n?.1:.02,t)}}let nu;class ru extends jl{init(){nu=j(),nu.road=this,this.base=new Rt,nu.getRoadDataAt=oe("getRoadDataAt",this,2),this.curve=nu.curves.road,this.road=this.add(nu.meshes.road),this.road.material=Jl.get(),this.road.renderOrder=nu.store.renderOrder.road,this.road.castShadow=!1,this.road.receiveShadow=!1,this.pointer=this.addComponent(Ql),nu.pointer=nu.game.pointer=this.pointer,this.line=this.addComponent(Xc),this.car=this.addComponent(Dc,{mountTo:this.pointer}),this.carShadow=this.addComponent(Fc,{mountTo:this.pointer,car:this.car}),this.carTrails=this.addComponent(iu,{car:this.car}),this.alphaInfluence=1}update(){super.update();this.road.material.uniforms.speedInfluence.value=c(te(nu.game.velocity,7.3,14),0,1)*nu.scene.gameCam.activeInfluence}}const su=new De,au=new De;class ou extends jl{constructor(e){super(e),this.base=null}init(e){this.dirLightPos=new De(1.3,2,1).multiplyScalar(2),this.shadowSize=.85;const t=this.ambLight=new Io(13167353,.8),i=this.dirLight=new Do(15852283,1);i.position.copy(this.dirLightPos),i.castShadow=!0,i.shadow.camera.near=.4,i.shadow.camera.far=10,i.shadow.camera.fov=50,i.shadow.camera.top=this.shadowSize,i.shadow.camera.bottom=-this.shadowSize,i.shadow.camera.left=this.shadowSize,i.shadow.camera.right=-this.shadowSize,this.setShadowSize(128),e.scene.add(t),e.scene.add(i)}setShadowSize(e=128){this.dirLight.shadow.mapSize.width!==e&&(this.dirLight.shadow.mapSize.width=e,this.dirLight.shadow.mapSize.height=e,this.dirLight.shadow.map&&(this.dirLight.shadow.map.dispose(),this.dirLight.shadow.map=null))}toggleShadow(e){const t=J.threeRenderer;J.store.shadowActive.set(e),t.shadowMapAutoUpdate=e;const i=t.getRenderTarget();t.setRenderTarget(this.dirLight.shadow.map),t.clear(),t.setRenderTarget(i)}update(){const e=this.props.scene.road.car.base,t=this.props.scene.road.carShadow.base;this.dirLight.target=e,this.dirLight.position.copy(e.getWorldPosition(su)).add(this.dirLightPos),t.worldToLocal(au.copy(this.dirLight.position));const i=c(te(au.z,.04,.6),0,1);t.material.uniforms.dirOpacity.value=i}}var lu=cl("#define PHONG\nvarying vec3 vViewPosition;varying float vY;\n#include <common>\n#include <uv_pars_vertex>\n#include <envmap_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <shadowmap_pars_vertex>\nvoid main(){\n#include <uv_vertex>\n#include <beginnormal_vertex>\n#include <defaultnormal_vertex>\n#include <normal_vertex>\n#include <begin_vertex>\n#include <project_vertex>\nvViewPosition=-mvPosition.xyz;\n#include <worldpos_vertex>\nvY=worldPosition.y;\n#include <envmap_vertex>\n#include <shadowmap_vertex>\n#include <fog_vertex>\n}","#define PHONG\n#define NEON\n#define STRUCTURE\n#include <common>\n#include <packing>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <cube_uv_reflection_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_phong_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <bg_fog_pars>\n#include <conditionals>\n#include <luma>\nuniform vec3 diffuse;uniform vec3 emissive;uniform vec3 specular;uniform float shininess;uniform float opacity;uniform sampler2D data;uniform sampler2D matcaps;void main(){vec3 texelData=texture2D(data,vUv).rgb;vec4 diffuseColor=vec4(diffuse,opacity);ReflectedLight reflectedLight=ReflectedLight(vec3(0.0),vec3(0.0),vec3(0.0),vec3(0.0));vec3 totalEmissiveRadiance=emissive;\n#include <map_fragment>\nfloat specularStrength=texelData.b;\n#include <normal_fragment_begin>\n#include <lights_phong_fragment>\n#include <lights_fragment_begin>\n#include <lights_fragment_maps>\n#include <lights_fragment_end>\nvec3 outgoingLight=reflectedLight.directDiffuse+reflectedLight.indirectDiffuse+reflectedLight.directSpecular+reflectedLight.indirectSpecular+totalEmissiveRadiance;\n#include <output_fragment>\nvec2 uv=vUv;float id=floor(texelData.g*8.);float id_x=mod(id,4.)/4.+0.0001;float id_y=(floor(id/4.)/2.)+0.0001;vec2 start=vec2(id_x,id_y);vec2 size=vec2(0.25,0.5);float hasMatcap=min(id,1.);vec3 viewDir=normalize(vViewPosition);vec3 x=normalize(vec3(viewDir.z,0.0,-viewDir.x));vec3 y=cross(viewDir,x);vec2 matcapUV=vec2(dot(x,normal),dot(y,normal))*0.499+0.5;matcapUV.y=1.-matcapUV.y;matcapUV.xy=matcapUV.xy*size+start;vec3 matcapColor=texture2D(matcaps,matcapUV).rgb;vec3 lMatcapColor=matcapColor*smoothstep(0.,0.06,(luma(reflectedLight.directDiffuse)));matcapColor=mix(lMatcapColor,matcapColor,0.4+0.6*smoothstep(0.,0.4,luma(matcapColor)))+reflectedLight.directSpecular;gl_FragColor.rgb=mix(gl_FragColor.rgb,matcapColor,hasMatcap);float neonIntensity=texelData.r;\n#include <neon_encode>\n#include <bg_fog>\n}");let cu=null;class uu extends ki{constructor(e={}){super(e);const t=this.uniforms=l(o(o({},Ui.merge([nn.common,nn.specularmap,nn.fog,nn.lights])),ml.uniforms),{data:{value:J.textures.structureData},matcaps:{value:J.textures.matcaps},specular:{value:new $t(16720418)},shininess:{value:10}});this.map=t.map.value=J.textures.structureDiffuse,lu.use(this),this.lights=!0,this.fog=!0,this.type="ShaderMaterial",this.isShaderMaterial=!0}}uu.get=e=>cu=cu||new uu(e);class hu extends jl{init(){this.base=J.meshes.structure,this.base.material=uu.get(),this.base.castShadow=!1,this.base.receiveShadow=!1,this.base.renderOrder=J.store.renderOrder.structure,this.base.frustumCulled=!1;let e=!1;J.hooks.beforePrerender.watchOnce((()=>{e=this.base.visible,this.base.visible=!0})),J.hooks.afterPrerender.watchOnce((()=>{this.base.visible=e}))}}var du=cl("precision highp float;attribute vec3 instancePos;attribute float aOffset;uniform float uTime;uniform float uHalfBoxSize;uniform vec3 uBoxPosition;uniform float uGameVelocity;varying float vFade;varying vec2 vUv;const float DURATION=100.;void main(){vec3 pos=position;float boxSize=uHalfBoxSize*2.;vec3 translation=uBoxPosition-mod(instancePos+uBoxPosition,boxSize)+uHalfBoxSize;float loop=mod((uTime*.0005)+aOffset*DURATION,DURATION)/DURATION;translation.z+=cos(uTime*(0.0004+instancePos.z*0.0005)+instancePos.y*2.2)*(0.02+instancePos.x*0.02);translation.y+=sin(4.+uTime*(0.0003+instancePos.x*0.00005)+instancePos.z*2.2)*(0.02+instancePos.y*0.02);translation.y+=-2.5+(1.-loop)*(10.+translation.y)*(1.+abs((uTime*.0001+aOffset))*.01);vec4 mvPosition=modelViewMatrix*vec4(translation,1.0);mvPosition.xyz+=pos.xyz;float fade=1.;fade*=.3-smoothstep(.05,.75,(.05*distance(uBoxPosition,translation)));fade*=smoothstep(1.,.75,loop)*smoothstep(.0,.25,loop);fade*=1.-smoothstep(6.,14.,uGameVelocity);vFade=fade;vUv=uv;gl_Position=projectionMatrix*mvPosition;}","precision highp float;uniform float uActiveInfluence;uniform float uGameVelocity;uniform vec3 uBoxPosition;uniform vec3 uColor;uniform vec2 uResolution;uniform float uPixelRatio;varying float vFade;varying vec2 vUv;void main(){vec2 uv=vUv;vec2 res=gl_FragCoord.xy/uResolution.xy;res/=uPixelRatio;float strength=(.5+(uGameVelocity*.01))/(distance(uv,vec2(.5)));vec3 color=uColor;color*=strength;color*=smoothstep(1.,10.,color);float center=.1/distance(res,vec2(.5,.45));color*=vFade*0.4;color*=uActiveInfluence;float alpha=mix(1.,.85,vFade);gl_FragColor=vec4(color,alpha);}");let pu;class mu extends ki{constructor(e={}){super(e),Uc(this),this.uniforms={uBoxPosition:{value:new De},uHalfBoxSize:{value:5},uGameVelocity:{value:0},uTime:{value:0},uColor:{value:new $t(16777215)},uActiveInfluence:{value:J.scene.gameCam.activeInfluence},uResolution:{value:new xe(window.innerWidth,window.innerHeight)},uPixelRatio:{value:window.devicePixelRatio}},this.depthTest=!0,this.depthWrite=!1,du.use(this)}}mu.get=e=>pu=pu||new mu(e);const fu=new en;let gu,vu,yu,xu,_u,bu,wu;class Mu extends jl{init(){gu=j(),vu=gu.game,this.material=mu.get(),this.initGeometry(2500),this.base=new Ri(this.geo,this.material),this.base.renderOrder=gu.store.renderOrder.cloudParticles,this.base.frustumCulled=!1,this.position=new De;let e=!1;gu.hooks.beforePrerender.watchOnce((()=>{e=this.base.visible,this.base.visible=!0})),gu.hooks.afterPrerender.watchOnce((()=>{this.base.visible=e}))}initGeometry(e){if(e===this.count)return;this.count=e,this.geo&&this.geo.dispose(),this.geo=new zo,this.geo.index=fu.index,this.geo.attributes.position=fu.attributes.position,this.geo.attributes.uv=fu.attributes.uv,this.geo.scale(.03,.03,.03),this.stride=4,this.buffer=new Float32Array(this.count*this.stride);const t=this.interleavedBuffer=new jo(this.buffer,this.stride);this.geo.setAttribute("instancePos",new Hs(t,3,0,!1)),this.geo.setAttribute("aOffset",new Hs(t,1,3,!1));const i=this.buffer;for(let n=0;n<this.count;n++)i[n+0]=_l.randomFloat(-4.8,4.8),i[n+1]=_l.randomFloat(-4.8,4.8),i[n+2]=_l.randomFloat(-4.8,4.8),i[n+3]=_l.randomFloat(-4.8,4.8);this.interleavedBuffer.needsUpdate=!0,this.material.uniforms.uHalfBoxSize.value=4.8,this.base&&(this.base.geometry=this.geo,this.base.needsUpdate=!0)}update(){this.material.uniforms.uGameVelocity.value=vu.velocity,this.material.uniforms.uTime.value=gu.game.elapsed,this.material.uniforms.uActiveInfluence.value=gu.scene.gameCam.activeInfluence;const e=this.material.uniforms.uBoxPosition.value;let t=gu.scene.currentCamera;this.base.visible=!!t.cloudParticlesActive,this.base.visible&&e.copy(t.base.position)}}class Su extends fl{constructor(e){super(e),yu=Of(),xu=yu.game,this.emitterOptions={amount:1,depthTest:!0}}update(){const e=yu.scene.currentCamera;!e||!e.isGameCamera||e.activeInfluence<.002||xu.velocity<xu.minVelocity||xu.particles.emit("dashline",this.emitterOptions)}}const Tu=new xe,Au=new De,Cu=new De;new Ee;class Lu extends yl{init(){wu=X,_u=j(),bu=_u.game,_u.scene=this,_u.particles.init(this),this.road=this.addComponent(ru),_u.gameCam=bu.gameCam=this.gameCam=this.addComponent(Ol),this.idleCam=this.addComponent(Hl),this.useCamera(this.gameCam),this.lightning=this.addComponent(ou,{scene:this}),this.structures=this.addComponent(hu),this.cloudParticles=this.addComponent(Mu),this.dashLines=this.addComponent(Su);let e=null;_u.hooks.beforePrerender.watchOnce((()=>{e=this.currentCamera,this.useCamera(this.gameCam)})),_u.hooks.afterPrerender.watchOnce((()=>{this.useCamera(e)})),this.initFog()}initFog(){this.clearColor=re(m("#8b0300"),"scene_clear_color"),this.fog=this.base.fog=new Bs,this.clearColor.watchImmediate((e=>_u.threeRenderer.setClearColor(e))),this.clearColor.watchImmediate((e=>this.fog.color.set(e)))}setFar(e){this.gameCam.cam.far=e,this.gameCam.cam.updateProjectionMatrix(),this.idleCam.cam.far=e,this.idleCam.cam.updateProjectionMatrix(),this.fog.near=Math.max(0,e-160),this.fog.far=e}setNear(e){this.gameCam.cam.near=e,this.gameCam.cam.updateProjectionMatrix(),this.idleCam.cam.near=e,this.idleCam.cam.updateProjectionMatrix()}emitFirework(){const e=bu.normalizeProgress(bu.checkpoints.list.finish+30),t=bu.getAbsoluteRoadData(e),i=_u.viewport.size.value,n=i.x/i.y,r=c(te(n,.5,1.5),0,1),s=W(_l.randomFloat(-50,40),_l.randomFloat(-120,40),r),a=Au.set(s,_l.randomFloat(-19,45),_l.randomFloat(0,2)).applyQuaternion(t.quaternion.fromArray([-.10036272,.24738172,.02577216,.96336151])).add(Cu.fromArray([356.666661,12.856385,67.333084]));_u.particles.emit("fireworksFlash",{amount:1,position:a,scale:Tu.set(100,100),duration:900,power:.9,powerMult:.92,glowMult:1,depthTest:!0,rotation:_l.randomFloat(0,2*Math.PI),gravityY:.2,sprite:"smoke"}),_u.particles.emit("fireworksFlash",{amount:1,position:a,scale:Tu.set(500,500),duration:250,power:.001,depthTest:!0,powerMult:.02,glowMult:.07,sprite:"particleA"}),_u.particles.emit("fireworksFlash",{amount:1,position:a,scale:Tu.set(220,220),duration:200,power:.55,depthTest:!0,powerMult:.9,glowMult:.01,sprite:"particleA"}),_u.particles.emit("fireworksBurst",{amount:_l.randomInt(8,15),position:a,scale:Tu.set(35,9),duration:800,opacity:.3,depthTest:!0,sprite:"raysA"}),_u.particles.emit("fireworksBurstFall",{amount:_l.randomInt(4,6),position:a,scale:Tu.set(6,4),duration:1100,opacity:.9,depthTest:!0,velocity:.6,sprite:"particleA"})}update(){let e="game"!==wu.$route.name&&"webgl"!==wu.$route.name,t=!e&&!this.idleCam.enabled.value;(e||this.idleCam.enabled.value)&&this.currentCamera!==this.idleCam?this.useCamera(this.idleCam):t&&this.currentCamera!==this.gameCam&&this.useCamera(this.gameCam),super.update(),_u.particles.update()}}const Pu={"./bg.glsl":Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:"vec2 bgUV=bgRot(gl_FragCoord.xy/res.xy,bgCamRotation.y);float bgProgress=smoothstep(1.,0.,bgUV.y*2.+bgCamRotation.x*1.-0.9);vec3 bgColor=mix(bgTopColor,bgBottomColor,bgProgress);"}),"./bg_fog.glsl":Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:"float _fogNear=fogNear;\n#ifdef NEON\n_fogNear+=(fogFar-fogNear)*0.6*neonIntensity;\n#endif\nfloat fogFactor=smoothstep(_fogNear,fogFar,vFogDepth);\n#ifdef STRUCTURE\nfogFactor=max(fogFactor,smoothstep(3.,-21.,vY));\n#endif\n#include <bg>\n#ifdef NEON\ngl_FragColor.a=mix(gl_FragColor.a,1.,fogFactor);\n#endif\ngl_FragColor.rgb=mix(gl_FragColor.rgb,bgColor,fogFactor);"}),"./bg_fog_pars.glsl":Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:"uniform float fogNear;uniform float fogFar;varying float vFogDepth;\n#ifdef STRUCTURE\nvarying float vY;\n#endif\n#include <bg_pars>"}),"./bg_pars.glsl":Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:"uniform vec2 res;uniform vec2 bgCamRotation;const vec3 bgTopColor=vec3(0.325,0.6,0.851)*0.8;const vec3 bgBottomColor=vec3(0.855,0.925,0.988)*1.;vec2 bgRot(vec2 v,float a){float s=sin(a);float c=cos(a);mat2 m=mat2(c,-s,s,c);return(m*v-0.5)+0.5;}"}),"./blend_add.glsl":Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:"float blendScreen(float base,float blend){return 1.0-((1.0-base)*(1.0-blend));}vec3 blendAdd(vec3 base,vec3 blend){return vec3(blendScreen(base.r,blend.r),blendScreen(base.g,blend.g),blendScreen(base.b,blend.b));}"}),"./conditionals.glsl":Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:"float when_gt(float x,float y){return max(sign(x-y),0.0);}float when_lt(float x,float y){return max(sign(y-x),0.0);}float when_ge(float x,float y){return 1.0-when_lt(x,y);}float when_eq(float x,float y){return 1.0-abs(sign(x-y));}"}),"./equals.glsl":Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:"float equals(float x,float y){return 1.0-abs(sign(x-y));}"}),"./get_instance_matrix.glsl":Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:"mat4 getInstanceMatrix(vec3 p,vec4 q,vec3 s){mat4 m;float x=q.x;float y=q.y;float z=q.z;float w=q.w;float x2=x+x;float y2=y+y;float z2=z+z;float xx=x*x2;float xy=x*y2;float xz=x*z2;float yy=y*y2;float yz=y*z2;float zz=z*z2;float wx=w*x2;float wy=w*y2;float wz=w*z2;float sx=s.x;float sy=s.y;float sz=s.z;m[0][0]=(1.-(yy+zz))*sx;m[0][1]=(xy+wz)*sx;m[0][2]=(xz-wy)*sx;m[0][3]=0.;m[1][0]=(xy-wz)*sy;m[1][1]=(1.-(xx+zz))*sy;m[1][2]=(yz+wx)*sy;m[1][3]=0.;m[2][0]=(xz+wy)*sz;m[2][1]=(yz-wx)*sz;m[2][2]=(1.-(xx+yy))*sz;m[2][3]=0.;m[3][0]=p.x;m[3][1]=p.y;m[3][2]=p.z;m[3][3]=1.;return m;}"}),"./linearstep.glsl":Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:"float linearstep(float start,float end,float value){return(clamp(value,start,end)-start)/(end-start);}"}),"./luma.glsl":Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:"float luma(vec3 color){return dot(color,vec3(0.299,0.587,0.114));}"}),"./neon_encode.glsl":Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:"gl_FragColor.a=1.-neonIntensity;"}),"./neon_pars.glsl":Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:"const float neonx=1.0/255.0;vec4 decodeNeon(float v){vec4 enc=vec2(1.0,255.0)*v;enc=fract(enc);enc-=enc.yzww*vec2(neonx,neonx,neonx,0.0);return enc;}float encodeNeon(vec2 rg){return dot(rg,vec2(1.0,neonx));}"}),"./remap.glsl":Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:"float remap(float value,float min1,float max1,float min2,float max2){return min2+(value-min1)*(max2-min2)/(max1-min1);}"})};const Eu={default:!0,webp:!1,avif:!1};async function Du(e){const t="image/"+e,i=document.createElement("picture"),n=document.createElement("img"),r=document.createElement("source");r.srcset="data:,x",r.type=t,i.appendChild(r),i.appendChild(n),await 0;const s=!!n.currentSrc;return Eu[e]=s,s}var Iu={test:async function(){await Promise.all([Du("webp"),Du("avif")])},select:function(e,t,i){return"object"==typeof e&&(i=e.avif,t=e.webp,e=e.default),Eu.avif&&i?i:Eu.webp&&t?t:e},supports:Eu};const Ru=function(){let e={};return{get:function(t,i=!0){if(e[t])return e[t];if(!i)return;for(const n in e)if(n.match(t))return e[n]},add:function(t,i){e[t]=i},clear:function(){e={}},list:function(){return e}}}();const zu={},Nu={};var Ou={get:function(e,t){return Ru.get(e,t)},list:function(){return Ru.list()},load:function(e,t={}){if(Ru.get(e))return Promise.resolve();if(Nu[e])return Nu[e];let i;return e.startsWith("http")||e.startsWith("/")||(e="/"+e),i=t.loader&&zu[t.loader]?zu[t.loader].function(e,t):function(e,t){for(const i in zu){const n=zu[i];if(n.extensions){const i=n.extensions;for(let r=0;r<i.length;r++){const s=i[r];if(e.endsWith(s))return n.function(e,t)}}else if(n.test&&n.test(e,t))return n.function(e,t)}return function(e,t={}){return new Promise(((i,n)=>{const r=new XMLHttpRequest;r.responseType=t.responseType||"arraybuffer",r.onreadystatechange=()=>{4===r.readyState&&(4===r.readyState&&200===r.status?(t.noCache||Ru.add(e,r.response),t.onLoad&&t.onLoad(r.response),i(r.response,r.status)):n(r.status))},r.open("GET",e,!0),r.send()}))}(e,t)}(e,t),i&&(Nu[e]=i),i},registerLoader:function(e){e.loader&&(e=e.loader),zu[e.name]=e}};function Fu(e,t){return new Promise((i=>{const n=new Image;n.onload=()=>{const r={node:n,url:e};t.onLoad&&t.onLoad(r),Ru.add(e,r),i(r)},n.decoding="async",n.setAttribute("decoding","async"),n.src=e}))}Fu.loader={name:"image",extensions:[".jpg",".png",".webp",".avif",".gif",".jpeg"],function:Fu};function Uu(){let e={};return{get:function(t){return e[t]},add:function(t,i){e[t]=i},remove:function(t){delete e[t]},removeAll:function(){e={}}}}const ku={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:"KHR_materials_pbrSpecularGlossiness",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression"};class Bu{constructor(e){this.parser=e,this.name=ku.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){const e=this.parser,t=this.parser.json.nodes||[];for(let i=0,n=t.length;i<n;i++){const n=t[i];n.extensions&&n.extensions[this.name]&&void 0!==n.extensions[this.name].light&&e._addNodeRef(this.cache,n.extensions[this.name].light)}}_loadLight(e){const t=this.parser,i="light:"+e;let n=t.cache.get(i);if(n)return n;const r=t.json,s=((r.extensions&&r.extensions[this.name]||{}).lights||[])[e];let a;const o=new $t(16777215);void 0!==s.color&&o.fromArray(s.color);const l=void 0!==s.range?s.range:0;switch(s.type){case"directional":a=new Do(o),a.target.position.set(0,0,-1),a.add(a.target);break;case"point":a=new Po(o),a.distance=l;break;case"spot":a=new So(o),a.distance=l,s.spot=s.spot||{},s.spot.innerConeAngle=void 0!==s.spot.innerConeAngle?s.spot.innerConeAngle:0,s.spot.outerConeAngle=void 0!==s.spot.outerConeAngle?s.spot.outerConeAngle:Math.PI/4,a.angle=s.spot.outerConeAngle,a.penumbra=1-s.spot.innerConeAngle/s.spot.outerConeAngle,a.target.position.set(0,0,-1),a.add(a.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+s.type)}return a.position.set(0,0,0),a.decay=2,void 0!==s.intensity&&(a.intensity=s.intensity),a.name=t.createUniqueName(s.name||"light_"+e),n=Promise.resolve(a),t.cache.add(i,n),n}createNodeAttachment(e){const t=this,i=this.parser,n=i.json.nodes[e],r=(n.extensions&&n.extensions[this.name]||{}).light;return void 0===r?null:this._loadLight(r).then((function(e){return i._getNodeRef(t.cache,r,e)}))}}class Vu{constructor(){this.name=ku.KHR_MATERIALS_UNLIT}getMaterialType(){return ei}extendParams(e,t,i){const n=[];e.color=new $t(1,1,1),e.opacity=1;const r=t.pbrMetallicRoughness;if(r){if(Array.isArray(r.baseColorFactor)){const t=r.baseColorFactor;e.color.fromArray(t),e.opacity=t[3]}void 0!==r.baseColorTexture&&n.push(i.assignTexture(e,"map",r.baseColorTexture))}return Promise.all(n)}}class Gu{constructor(e){this.parser=e,this.name=ku.KHR_MATERIALS_CLEARCOAT}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?Xa:null}extendMaterialParams(e,t){const i=this.parser,n=i.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=[],s=n.extensions[this.name];if(void 0!==s.clearcoatFactor&&(t.clearcoat=s.clearcoatFactor),void 0!==s.clearcoatTexture&&r.push(i.assignTexture(t,"clearcoatMap",s.clearcoatTexture)),void 0!==s.clearcoatRoughnessFactor&&(t.clearcoatRoughness=s.clearcoatRoughnessFactor),void 0!==s.clearcoatRoughnessTexture&&r.push(i.assignTexture(t,"clearcoatRoughnessMap",s.clearcoatRoughnessTexture)),void 0!==s.clearcoatNormalTexture&&(r.push(i.assignTexture(t,"clearcoatNormalMap",s.clearcoatNormalTexture)),void 0!==s.clearcoatNormalTexture.scale)){const e=s.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new xe(e,-e)}return Promise.all(r)}}class Wu{constructor(e){this.parser=e,this.name=ku.KHR_MATERIALS_TRANSMISSION}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?Xa:null}extendMaterialParams(e,t){const i=this.parser,n=i.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=[],s=n.extensions[this.name];return void 0!==s.transmissionFactor&&(t.transmission=s.transmissionFactor),void 0!==s.transmissionTexture&&r.push(i.assignTexture(t,"transmissionMap",s.transmissionTexture)),Promise.all(r)}}class Hu{constructor(e){this.parser=e,this.name=ku.KHR_TEXTURE_BASISU}loadTexture(e){const t=this.parser,i=t.json,n=i.textures[e];if(!n.extensions||!n.extensions[this.name])return null;const r=n.extensions[this.name],s=i.images[r.source],a=t.options.ktx2Loader;if(!a){if(i.extensionsRequired&&i.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return t.loadTextureImage(e,s,a)}}class ju{constructor(e){this.parser=e,this.name=ku.EXT_TEXTURE_WEBP,this.isSupported=null}loadTexture(e){const t=this.name,i=this.parser,n=i.json,r=n.textures[e];if(!r.extensions||!r.extensions[t])return null;const s=r.extensions[t],a=n.images[s.source];let o=i.textureLoader;if(a.uri){const e=i.options.manager.getHandler(a.uri);null!==e&&(o=e)}return this.detectSupport().then((function(r){if(r)return i.loadTextureImage(e,a,o);if(n.extensionsRequired&&n.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: WebP required by asset but unsupported.");return i.loadTexture(e)}))}detectSupport(){return this.isSupported||(this.isSupported=new Promise((function(e){const t=new Image;t.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",t.onload=t.onerror=function(){e(1===t.height)}}))),this.isSupported}}class qu{constructor(e){this.name=ku.EXT_MESHOPT_COMPRESSION,this.parser=e}loadBufferView(e){const t=this.parser.json,i=t.bufferViews[e];if(i.extensions&&i.extensions[this.name]){const e=i.extensions[this.name],n=this.parser.getDependency("buffer",e.buffer),r=this.parser.options.meshoptDecoder;if(!r||!r.supported){if(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return Promise.all([n,r.ready]).then((function(t){const i=e.byteOffset||0,n=e.byteLength||0,s=e.count,a=e.byteStride,o=new ArrayBuffer(s*a),l=new Uint8Array(t[0],i,n);return r.decodeGltfBuffer(new Uint8Array(o),s,a,l,e.mode,e.filter),o}))}return null}}const Xu="glTF",Yu=1313821514,Zu=5130562;class Ju{constructor(e){this.name=ku.KHR_BINARY_GLTF,this.content=null,this.body=null;const t=new DataView(e,0,12);if(this.header={magic:Ro.decodeText(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==Xu)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const i=this.header.length-12,n=new DataView(e,12);let r=0;for(;r<i;){const t=n.getUint32(r,!0);r+=4;const i=n.getUint32(r,!0);if(r+=4,i===Yu){const i=new Uint8Array(e,12+r,t);this.content=Ro.decodeText(i)}else if(i===Zu){const i=12+r;this.body=e.slice(i,i+t)}r+=t}if(null===this.content)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class Qu{constructor(e,t){if(!t)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=ku.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}decodePrimitive(e,t){const i=this.json,n=this.dracoLoader,r=e.extensions[this.name].bufferView,s=e.extensions[this.name].attributes,a={},o={},l={};for(const c in s){const e=mh[c]||c.toLowerCase();a[e]=s[c]}for(const c in e.attributes){const t=mh[c]||c.toLowerCase();if(void 0!==s[c]){const n=i.accessors[e.attributes[c]],r=uh[n.componentType];l[t]=r,o[t]=!0===n.normalized}}return t.getDependency("bufferView",r).then((function(e){return new Promise((function(t){n.decodeDracoFile(e,(function(e){for(const t in e.attributes){const i=e.attributes[t],n=o[t];void 0!==n&&(i.normalized=n)}t(e)}),a,l)}))}))}}class Ku{constructor(){this.name=ku.KHR_TEXTURE_TRANSFORM}extendTexture(e,t){return t.texCoord,void 0===t.offset&&void 0===t.rotation&&void 0===t.scale||(e=e.clone(),void 0!==t.offset&&e.offset.fromArray(t.offset),void 0!==t.rotation&&(e.rotation=t.rotation),void 0!==t.scale&&e.repeat.fromArray(t.scale),e.needsUpdate=!0),e}}class $u extends qa{constructor(e){super(),this.isGLTFSpecularGlossinessMaterial=!0;const t=["#ifdef USE_SPECULARMAP","\tuniform sampler2D specularMap;","#endif"].join("\n"),i=["#ifdef USE_GLOSSINESSMAP","\tuniform sampler2D glossinessMap;","#endif"].join("\n"),n=["vec3 specularFactor = specular;","#ifdef USE_SPECULARMAP","\tvec4 texelSpecular = texture2D( specularMap, vUv );","\ttexelSpecular = sRGBToLinear( texelSpecular );","\t// reads channel RGB, compatible with a glTF Specular-Glossiness (RGBA) texture","\tspecularFactor *= texelSpecular.rgb;","#endif"].join("\n"),r=["float glossinessFactor = glossiness;","#ifdef USE_GLOSSINESSMAP","\tvec4 texelGlossiness = texture2D( glossinessMap, vUv );","\t// reads channel A, compatible with a glTF Specular-Glossiness (RGBA) texture","\tglossinessFactor *= texelGlossiness.a;","#endif"].join("\n"),s=["PhysicalMaterial material;","material.diffuseColor = diffuseColor.rgb * ( 1. - max( specularFactor.r, max( specularFactor.g, specularFactor.b ) ) );","vec3 dxy = max( abs( dFdx( geometryNormal ) ), abs( dFdy( geometryNormal ) ) );","float geometryRoughness = max( max( dxy.x, dxy.y ), dxy.z );","material.specularRoughness = max( 1.0 - glossinessFactor, 0.0525 ); // 0.0525 corresponds to the base mip of a 256 cubemap.","material.specularRoughness += geometryRoughness;","material.specularRoughness = min( material.specularRoughness, 1.0 );","material.specularColor = specularFactor;"].join("\n"),a={specular:{value:(new $t).setHex(16777215)},glossiness:{value:1},specularMap:{value:null},glossinessMap:{value:null}};this._extraUniforms=a,this.onBeforeCompile=function(e){for(const t in a)e.uniforms[t]=a[t];e.fragmentShader=e.fragmentShader.replace("uniform float roughness;","uniform vec3 specular;").replace("uniform float metalness;","uniform float glossiness;").replace("#include <roughnessmap_pars_fragment>",t).replace("#include <metalnessmap_pars_fragment>",i).replace("#include <roughnessmap_fragment>",n).replace("#include <metalnessmap_fragment>",r).replace("#include <lights_physical_fragment>",s)},Object.defineProperties(this,{specular:{get:function(){return a.specular.value},set:function(e){a.specular.value=e}},specularMap:{get:function(){return a.specularMap.value},set:function(e){a.specularMap.value=e,e?this.defines.USE_SPECULARMAP="":delete this.defines.USE_SPECULARMAP}},glossiness:{get:function(){return a.glossiness.value},set:function(e){a.glossiness.value=e}},glossinessMap:{get:function(){return a.glossinessMap.value},set:function(e){a.glossinessMap.value=e,e?(this.defines.USE_GLOSSINESSMAP="",this.defines.USE_UV=""):(delete this.defines.USE_GLOSSINESSMAP,delete this.defines.USE_UV)}}}),delete this.metalness,delete this.roughness,delete this.metalnessMap,delete this.roughnessMap,this.setValues(e)}copy(e){return super.copy(e),this.specularMap=e.specularMap,this.specular.copy(e.specular),this.glossinessMap=e.glossinessMap,this.glossiness=e.glossiness,delete this.metalness,delete this.roughness,delete this.metalnessMap,delete this.roughnessMap,this}}class eh{constructor(){this.name=ku.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS,this.specularGlossinessParams=["color","map","lightMap","lightMapIntensity","aoMap","aoMapIntensity","emissive","emissiveIntensity","emissiveMap","bumpMap","bumpScale","normalMap","normalMapType","displacementMap","displacementScale","displacementBias","specularMap","specular","glossinessMap","glossiness","alphaMap","envMap","envMapIntensity","refractionRatio"]}getMaterialType(){return $u}extendParams(e,t,i){const n=t.extensions[this.name];e.color=new $t(1,1,1),e.opacity=1;const r=[];if(Array.isArray(n.diffuseFactor)){const t=n.diffuseFactor;e.color.fromArray(t),e.opacity=t[3]}if(void 0!==n.diffuseTexture&&r.push(i.assignTexture(e,"map",n.diffuseTexture)),e.emissive=new $t(0,0,0),e.glossiness=void 0!==n.glossinessFactor?n.glossinessFactor:1,e.specular=new $t(1,1,1),Array.isArray(n.specularFactor)&&e.specular.fromArray(n.specularFactor),void 0!==n.specularGlossinessTexture){const t=n.specularGlossinessTexture;r.push(i.assignTexture(e,"glossinessMap",t)),r.push(i.assignTexture(e,"specularMap",t))}return Promise.all(r)}createMaterial(e){const t=new $u(e);return t.fog=!0,t.color=e.color,t.map=void 0===e.map?null:e.map,t.lightMap=null,t.lightMapIntensity=1,t.aoMap=void 0===e.aoMap?null:e.aoMap,t.aoMapIntensity=1,t.emissive=e.emissive,t.emissiveIntensity=1,t.emissiveMap=void 0===e.emissiveMap?null:e.emissiveMap,t.bumpMap=void 0===e.bumpMap?null:e.bumpMap,t.bumpScale=1,t.normalMap=void 0===e.normalMap?null:e.normalMap,t.normalMapType=0,e.normalScale&&(t.normalScale=e.normalScale),t.displacementMap=null,t.displacementScale=1,t.displacementBias=0,t.specularMap=void 0===e.specularMap?null:e.specularMap,t.specular=e.specular,t.glossinessMap=void 0===e.glossinessMap?null:e.glossinessMap,t.glossiness=e.glossiness,t.alphaMap=null,t.envMap=void 0===e.envMap?null:e.envMap,t.envMapIntensity=1,t.refractionRatio=.98,t}}class th{constructor(){this.name=ku.KHR_MESH_QUANTIZATION}}class ih extends Ja{constructor(e,t,i,n){super(e,t,i,n)}copySampleValue_(e){const t=this.resultBuffer,i=this.sampleValues,n=this.valueSize,r=e*n*3+n;for(let s=0;s!==n;s++)t[s]=i[r+s];return t}}ih.prototype.beforeStart_=ih.prototype.copySampleValue_,ih.prototype.afterEnd_=ih.prototype.copySampleValue_,ih.prototype.interpolate_=function(e,t,i,n){const r=this.resultBuffer,s=this.sampleValues,a=this.valueSize,o=2*a,l=3*a,c=n-t,u=(i-t)/c,h=u*u,d=h*u,p=e*l,m=p-l,f=-2*d+3*h,g=d-h,v=1-f,y=g-h+u;for(let x=0;x!==a;x++){const e=s[m+x+a],t=s[m+x+o]*c,i=s[p+x+a],n=s[p+x]*c;r[x]=v*e+y*t+f*i+g*n}return r};const nh=0,rh=1,sh=2,ah=3,oh=4,lh=5,ch=6,uh={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},hh={9728:1003,9729:1006,9984:1004,9985:1007,9986:1005,9987:1008},dh={33071:1001,33648:1002,10497:1e3},ph={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},mh={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv2",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},fh={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},gh={CUBICSPLINE:void 0,LINEAR:2301,STEP:2300},vh="OPAQUE",yh="MASK",xh="BLEND";function _h(e,t){return"string"!=typeof e||""===e?"":(/^https?:\/\//i.test(t)&&/^\//.test(e)&&(t=t.replace(/(^https?:\/\/[^\/]+).*/i,"$1")),/^(https?:)?\/\//i.test(e)||/^data:.*,.*$/i.test(e)||/^blob:.*$/i.test(e)?e:t+e)}function bh(e,t,i){for(const n in i.extensions)void 0===e[n]&&(t.userData.gltfExtensions=t.userData.gltfExtensions||{},t.userData.gltfExtensions[n]=i.extensions[n])}function wh(e,t){void 0!==t.extras&&"object"==typeof t.extras&&Object.assign(e.userData,t.extras)}function Mh(e,t){if(e.updateMorphTargets(),void 0!==t.weights)for(let i=0,n=t.weights.length;i<n;i++)e.morphTargetInfluences[i]=t.weights[i];if(t.extras&&Array.isArray(t.extras.targetNames)){const i=t.extras.targetNames;if(e.morphTargetInfluences.length===i.length){e.morphTargetDictionary={};for(let t=0,n=i.length;t<n;t++)e.morphTargetDictionary[i[t]]=t}}}function Sh(e){const t=e.extensions&&e.extensions[ku.KHR_DRACO_MESH_COMPRESSION];let i;return i=t?"draco:"+t.bufferView+":"+t.indices+":"+Th(t.attributes):e.indices+":"+Th(e.attributes)+":"+e.mode,i}function Th(e){let t="";const i=Object.keys(e).sort();for(let n=0,r=i.length;n<r;n++)t+=i[n]+":"+e[i[n]]+";";return t}function Ah(e){switch(e){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}class Ch{constructor(e={},t={}){this.json=e,this.extensions={},this.plugins={},this.options=t,this.cache=new Uu,this.associations=new Map,this.primitiveCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.textureCache={},this.nodeNamesUsed={},"undefined"!=typeof createImageBitmap&&!1===/Firefox/.test(navigator.userAgent)?this.textureLoader=new No(this.options.manager):this.textureLoader=new vo(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new fo(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),"use-credentials"===this.options.crossOrigin&&this.fileLoader.setWithCredentials(!0)}setExtensions(e){this.extensions=e}setPlugins(e){this.plugins=e}parse(e,t){const i=this,n=this.json,r=this.extensions;this.cache.removeAll(),this._invokeAll((function(e){return e._markDefs&&e._markDefs()})),Promise.all(this._invokeAll((function(e){return e.beforeRoot&&e.beforeRoot()}))).then((function(){return Promise.all([i.getDependencies("scene"),i.getDependencies("animation"),i.getDependencies("camera")])})).then((function(t){const s={scene:t[0][n.scene||0],scenes:t[0],animations:t[1],cameras:t[2],asset:n.asset,parser:i,userData:{}};bh(r,s,n),wh(s,n),Promise.all(i._invokeAll((function(e){return e.afterRoot&&e.afterRoot(s)}))).then((function(){e(s)}))})).catch(t)}_markDefs(){const e=this.json.nodes||[],t=this.json.skins||[],i=this.json.meshes||[];for(let n=0,r=t.length;n<r;n++){const i=t[n].joints;for(let t=0,n=i.length;t<n;t++)e[i[t]].isBone=!0}for(let n=0,r=e.length;n<r;n++){const t=e[n];void 0!==t.mesh&&(this._addNodeRef(this.meshCache,t.mesh),void 0!==t.skin&&(i[t.mesh].isSkinnedMesh=!0)),void 0!==t.camera&&this._addNodeRef(this.cameraCache,t.camera)}}_addNodeRef(e,t){void 0!==t&&(void 0===e.refs[t]&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)}_getNodeRef(e,t,i){if(e.refs[t]<=1)return i;const n=i.clone();return n.name+="_instance_"+e.uses[t]++,n}_invokeOne(e){const t=Object.values(this.plugins);t.push(this);for(let i=0;i<t.length;i++){const n=e(t[i]);if(n)return n}return null}_invokeAll(e){const t=Object.values(this.plugins);t.unshift(this);const i=[];for(let n=0;n<t.length;n++){const r=e(t[n]);r&&i.push(r)}return i}getDependency(e,t){const i=e+":"+t;let n=this.cache.get(i);if(!n){switch(e){case"scene":n=this.loadScene(t);break;case"node":n=this.loadNode(t);break;case"mesh":n=this._invokeOne((function(e){return e.loadMesh&&e.loadMesh(t)}));break;case"accessor":n=this.loadAccessor(t);break;case"bufferView":n=this._invokeOne((function(e){return e.loadBufferView&&e.loadBufferView(t)}));break;case"buffer":n=this.loadBuffer(t);break;case"material":n=this._invokeOne((function(e){return e.loadMaterial&&e.loadMaterial(t)}));break;case"texture":n=this._invokeOne((function(e){return e.loadTexture&&e.loadTexture(t)}));break;case"skin":n=this.loadSkin(t);break;case"animation":n=this.loadAnimation(t);break;case"camera":n=this.loadCamera(t);break;default:throw new Error("Unknown type: "+e)}this.cache.add(i,n)}return n}getDependencies(e){let t=this.cache.get(e);if(!t){const i=this,n=this.json[e+("mesh"===e?"es":"s")]||[];t=Promise.all(n.map((function(t,n){return i.getDependency(e,n)}))),this.cache.add(e,t)}return t}loadBuffer(e){const t=this.json.buffers[e],i=this.fileLoader;if(t.type&&"arraybuffer"!==t.type)throw new Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(void 0===t.uri&&0===e)return Promise.resolve(this.extensions[ku.KHR_BINARY_GLTF].body);const n=this.options;return new Promise((function(e,r){i.load(_h(t.uri,n.path),e,void 0,(function(){r(new Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))}))}))}loadBufferView(e){const t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then((function(e){const i=t.byteLength||0,n=t.byteOffset||0;return e.slice(n,n+i)}))}loadAccessor(e){const t=this,i=this.json,n=this.json.accessors[e];if(void 0===n.bufferView&&void 0===n.sparse)return Promise.resolve(null);const r=[];return void 0!==n.bufferView?r.push(this.getDependency("bufferView",n.bufferView)):r.push(null),void 0!==n.sparse&&(r.push(this.getDependency("bufferView",n.sparse.indices.bufferView)),r.push(this.getDependency("bufferView",n.sparse.values.bufferView))),Promise.all(r).then((function(e){const r=e[0],s=ph[n.type],a=uh[n.componentType],o=a.BYTES_PER_ELEMENT,l=o*s,c=n.byteOffset||0,u=void 0!==n.bufferView?i.bufferViews[n.bufferView].byteStride:void 0,h=!0===n.normalized;let d,p;if(u&&u!==l){const e=Math.floor(c/u),i="InterleavedBuffer:"+n.bufferView+":"+n.componentType+":"+e+":"+n.count;let l=t.cache.get(i);l||(d=new a(r,e*u,n.count*u/o),l=new Gs(d,u/o),t.cache.add(i,l)),p=new Hs(l,s,c%u/o,h)}else d=null===r?new a(n.count*s):new a(r,c,n.count*s),p=new ni(d,s,h);if(void 0!==n.sparse){const t=ph.SCALAR,i=uh[n.sparse.indices.componentType],o=n.sparse.indices.byteOffset||0,l=n.sparse.values.byteOffset||0,c=new i(e[1],o,n.sparse.count*t),u=new a(e[2],l,n.sparse.count*s);null!==r&&(p=new ni(p.array.slice(),p.itemSize,p.normalized));for(let e=0,n=c.length;e<n;e++){const t=c[e];if(p.setX(t,u[e*s]),s>=2&&p.setY(t,u[e*s+1]),s>=3&&p.setZ(t,u[e*s+2]),s>=4&&p.setW(t,u[e*s+3]),s>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return p}))}loadTexture(e){const t=this.json,i=this.options,n=t.textures[e],r=t.images[n.source];let s=this.textureLoader;if(r.uri){const e=i.manager.getHandler(r.uri);null!==e&&(s=e)}return this.loadTextureImage(e,r,s)}loadTextureImage(e,t,i){const n=this,r=this.json,s=this.options,a=r.textures[e],o=(t.uri||t.bufferView)+":"+a.sampler;if(this.textureCache[o])return this.textureCache[o];const l=self.URL||self.webkitURL;let c=t.uri||"",u=!1,h=!0;const d=c.search(/\.jpe?g($|\?)/i)>0||0===c.search(/^data\:image\/jpeg/);if(("image/jpeg"===t.mimeType||d)&&(h=!1),void 0!==t.bufferView)c=n.getDependency("bufferView",t.bufferView).then((function(e){if("image/png"===t.mimeType){const t=new DataView(e,25,1).getUint8(0,!1);h=6===t||4===t||3===t}u=!0;const i=new Blob([e],{type:t.mimeType});return c=l.createObjectURL(i),c}));else if(void 0===t.uri)throw new Error("THREE.GLTFLoader: Image "+e+" is missing URI and bufferView");const p=Promise.resolve(c).then((function(e){return new Promise((function(t,n){let r=t;!0===i.isImageBitmapLoader&&(r=function(e){const i=new Te(e);i.needsUpdate=!0,t(i)}),i.load(_h(e,s.path),r,void 0,n)}))})).then((function(t){!0===u&&l.revokeObjectURL(c),t.flipY=!1,a.name&&(t.name=a.name),h||(t.format=1022);const i=(r.samplers||{})[a.sampler]||{};return t.magFilter=hh[i.magFilter]||1006,t.minFilter=hh[i.minFilter]||1008,t.wrapS=dh[i.wrapS]||1e3,t.wrapT=dh[i.wrapT]||1e3,n.associations.set(t,{type:"textures",index:e}),t})).catch((function(){return null}));return this.textureCache[o]=p,p}assignTexture(e,t,i){const n=this;return this.getDependency("texture",i.index).then((function(r){if(void 0!==i.texCoord&&0!=i.texCoord&&("aoMap"!==t||i.texCoord),n.extensions[ku.KHR_TEXTURE_TRANSFORM]){const e=void 0!==i.extensions?i.extensions[ku.KHR_TEXTURE_TRANSFORM]:void 0;if(e){const t=n.associations.get(r);r=n.extensions[ku.KHR_TEXTURE_TRANSFORM].extendTexture(r,e),n.associations.set(r,t)}}e[t]=r}))}assignFinalMaterial(e){const t=e.geometry;let i=e.material;const n=void 0!==t.attributes.tangent,r=void 0!==t.attributes.color,s=void 0===t.attributes.normal,a=Object.keys(t.morphAttributes).length>0,o=a&&void 0!==t.morphAttributes.normal;if(e.isPoints){const e="PointsMaterial:"+i.uuid;let t=this.cache.get(e);t||(t=new xa,qt.prototype.copy.call(t,i),t.color.copy(i.color),t.map=i.map,t.sizeAttenuation=!1,this.cache.add(e,t)),i=t}else if(e.isLine){const e="LineBasicMaterial:"+i.uuid;let t=this.cache.get(e);t||(t=new la,qt.prototype.copy.call(t,i),t.color.copy(i.color),this.cache.add(e,t)),i=t}if(n||r||s||a){let e="ClonedMaterial:"+i.uuid+":";i.isGLTFSpecularGlossinessMaterial&&(e+="specular-glossiness:"),n&&(e+="vertex-tangents:"),r&&(e+="vertex-colors:"),s&&(e+="flat-shading:"),a&&(e+="morph-targets:"),o&&(e+="morph-normals:");let t=this.cache.get(e);t||(t=i.clone(),r&&(t.vertexColors=!0),s&&(t.flatShading=!0),a&&(t.morphTargets=!0),o&&(t.morphNormals=!0),n&&(t.vertexTangents=!0,t.normalScale&&(t.normalScale.y*=-1),t.clearcoatNormalScale&&(t.clearcoatNormalScale.y*=-1)),this.cache.add(e,t),this.associations.set(t,this.associations.get(i))),i=t}i.aoMap&&void 0===t.attributes.uv2&&void 0!==t.attributes.uv&&t.setAttribute("uv2",t.attributes.uv),e.material=i}getMaterialType(){return qa}loadMaterial(e){const t=this,i=this.json,n=this.extensions,r=i.materials[e];let s;const a={},o=r.extensions||{},l=[];if(o[ku.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS]){const e=n[ku.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS];s=e.getMaterialType(),l.push(e.extendParams(a,r,t))}else if(o[ku.KHR_MATERIALS_UNLIT]){const e=n[ku.KHR_MATERIALS_UNLIT];s=e.getMaterialType(),l.push(e.extendParams(a,r,t))}else{const i=r.pbrMetallicRoughness||{};if(a.color=new $t(1,1,1),a.opacity=1,Array.isArray(i.baseColorFactor)){const e=i.baseColorFactor;a.color.fromArray(e),a.opacity=e[3]}void 0!==i.baseColorTexture&&l.push(t.assignTexture(a,"map",i.baseColorTexture)),a.metalness=void 0!==i.metallicFactor?i.metallicFactor:1,a.roughness=void 0!==i.roughnessFactor?i.roughnessFactor:1,void 0!==i.metallicRoughnessTexture&&(l.push(t.assignTexture(a,"metalnessMap",i.metallicRoughnessTexture)),l.push(t.assignTexture(a,"roughnessMap",i.metallicRoughnessTexture))),s=this._invokeOne((function(t){return t.getMaterialType&&t.getMaterialType(e)})),l.push(Promise.all(this._invokeAll((function(t){return t.extendMaterialParams&&t.extendMaterialParams(e,a)}))))}!0===r.doubleSided&&(a.side=2);const c=r.alphaMode||vh;return c===xh?(a.transparent=!0,a.depthWrite=!1):(a.transparent=!1,c===yh&&(a.alphaTest=void 0!==r.alphaCutoff?r.alphaCutoff:.5)),void 0!==r.normalTexture&&s!==ei&&(l.push(t.assignTexture(a,"normalMap",r.normalTexture)),a.normalScale=new xe(1,-1),void 0!==r.normalTexture.scale&&a.normalScale.set(r.normalTexture.scale,-r.normalTexture.scale)),void 0!==r.occlusionTexture&&s!==ei&&(l.push(t.assignTexture(a,"aoMap",r.occlusionTexture)),void 0!==r.occlusionTexture.strength&&(a.aoMapIntensity=r.occlusionTexture.strength)),void 0!==r.emissiveFactor&&s!==ei&&(a.emissive=(new $t).fromArray(r.emissiveFactor)),void 0!==r.emissiveTexture&&s!==ei&&l.push(t.assignTexture(a,"emissiveMap",r.emissiveTexture)),Promise.all(l).then((function(){let i;return i=s===$u?n[ku.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS].createMaterial(a):new s(a),r.name&&(i.name=r.name),i.map&&(i.map.encoding=3001),i.emissiveMap&&(i.emissiveMap.encoding=3001),wh(i,r),t.associations.set(i,{type:"materials",index:e}),r.extensions&&bh(n,i,r),i}))}createUniqueName(e){const t=Ho.sanitizeNodeName(e||"");let i=t;for(let n=1;this.nodeNamesUsed[i];++n)i=t+"_"+n;return this.nodeNamesUsed[i]=!0,i}loadGeometries(e){const t=this,i=this.extensions,n=this.primitiveCache;function r(e){return i[ku.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(e,t).then((function(i){return Ph(i,e,t)}))}const s=[];for(let a=0,o=e.length;a<o;a++){const i=e[a],o=Sh(i),l=n[o];if(l)s.push(l.promise);else{let e;e=i.extensions&&i.extensions[ku.KHR_DRACO_MESH_COMPRESSION]?r(i):Ph(new fi,i,t),n[o]={primitive:i,promise:e},s.push(e)}}return Promise.all(s)}loadMesh(e){const t=this,i=this.json,n=this.extensions,r=i.meshes[e],s=r.primitives,a=[];for(let l=0,c=s.length;l<c;l++){const e=void 0===s[l].material?(void 0===(o=this.cache).DefaultMaterial&&(o.DefaultMaterial=new qa({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:0})),o.DefaultMaterial):this.getDependency("material",s[l].material);a.push(e)}var o;return a.push(t.loadGeometries(s)),Promise.all(a).then((function(i){const a=i.slice(0,i.length-1),o=i[i.length-1],l=[];for(let u=0,h=o.length;u<h;u++){const i=o[u],c=s[u];let h;const d=a[u];if(c.mode===oh||c.mode===lh||c.mode===ch||void 0===c.mode)h=!0===r.isSkinnedMesh?new Js(i,d):new Ri(i,d),!0!==h.isSkinnedMesh||h.geometry.attributes.skinWeight.normalized||h.normalizeSkinWeights(),c.mode===lh?h.geometry=Eh(h.geometry,1):c.mode===ch&&(h.geometry=Eh(h.geometry,2));else if(c.mode===rh)h=new va(i,d);else if(c.mode===ah)h=new ma(i,d);else if(c.mode===sh)h=new ya(i,d);else{if(c.mode!==nh)throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+c.mode);h=new Sa(i,d)}Object.keys(h.geometry.morphAttributes).length>0&&Mh(h,r),h.name=t.createUniqueName(r.name||"mesh_"+e),wh(h,r),c.extensions&&bh(n,h,c),t.assignFinalMaterial(h),l.push(h)}if(1===l.length)return l[0];const c=new zs;for(let e=0,t=l.length;e<t;e++)c.add(l[e]);return c}))}loadCamera(e){let t;const i=this.json.cameras[e],n=i[i.type];if(n)return"perspective"===i.type?t=new Vi(n.yfov*he,n.aspectRatio||1,n.znear||1,n.zfar||2e6):"orthographic"===i.type&&(t=new hn(-n.xmag,n.xmag,n.ymag,-n.ymag,n.znear,n.zfar)),i.name&&(t.name=this.createUniqueName(i.name)),wh(t,i),Promise.resolve(t)}loadSkin(e){const t=this.json.skins[e],i={joints:t.joints};return void 0===t.inverseBindMatrices?Promise.resolve(i):this.getDependency("accessor",t.inverseBindMatrices).then((function(e){return i.inverseBindMatrices=e,i}))}loadAnimation(e){const t=this.json.animations[e],i=[],n=[],r=[],s=[],a=[];for(let o=0,l=t.channels.length;o<l;o++){const e=t.channels[o],l=t.samplers[e.sampler],c=e.target,u=void 0!==c.node?c.node:c.id,h=void 0!==t.parameters?t.parameters[l.input]:l.input,d=void 0!==t.parameters?t.parameters[l.output]:l.output;i.push(this.getDependency("node",u)),n.push(this.getDependency("accessor",h)),r.push(this.getDependency("accessor",d)),s.push(l),a.push(c)}return Promise.all([Promise.all(i),Promise.all(n),Promise.all(r),Promise.all(s),Promise.all(a)]).then((function(i){const n=i[0],r=i[1],s=i[2],a=i[3],o=i[4],l=[];for(let e=0,t=n.length;e<t;e++){const t=n[e],i=r[e],c=s[e],u=a[e],h=o[e];if(void 0===t)continue;let d;switch(t.updateMatrix(),t.matrixAutoUpdate=!0,fh[h.path]){case fh.weights:d=no;break;case fh.rotation:d=so;break;default:d=oo}const p=t.name?t.name:t.uuid,m=void 0!==u.interpolation?gh[u.interpolation]:2301,f=[];fh[h.path]===fh.weights?t.traverse((function(e){!0===e.isMesh&&e.morphTargetInfluences&&f.push(e.name?e.name:e.uuid)})):f.push(p);let g=c.array;if(c.normalized){const e=Ah(g.constructor),t=new Float32Array(g.length);for(let i=0,n=g.length;i<n;i++)t[i]=g[i]*e;g=t}for(let e=0,n=f.length;e<n;e++){const t=new d(f[e]+"."+fh[h.path],i.array,g,m);"CUBICSPLINE"===u.interpolation&&(t.createInterpolant=function(e){return new ih(this.times,this.values,this.getValueSize()/3,e)},t.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0),l.push(t)}}const c=t.name?t.name:"animation_"+e;return new lo(c,void 0,l)}))}createNodeMesh(e){const t=this.json,i=this,n=t.nodes[e];return void 0===n.mesh?null:i.getDependency("mesh",n.mesh).then((function(e){const t=i._getNodeRef(i.meshCache,n.mesh,e);return void 0!==n.weights&&t.traverse((function(e){if(e.isMesh)for(let t=0,i=n.weights.length;t<i;t++)e.morphTargetInfluences[t]=n.weights[t]})),t}))}loadNode(e){const t=this.json,i=this.extensions,n=this,r=t.nodes[e],s=r.name?n.createUniqueName(r.name):"";return function(){const t=[],i=n._invokeOne((function(t){return t.createNodeMesh&&t.createNodeMesh(e)}));return i&&t.push(i),void 0!==r.camera&&t.push(n.getDependency("camera",r.camera).then((function(e){return n._getNodeRef(n.cameraCache,r.camera,e)}))),n._invokeAll((function(t){return t.createNodeAttachment&&t.createNodeAttachment(e)})).forEach((function(e){t.push(e)})),Promise.all(t)}().then((function(t){let a;if(a=!0===r.isBone?new Qs:t.length>1?new zs:1===t.length?t[0]:new Rt,a!==t[0])for(let e=0,i=t.length;e<i;e++)a.add(t[e]);if(r.name&&(a.userData.name=r.name,a.name=s),wh(a,r),r.extensions&&bh(i,a,r),void 0!==r.matrix){const e=new lt;e.fromArray(r.matrix),a.applyMatrix4(e)}else void 0!==r.translation&&a.position.fromArray(r.translation),void 0!==r.rotation&&a.quaternion.fromArray(r.rotation),void 0!==r.scale&&a.scale.fromArray(r.scale);return n.associations.set(a,{type:"nodes",index:e}),a}))}loadScene(e){const t=this.json,i=this.extensions,n=this.json.scenes[e],r=this,s=new zs;n.name&&(s.name=r.createUniqueName(n.name)),wh(s,n),n.extensions&&bh(i,s,n);const a=n.nodes||[],o=[];for(let l=0,c=a.length;l<c;l++)o.push(Lh(a[l],s,t,r));return Promise.all(o).then((function(){return s}))}}function Lh(e,t,i,n){const r=i.nodes[e];return n.getDependency("node",e).then((function(e){if(void 0===r.skin)return e;let t;return n.getDependency("skin",r.skin).then((function(e){t=e;const i=[];for(let r=0,s=t.joints.length;r<s;r++)i.push(n.getDependency("node",t.joints[r]));return Promise.all(i)})).then((function(i){return e.traverse((function(e){if(!e.isMesh)return;const n=[],r=[];for(let s=0,a=i.length;s<a;s++){const e=i[s];if(e){n.push(e);const i=new lt;void 0!==t.inverseBindMatrices&&i.fromArray(t.inverseBindMatrices.array,16*s),r.push(i)}}e.bind(new ta(n,r),e.matrixWorld)})),e}))})).then((function(e){t.add(e);const s=[];if(r.children){const t=r.children;for(let r=0,a=t.length;r<a;r++){const a=t[r];s.push(Lh(a,e,i,n))}}return Promise.all(s)}))}function Ph(e,t,i){const n=t.attributes,r=[];function s(t,n){return i.getDependency("accessor",t).then((function(t){e.setAttribute(n,t)}))}for(const a in n){const t=mh[a]||a.toLowerCase();t in e.attributes||r.push(s(n[a],t))}if(void 0!==t.indices&&!e.index){const n=i.getDependency("accessor",t.indices).then((function(t){e.setIndex(t)}));r.push(n)}return wh(e,t),function(e,t,i){const n=t.attributes,r=new ze;if(void 0===n.POSITION)return;{const e=i.json.accessors[n.POSITION],t=e.min,s=e.max;if(void 0===t||void 0===s)return;if(r.set(new De(t[0],t[1],t[2]),new De(s[0],s[1],s[2])),e.normalized){const t=Ah(uh[e.componentType]);r.min.multiplyScalar(t),r.max.multiplyScalar(t)}}const s=t.targets;if(void 0!==s){const e=new De,t=new De;for(let n=0,r=s.length;n<r;n++){const r=s[n];if(void 0!==r.POSITION){const n=i.json.accessors[r.POSITION],s=n.min,a=n.max;if(void 0!==s&&void 0!==a){if(t.setX(Math.max(Math.abs(s[0]),Math.abs(a[0]))),t.setY(Math.max(Math.abs(s[1]),Math.abs(a[1]))),t.setZ(Math.max(Math.abs(s[2]),Math.abs(a[2]))),n.normalized){const e=Ah(uh[n.componentType]);t.multiplyScalar(e)}e.max(t)}}}r.expandByVector(e)}e.boundingBox=r;const a=new $e;r.getCenter(a.center),a.radius=r.min.distanceTo(r.max)/2,e.boundingSphere=a}(e,t,i),Promise.all(r).then((function(){return void 0!==t.targets?function(e,t,i){let n=!1,r=!1;for(let o=0,l=t.length;o<l;o++){const e=t[o];if(void 0!==e.POSITION&&(n=!0),void 0!==e.NORMAL&&(r=!0),n&&r)break}if(!n&&!r)return Promise.resolve(e);const s=[],a=[];for(let o=0,l=t.length;o<l;o++){const l=t[o];if(n){const t=void 0!==l.POSITION?i.getDependency("accessor",l.POSITION):e.attributes.position;s.push(t)}if(r){const t=void 0!==l.NORMAL?i.getDependency("accessor",l.NORMAL):e.attributes.normal;a.push(t)}}return Promise.all([Promise.all(s),Promise.all(a)]).then((function(t){const i=t[0],s=t[1];return n&&(e.morphAttributes.position=i),r&&(e.morphAttributes.normal=s),e.morphTargetsRelative=!0,e}))}(e,t.targets,i):e}))}function Eh(e,t){let i=e.getIndex();if(null===i){const t=[],n=e.getAttribute("position");if(void 0===n)return e;for(let e=0;e<n.count;e++)t.push(e);e.setIndex(t),i=e.getIndex()}const n=i.count-2,r=[];if(2===t)for(let a=1;a<=n;a++)r.push(i.getX(0)),r.push(i.getX(a)),r.push(i.getX(a+1));else for(let a=0;a<n;a++)a%2==0?(r.push(i.getX(a)),r.push(i.getX(a+1)),r.push(i.getX(a+2))):(r.push(i.getX(a+2)),r.push(i.getX(a+1)),r.push(i.getX(a)));r.length;const s=e.clone();return s.setIndex(r),s}const Dh=new class extends po{constructor(e){super(e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register((function(e){return new Gu(e)})),this.register((function(e){return new Hu(e)})),this.register((function(e){return new ju(e)})),this.register((function(e){return new Wu(e)})),this.register((function(e){return new Bu(e)})),this.register((function(e){return new qu(e)}))}load(e,t,i,n){const r=this;let s;s=""!==this.resourcePath?this.resourcePath:""!==this.path?this.path:Ro.extractUrlBase(e),this.manager.itemStart(e);const a=function(t){n&&n(t),r.manager.itemError(e),r.manager.itemEnd(e)},o=new fo(this.manager);o.setPath(this.path),o.setResponseType("arraybuffer"),o.setRequestHeader(this.requestHeader),o.setWithCredentials(this.withCredentials),o.load(e,(function(i){try{r.parse(i,s,(function(i){t(i),r.manager.itemEnd(e)}),a)}catch(n){a(n)}}),i,a)}setDRACOLoader(e){return this.dracoLoader=e,this}setDDSLoader(){throw new Error('THREE.GLTFLoader: "MSFT_texture_dds" no longer supported. Please update to "KHR_texture_basisu".')}setKTX2Loader(e){return this.ktx2Loader=e,this}setMeshoptDecoder(e){return this.meshoptDecoder=e,this}register(e){return-1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this}unregister(e){return-1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,i,n){let r;const s={},a={};if("string"==typeof e)r=e;else{if(Ro.decodeText(new Uint8Array(e,0,4))===Xu){try{s[ku.KHR_BINARY_GLTF]=new Ju(e)}catch(c){return void(n&&n(c))}r=s[ku.KHR_BINARY_GLTF].content}else r=Ro.decodeText(new Uint8Array(e))}const o=JSON.parse(r);if(void 0===o.asset||o.asset.version[0]<2)return void(n&&n(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported.")));const l=new Ch(o,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});l.fileLoader.setRequestHeader(this.requestHeader);for(let u=0;u<this.pluginCallbacks.length;u++){const e=this.pluginCallbacks[u](l);a[e.name]=e,s[e.name]=!0}if(o.extensionsUsed)for(let u=0;u<o.extensionsUsed.length;++u){const e=o.extensionsUsed[u],t=o.extensionsRequired||[];switch(e){case ku.KHR_MATERIALS_UNLIT:s[e]=new Vu;break;case ku.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:s[e]=new eh;break;case ku.KHR_DRACO_MESH_COMPRESSION:s[e]=new Qu(o,this.dracoLoader);break;case ku.KHR_TEXTURE_TRANSFORM:s[e]=new Ku;break;case ku.KHR_MESH_QUANTIZATION:s[e]=new th;break;default:t.indexOf(e)>=0&&a[e]}}l.setExtensions(s),l.setPlugins(a),l.parse(i,n)}};async function Ih(e,t={}){return new Promise(((i,n)=>{Dh.load(e,(n=>{Ru.add(e,n),t.onLoad&&t.onLoad(n),i(n)}),(()=>{}),n)}))}async function Rh(e,t={}){const i=await fetch(e),n=await i.json();return Ru.add(e,n),t.onLoad&&t.onLoad(n),n}function zh(e,t,i,n=0){const r=t.size,s=t.scale/Math.max(r.w,r.h),a={},o=e.anchor||e.pivot||{x:.5,y:.5};"hint"===i.split("_")[0]&&(o.x=0,o.y=0);const l=e.frame,c=e.sourceSize,u=e.spriteSourceSize;a.id=i;const h=i.split("/");a.sequence=h.pop(),a.group=h.join("/"),a.frameIndex=n,a.texCoords=new Float32Array([l.x/r.w,(r.h-l.y-l.h)/r.h,l.w/r.w,l.h/r.h]),a.meshCoords=new Float32Array([.5*u.w+u.x-c.w*o.x,-(.5*u.h+u.y-c.h*o.y),u.w,u.h]);for(let d=0,p=a.meshCoords.length;d<p;d++)a.meshCoords[d]*=s;return a.anchor=o,a.sourceSize=e.sourceSize,a.spriteSourceSize=e.spriteSourceSize,a.vertices=e.vertices,a.verticesUV=e.verticesUV,a.triangles=e.triangles,a}Ih.setDRACOLoader=e=>Dh.setDRACOLoader(e),Ih.loader={name:"gltf",extensions:[".gltf",".glb"],function:Ih},Rh.loader={name:"json",extensions:[".json"],function:Rh};var Nh=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:"/assets/structure_data.b0fc828121e5b1ef.png"}),Oh=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:"/assets/structure_diffuse.00c7120021e5b1ef.png"}),Fh=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:"/assets/road_data.3f583de321e5b1ef.png"}),Uh=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:"/assets/road_diffuse.d57d9afe21e5b1ef.png"}),kh=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:"/assets/car_data.c126940521e5b1ef.png"}),Bh=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:"/assets/flakes_256.fdf868cc21e5b1ef.png"}),Vh=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:"/assets/bokeh_overlay.7c87d4c321e5b1ef.avif"}),Gh=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:"/assets/bokeh_overlay.d509a5b121e5b1ef.jpg"}),Wh=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:"/assets/bokeh_overlay.0ab604e721e5b1ef.webp"}),Hh=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:"/assets/matcaps.69da094921e5b1ef.png"}),jh=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:"/assets/bluenoise.5c5463f021e5b1ef.png"}),qh=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:"/assets/sprites.d60fd3d421e5b1ef.avif"}),Xh=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:"/assets/sprites.48581f0321e5b1ef.jpg"}),Yh=JSON.parse('{"frames":{"circleA":{"frame":{"x":508,"y":2,"w":282,"h":281},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":282,"h":281},"sourceSize":{"w":282,"h":281},"pivot":{"x":0.5,"y":0.5}},"particleA":{"frame":{"x":508,"y":289,"w":255,"h":255},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":255,"h":255},"sourceSize":{"w":256,"h":256},"pivot":{"x":0.5,"y":0.5}},"raysA":{"frame":{"x":2,"y":507,"w":397,"h":415},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":397,"h":415},"sourceSize":{"w":397,"h":415},"pivot":{"x":0.5,"y":0.5}},"smoke":{"frame":{"x":2,"y":2,"w":500,"h":499},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":4,"w":500,"h":499},"sourceSize":{"w":512,"h":512},"pivot":{"x":0.5,"y":0.5}},"sparkleA":{"frame":{"x":796,"y":2,"w":33,"h":201},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":33,"h":201},"sourceSize":{"w":33,"h":201},"pivot":{"x":0.5,"y":0.5}}},"meta":{"app":"https://www.codeandweb.com/texturepacker","version":"1.0","image":"sprites.png","format":"RGB888","size":{"w":1024,"h":1024},"scale":"1","smartupdate":"$TexturePacker:SmartUpdate:b1ed601573dfda7519f1b5678be50c5b:87ba29695c7ddc2c903c06f78569a8eb:1eabdf11f75e3a4fe3147baf7b5be24b$"}}'),Zh=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:Yh}),Jh=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:"/assets/sprites.8e39f09121e5b1ef.png"}),Qh=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:"/assets/sprites.49a1173121e5b1ef.webp"}),Kh=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:"/assets/nx.d415b4ef21e5b1ef.avif"}),$h=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:"/assets/ny.43e2549621e5b1ef.avif"}),ed=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:"/assets/nz.d3e9e24421e5b1ef.avif"}),td=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:"/assets/px.344dbb2121e5b1ef.avif"}),id=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:"/assets/py.dcc357b921e5b1ef.avif"}),nd=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:"/assets/pz.6fb954e121e5b1ef.avif"}),rd=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:"/assets/nx.f9e72b5021e5b1ef.webp"}),sd=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:"/assets/ny.7c4a5e3a21e5b1ef.webp"}),ad=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:"/assets/nz.c2966f2321e5b1ef.webp"}),od=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:"/assets/px.0e95ae7221e5b1ef.webp"}),ld=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:"/assets/py.8093695221e5b1ef.webp"}),cd=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:"/assets/pz.fbb1f06921e5b1ef.webp"}),ud=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:"/assets/nx.d00b022221e5b1ef.jpg"}),hd=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:"/assets/ny.7547b99b21e5b1ef.jpg"}),dd=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:"/assets/nz.d8dc138b21e5b1ef.jpg"}),pd=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:"/assets/px.104b0f3c21e5b1ef.jpg"}),md=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:"/assets/py.7137228c21e5b1ef.jpg"}),fd=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:"/assets/pz.e8eabcfe21e5b1ef.jpg"});function gd(e,t={},i,n){for(const r in e){let s=r.split("/").pop().split(".").slice(0,-1).join(".");n&&(s=n(s)),i?(t[s]||(t[s]={}),t[s][i]=e[r].default):t[s]=e[r].default}}const vd=["jpeg","jpg","png","gif"],yd=[...vd,"avif","webp"];function xd(e,t){let i={},n=1e3;for(let r in e){const t=e[r].default,s=r.split("/").pop().split(".");let a=s.pop();if(!yd.includes(a))continue;const o=vd.indexOf(a);if(~o&&o>=n)continue;~o&&(n=o,a="default");const l=s.join(".");(i[l]=i[l]||{})[a]=t}return 1!==Object.values(i).length||t||(i=Object.values(i)[0]),i}const _d={},bd=_d.envmap={};gd({"/src/assets/scene/envmap/nx.jpg":ud,"/src/assets/scene/envmap/ny.jpg":hd,"/src/assets/scene/envmap/nz.jpg":dd,"/src/assets/scene/envmap/px.jpg":pd,"/src/assets/scene/envmap/py.jpg":md,"/src/assets/scene/envmap/pz.jpg":fd},bd,"default"),gd({"/src/assets/scene/envmap/nx.webp":rd,"/src/assets/scene/envmap/ny.webp":sd,"/src/assets/scene/envmap/nz.webp":ad,"/src/assets/scene/envmap/px.webp":od,"/src/assets/scene/envmap/py.webp":ld,"/src/assets/scene/envmap/pz.webp":cd},bd,"webp"),gd({"/src/assets/scene/envmap/nx.avif":Kh,"/src/assets/scene/envmap/ny.avif":$h,"/src/assets/scene/envmap/nz.avif":ed,"/src/assets/scene/envmap/px.avif":td,"/src/assets/scene/envmap/py.avif":id,"/src/assets/scene/envmap/pz.avif":nd},bd,"avif"),_d.sprites=xd({"/src/assets/scene/sprites/sprites.avif":qh,"/src/assets/scene/sprites/sprites.jpg":Xh,"/src/assets/scene/sprites/sprites.json":Zh,"/src/assets/scene/sprites/sprites.png":Jh,"/src/assets/scene/sprites/sprites.webp":Qh}),_d.bluenoise=xd({"/src/assets/scene/textures/bluenoise.png":jh}),_d.matcaps=xd({"/src/assets/scene/textures/matcaps.png":Hh}),_d.bokeh=xd({"/src/assets/scene/textures/bokeh_overlay.avif":Vh,"/src/assets/scene/textures/bokeh_overlay.jpg":Gh,"/src/assets/scene/textures/bokeh_overlay.webp":Wh}),_d.flakes=xd({"/src/assets/scene/textures/flakes_256.png":Bh}),_d.carData=xd({"/src/assets/scene/textures/car_data.png":kh}),_d.roadDiffuse=xd({"/src/assets/scene/textures/road_diffuse.png":Uh}),_d.roadData=xd({"/src/assets/scene/textures/road_data.png":Fh}),_d.structureDiffuse=xd({"/src/assets/scene/textures/structure_diffuse.png":Oh}),_d.structureData=xd({"/src/assets/scene/textures/structure_data.png":Nh}),_d.sceneModel="/assets/scene.5cd70f0e21e5b1ef.glb",_d.sceneModelDraco="/assets/scene.drc.ae97704a21e5b1ef.glb",_d.roadCurveData="/assets/road.1999f75921e5b1ef.dat",_d.framesData="/assets/positions.fc37884921e5b1ef.dat",_d.spritesData="/assets/sprites.e45dc30e21e5b1ef.json";var wd=_d;const Md=new Ya,Sd=(e,t)=>(t.position.copy(e.position),t.quaternion.copy(e.quaternion),t.scale.copy(e.scale),t.updateMatrix(),t),Td=new Rt;const Ad=function(e){const t=new po(e);Object.assign(this,t),this.decoderPath="",this.decoderConfig={},this.decoderBinary=null,this.decoderPending=null,this.workerLimit=4,this.workerPool=[],this.workerNextTaskID=1,this.workerSourceURL="",this.defaultAttributeIDs={position:"POSITION",normal:"NORMAL",color:"COLOR",uv:"TEX_COORD"},this.defaultAttributeTypes={position:"Float32Array",normal:"Float32Array",color:"Float32Array",uv:"Float32Array"}};Ad.prototype=Object.assign(Object.create(po.prototype),{constructor:Ad,setDecoderPath:function(e){return this.decoderPath=e,this},setDecoderConfig:function(e){return this.decoderConfig=e,this},setWorkerLimit:function(e){return this.workerLimit=e,this},load:function(e,t,i,n){const r=new fo(this.manager);r.setPath(this.path),r.setResponseType("arraybuffer"),"use-credentials"===this.crossOrigin&&r.setWithCredentials(!0),r.load(e,(e=>{const i={attributeIDs:this.defaultAttributeIDs,attributeTypes:this.defaultAttributeTypes,useUniqueIDs:!1};this.decodeGeometry(e,i).then(t).catch(n)}),i,n)},decodeDracoFile:function(e,t,i,n){const r={attributeIDs:i||this.defaultAttributeIDs,attributeTypes:n||this.defaultAttributeTypes,useUniqueIDs:!!i};this.decodeGeometry(e,r).then(t)},decodeGeometry:function(e,t){for(const o in t.attributeTypes){const e=t.attributeTypes[o];void 0!==e.BYTES_PER_ELEMENT&&(t.attributeTypes[o]=e.name)}const i=JSON.stringify(t);if(Ad.taskCache.has(e)){const t=Ad.taskCache.get(e);if(t.key===i)return t.promise;if(0===e.byteLength)throw new Error("DRACOLoader: Unable to re-decode a buffer with different settings. Buffer has already been transferred.")}let n;const r=this.workerNextTaskID++,s=e.byteLength,a=this._getWorker(r,s).then((i=>(n=i,new Promise(((i,s)=>{n._callbacks[r]={resolve:i,reject:s},n.postMessage({type:"decode",id:r,taskConfig:t,buffer:e},[e])}))))).then((e=>this._createGeometry(e.geometry)));return a.finally((()=>{n&&r&&this._releaseTask(n,r)})),Ad.taskCache.set(e,{key:i,promise:a}),a},_createGeometry:function(e){const t=new fi;e.index&&t.setIndex(new ni(e.index.array,1));for(let i=0;i<e.attributes.length;i++){const n=e.attributes[i],r=n.name,s=n.array,a=n.itemSize;t.setAttribute(r,new ni(s,a))}return t},_loadLibrary:function(e,t){const i=new fo(this.manager);return i.setPath(this.decoderPath),i.setResponseType(t),new Promise(((t,n)=>{i.load(e,t,void 0,n)}))},preload:function(){return this._initDecoder(),this},_initDecoder:function(){if(this.decoderPending)return this.decoderPending;const e="object"!=typeof WebAssembly||"js"===this.decoderConfig.type,t=[];return e?t.push(this._loadLibrary("draco_decoder.js","text")):(t.push(this._loadLibrary("draco_wasm_wrapper.js","text")),t.push(this._loadLibrary("draco_decoder.wasm","arraybuffer"))),this.decoderPending=Promise.all(t).then((t=>{const i=t[0];e||(this.decoderConfig.wasmBinary=t[1]);const n=Ad.DRACOWorker.toString(),r=["/* draco decoder */",i,"","/* worker */",n.substring(n.indexOf("{")+1,n.lastIndexOf("}"))].join("\n");this.workerSourceURL=URL.createObjectURL(new Blob([r]))})),this.decoderPending},_getWorker:function(e,t){return this._initDecoder().then((()=>{if(this.workerPool.length<this.workerLimit){const e=new Worker(this.workerSourceURL);e._callbacks={},e._taskCosts={},e._taskLoad=0,e.postMessage({type:"init",decoderConfig:this.decoderConfig}),e.onmessage=function(t){const i=t.data;switch(i.type){case"decode":e._callbacks[i.id].resolve(i);break;case"error":e._callbacks[i.id].reject(i)}},this.workerPool.push(e)}else this.workerPool.sort((function(e,t){return e._taskLoad>t._taskLoad?-1:1}));const i=this.workerPool[this.workerPool.length-1];return i._taskCosts[e]=t,i._taskLoad+=t,i}))},_releaseTask:function(e,t){e._taskLoad-=e._taskCosts[t],delete e._callbacks[t],delete e._taskCosts[t]},dispose:function(){for(let e=0;e<this.workerPool.length;++e)this.workerPool[e].terminate();return this.workerPool.length=0,this}}),Ad.DRACOWorker=function(){let e,t;function i(e,t,i,n,r,s){const a=s.num_components(),o=i.num_points()*a;let l,c,u;switch(r){case Float32Array:u=4*o,l=e._malloc(u),t.GetAttributeDataArrayForAllPoints(i,s,e.DT_FLOAT32,u,l),c=new Float32Array(e.HEAPF32.buffer,l,o).slice(),e._free(l);break;case Int8Array:l=e._malloc(o),t.GetAttributeDataArrayForAllPoints(i,s,e.DT_INT8,o,l),c=new Int8Array(e.HEAP8.buffer,l,o).slice(),e._free(l);break;case Int16Array:u=2*o,l=e._malloc(u),t.GetAttributeDataArrayForAllPoints(i,s,e.DT_INT16,u,l),c=new Int16Array(e.HEAP16.buffer,l,o).slice(),e._free(l);break;case Int32Array:u=4*o,l=e._malloc(u),t.GetAttributeDataArrayForAllPoints(i,s,e.DT_INT32,u,l),c=new Int32Array(e.HEAP32.buffer,l,o).slice(),e._free(l);break;case Uint8Array:l=e._malloc(o),t.GetAttributeDataArrayForAllPoints(i,s,e.DT_UINT8,o,l),c=new Uint8Array(e.HEAPU8.buffer,l,o).slice(),e._free(l);break;case Uint16Array:u=2*o,l=e._malloc(u),t.GetAttributeDataArrayForAllPoints(i,s,e.DT_UINT16,u,l),c=new Uint16Array(e.HEAPU16.buffer,l,o).slice(),e._free(l);break;case Uint32Array:u=4*o,l=e._malloc(u),t.GetAttributeDataArrayForAllPoints(i,s,e.DT_UINT32,u,l),c=new Uint32Array(e.HEAPU32.buffer,l,o).slice(),e._free(l);break;default:throw new Error("DRACOLoader: Unexpected attribute type.")}return{name:n,array:c,itemSize:a}}onmessage=function(n){const r=n.data;switch(r.type){case"init":e=r.decoderConfig,t=new Promise((function(t){e.onModuleLoaded=function(e){t({draco:e})},DracoDecoderModule(e)}));break;case"decode":const n=r.buffer,s=r.taskConfig;t.then((e=>{const t=e.draco,a=new t.Decoder,o=new t.DecoderBuffer;o.Init(new Int8Array(n),n.byteLength);try{const e=function(e,t,n,r){const s=r.attributeIDs,a=r.attributeTypes;let o,l;const c=t.GetEncodedGeometryType(n);if(c===e.TRIANGULAR_MESH)o=new e.Mesh,l=t.DecodeBufferToMesh(n,o);else{if(c!==e.POINT_CLOUD)throw new Error("DRACOLoader: Unexpected geometry type.");o=new e.PointCloud,l=t.DecodeBufferToPointCloud(n,o)}if(!l.ok()||0===o.ptr)throw new Error("DRACOLoader: Decoding failed: "+l.error_msg());const u={index:null,attributes:[]};for(const h in s){const n=self[a[h]];let l,c;if(r.useUniqueIDs)c=s[h],l=t.GetAttributeByUniqueId(o,c);else{if(c=t.GetAttributeId(o,e[s[h]]),-1===c)continue;l=t.GetAttribute(o,c)}u.attributes.push(i(e,t,o,h,n,l))}if(c===e.TRIANGULAR_MESH){const i=3*o.num_faces(),n=4*i,r=e._malloc(n);t.GetTrianglesUInt32Array(o,n,r);const s=new Uint32Array(e.HEAPU32.buffer,r,i).slice();e._free(r),u.index={array:s,itemSize:1}}return e.destroy(o),u}(t,a,o,s),n=e.attributes.map((e=>e.array.buffer));e.index&&n.push(e.index.array.buffer),self.postMessage({type:"decode",id:r.id,geometry:e},n)}catch(l){self.postMessage({type:"error",id:r.id,error:l.message})}finally{t.destroy(o),t.destroy(a)}}))}}},Ad.taskCache=new WeakMap;var Cd=Ad;const Ld=Iu.select,Pd=["px","nx","py","ny","pz","nz"];async function Ed(e){const t=_();Ou.registerLoader(Fu),Ou.registerLoader(Ih),Ou.registerLoader(Rh);const i=e.geometries={},n=e.meshes={},r=e.curves={},s=e.textures={};function a(t,i){const r=i.userData.name;"ROAD"===r?n.road=i:"CAR"===r?function(e,t){const i=e.meshes,n=i.rawCar=t,r=n.children[n.children[0].name.includes("wh")?0:1],s=n.children[r===n.children[0]?1:0],a=i.car=new Rt,o=s.children[0].geometry;a.body=new oa(o,Md,1),a.body.instanceMatrix.setUsage(35044),Sd(s,a.body),Sd(s.children[0],Td),a.body.setMatrixAt(0,Td.matrix),a.body.instanceMatrix.needsUpdate=!0,a.add(a.body);const l=r.children[0].geometry;a.wheels=new oa(l,Md,4),a.wheels.instanceMatrix.setUsage(35048),Sd(r,a.wheels),a.add(a.wheels),a.dummyWheels=r.children.map((e=>Sd(e,new Rt)))}(e,i):"STRUCTURE"===r&&(n.structure=i)}function l(e,t){const i=t.userData,n=i.name;if(n&&"*"===n[0]&&(i.instancedMesh=!0),!i.instancedMesh)for(const r of t.children)l(t,r);a(0,t)}e.assets={},e.previousFrame={value:null,type:"t"},e.currentFrame={value:null,type:"t"},e.assets.load=async function(){const n=[];await Iu.test(),i.plane=new en,n.push(t.task(Ou.load(wd.spritesData,{onLoad:t=>{e.atlas=function(e){const t={sprites:{},meta:e.meta},i=e.frames;e.animations||(e.animations={});for(const n in e.animations){const r=e.animations[n],s=t.sprites[n]=[];for(let t=0,a=r.length;t<a;t++){const a=i[r[t]];delete i[r[t]],s.push(zh(a,e.meta,n,t))}}for(const n in i){const r=i[n],s=(r.filename?r.filename.toString():n).replace(/[^a-zA-Z0-9-_-]/g,"").replace("png",""),a=t.sprites[s]=[];delete i[n],a.push(zh(r,e.meta,s))}return t}(t)}}))),n.push(t.task(Promise.all(Pd.map((e=>Ld(wd.envmap[e]))).map(Ou.load)).then((e=>e.map((e=>e.node)))).then((e=>{const t=new Wi;t.images=e,t.needsUpdate=!0,s.envMap2=t})))),n.push(...[[Ld(wd.sprites),"sprites",{}],[Ld(wd.bokeh),"bokeh",{}],[Ld(wd.bluenoise),"blueNoise",{repeat:!0}],[Ld(wd.flakes),"flakes",{repeat:!0}],[Ld(wd.matcaps),"matcaps"],[Ld(wd.carData),"carData"],[Ld(wd.roadDiffuse),"roadDiffuse"],[Ld(wd.roadData),"roadData"],[Ld(wd.structureDiffuse),"structureDiffuse"],[Ld(wd.structureData),"structureData"]].map((e=>t.task(Ou.load(e[0],{onLoad:({node:t})=>{s[e[1]]=function(e){const t=new Te(e.img);return void 0!==e.flipY&&(t.flipY=e.flipY),void 0!==e.mipmaps&&(t.generateMipmaps=!!e.mipmaps),e.magFilter&&(t.magFilter=e.magFilter),e.minFilter&&(t.minFilter=e.minFilter),e.encoding&&(t.encoding=e.encoding),e.mapping&&(t.mapping=e.mapping),e.premultiplyAlpha&&(t.premultiplyAlpha=!0),e.repeat?(t.wrapS=1e3,t.wrapT=1e3):(e.wrapS&&(t.wrapS=e.wrapS),e.wrapT&&(t.wrapT=e.wrapT)),e.format&&(t.format=e.format),e.type&&(t.type=e.type),t.needsUpdate=!0,t}(o({img:t,flipY:!1},e[2]))}}))))),n.push(t.task(Ou.load(wd.framesData,{onLoad:t=>{const i=new Float32Array(t),n=e.frames=[];for(let e=0,r=i.length/5;e<r;e++){let t=5*e;n.push({quaternion:new Ee(i[t++],i[t++],i[t++],i[t++]),scale:i[t++]})}}}))),n.push(t.task(Ou.load(wd.roadCurveData,{onLoad:e=>{const t=new Float32Array(e),i=r.road=new ja;let n=null;for(let r=0,s=t.length/9;r<s;r++){if(r+1>=s)continue;const e=9*r,a=n||new De(t[e],t[e+1],t[e+2]),o=new De(t[e+6],t[e+7],t[e+8]),l=new De(t[e+12],t[e+13],t[e+14]),c=n=new De(t[e+9],t[e+10],t[e+11]);i.add(new ka(a,o,l,c))}}})));let a=wd.sceneModel;const c=new Cd;c.setDecoderPath(__DATA.config.basepath+"vendors/draco/"),c.preload(),Ih.setDRACOLoader(c),a=wd.sceneModelDraco,n.push(t.task(Ih(a,{onLoad:e=>{for(const t of e.scene.children)l(e.scene,t)}}))),await Promise.all(n),e.atlas.meta.image=e.textures.sprites,e.atlas.texture=e.textures.sprites}}function Dd(e){e.store={renderOrder:{background:0,road:1,carShadow:2,car:3,structure:4,turboLine:5,carTrails:6,sprites:7,cloudParticles:8},carShadow:new xe,shadowActive:m(!1)}}const Id=()=>{};function Rd(e){const t={createBuffer:function(e){return function({renderer:e,alpha:t,depth:i,stencil:n,width:r,height:s,name:a}){const o=xe.get();r&&s?o.set(r,s):e.getDrawingBufferSize(o);const l=new Le(o.x,o.y,{minFilter:1006,magFilter:1006,format:1023,depthBuffer:!!i,stencilBuffer:!!n});return o.release(),l.texture.generateMipmaps=!1,l}(e)},registerBuffer:Id,unregisterBuffer:Id};e.fbo=t}function zd(e){const t=e.game,i={IDLE:0,STARTING:1,ACTIVATING:2,ACTIVE:3,ENDED:4},n="tuto_done";let r=0,s=0,a=!0,l=!1,c=0,u=!0,h=-1,d=!1;const p=o({current:i.IDLE,reset:function(){r=0,s=0,a=!0,l=!1,c=0,h=-1,d=!1},update:function(o){const _=p.current;r=s,s+=o,_===i.STARTING?function(n){const a=e.audio;0===r&&(X.$stores.keysVisible=!1,a.setBgm("pad"));f(g)&&a.playSound("UI_Countdown_Three");f(1700)&&a.playSound("UI_Countdown_Two");f(2700)&&a.playSound("UI_Countdown_One");f(3700)&&a.playSound("UI_Countdown_GO");f(1e3)&&t.view&&t.view.countdown.value.show();s>4e3&&m(i.ACTIVATING)}():_===i.ACTIVATING?(a=!1,l=!1,c=1e5,X.$stores.keysVisible=!1,m(i.ACTIVE)):_===i.ACTIVE?function(r){f(10)&&e.audio.setBgm("pad+guitar");f(6e3)&&e.audio.setBgm("pad+drum+guitar");f(12e3)&&e.audio.setBgm("all");f(1e3)&&t.view&&t.view.timer.value.show();f(1200)&&(t.view&&!a&&u&&t.view.tuto.value.show(),a=!0,X.$stores.keysVisible=!0);a&&s>3200&&e.controls.active&&(t.view&&t.view.tuto.value.hide(),a=!1,u=!1,sessionStorage.setItem(n,1),c=s);!l&&s-c>1e3&&(l=!0,t.view&&t.view.turbo.value.show());t.progress>=t.checkpoints.list.finish&&(t.updateBestTime(),X.$rtcDisplay.enabled.value&&X.$rtcDisplay.sendFinish(t.racetime,t.bestTime),m(i.ENDED))}():_===i.ENDED&&function(i){0===r&&(X.$stores.keysVisible=!1,e.audio.playSound("UI_Finish"));e.gameCam.activeInfluence<.08&&(h<0&&(h=performance.now()),function(t){const i=performance.now();if(i<v)return;e.audio.playSound("FireworksEnd",{volume:_l.randomFloat(.4,.6)}),x=Math.random()<y,x?y=0:y+=.15+y;const n=x?_l.randomFloat(10,90):_l.randomFloat(150,420);v=i+n,e.scene.emitFirework()}());f(20)&&t.view&&t.view.finish.value.show();f(700)&&e.audio.setBgm("outro");f(10)&&t.view&&(t.view.tuto.value.hide(),t.view.countdown.value.hide(),t.view.turbo.value.hide());const n=performance.now();if(!d&&p.stateTime>4500&&n-h>3e3){if(d)return;X.$router.push({name:"result"})}}()},isGameRunning:function(){return p.current>i.IDLE&&p.current<i.ENDED},hasEnded:function(e=0,n=0){if(!e&&!n)return p.current>=i.ENDED;const r=t.checkpoints.list.finish+n;return p.current>=i.ENDED&&s>=e&&t.progress>=r},get stateTime(){return s},set:m},i);function m(e){p.current=e,r=s=0,h=-1,d=!1,t.ended.set(e>i.ACTIVE)}function f(e){return r<e&&s>=e}const g=700;let v=0,y=1,x=!1;return p}const Nd=Od();function Od(){return{position:new De,quaternion:new Ee,scale:new De(1,1,1)}}function Fd(e){const t={reset:f()},i=localStorage.getItem("best_time"),n=e.game={createFrameData:Od,currentCam:m(null),time:0,racetime:0,elapsed:0,bestTime:null==i||isNaN(i)?-1:i,getRoadData:function(e){return d(n.progressNorm,e)},getRelativeRoadData:function(e,t){return d(n.progressNorm+e/n.roadLength,t)},getAbsoluteRoadData:d,normalizeProgress:function(e){return c(e/n.roadLength,0,1)},roadLength:0,minVelocity:8,maxVelocity:10.5,turboVelocity:19.8,velocity:0,progress:0,progressNorm:0,replay:function(){p()},resetting:!1,started:!1,ended:m(!1),hooks:t,setView:function(e){n.view=e,p()},removeView:function(e){if(n.view!==e)return;n.view=null,p()},view:null,updateProgressNorm:g,updateBestTime:function(){(n.bestTime<0||n.racetime<n.bestTime)&&(n.bestTime=n.racetime,localStorage.setItem("best_time",n.bestTime))},paused:m(!1),isPaused:v,forceAutopilot:m(!1)},r=function(e){let t=0;const i={progress:0,velProgress:0,hover:!1,active:m(!1),init:function(){e.game.hooks.reset.watch(n)},reset:n,update:function(){const n=e.time.stableDt,r=e.scene.road.car,s=e.game.progress;if(i.active.value)i.progress-=2.9*n*1e-4,i.progress<=0&&(i.active.set(!1),t=s);else if(i.cooldownActive&&(i.cooldownActive=s-t<15),i.hover||(i.progress-=2*n*1e-4,i.cooldownActive||i.ended||(i.velProgress-=2.8*n*1e-4)),r.dip){const e=r.dipStrength,t=.007*c(ie(e,.01,.02,0,1),0,1);i.progress-=t,i.active.value||i.cooldownActive||(i.velProgress-=t)}i.velProgress=c(i.velProgress,0,1),i.progress=c(i.progress,0,1)},addHitDistance:function(n){if(i.active.value)return;const r=i.progress,s=n/50;i.progress=c(i.progress+s,0,1);const a=n/50;i.velProgress=c(i.velProgress+a,0,1),i.progress>=1&&r<1&&(i.cooldownActive=!0,t=e.game.progress,i.active.set(!0),e.audio.playSound("Car_Engine_Boost"))},cooldownActive:!1,cooldown:15,distanceToFill:50,ended:!1};return i;function n(){i.progress=0,i.velProgress=0,i.hover=!1,i.active.set(!1),i.cooldownActive=!1}}(e);n.turbo=r;const s=zd(e);n.state=s;const a=function(e){return e.game,{list:{start:3,finish:786.5},reset:function(){},update:function(e){}}}(e);let o,l,h;function d(t,i){t=c(t,0,1);const n=i||Nd,r=e.frames,s=t*(r.length-1),a=Math.floor(s),l=s-a,u=r[a],h=r[a+1]||u;return n.position=o.getPointAt(t,n.position),n.quaternion.slerpQuaternions(u.quaternion,h.quaternion,l),n.scale.set(1,W(u.scale,h.scale,l),1),n}function p(){l=!0}function g(){n.progressNorm=c(n.progress/n.roadLength,0,1)}function v(){return n.paused.value&&e.scene.gameCam.used}n.checkpoints=a,n.autopilot=function(e,t){const i=new u,n=i.set.bind(i);delete i.set,e=Array.isArray(e)?e:[e];const r=new Array(e.length);let s=[];for(let o=0,l=e.length;o<l;o++){const t=e[o],i=function(e){r[o]=e,a()};r[o]=t.value,t.watch(i),s.push(t,i)}function a(){const e=t.apply(null,r);e&&e.then?e.then(n):n(e)}return i.destroy=function(){for(let e=0,t=s.length;e<t;e+=2)s[e].unwatch(s[e+1]);s=null,i.unwatchAll()},a(),i}([n.forceAutopilot,n.turbo.active,n.currentCam,n.ended],((e,t,i,n)=>e||t||i&&i.forceCarAutopilot||n)),e.hooks.afterLoad.watchOnce((function(){k((()=>{n.paused.set(X.$stores.gamePaused)})),o=e.curves.road,n.roadLength=o.getLength(),r.init()})),e.hooks.beforeUpdate.watch((function(){const i=e.time.stableDt;e.scene.currentCamera!==n.currentCam.value&&n.currentCam.set(e.scene.currentCamera);if(v())return;h&&(n.resetting=!1,h=!1);l&&function(){n.time=0,n.racetime=0,n.progress=0,g(),n.resetting=!0;const e=n.view;let i=s.IDLE;e&&(i=s.STARTING);s.set(i),l=!1,h=!1,n.progress=Math.min(a.list.start,n.roadLength),t.reset.emit(),r.reset(),s.reset(),a.reset(),n.view&&n.view.hideAll()}();const o=i/1e3;n.elapsed+=i,n.time+=i,s.current===s.ACTIVE&&(n.racetime+=i);e.scene.road.car.updateVelocity(),n.progress=c(n.progress+n.velocity*o,0,n.roadLength),g(),r.update(i),s.update(i),n.resetting&&(h=!0)})),e.hooks.afterStart.watchOnce(p)}var Ud="precision highp float;varying vec2 vUv;uniform sampler2D colorTexture;uniform vec2 texSize;uniform vec2 direction;uniform float sigma;uniform int kernelRadius;\n#ifdef USE_HIGH_PASS\nuniform float threshold;\n#include <shaderHighPass>\n#endif\nfloat gaussianPdf(in float x,in float sigma){return 0.39894*exp(-0.5*x*x/(sigma*sigma))/sigma;}void main(){vec2 invSize=1.0/texSize;float weightSum=gaussianPdf(0.0,sigma);\n#ifdef USE_HIGH_PASS\nvec3 diffuseSum=highPass(texture2D(colorTexture,vUv).rgba,threshold,0.001)*weightSum;\n#else\nvec3 diffuseSum=texture2D(colorTexture,vUv).rgb*weightSum;\n#endif\nif(kernelRadius==3){for(int i=1;i<3;i++){\n#include <shaderBlurChunk>\n}}else if(kernelRadius==5){for(int i=1;i<5;i++){\n#include <shaderBlurChunk>\n}}else if(kernelRadius==7){for(int i=1;i<7;i++){\n#include <shaderBlurChunk>\n}}else if(kernelRadius==9){for(int i=1;i<9;i++){\n#include <shaderBlurChunk>\n}}else if(kernelRadius==11){for(int i=1;i<11;i++){\n#include <shaderBlurChunk>\n}}gl_FragColor=vec4(diffuseSum/weightSum,1.0);}";const kd=[3,5,7,9,11],Bd=new xe(1,0),Vd=new xe(0,.8),Gd={format:1022},Wd={exposure:.9,threshold:.6,strength:1.45,radius:1,resolution:new xe(512,512)},Hd=[],jd=[],qd=[];let Xd,Yd,Zd,Jd,Qd;function Kd(e,t,i){const n=new Le(t,i,Gd);return n.texture.name=e,n.texture.generateMipmaps=!1,(e.endsWith("H.mip0")||e.endsWith("site"))&&J.fbo.registerBuffer(e,n),n}var $d={init:function(e){Qd=J.threeRenderer;const t=xe.get().copy(Wd.resolution);tn.shaderBlurChunk="float x=float(i);float w=gaussianPdf(x,sigma);vec2 uvOffset=direction*invSize*x;\n#ifdef USE_HIGH_PASS\nvec3 sample1=highPass(texture2D(colorTexture,vUv+uvOffset).rgba,threshold,0.001);vec3 sample2=highPass(texture2D(colorTexture,vUv-uvOffset).rgba,threshold,0.001);\n#else\nvec3 sample1=texture2D(colorTexture,vUv+uvOffset).rgb;vec3 sample2=texture2D(colorTexture,vUv-uvOffset).rgb;\n#endif\ndiffuseSum+=(sample1+sample2)*w;weightSum+=2.0*w;",tn.shaderHighPass="const vec3 hp_DefaultColor=vec3(0.0);const vec3 hp_Luma=vec3(0.299,0.587,0.114);const vec3 pinkColor=vec3(1.,0.5,0.5);vec3 highPass(vec4 texel,float threshold,float epsilon){float neon=step(0.995,texel.g);float intensity=1.-texel.a;float hasWhite=step(0.995,texel.b);float whiteNeon=step(0.995,texel.b);float pinkNeon=step(0.995,texel.g);whiteNeon+=pinkNeon*hasWhite;pinkNeon*=(1.-hasWhite);whiteNeon*=texel.b;pinkNeon*=texel.g;float v=dot(texel.xyz,hp_Luma);float test=step(texel.a,0.999);return texel.rgb*intensity*2.;}";for(let i=0;i<kd.length;i++)0===i&&(Xd=Kd("Bloom.composite",t.x,t.y)),Hd.push(Kd("BloomBlurH.mip"+i,t.x,t.y)),jd.push(Kd("BloomBlurV.mip"+i,t.x,t.y)),qd.push(jd[i].texture),t.set(.5*t.x|0,.5*t.y|0);xe.release(t),Yd=ll({name:"Bloom - Composite",renderer:J.threeRenderer,fragmentShader:"precision highp float;varying vec2 vUv;uniform sampler2D blurTexture1;uniform sampler2D blurTexture2;uniform sampler2D blurTexture3;uniform sampler2D blurTexture4;uniform sampler2D blurTexture5;uniform float bloomStrength;uniform float bloomRadius;uniform float bloomFactors[NUM_MIPS];uniform vec3 bloomTintColors[NUM_MIPS];float lerpBloomFactor(const in float factor){float mirrorFactor=1.2-factor;return mix(factor,mirrorFactor,bloomRadius);}void main(){gl_FragColor=bloomStrength*(lerpBloomFactor(bloomFactors[0])*vec4(bloomTintColors[0],1.0)*texture2D(blurTexture1,vUv)+lerpBloomFactor(bloomFactors[1])*vec4(bloomTintColors[1],1.0)*texture2D(blurTexture2,vUv)+lerpBloomFactor(bloomFactors[2])*vec4(bloomTintColors[2],1.0)*texture2D(blurTexture3,vUv)+lerpBloomFactor(bloomFactors[3])*vec4(bloomTintColors[3],1.0)*texture2D(blurTexture4,vUv)+lerpBloomFactor(bloomFactors[4])*vec4(bloomTintColors[4],1.0)*texture2D(blurTexture5,vUv));}",transparent:!1,uniforms:{blurTexture1:{value:jd[0].texture},blurTexture2:{value:jd[1].texture},blurTexture3:{value:jd[2].texture},blurTexture4:{value:jd[3].texture},blurTexture5:{value:jd[4].texture},bloomStrength:{value:1},bloomRadius:{value:0},bloomFactors:{value:[1,.8,.6,.4,.2]},bloomTintColors:{value:[new De(1,1,1),new De(1,1,1),new De(1,1,1),new De(1,1,1),new De(1,1,1)]}},defines:{NUM_MIPS:kd.length}}),Jd=ll({renderer:J.threeRenderer,fragmentShader:Ud,transparent:!1,uniforms:{colorTexture:{value:Hd[0].texture},texSize:{value:(new xe).setScalar(.5*Wd.resolution)},direction:{value:Bd},kernelRadius:{type:"i",value:kd[0]},sigma:{type:"f",value:kd[0]}}}),Zd=ll({renderer:J.threeRenderer,fragmentShader:Ud,transparent:!1,uniforms:Object.assign({},Jd.u,{threshold:{value:.5}}),defines:{USE_HIGH_PASS:!0}})},render:function(e){if(0===Wd.exposure)return;let t=Zd;t.uniforms.threshold.value=Wd.threshold;for(let i=0;i<kd.length;i++){const n=kd[i];t.u.kernelRadius.value=0|n,t.u.sigma.value=n;const r=Hd[i];t.u.texSize.value.set(r.width,r.height),t.u.colorTexture.value=e.texture,t.u.direction.value=Bd,Qd.setRenderTarget(r),t.render(),t=Jd,t.u.colorTexture.value=Hd[i].texture,t.u.direction.value=Vd,Qd.setRenderTarget(jd[i]),t.render(),e=jd[i]}Yd.u.bloomStrength.value=Wd.strength,Yd.u.bloomRadius.value=Wd.radius,Qd.setRenderTarget(Xd),Yd.render()},resize:function(e,t){const i=xe.get().set(e,t);for(let n=0;n<kd.length;n++)0===n&&Xd.setSize(i.x,i.y),Hd[n].setSize(i.x,i.y),jd[n].setSize(i.x,i.y),i.set(.5*i.x|0,.5*i.y|0);xe.release(i)},blurTextures:qd,params:Wd,get compositeTexture(){return Xd.texture}},ep=cl(al,"precision highp float;\n#include <blend_add>\n#include <luma>\n#define PI 3.1415926538\nuniform sampler2D scene;uniform vec4 res;uniform float dpi;uniform vec4 uvOverlayOffset;uniform sampler2D bloom;uniform float time;uniform float bloomExposure;uniform sampler2D noise;uniform vec2 ditherOffset;uniform float menuInfluence;uniform sampler2D overlayTex;uniform vec2 press;varying vec2 vUv;const vec3 PINK=vec3(0.871,0.012,0.682);const vec3 BLUE=vec3(0.2,0.098,0.355);vec3 blendOverlay(vec3 base,vec3 blend){return mix(1.0-2.0*(1.0-base)*(1.0-blend),2.0*base*blend,step(base,vec3(0.5)));}vec3 blendSoftLight(vec3 base,vec3 blend){return mix(sqrt(base)*(2.0*blend-1.0)+2.0*base*(1.0-blend),2.0*base*blend+base*base*(1.0-2.0*blend),step(base,vec3(0.5)));}float gradientEase(float t){float tm1=t-1.0;float tm1_2=tm1*tm1;return 1.0-tm1_2*tm1_2;}vec2 correctRatio(vec2 inUv){return vec2(inUv.x*uvOverlayOffset.x+uvOverlayOffset.y,inUv.y*uvOverlayOffset.z+uvOverlayOffset.w);}const int speedBlurSamples=6;const float overlayRatio=1024./512.;void main(){vec2 uv=vUv;vec2 pxCoords=vUv*res.xy/dpi;vec2 buv=uv;buv.x+=cos(cos(buv.y)*120.+time*0.012)*0.0004;buv.y+=cos(buv.x*70.+time*0.022)*0.0002;vec3 bloomTexel=texture2D(bloom,buv).xyz;vec3 diffuse=texture2D(scene,vUv).rgb;float radius=length(vUv*2.-1.);diffuse=mix(diffuse,diffuse*1.2+0.23,smoothstep(0.8-menuInfluence*0.7,1.8,radius));bloomTexel=bloomTexel*bloomExposure;diffuse+=bloomTexel;diffuse=blendAdd(diffuse,bloomTexel*0.3);diffuse=blendAdd(diffuse,bloomTexel*0.2);diffuse=min(diffuse,1.);diffuse.r-=(1.-gradientEase(min(1.,(1.-vUv.y)*0.6+vUv.x*0.05)))*0.11;diffuse=mix(diffuse,BLUE,(1.-gradientEase(min(1.,(1.-vUv.x)*0.25+vUv.y*0.8-0.15)))*0.05);float screenRatio=res.x/res.y;vec2 overlayUv=mix(correctRatio(vUv.yx),correctRatio(vUv),step(1.,screenRatio));vec3 dirt=texture2D(overlayTex,overlayUv).rgb;diffuse=blendOverlay(diffuse,dirt*bloomTexel*1.8+0.5);diffuse=mix(diffuse,blendOverlay(diffuse,dirt+0.5),luma(diffuse)*0.15);float lum=clamp(luma(diffuse),0.,1.);vec3 dither=texture2D(noise,(pxCoords+ditherOffset)/NOISE_SIZE*dpi).rgb;vec3 ditheredDiffuse=blendSoftLight(diffuse,dither);diffuse=mix(diffuse,ditheredDiffuse,0.85);vec3 menuDiffuse=diffuse*vec3(0.12+diffuse.b*0.2,0.1+diffuse.b*0.3,0.1+diffuse.b*0.4);diffuse=mix(diffuse,menuDiffuse,menuInfluence);float vtouch=cos(uv.y*PI*2.)*0.02+0.13;float touch=smoothstep(0.8,1.3,(1.-uv.x)-vtouch)*press.x+smoothstep(0.8,1.3,uv.x-vtouch)*press.y;diffuse=mix(diffuse,vec3(1.8,2.,2.5),touch*4.);gl_FragColor=vec4(diffuse,1.);}");let tp=1;const ip=new Ce;function np(e){const t={},i={},n={};let r=128;const s={init:function(){$d.init(undefined),t.ping=e.fbo.createBuffer({name:"Scene - Main Ping",renderer:e.threeRenderer,depth:!0,alpha:!0,stencil:!0}),t.pong=e.fbo.createBuffer({name:"Scene - Main Pong",renderer:e.threeRenderer,depth:!0,alpha:!0,stencil:!0}),o(),r=e.textures.blueNoise.image.naturalWidth,i.main=ll({renderer:e.threeRenderer,vertexShader:ep.vs,fragmentShader:ep.fs,uniforms:Object.assign({res:{value:new Ce},dpi:{value:0},scene:e.currentFrame,uvOverlayOffset:{value:new Ce},time:{value:0},bloom:{value:$d.compositeTexture},bloomExposure:{value:$d.params.exposure},noise:{value:e.textures.blueNoise},ditherOffset:{value:[0,0]},overlayTex:{value:e.textures.bokeh},menuInfluence:{value:0},press:{value:[0,0]}}),defines:{NOISE_SIZE:(s=r,s.toString().includes(".")?s:s+".")}}),n.dither={maxFrames:1,frame:0,value:i.main.u.ditherOffset.value},ep.use(i.main.material),e.renderer.drawingBufferSize.watchImmediate(l);var s},enabled:!0,update:function(){const t=i.main.u;t.menuInfluence.value=W(t.menuInfluence.value,e.game.paused.value?1:0,.1),t.time.value=e.time.elapsed,a=W(a,e.controls.pressed?1:0,e.controls.pressed?.8:.1);const s=t.press.value;s[0]=W(s[0],a*Math.min(0,e.controls.turn)*-1,e.controls.active?.15:.2),s[1]=W(s[1],a*Math.max(0,e.controls.turn),e.controls.active?.15:.2),function(e){if(e.frame+=1,e.frame<e.maxFrames)return;e.frame=0,e.value[0]=_l.randomInt(.5*-r,.5*r),e.value[1]=_l.randomInt(.5*-r,.5*r)}(n.dither)},render:function(){i.main.u.bloomExposure.value=$d.params.exposure,i.main.render()},renderBloom:function(e){$d.render(e)},buffers:t,filters:i,bloom:$d,pingpong:o};e.postprocess=s;let a=0;function o(){const i=t.ping,n=t.pong,r=t.main===i?i:n,s=r===n?i:n;t.main=s,e.previousFrame.value=r.texture,e.currentFrame.value=s.texture}function l(n){t.ping.setSize(n.x,n.y),t.pong.setSize(n.x,n.y),tp=n.x>n.y?n.x/n.y:n.y/n.x,i.main.u.res.value.set(n.x,n.y,1/n.x,1/n.y),i.main.u.dpi.value=e.renderer.pixelRatio.value,ip.x=2>tp?tp/2:1,ip.y=2>tp?.5*(1-tp/2):0,ip.z=2<=tp?2/tp:1,ip.w=2<=tp?.5*(1-2/tp):0,i.main.u.uvOverlayOffset.value.copy(ip)}}const rp=["INPUT","SELECT","TEXTAREA","A","BUTTON"].reduce(((e,t)=>(e[t]=1,e)),{});function sp(e){e.hooks.afterLoad.watchOnce((function(){window.addEventListener("keydown",s),window.addEventListener("keyup",a),e.viewport.visible.watchImmediate((()=>{for(const e in t)t[e]=!1}))})),e.hooks.beforeFrame.watch((function(){const r=e.touch.value,s=X.$rtcDisplay,a=s.enabled.value;s.controls.state,t.keyA||t.KeyD||t.ArrowLeft||t.ArrowRight?n.keyboard=!0:(r.pressed||a&&s.controls.state)&&(n.keyboard=!1);X.$rtcDisplay.enabled.value?(i.left=s.controls.state<0,i.right=s.controls.state>0):(i.left=t.KeyA||t.ArrowLeft||r.pressed&&r.activeFinger.normalizePos.x<0,i.right=t.KeyD||t.ArrowRight||r.pressed&&r.activeFinger.normalizePos.x>0);const o=e.time.stableDt,l=o/16.6667,c=n.active=!(!i.left&&!i.right),u=(n.keyboard,c?.15:.18);n.turnTarget=(-1*+i.left+1*+i.right)*l;(e.game.state.current!==e.game.state.ACTIVE||e.game.autopilot.value)&&(n.turnTarget=0,n.active=!1);n.pressed=r.pressed,n.turn=Z(n.turn,n.turnTarget,u,o,.001),n.direction.set(i.right?1:i.left?-1:0)}));const t={KeyA:!1,KeyD:!1,ArrowLeft:!1,ArrowRight:!1},i={left:!1,right:!1},n=e.controls={active:!1,turn:0,turnTarget:0,pressed:!1,keyboard:!0,steeringMultKeyboard:1.1,steeringMultTouch:.9,rotationMultKeyboard:1,rotationMultTouch:.9,direction:m(0)},r=Object.keys(t).reduce(((e,t)=>(e[t]=1,e)),{});function s(e){(function(e){return!(rp[e.tagName]||e.code&&!r[e.code])})(e)&&(t[e.code]=!0)}function a(e){r[e.code]&&(t[e.code]=!1)}}const ap=["INPUT","SELECT","TEXTAREA","A","BUTTON"].reduce(((e,t)=>(e[t]=1,e)),{}),op=["game","webgl"].reduce(((e,t)=>(e[t]=1,e)),{}),lp=void 0!==window.visualViewport&&void 0!==window.visualViewport.scale,cp=[{identifier:-987654321,clientX:0,clientY:0}];function up(e){return cp[0].clientX=e.clientX||0,cp[0].clientY=e.clientY||0,cp}let hp,dp;const pp=()=>hp=!1;function mp(){hp=!0,clearTimeout(dp),dp=setTimeout(pp,200)}function fp(e){let t;const i=H(),n=i.$router,r=i.$viewport;function s(e){this.name=e,this.position=this.pos=new xe,this.prevPosition=this.prevPos=new xe,this.relPos=this.relativePos=new xe,this.normalizePos=new xe,this.normalizeRelPos=this.normalizeRelativePos=new xe,this.initialPos=new xe,this.vel=this.velocity=new xe,this.identifier=-1,this.used=!1,this.use=e=>{this.used=!0,this.id=e.identifier;const t=r.width.value,i=r.height.value;this.initialPos.set(e.clientX||0,e.clientY||0),this.pos.set(e.clientX||0,e.clientY||0),this.relPos.set(0,0),this.vel.set(0,0),this.normalizePos.set(ie(this.pos.x,0,t,-1,1),ie(this.pos.y,0,i,1,-1)),this.normalizeRelPos.set(0,0)},this.move=e=>{const t=r.width.value,i=r.height.value;this.pos.set(e.clientX,e.clientY),this.relPos.subVectors(this.pos,this.initialPos),this.normalizePos.set(ie(this.pos.x,0,t,-1,1),ie(this.pos.y,0,i,1,-1)),this.normalizeRelPos.set(ie(this.relPos.x,0,t,-1,1),ie(this.relPos.y,0,i,1,-1))},this.unuse=()=>{this.used=!1,this.id=-1}}const a=new s("Finger 1"),o=new s("Finger 2"),l=m({pressed:!1,clickIn:!1,clickOut:!1,pos:new xe,relativePos:new xe,delta:new xe,normalizePos:new xe,normalizeRelativePos:new xe,activeFinger:a}),c={firstPos:new xe,prevPos:new xe,clickIn:!1,clickOut:!1,pressed:!1,pos:new xe(0,0),relativePos:new xe(0,0),delta:new xe(0,0),interactive:!1,active:!1,useTouch:!1,fingerCount:0,containerOffset:new xe};function u(e){return!!e&&(!e.target||!function(e){if(!e)return!1;const t=e.tagName,i=n.currentRoute.value.name||"";return!!(!op[i]||ap[t]||lp&&1!==window.visualViewport.scale)}(e.target))}function h(e){return e.changedTouches[e.changedTouches.length-1]}function d(e){if(e&&void 0!==e.identifier)return a.id===e.identifier?a:o.id===e.identifier?o:null}function p(e){const i=!!e.changedTouches;if(i)mp();else if(hp)return;if(!i&&0!==e.button)return;if(c.fingerCount>=2)return;if(!u(e))return;e.preventDefault();const n=i?h(e):e;c.delta.set(0,0),c.firstPos.set(n.clientX||0,n.clientY||0),c.prevPos.copy(c.firstPos),c.pos.copy(c.firstPos),c.pressed=!0,c.clickIn=!0,c.clickOut=!1;const r=i?e.changedTouches:up(e);for(let t=0;t<r.length;t++){const e=r[t];let i=d(e);i||c.fingerCount>=2||(i=a.used?o:a,i.use(e),y=i,c.fingerCount++)}t=!0,x()}function f(e){const i=!!e.changedTouches,n=i?h(e):e;c.pos.set(n.clientX||0,n.clientY||0),c.pressed?c.relativePos.copy(c.pos).sub(c.firstPos):c.relativePos.set(0,0);const r=i?e.changedTouches:up(e);for(let t=0;t<r.length;t++){const e=r[t],i=d(e);i&&i.move(e)}t=!0}function g(e){const i=!!e.changedTouches;if(i)mp();else if(hp)return;if(!i&&0!==e.button)return;if(u(e))e.preventDefault();else if(!c.pressed)return;i&&h(e);const n=i?e.changedTouches:up(e);for(let t=0;t<n.length;t++){const e=d(n[t]);if(!e)return;e.unuse(),c.fingerCount--}c.clickIn=!1,c.clickOut=c.pressed,t=!0,c.pressed=!(c.fingerCount<=0),x(),t=!0,c.relativePos.set(0,0)}function v(){(c.clickIn||c.clickOut)&&(t=!0),c.clickOut=c.clickIn=!1,c.delta.copy(c.pos).sub(c.prevPos),c.prevPos.copy(c.pos);const e=l.value.delta;t||(t=!c.delta.equals(e)||0!==c.delta),t&&x(),t=!1}e.touch=l,e.hooks.afterLoad.watchOnce((function(){const t=window,i="addEventListener",n={passive:!1};t[i]("touchstart",p,n),t[i]("touchmove",f,n),t[i]("touchend",g,n),t[i]("touchcancel",g,n),t[i]("mousedown",p,n),t[i]("mousemove",f,n),t[i]("mouseup",g,n),t[i]("gesturestart",(e=>e.preventDefault()),n),e.hooks.beforeFrame.watch(v)}));let y=a;function x(){const e=l.value;e.pressed=c.pressed,e.clickIn=c.clickIn,e.clickOut=c.clickOut,e.pos.copy(c.pos),e.relativePos.copy(c.relativePos),e.delta.copy(c.delta);const t={x:r.width.value,y:r.height.value};e.activeFinger=o.used&&!a.used?o:a.used&&!o.used||a.used&&o.used&&y===a?a:a.used&&o.used&&y===o?o:a,e.normalizePos.set(ie(e.pos.x,0,t.x,-1,1),ie(e.pos.y,0,t.y,1,-1)),e.normalizeRelativePos.copy(e.relativePos).divide(t),l.set(e,!0)}}const gp=2*Math.PI,vp=new $t(1,1,1),yp=new De;var xp={beforeEmit:function(e={}){e.position||(e.position=yp),e.scale=e.scale||1,e.angOffset=_l.randomFloat(0,gp)},particleEmitted:function(e,{angOffset:t,position:i,scale:n,velDrag:r,durationMin:s,durationMax:a,sprite:o,color:l,amount:c,billboard:u,velocity:h,opacity:d,gravity:p=0}){const m=gp/c,f=e.index*m+_l.randomFloat(-.2,.2)+t;let g=(.01+_l.randomFloat(-.005,.007))*n;g=.003*h.x,e.billboard=u,e.angVelocity=0,e.spriteId=o,e.velocity.copy(h).multiplyScalar(-1),e.velocity.z+=g*Math.cos(f),e.velocity.y+=g*Math.sin(f),e.rotation.x=Math.PI/-2,e.rotation.z=g*e.velocity.x*Math.cos(f),e.velocityDrag.setScalar(r||.98),e.useVelocityDragMult=!0,e.gravity.y=0,e.position.copy(i),e.duration=_l.randomFloat(s||500,a||900),e.scaleFrom.copy(n),e.scaleTo.setScalar(0),e.alpha=.9,e.colorFrom.copy(l||vp).multiplyScalar(d),e.colorTo.copy(e.colorFrom)}},_p=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:xp});const bp=new Map,wp=e=>e;function Mp(e){return e?(bp.has(e)||bp.set(e,U(e[0],e[1],e[2],e[3])),bp.get(e)):wp}const Sp=Math.PI;new $t(1,1,1);const Tp=new De,Ap=new De,Cp=new Rt,Lp=new Rt;let Pp=0;var Ep={beforeAlloc:function(e){e.amount=Math.min(150-Pp,e.amount),Pp+=e.amount},beforeEmit:function(e={}){e.position||(e.position=Tp),e.scale=e.scale||1,e.angOffset=_l.randomFloat(Sp,0)},particleEmitted:function(e,{angOffset:t,position:i,scale:n,velDrag:r,durationMin:s,durationMax:a,sprite:o,color:l,amount:u,billboard:h,gravity:d=0}){e.spriteId="particleA",e.fadeIn=1e3,e.colorEase=Mp(),e.progressEase=Mp(),e.colorFrom=new $t(0),e.colorTo=new $t(16777215);const p=c(te(J.game.velocity,10,18),0,1),m=_l.randomFloat(5,12),f=_l.randomFloat(2,4),g=W(m,f,p),v=J.game.getRelativeRoadData(g),y=_l.randomFloat(v.scale.y/7,v.scale.y/2);Cp.position.copy(v.position),Cp.quaternion.copy(v.quaternion),Cp.scale.setScalar(y),Cp.updateMatrixWorld();const x=t,_=_l.randomFloat(3,4),b=_*Math.cos(x),w=_*Math.sin(x),M=Cp.localToWorld(Tp.set(0,w,b));Lp.position.copy(M),Lp.up.copy(Ap.set(0,1,0).applyQuaternion(v.quaternion)),Lp.lookAt(Cp.position),Lp.updateMatrixWorld(),e.initialRoadProgress=J.game.progress+g,e.position.copy(Lp.position),e.rotation.copy(Lp.rotation),e.scale.x=1*J.game.velocity,e.scale.y=.11},particleUpdate:function(e,t){e.initialRoadProgress-J.game.progress<-3&&(e.killable=!0),e.progress=e.progressEase(c(e.age/e.fadeIn,0,1)),e.color.copy(e.colorFrom).lerp(e.colorTo,e.colorEase(e.progress)).multiplyScalar(ne(9.5,15,J.game.velocity)*J.scene.gameCam.activeInfluence);const i=.3*J.scene.gameCam.activeInfluence;e.alpha=1-i+(1-ne(10,17,J.game.velocity))},particleReleased:function(){Pp=Math.max(Pp-1,0)}},Dp=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:Ep});const Ip=2*Math.PI,Rp=new $t(1,1,1),zp=new De;var Np={beforeEmit:function(e={}){e.position||(e.position=zp),e.scale=e.scale||1,e.angOffset=_l.randomFloat(0,Ip)},particleEmitted:function(e,{angOffset:t,position:i,scale:n,velDrag:r,sprite:s,color:a,amount:o,billboard:l,duration:c=1e3,velocity:u=1,opacity:h,gravity:d=0}){const p=Ip/o,m=e.index*p+_l.randomFloat(-.2,.2)+t;u+=_l.randomFloat(-.05,.1),u*=1.03,e.delay=_l.randomFloat(0,20),e.billboard=l||!0,e.angVelocity=0,e.spriteId=s,e.velocity.x+=u*Math.cos(m),e.velocity.y+=u*Math.sin(m),e.angle=-m+Math.PI/16,e.velocityDrag.setScalar(r||.97),e.useVelocityDragMult=!0,e.gravity.y=-.03,e.position.copy(i),e.position.add(zp.copy(e.velocity).multiplyScalar(5.5)),e.duration=c*_l.randomFloat(.8,1);const f=(n=n||1).x||n,g=n.y||n;e.scaleFrom.set(f,g),e.scaleTo.setScalar(0),h*=_l.randomFloat(.8,1.2),e.alpha=.3,e.colorFrom.copy(a||Rp).multiplyScalar(h),e.colorTo.copy(e.colorFrom)}},Op=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:Np});const Fp=2*Math.PI,Up=new $t(1,1,1),kp=new De,Bp=Fp;var Vp={beforeEmit:function(e={}){e.position||(e.position=kp),e.scale=e.scale||1,e.angOffset=.6*Fp},particleEmitted:function(e,{angOffset:t,position:i,scale:n,velDrag:r,sprite:s,color:a,amount:o,billboard:l,duration:c,velocity:u=1,opacity:h,gravity:d=0}){const p=Bp/o,m=e.index*p+_l.randomFloat(-.2,.2)+t;u*=_l.randomFloat(.8,1.2),e.billboard=l||!0,e.delay=_l.randomFloat(20,100),e.angVelocity=0,e.spriteId=s,e.velocity.x+=u*Math.cos(m),e.velocity.y+=u*Math.sin(m),e.angle=-m+Math.PI/16,e.velocityDrag.setScalar(r||.98),e.useVelocityDragMult=!0,e.gravity.y=-.2*_l.randomFloat(.2,2.5),e.position.copy(i),e.position.add(kp.copy(e.velocity).multiplyScalar(2.5)),e.duration=c*_l.randomFloat(.8,1);const f=(n=n||1).x||n,g=n.y||n;e.scaleFrom.set(f,g),e.scaleTo.setScalar(0),e.alpha=.9,e.colorFrom.copy(a||Up).multiplyScalar(h),e.colorTo.copy(e.colorFrom)}},Gp=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:Vp});const Wp=new $t(1,1,1),Hp=new $t(0,0,0);new Rt;const jp=new De,qp=[0,.815,.145,1],Xp=[0,.485,.465,1];var Yp={particleEmitted:function(e,{position:t,scale:i,sprite:n,duration:r,rotation:s=0,power:a,gravityY:o=0,powerMult:l=1,glowMult:c=1}){e.billboard=!0,e.spriteId=n,e.position.copy(t||jp),e.duration=r||1e3;const u=(i=i||1).x||i,h=i.y||i;e.scaleFrom.set(u,h),e.scaleTo.copy(e.scaleFrom).multiplyScalar(1.1),e.gravity.y=o,e.angle=s,e.alphaEase=Mp(Xp),e.alphaFrom=(1-(.3+.7*a))*c,e.alphaTo=1,e.colorEase=Mp(qp),e.colorFrom.lerpColors(Hp,Wp,(.5+.5*a)*l),e.colorTo.copy(Hp)}};var Zp=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:Yp});const Jp=new $t(1,1,1),Qp=new $t(0,0,0);new Rt;const Kp=new De,$p=[0,.815,.145,1],em=[0,.485,.465,1];var tm={particleEmitted:function(e,{position:t,scale:i,sprite:n,duration:r,power:s}){e.billboard=!0,e.spriteId=n,e.position.copy(t||Kp),e.duration=r||1e3;const a=(i=i||1).x||i,o=i.y||i;e.scaleFrom.set(a,o),e.scaleTo.copy(e.scaleFrom).multiplyScalar(1.1),e.alphaEase=Mp(em),e.alphaFrom=1-(.3+.7*s),e.alphaTo=1,e.colorEase=Mp($p),e.colorFrom.lerpColors(Qp,Jp,.5+.5*s),e.colorTo.copy(Qp)}};var im=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:tm});const nm=2*Math.PI,rm=new $t(1,1,1),sm=new Rt;var am={beforeEmit:function(e={}){e.position||(e.position=tVec3);e.scale=e.scale||1,e.angOffset=_l.randomFloat(0,nm)},particleEmitted:function(e,{velDrag:t,position:i,scale:n,sprite:r,rotate:s,durationMin:a,durationMax:o}){e.billboard=!1,e.duration=_l.randomFloat(a||100,o||300),e.rotation.z=s?Math.PI/2:0,e.angVelocity=0,e.spriteId=r,e.velocity.x=-.04;const l=.006;e.velocity.y=_l.randomFloat(.1*-.006,.0072),e.velocity.z=_l.randomFloat(-.006,l),e.velocityDrag.setScalar(t||.88),e.useVelocityDragMult=!0,e.position.copy(i),e.scaleFrom.set(1*n,n*_l.randomFloat(7,12)),e.scaleTo.set(.1*n,6*n),sm.position.setScalar(0),sm.lookAt(e.velocity),sm.rotateX(-Math.PI/2),e.rotation.copy(sm.rotation),e.alphaFrom=0,e.alphaTo=1,e.colorFrom.copy(rm),e.colorTo.copy(rm)}};var om=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:am});const lm=2*Math.PI,cm=new $t(1,1,1),um=new $t(.5,.5,1),hm=new De;var dm={beforeEmit:function(e={}){e.position||(e.position=hm),e.scale=e.scale||1,e.angOffset=_l.randomFloat(0,lm)},particleEmitted:function(e,{angOffset:t,position:i,scale:n,velDrag:r,sprite:s,color:a,amount:o,billboard:l,velocity:c,opacity:u}){const h=lm/o,d=e.index*h+_l.randomFloat(-.2,.2)+t,p=_l.randomFloat(.0018,.002);e.billboard=l,e.angVelocity=0,e.spriteId=s,e.velocity.copy(c),e.velocity.x*=-1*_l.randomFloat(.0075,.015);const m=_l.randomFloat(.7,.9);e.velocity.z+=p*Math.cos(d)*m,e.velocity.y+=p*Math.sin(d)*m,e.angle=m*Math.cos(d),e.velocityDrag.setScalar(r||.98),e.useVelocityDragMult=!0,e.gravity.y=_l.randomFloat(-1e-4,22e-5),e.position.copy(i),e.duration=_l.randomFloat(500,900),e.scaleFrom.copy(n),e.scaleTo.setScalar(0),e.alpha=.2,e.colorFrom.copy(a||cm).multiplyScalar(u),e.colorTo.copy(um)}},pm=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:dm});const mm=2*Math.PI,fm=new $t(1,1,1),gm=new De;var vm={beforeEmit:function(e={}){e.position||(e.position=gm),e.scale=e.scale||1,e.angOffset=_l.randomFloat(0,mm)},particleEmitted:function(e,{angOffset:t,position:i,scale:n,velDrag:r,durationMin:s,durationMax:a,sprite:o,color:l,amount:c,billboard:u,velocity:h,opacity:d,gravity:p=0}){const m=mm/c,f=e.index*m+_l.randomFloat(-.2,.2)+t;let g=(.01+_l.randomFloat(-.005,.007))*n;g=.003*h.x,e.billboard=u,e.angVelocity=0,e.spriteId=o,e.velocity.copy(h).multiplyScalar(-1),e.velocity.z+=g*Math.cos(f),e.velocity.y+=g*Math.sin(f),e.rotation.x=Math.PI/-2,e.rotation.z=g*e.velocity.x*Math.cos(f),e.velocityDrag.setScalar(r||.98),e.useVelocityDragMult=!0,e.gravity.y=0,e.position.copy(i),e.duration=_l.randomFloat(s||500,a||900),e.scaleFrom.copy(n),e.scaleTo.setScalar(0),e.alpha=.9,e.colorFrom.copy(l||fm).multiplyScalar(d),e.colorTo.copy(e.colorFrom)}},ym=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:vm});const xm=new Ee,_m=1/Number.MAX_SAFE_INTEGER,bm={};let wm;new Rt;class Mm extends cc{constructor(e){e.useEuler=!0,super(e),wm||(wm=j()),this.batcher&&this.batcher.removeInstance(this),this.spriteId=null,this.spriteFrame=0,this.spriteFrameDuration=50,this.spriteLoop=!1,this.spriteAutoplay=!1,this.rotation=new yt,this.delay=0,this.duration=0,this.age=0,this.progress=0,this.onProgress=null,this.onComplete=null,this.onEnd=null,this.angVelocity=0,this.angVelocityDrag=0,this.velocity=new De,this.velocityDrag=new De,this.velocityDragMult=new De,this.useVelocityDragMult=!1,this.scaleWithVel=!1,this.gravity=new De,this.scaleFrom=new xe,this.scaleTo=new xe,this.colorFrom=new $t,this.colorTo=new $t,this.alphaFrom=1,this.alphaTo=1,this.alive=!1,this.killable=!1,this.progressEase=Mp(),this.scaleEase=Mp(),this.alphaEase=Mp(),this.colorEase=Mp(),this.scaleVelEase=Mp([0,1,.5,1])}reset(){this.alive&&this.onRelease&&this.onRelease(),this.preset&&this.preset.particleReleased&&this.preset.particleReleased(this,this.presetOptions),this.parent=null,this.preset=bm,this.spriteId=null,this.spriteFrame=0,this.spriteFrameDuration=50,this.spriteLoop=!1,this.spriteAutoplay=!1,this.billboard=!1,this.angle=0,this.quaternion.copy(xm),this.rotation.set(0,0,0),this.position.setScalar(0),this.scale.setScalar(1),this.delay=0,this.duration=1e3,this.age=0,this.progress=0,this.onProgress=null,this.onComplete=null,this.onRelease=null,this.angVelocity=0,this.angVelocityDrag=0,this.velocity.setScalar(0),this.velocityDrag.setScalar(0),this.useVelocityDragMult=!1,this.scaleWithVel=!1,this.gravity.setScalar(0),this.scaleFrom.setScalar(1),this.scaleTo.setScalar(1),this.colorFrom.setRGB(255,255,255),this.colorTo.setRGB(255,255,255),this.alphaFrom=1,this.alphaTo=1,this.progressEase=Mp(),this.scaleEase=Mp(),this.alphaEase=Mp(),this.colorEase=Mp(),this.scaleVelEase=Mp([.7,.3,.2,.2])}emit(e,t,i,n){this.reset(),this.batcher=e,this.spriteId=this.killable=!1,this.alive=!0,this.index=n,this.billboard=i.billboard||!1,this.parent=i.parent,this.preset=t||bm,this.presetOptions=i||bm,this.preset.particleEmitted&&this.preset.particleEmitted(this,this.presetOptions),this.sprite.setAtlas(this.batcher.atlas),this.sprite.change({id:this.spriteId,frame:this.spriteFrame,frameDuration:this.spriteFrameDuration,loop:this.spriteLoop,autoplay:this.spriteAutoplay}),this.batcher.addInstance(this),this.sprite.update(1),this.update(0)}kill(){this.killable&&this.preset.particleKilled&&this.preset.particleKilled(this,this.presetOptions),this.killable&&this.onComplete&&this.onComplete(),this.batcher&&(this.batcher.removeInstance(this),this.batcher=null),this.reset(),this.progress=1,this.alive=!1,this.killable=!1}update(){if(!this.alive||this.killable)return;if(this.progress>=1)return this.killable=!0;let e=wm.time.stableDt;if(this.delay>0){if(this.delay-=e,this.delay>0)return this.alpha=0,void this.scale.setScalar(_m);e=Math.max(0,e+this.delay)}super.update(e);const t=Math.max(Math.min(e/16.666666667,1.5),.5);if(this.age+=e,this.progress=this.progressEase(c(this.age/this.duration,0,1)),this.preset.particleUpdate)this.preset.particleUpdate(this,this.presetOptions);else{if(this.useVelocityDragMult)this.velocity.multiply(this.velocityDrag),this.velocity.lengthSq<1e-4&&this.velocity.setScalar(0);else{if(this.velocity.x){const e=Math.sign(this.velocity.x);this.velocity.x-=e*this.velocityDrag.x*t,Math.sign(this.velocity.x)!==e&&(this.velocity.x=0)}if(this.velocity.y){const e=Math.sign(this.velocity.y);this.velocity.y-=e*this.velocityDrag.y*t,Math.sign(this.velocity.y)!==e&&(this.velocity.y=0)}if(this.velocity.z){const e=Math.sign(this.velocity.z);this.velocity.z-=e*this.velocityDrag.z*t,Math.sign(this.velocity.z)!==e&&(this.velocity.z=0)}}if(this.angVelocity){const e=Math.sign(this.angVelocity);this.angVelocity-=e*this.angVelocityDrag*t,Math.sign(this.angVelocity)!==e&&(this.angVelocity=0)}this.position.x+=(this.velocity.x+this.gravity.x)*t,this.position.y+=(this.velocity.y+this.gravity.y)*t,this.position.z+=(this.velocity.z+this.gravity.z)*t,this.billboard?this.angle+=this.angVelocity*t:this.rotation.z+=this.angVelocity*t,this.scaleWithVel?this.scale.copy(this.scaleFrom).lerp(this.scaleTo,this.scaleVelEase(this.progress)):this.scale.copy(this.scaleFrom).lerp(this.scaleTo,this.scaleEase(this.progress)),this.color.copy(this.colorFrom).lerp(this.colorTo,this.colorEase(this.progress)),this.alpha=W(this.alphaFrom,this.alphaTo,this.alphaEase(this.progress))}this.preset.particleUpdated&&this.preset.particleUpdated(this,this.presetOptions),this.onProgress&&this.onProgress(this,this.progress)}}const Sm={};class Tm extends fl{constructor(e){super(e),e.batcher&&(e.batchers=[e.batcher]),this.count=e.count||150,this.dead=new Array(this.count).fill(0).map((()=>new Mm({}))),this.alive=[],this.batchers=e.batchers||[]}emit(e,t={},i){"number"==typeof t&&(t={amount:t});const n=t.amount=t.amount||1,r=Sm[e];if(!r)return;if(r.beforeAlloc&&r.beforeAlloc(t),t.amount<=0)return;const s=this.batchers[i]||this.batchers[0],a=this.alloc(n);r.beforeEmit&&r.beforeEmit(t,a);for(let o=a.length-1;o>=0;o--)a[o].alive||0,this.alive.push(a[o]),a[o].emit(s,r,t,o)}update(e){const t=[];for(let i=this.alive.length-1;i>=0;i--){const n=this.alive[i];n.update(e),n.killable&&(t.push(n),this.alive.splice(i,1),this.dead.push(n))}for(let i=t.length-1;i>=0;i--)t[i].kill()}alloc(e){const t=this.dead,i=this.alive;let n=[],r=e;return t.length>0&&(n=t.splice(0,r)),r-=n.length,r>0&&(n=n.concat(i.splice(0,r))),n}killAll(){for(let e=this.alive.length-1;e>=0;e--)this.alive[e].kill(),this.dead.push(this.alive[e]),this.alive.splice(e,1)}registerPreset(e,t){!function(e,t){t||(t={}),Sm[e]=t}(e,t)}}let Am=0;const Cm=new en,Lm=new Map,Pm=new Rt,Em=new Ee,Dm={default:1,additive:2},Im={double:2,front:0,back:1};var Rm=class extends jl{init(e){this.needsUpdate=!0,this.atlas=e.atlas,this.count=e.count||200,this.geo=new zo,this.geo.index=Cm.index,this.geo.attributes.position=Cm.attributes.position,this.geo.attributes.uv=Cm.attributes.uv,this.initAttributes(),this.layers=[],this.layersHashmap={},this.instances=new Set,this.setDynamic(e.dynamic);const t=this.getMaterial(e);this.base=new Ri(this.geo,t),this.base.renderOrder=e.renderOrder,this.base.frustumCulled=!!e.frustumCulled,this.currentCount=0,this.updateAttributes=this.updateAttributes.bind(this)}setDynamic(e){this.dynamic=null==e||!!e,this.interleavedBuffer.setUsage(this.dynamic?35048:StaticDrawUsage),this.interleavedBuffer.needsUpdate=!0,this.needsUpdate=!0}getMaterial(e){const t=e.material;if(!t)return;Lm.has(t)||Lm.set(t,{});const i=Lm.get(t),n=e.atlas;if(!n)return;null==n.meta.atlasIndex&&(n.meta.atlasIndex=++Am);const r=null==e.depthWrite||e.depthWrite,s=null==e.depthTest||e.depthTest,a=null!=e.blending?e.blending:"default",c=null!=e.transparent&&e.transparent,u=null!=e.alphaTest&&e.alphaTest,h=null!=e.side?e.side:"front",d=[n.meta.atlasIndex,h+"",r.toString(),s.toString(),a.toString(),c.toString(),u.toString()].join("_");if(i[d])return i[d];const p=o({},e);return delete p.material,i[d]=new t(l(o({},p),{atlas:n,side:Im[h],blending:"function"==typeof a?a:Dm[a],depthWrite:!!r,depthTest:!!s,transparent:!!c,alphaTest:!!u}))}initAttributes(){this.stride=20,this.buffer=new Float32Array(this.count*this.stride);const e=this.geo,t=this.interleavedBuffer=new jo(this.buffer,this.stride);e.setAttribute("texCoords",new Hs(t,4,0,!1)),e.setAttribute("meshCoords",new Hs(t,4,4,!1)),e.setAttribute("spritePos",new Hs(t,3,8,!1)),e.setAttribute("billboard",new Hs(t,1,11,!1)),e.setAttribute("spriteQt",new Hs(t,4,12,!1)),e.setAttribute("spriteColor",new Hs(t,4,16,!1)),t.needsUpdate=!0}updateAttributes(e){if(!e||!e.visible)return;const t=this.currentCount++,i=this.buffer,n=this.stride,r=e.sprite.frame;let s=t*n;e.useEuler&&e.quaternion.setFromEuler(e.rotation);let a=e.position,o=e.quaternion,l=e.scale;if(e.parent){const t=e.parent;Pm.position.copy(a),Pm.quaternion.copy(e.billboard?Em:o),Pm.scale.set(l.x,l.y,1),Pm.applyMatrix4(t.matrixWorld),Pm.updateMatrixWorld(),a=Pm.position,o=Pm.quaternion,l=Pm.scale}const c=e.billboard?e.angle:o.x;i[s++]=r.texCoords[0],i[s++]=r.texCoords[1],i[s++]=r.texCoords[2],i[s++]=r.texCoords[3],i[s++]=r.meshCoords[0]*e.scale.x,i[s++]=r.meshCoords[1]*e.scale.y,i[s++]=r.meshCoords[2]*e.scale.x,i[s++]=r.meshCoords[3]*e.scale.y,i[s++]=a.x,i[s++]=a.y,i[s++]=a.z,i[s++]=e.billboard?1:0,i[s++]=c,i[s++]=o.y,i[s++]=o.z,i[s++]=o.w,i[s++]=e.color.r,i[s++]=e.color.g,i[s++]=e.color.b,i[s++]=e.alpha}addInstance(e){this.instances.has(e)||this.instances.add(e)}removeInstance(e){this.instances.has(e)&&this.instances.delete(e)}update(){this.dynamic&&(this.currentCount=0,this.instances.forEach(this.updateAttributes),this.geo.instanceCount=this.currentCount,this.interleavedBuffer.needsUpdate=!0)}clearInstances(){this.instances.clear()}destroy(){this.clearInstances(),this.geo.dispose(),super.destroy()}},zm=cl("precision highp float;attribute vec4 texCoords;attribute vec4 meshCoords;attribute vec3 spritePos;attribute vec4 spriteQt;attribute vec4 spriteColor;attribute float billboard;varying vec2 vUv;varying vec4 vColor;\n#include <get_instance_matrix>\nvoid main(){vColor=spriteColor;vUv=uv*texCoords.zw+texCoords.xy;vUv.y=1.-vUv.y;vec3 transformed=position;transformed.xy=transformed.xy*meshCoords.zw+(meshCoords.xy*0.5);transformed.xy+=meshCoords.xy*0.5;mat4 instanceMatrix=getInstanceMatrix(spritePos,spriteQt,vec3(1.));vec4 mvPosition=modelViewMatrix*instanceMatrix*vec4(transformed,1.);vec4 bbPosition=modelViewMatrix*instanceMatrix*vec4(0.0,0.0,0.0,1.0);bbPosition.x+=cos(spriteQt.x)*transformed.x-sin(spriteQt.x)*transformed.y;bbPosition.y+=sin(spriteQt.x)*transformed.x+cos(spriteQt.x)*transformed.y;mvPosition=mix(mvPosition,bbPosition,billboard);gl_Position=projectionMatrix*mvPosition;}","precision highp float;uniform sampler2D atlas;varying vec2 vUv;varying vec4 vColor;void main(){vec2 uv=vUv;vec3 color=texture2D(atlas,uv).rgb;float alpha=1.-(color.r*(1.-vColor.a));gl_FragColor=vec4(vColor.rgb*color,alpha);}");class Nm extends ki{constructor(e={}){const t=e.atlas;delete e.atlas,delete e.renderOrder;const i="function"==typeof e.blending&&e.blending;i&&delete e.blending,super(e),this.uniforms=l(o({},e.uniforms||{}),{atlas:{value:t.texture,type:"t"}}),i&&i(this),e.vertexShader||e.fragmentShader||zm.use(this)}}const Om={"/webgl/particlePresets/burst.js":_p,"/webgl/particlePresets/dashline.js":Dp,"/webgl/particlePresets/fireworksBurst.js":Op,"/webgl/particlePresets/fireworksBurstFall.js":Gp,"/webgl/particlePresets/fireworksFlash.js":Zp,"/webgl/particlePresets/flash.js":im,"/webgl/particlePresets/hitSparkles.js":om,"/webgl/particlePresets/line.js":pm,"/webgl/particlePresets/smoke.js":ym},Fm=Object.entries(Om).map((([e,t])=>({id:e.split("/").pop().split(".js").shift(),module:t.default})));function Um(e){const t={init:function(t){const a={renderOrder:e.store.renderOrder.sprites,material:Nm,atlas:e.atlas,blending:Uc,depthWrite:!1,depthTest:!1};i=new Rm(o({},a)),n=new Rm(l(o({},a),{depthTest:!0})),t.add(i.base),t.add(n.base);r=new Tm({batchers:[i,n]}),Fm.forEach((e=>r.registerPreset(e.id,e.module))),e.game.hooks.reset.watch(s)},emit:function(e,t={}){if(!r)return;const i=t.depthTest?1:0;return r.emit(e,t,i)},update:function(){if(e.game.isPaused())return;i.update(),n.update(),r.update()},get batcher(){return i},get batcherDepth(){return n}};let i,n,r;function s(){r.killAll()}e.particles=e.game.particles=t}function km(){}const Bm={},Vm={};function Gm(e){try{return e.stop(),!1}catch(t){return!0}}function Wm(e){return Bm[e]||(Bm[e]=new Promise((t=>{const i=new XMLHttpRequest;i.open("GET",e,!0),i.responseType="arraybuffer",i.onload=()=>t(i.response),i.send()}))),Bm[e]}function Hm(e,t){return e?(Vm[t]||(Vm[t]=new Promise((i=>{Wm(t).then((t=>{e.decodeAudioData(t,(e=>i(e)))}))}))),Vm[t]):Wm(t)}class jm{constructor(e){this.onEnded=this.onEnded.bind(this),this.onLoaded=this.onLoaded.bind(this),this.controller=e,this.context=e.getContext(),this.input=null,this.output=this.context.createGain()}reset(e={}){this.onStop=null,this.stop(),this.pausedProgress=0,this.fadein=e.fadein||0,this.fadeout=e.fadeout||0,this.fadeinTimer=0,this.fadeoutTimer=0,this.fadeinActive=!1,this.fadeoutActive=!1,this.needsPlay=!1,this.isPlaying=!1,this.isStopping=!1,this.hasEnded=!1,this.loaded=!1,this.stopped=!1,this.id=e.id||null,this.source=null,this.buffer=null,this.loop=!!e.loop,this.autoplay=!!e.autoplay,this.playbackRate=e.playbackRate||1,this.volume=e.volume||1,this.realvolume=-1,this.loopStart=e.loopStart||0,this.loopEnd=e.loopEnd||0,this.onStop=e.onStop||km,this.baseOffset=e.start||e.baseOffset||0,this.duration=e.duration;const t=e.input||this.controller.getInput();t!==this.input&&(this.input&&this.output.disconnect(this.input),this.input=t,this.output.connect(this.input)),Hm(this.context,e.path).then(this.onLoaded),this.autoplay&&this.play()}onLoaded(e){this.isStopping||this.stopped||this.stopped||(this.loaded=!0,this.buffer=e,this.needsPlay&&this.play())}onEnded(){this.loop||(this.hasEnded=!0,this.stop())}getOutput(){return this.output}update(e){if(!this.source)return;let t=this.volume;if(this.fadeinActive){this.fadeinTimer+=e;const i=c(this.fadeinTimer/this.fadein,0,1);t*=i,1===i&&(this.fadeinActive=!1)}if(this.fadeoutActive){this.fadeoutTimer+=e;const i=c(1-this.fadeoutTimer/this.fadeout,0,1);t*=i,0===i&&this.realstop()}t!==this.realvolume&&this.setVolume(t)}play(){if(this.source&&this.stop(),!this.loaded)return void(this.needsPlay=!0);const e=this.source=this.context.createBufferSource();if(e.buffer=this.buffer,e.onended=this.onEnded,this.startTime=this.context.currentTime,this.isPlaying=!0,this.needsPlay=!1,!e||!e.buffer)return this.stop();this.progressStart=this.startTime-this.offset,this.duration||(this.duration=e.buffer.duration);const t=Math.max(this.duration-this.offset,.01),i=function(e,t,i,n){try{return e.start(t,i,n),!1}catch(r){return!0}}(this.source,this.startTime,(this.baseOffset+this.offset)%e.buffer.duration,this.duration?t:void 0);i?requestAnimationFrame((()=>this.stop())):(this.fadein&&0===this.fadeinTimer?this.setVolume(0,!0):this.setVolume(this.volume,!0),this.fadein&&(this.fadeinActive=!0),this.setPlaybackRate(this.playbackRate),this.connect(),this.setLoop(this.loop))}getCurrentTime(){return this.getProgress()*this.duration}getProgress(){return this.isPlaying?(this.context.currentTime-this.progressStart)/this.duration:this.pausedProgress}connect(){this.source.connect(this.output)}disconnect(){this.source.disconnect(this.output)}pause(){this.pausedProgress=this.getProgress(),this.offset+=(this.context.currentTime-this.startTime)*this.playbackRate,this.needsPlay=!1,this.isPlaying=!1,this.source&&(Gm(this.source),this.source.onended=null,this.source=null)}realstop(){this.onStop&&this.onStop(this),this.onStop=null,this.offset=0,this.needsPlay=!1,this.isPlaying=!1,this.isStopping=!1,this.fadeinActive=!1,this.fadeoutActive=!1,this.stopped=!0,this.source&&(Gm(this.source),this.source.onended=null,this.source=null)}stop(e={}){this.isStopping||(this.isStopping=!0,e.fadeout&&(this.fadeout=e.fadeout),this.fadeout?this.fadeoutActive=!0:this.realstop())}getPlaybackRate(){return this.playbackRate}setPlaybackRate(e){this.playbackRate=e,this.isPlaying&&this.source&&this.source.playbackRate.setTargetAtTime(this.playbackRate,this.context.currentTime,.01)}getLoop(){return this.loop}setLoop(e){this.loop=e,this.isPlaying&&this.source&&(this.source.loop=this.loop,this.source.loopStart=this.loopStart,this.source.loopEnd=this.loopEnd)}getVolume(){return this.output.gain.value}setVolume(e,t,i=.01){this.realvolume=e,t&&(this.output.gain.value=this.realvolume),this.output.gain.setTargetAtTime(this.realvolume,this.context.currentTime,i)}release(){jm.release(this)}}jm.pool=[],jm.get=function(e,t){const i=jm.pool.pop()||new jm(e);return i.reset(t),i},jm.release=function(e){e.buffer=null,e.onStop=null,jm.pool.length<50&&jm.pool.push(e)};const qm=window.performance||window.Date,Xm=["click","touchend","keydown"],Ym=window.AudioContext||window.webkitAudioContext;let Zm=null,Jm=null,Qm=null,Km=!1;const $m={initialized:!1,unlocked:!1,unlockerListening:!0,lastStuckCheck:qm.now(),stuckTimer:0,previousWebAudioTime:0},ef={onContextCreation:null,onUnlock:null,onStuck:null};function tf(e){const t=e.createBufferSource();t.buffer=e.createBuffer(1,1,44100),t.connect(e.destination),t.start(0),t.disconnect()}function nf(){$m.unlocked||(!function(){if(Qm)return;Qm=function(){try{const e=new Ym;return tf(e),e.close(),new Ym}catch(e){return null}}(),$m.initialized=!0,ef.onContextCreation&&ef.onContextCreation(Qm);af()}(),Qm.suspend(),window.setTimeout((()=>Qm.resume()),10),tf(Qm),rf(),function(){$m.unlockerListening=!1;for(const e of Xm)document.removeEventListener(e,nf,{passive:!0})}(),$m.unlocked=!0,$m.stuckTimer=-800,$m.lastStuckCheck=qm.now(),ef.onUnlock&&ef.onUnlock())}function rf(e=!1){return new Promise((e=>{Jm||(Jm=document.createElement("audio"),Jm.setAttribute("x-webkit-airplay","deny"),Jm.preload="auto",Jm.loop=!1,Jm.src=Zm,Jm.load()),Jm.pause(),Jm.currentTime=0;try{Promise.resolve().then((()=>Jm.play())).then((()=>e(!0))).catch((t=>{e(!1)}))}catch(t){e(!1)}}))}function sf(){$m.unlocked=!1,$m.unlockerListening=!0;for(const e of Xm)document.addEventListener(e,nf,{passive:!0})}function af(){window.requestAnimationFrame(af);const e=qm.now(),t=e-$m.lastStuckCheck;if(!$m.initialized||!Qm||t<400)return;const i=Qm.currentTime,n=i===$m.previousWebAudioTime;$m.stuckTimer=n?$m.stuckTimer+t:0,$m.previousWebAudioTime=i,$m.lastStuckCheck=e,$m.stuckTimer>400&&$m.unlocked&&!$m.unlockerListening&&(sf(),ef.onStuck&&ef.onStuck())}var of={init:function(){$m.initialized||(Zm=function(e){const t=new ArrayBuffer(10),i=new DataView(t);return i.setUint32(0,e,!0),i.setUint32(4,e,!0),i.setUint16(8,1,!0),`data:audio/wav;base64,UklGRisAAABXQVZFZm10IBAAAAABAAEA${window.btoa(String.fromCharCode(...new Uint8Array(t))).slice(0,13)}AgAZGF0YQcAAACAgICAgICAAAA=`}(44100),sf(),async function(){await rf(!0)&&nf()}())},getVolume:function(e){return e.gain.value},setVolume:function(e,t){e.gain.setTargetAtTime(t,Qm.currentTime,.01)},getContext:()=>Qm,isUnlocked:()=>$m.unlocked,set debug(e){Km=e},set onContextCreation(e){ef.onContextCreation=e},set onUnlock(e){ef.onUnlock=e},set onStuck(e){ef.onStuck=e}};const lf={};JSON.parse('[["Boost_Line_Loop",0,16,16],["Button",16.25,16.5,0.25],["Car_Engine_Boost",16.75,22.3809,5.6309],["Car_Engine_Loop_AirFlow",22.6309,27.1309,4.5],["Car_Engine_Loop_High",27.3809,31.8809,4.5],["Car_Engine_Loop_Low",32.1309,36.6309,4.5],["Car_Engine_Loop_Mid",36.8809,41.3809,4.5],["Car_Friction_Loop",41.6309,45.1375,3.5066],["Car_Impact",[[45.3875,46.2837,0.8962],[46.5337,47.43,0.8962],[47.68,48.5762,0.8962],[48.8262,49.7224,0.8962],[49.9724,50.8686,0.8962]]],["FireworksEnd",[[51.1186,52.7831,1.6645],[53.0331,55.007,1.9739],[55.257,57.0637,1.8067],[57.3137,59.0446,1.7309],[59.2946,60.9627,1.6681]]],["UI_Countdown_GO",61.2127,64.3783,3.1656],["UI_Countdown_One",64.6283,67.316,2.6877],["UI_Countdown_Three",67.566,70.1448,2.5788],["UI_Countdown_Two",70.3948,73.1069,2.7121],["UI_Finish",73.3569,76.5225,3.1656],["UI_Hover_Tiny",76.7725,76.8764,0.1039],["UI_Pause",77.1264,78.9815,1.8551],["UI_QRCode",79.2315,81.5343,2.3028],["UI_ResulTime",81.7843,84.4429,2.6585],["UI_Title_TheRace",84.6929,87.5254,2.8326],["UI_Validate_Big",87.7754,89.8833,2.1079],["UI_Validate_Small",90.1333,91.8986,1.7654]]').forEach((([e,t,i,n])=>{lf[e]=Array.isArray(t)?{id:e,path:"/assets/audiosprites.5ae006ed21e5b1ef.m4a",variations:t.map((t=>({id:e,start:t[0],end:t[1],duration:t[2]})))}:{id:e,path:"/assets/audiosprites.5ae006ed21e5b1ef.m4a",start:t,end:i,duration:n}})),lf.Music_Layer1_SoftBeat={path:"/assets/Music_Layer1_SoftBeat.d230ffac21e5b1ef.m4a",unique:!0},lf.Music_Layer2_Pad={path:"/assets/Music_Layer2_Pad.97e61a1b21e5b1ef.m4a",unique:!0},lf.Music_Layer3_Drum={path:"/assets/Music_Layer3_Drum.c70889f121e5b1ef.m4a",unique:!0},lf.Music_Layer4_BassSnare={path:"/assets/Music_Layer4_BassSnare.0c2dc41121e5b1ef.m4a",unique:!0};var cf=lf;const uf=.05*Math.log(10);const hf=e=>{return t=e+0,Math.exp(t*uf);var t},df=(e,t)=>Object.assign(cf[e],t);df("Music_Layer1_SoftBeat",{volume:hf(0),fadein:5e3,loop:!0}),df("Music_Layer2_Pad",{volume:hf(0),fadein:5e3,loop:!0}),df("Music_Layer3_Drum",{volume:hf(0),fadein:5e3,loop:!0}),df("Music_Layer4_BassSnare",{volume:hf(0),fadein:5e3,loop:!0});df("Car_Engine_Loop_Low",{fadein:1e3,loop:!0}),df("Car_Engine_Loop_Mid",{fadein:1e3,loop:!0}),df("Car_Engine_Loop_High",{fadein:1e3,loop:!0}),df("Car_Engine_Loop_AirFlow",{fadein:1e3,loop:!0}),df("Car_Friction_Loop",{loop:!0,fadein:300,fadeout:300}),df("Boost_Line_Loop",{loop:!0}),df("UI_Hover_Tiny",{randomRate:[.9,1.1],volume:.75}),df("UI_Validate_Big",{volume:.7}),df("UI_Validate_Small",{volume:.7}),df("Button",{randomRate:[.1,2],volume:.8});const pf=[{id:"Music_Layer1_SoftBeat",type:"softbeat"},{id:"Music_Layer2_Pad",type:"pad"},{id:"Music_Layer3_Drum",type:"drum"},{id:"Music_Layer4_BassSnare",type:"snareGuitar"}],mf={nothing:[],pad:["pad"],"pad+drum":["pad","drum"],"pad+guitar":["pad","snareGuitar"],"pad+drum+guitar":["pad","drum","snareGuitar"],"pad+drum+softbeat":["pad","drum","softbeat"],"pad+guitar+softbeat":["pad","snareGuitar","softbeat"],all:["softbeat","pad","drum","snareGuitar"],intro:["softbeat","pad"],outro:["pad","drum"]};const ff=Mp([.345,.005,.635,1]),gf=()=>0,vf=()=>1,yf=e=>ff(e),xf=e=>1-ff(e),_f=Mp([.57,.06,.925,.595]),bf=e=>e,wf=Mp([.555,.03,1,.81]),Mf=Mp([0,.705,.49,.995]),Sf=Mp([0,.705,.49,.995]),Tf=[{id:"Car_Engine_Loop_Low",pitchFrom:.5,pitchTo:2,before:xf,middle:.6,after:gf,gain:.63},{id:"Car_Engine_Loop_Mid",pitchFrom:.5,pitchTo:2,before:yf,middle:.5,after:xf,gain:.63*.95},{id:"Car_Engine_Loop_High",pitchFrom:.5,pitchTo:2,before:gf,middle:.3,after:yf,gain:.63*.9},{id:"Car_Engine_Loop_AirFlow",pitchFrom:1,pitchTo:3,before:vf,middle:.5,after:vf,gain:1.2}],Af=Mp([0,.745,.195,.995]),Cf=Mp([.735,.02,1,.295]),Lf=[4,5.2,6.5,7.7,8.3,9.4],Pf=["INACTIVE","DECREASE","INCREASE","COOLDOWN"].reduce(((e,t,i)=>(e[t]=i,e)),{});function Ef(e,t){const i=e.game;let n=!1,r=0,s=0,a=0,o=1,l=1,u=0,h=Pf.INACTIVE,d=0,p=1,m=1;return{onUnlock:async function(){const i=[];for(const e of Tf)i.push(t.preloadSound(e.id));await Promise.all(i);for(const e of Tf)t.stopSound(e.id),e.instance=t.playSound(e.id);n||(e.hooks.afterUpdate.watch(g),n=!0)}};function f(e,t){null!=t&&(p=m=t),d=0,h=e}function g(){!function(){if(e.game.paused.value)return;const t=e.time.stableDt,n=i.velocity;if(d+=t,e.game.turbo.active.value)f(Pf.INACTIVE,1);else switch(h){case Pf.INACTIVE:for(let e=0;e<Lf.length;e++){const t=Lf[e];if(u<t&&n>=t){u=t,f(Pf.DECREASE,1);break}n<=t&&u>=t&&(u=t)}break;case Pf.DECREASE:p=Y(p,0,.6,t),m=ie(Af(p),0,1,.55,1),p<1e-4&&f(Pf.INCREASE);break;case Pf.INCREASE:p=Y(p,1,.1,t),m=ie(Cf(p),0,1,.55,1),p>.999&&f(Pf.COOLDOWN,1);break;case Pf.COOLDOWN:d>150&&f(Pf.INACTIVE,1)}}();const t=e.time.stableDt,n=i.velocity;o=W(o,1-e.game.paused.value,.1);const g=.25*i.minVelocity,v=i.maxVelocity,y=c(te(n,g,v),0,1),x=bf(c(te(n,0,g),0,1));let _=_f(y)*m;const b=W(1,.8,wf(c(te(_,.6,1),0,1))),w=e.scene.currentCamera,M=e.scene.road.pointer,S=w.base.position.distanceTo(M.base.position),T=w.isGameCamera&&w.activeInfluence<.9999,A=+(w.isIdleCamera||1-(w.activeInfluence||0)),C=1-Mf(c(te(S,.3,15),0,1));const L=W(1,1.15*C,A);let P=(e=>1-Sf(c(te(e,0,20),0,1)))(S);w.carTowardsCam&&(P=1-P);let E=null!=w.engineMult?w.engineMult:1;T&&(E=1.2);const D=W(.8*_*E,_*E,P);_=W(_,D,A);const I=e.game.turbo.active.value;l=W(l,I?1.2:1,I?.1:.07),_*=l,a=1*Math.abs(e.controls.turn-r)+.1*Math.abs(e.controls.turn),s=Y(s,a,.1,t),r=e.controls.turn,_*=1-s;for(let e=0;e<Tf.length;e++){const t=Tf[e],i=W(t.pitchFrom,t.pitchTo,_);t.rate=i;const n=_>t.middle,r=n?t.middle:0,s=n?1:t.middle,a=(n?t.after:t.before)(te(_,r,s));t.volume=a*x*b*t.gain*L*o,t.instance&&(t.instance.volume=t.volume,t.instance.setPlaybackRate(t.rate))}}}const Df=(e,t)=>void 0!==e?e:t;function If(e){const t=m(!1);let i,n,r,s=!1,a=!1;const o=e=>e.update(r),l={},c=new Set;let u=1;const h={main:1,fade:1,mute:1},d={muted:t,init:function(){if(s)return;s=!0,of.debug=!0,of.onUnlock=x,of.onContextCreation=v,of.onStuck=y,of.init(),G.add(b),O((()=>X.$stores.muted),(e=>d.muted.set(e)),{immediate:!0}),e.viewport.visible.watch(g),d.muted.watchImmediate(_)},get masterVolume(){return u},getContext:()=>i,getInput:()=>n,play:M,pause:S,stop:T,playSound:A,stopSound:function(e,t={}){const i=l[e];if(!i)return;i.forEach((e=>e.stop(t)))},preloadSound:function(e){const t=cf[e];if(!t)return;const n=t.path;return Hm(i,n)},setBgm:function(e){p.setPreset(e)}};e.audio=e.game.audio=d;const p=function(e,t){let i=mf.nothing,n=!1;return{onUnlock:r,setPreset:function(e){const t=mf[e];t&&t!==i&&(i=t,a())},restart:function(){n&&r()}};async function r(){const e=[];for(const i of pf)e.push(t.preloadSound(i.id));await Promise.all(e);for(const i of pf)t.stopSound(i.id),i.instance=t.playSound(i.id),i.baseVolume=i.instance.volume,i.targetVolume=i.baseVolume;n||(G.add(s),n=!0),a(!0)}function s(){for(const e of pf)e.instance.volume!==e.targetVolume&&(e.instance.volume=Q(e.instance.volume,e.targetVolume,.025,.001))}function a(e){for(const t of pf)t.targetVolume=i.includes(t.type)?t.baseVolume:0,e&&(t.instance.volume=t.targetVolume)}}(0,d),f=Ef(e,d);function g(e){i&&(e?(M(),h.fade=1):(S(),h.fade=0),w())}function v(e){i=e,n=e.createGain(),n.connect(e.destination)}function y(){T()}function x(){p.onUnlock(i),f.onUnlock(i)}function _(e){h.mute=e?0:1}function b(e){if(of.isUnlocked()){r=e;for(const t of c)t.timer-=e,t.timer<=0&&(c.delete(t),A(t.id,t.opts));if(w(),!a)for(const e in l)l[e].forEach(o)}}function w(){const e=h;u=e.main*e.fade*e.mute,of.setVolume(n,u)}function M(){if(a){a=!1;for(const e in l)l[e].forEach((e=>{e.loop||e.play()}))}}function S(){if(!a){a=!0;for(const e in l)l[e].forEach((e=>{e.loop||e.pause()}))}}function T(){for(const e in l)l[e].forEach((e=>e.stop()))}function A(e,t={}){if(!of.isUnlocked())return;const i=cf[e];if(!i)return;if(t.delay){const i=t.delay;return delete t.delay,void c.add({id:e,opts:t,timer:i})}if(l[e]||(l[e]=new Set),i.unique&&l[e].size>0){const t=l[e].values().next().value;return t.play(),t}if(t.id=e,t.path=i.path,t.onStop=C,t.autoplay=!0,t.loop=Df(t.loop,!!i.loop),t.fadein=t.fadein||i.fadein,t.fadeout=t.fadeout||i.fadeout,i.variations){let e=t.variation&&i.variations[t.variation-1];e||(e=Ul(i.variations)),t.start=Df(t.start,e.start),t.duration=Df(t.duration,e.duration),t.loopStart=Df(t.loopStart,Df(e.loopStart,t.start)),t.loopEnd=Df(t.loopEnd,Df(e.loopEnd,t.start+t.duration))}else t.start=Df(t.start,i.start),t.duration=Df(t.duration,i.duration),t.loopStart=Df(t.loopStart,Df(i.loopStart,t.start)),t.loopEnd=Df(t.loopEnd,Df(i.loopEnd,t.start+t.duration));var n,r;t.volume=Df(t.volume,Df(i.volume,1)),t.playbackRate=i.randomRate?(n=i.randomRate[0],r=i.randomRate[1],Math.random()*(r-n)+n):null!=t.playbackRate?t.playbackRate:1;const s=jm.get(d,t);return l[e].add(s),s}function C(e){const t=l;e.release();const i=t[e.id];i&&i.delete(e)}}function Rf(e){let t,i;async function n(){const n=e.postprocess;i.update(),t.update(),n.update()}async function r(){const n=e.threeRenderer,r=e.postprocess;r.enabled&&r.pingpong(),n.setRenderTarget(r.enabled?r.buffers.main:null),n.clearDepth(),i.render(),t.render(),r.enabled&&(r.bloom.enabled&&r.renderBloom(r.buffers.main),n.setRenderTarget(null),r.render())}function s(t){const i=H(),n=e.renderer,r=e.threeRenderer,s=e.postprocess,a=e.scene,o=a.lightning,l=s.bloom,c=i.$device.type.mobile,u=r.capabilities.isWebGL2,h="safari"===i.$device.browser,d=c||!u||h;switch(a.setNear(d?.16:.08),t){case 5:n.setMaxPixelRatio(2),n.setMinPixelRatio(1.5),o.setShadowSize(256),o.toggleShadow(!0),a.setFar(d?200:240),l.resize(512,512),l.enabled=!0,e.postprocess.enabled=!0;break;case 4:n.setMaxPixelRatio(c?1.6:1.75),n.setMinPixelRatio(c?1:1.2),o.setShadowSize(128),o.toggleShadow(!0),a.setFar(d?190:230),l.resize(512,512),l.enabled=!0,e.postprocess.enabled=!0;break;case 3:n.setMaxPixelRatio(c?1.25:1.5),n.setMinPixelRatio(1),o.setShadowSize(64),o.toggleShadow(!0),a.setFar(d?170:220),l.resize(256,256),l.enabled=!0,e.postprocess.enabled=!0;break;case 2:n.setMaxPixelRatio(c?1:1.15),n.setMinPixelRatio(1),o.setShadowSize(64),o.toggleShadow(!0),a.setFar(d?160:200),l.resize(256,256),l.enabled=!0,e.postprocess.enabled=!0;break;case 1:n.setMaxPixelRatio(1),n.setMinPixelRatio(1),o.setShadowSize(4),o.toggleShadow(!1),a.setFar(d?150:180),l.resize(128,128),l.enabled=!1,e.postprocess.enabled=!0;break;default:n.setMaxPixelRatio(1),n.setMinPixelRatio(1),o.setShadowSize(4),o.toggleShadow(!1),a.setFar(d?140:170),l.resize(128,128),l.enabled=!1,e.postprocess.enabled=!1}}!function(){for(const e in Pu){const t=e.split("/").pop().slice(0,-".glsl".length);tn[t]=Pu[e].default}}(),e.plugins.push(Ed,Dd,fp,Rd,Fd,sp,Um,np,If),Object.assign(e,{init:async function(){const{renderer:t}=e;Object.assign(t.options,{precision:"highp",antialiased:!1,premultipliedAlpha:!1,stencil:!1}),e.time.clampTo60Fps=!0,t.init();const i=t.instance;tl(i),i.setClearColor(11184810),i.autoClear=!1,t.setMaxPixelRatio(1),i.shadowMap.enabled=!0,i.shadowMap.type=2},start:async function(){i=e.background=new ml,t=e.scene=new Lu,e.renderer.resize(),e.time.init(),e.postprocess.init(),e.audio.init(),e.prerender(),e.quality.current.watchImmediate(s)},load:async function(){return e.audio.preloadSound("Car_Engine_Loop_AirFlow"),e.assets.load()},update:n,render:r,prerender:async function(){n(),r()}})}const zf=function(){};let Nf=null;K((async(e,t={})=>{le(Ee,(e=>e.set(0,0,0,0))),le($t,(e=>e.setRGB(0,0,0))),le(xe,(e=>e.setScalar(0))),le(De,(e=>e.setScalar(0))),le(Ce,(e=>e.setScalar(0))),le(yt,(e=>e.set(0,0,0,"XYZ"))),le(lt);const i=t,n={},r=[!1,Ko,Jo,$o,el].filter(Boolean),s=f(),a=f(),o=f(),l=f(),c=f(),u=f(),h=f(),d=f(),p=f(),m=f(),g=f(),v=f(),y=f(),x=f(),_=f(),b=f(),w={beforePluginsInstall:s,afterPluginsInstall:a,beforeInit:o,afterInit:l,beforeLoad:c,afterLoad:u,beforeStart:h,afterStart:d,beforePrerender:p,afterPrerender:m,beforeFrame:g,afterFrame:v,beforeUpdate:y,afterUpdate:x,beforeRender:_,afterRender:b};function M(){e.update(),e.render()}function S(t,i){return t.install?t.install(e,i):"function"==typeof t?t(e,i):void 0}function T(t,i){const n=e[t]||zf;if("function"==typeof i)e[t]=i(n);else{const s=!!i,a=(r=t).charAt(0).toUpperCase()+r.slice(1),o=w["before"+a]||zf,l=w["after"+a]||zf;e[t]=s?async function(e){o.emit(),await n(e),l.emit()}:function(e){o.emit(),n(e),l.emit()}}var r;return e[t]}return Object.assign(e,{options:i,state:n,plugins:r,hooks:w,init:function(){e.renderer.init()},load:zf,start:function(){e.renderer.resize(),e.time.init()},frame:M,update:zf,render:zf,prerender:M}),Rf(e),T("load",!0),T("start",!0),T("frame"),T("update"),T("render"),T("init",(t=>i=>{o.emit(),function(){s.emit();const t=e.plugins.filter(Boolean);for(const e of t){const t=Array.isArray(e);S(t?e[0]:e,t?e[1]:{})}a.emit()}(),t(i),l.emit()})),T("prerender",(e=>t=>{p.emit(),n.prerendering=!0,e(t),n.prerendering=!1,m.emit()})),await e.init(t),Nf=e,e}));const Of=()=>Nf;function Ff(e={}){const t=b();let i={initialized:t,start:async function(e={}){await s.start(e)},post:function(e,t={}){t.type=e}};e.customize&&(i=e.customize(i)||i);const n=i.init,r=i.load;i.init=e=>(async function(e={}){n&&(e=await n(e));await $(e),s=Of(),t.resolve()}(e),t),i.load=async function(e={}){await t,r&&(e=await r(e));await s.load(e)};let s=null;return i}let Uf=null;function kf(e={}){let t,i;const n=Uf={getElement:function(){return t},install:function(r){const s=r.config.globalProperties;s.$webGL=n,r.provide("webGL",n),r.component("WebGL",ae),t=document.createElement("canvas"),i=Ff({app:r,customize:e.bridge}),n.bridge=i,n.load=e=>s.$preloader.task(i.load(e)),n.prerender=i.prerender,s.$preloader.task(i.init({canvas:t})),n.load({type:"main"}),s.$preloader.beforeExit(i.start),delete n.install}};return n}let Bf=location.origin+window.__DATA.config.basepath;const Vf=window.__DATA.site.locale;!!window.__DATA.site.locales[Vf].default||(Bf+="/"+Vf+"/");function Gf(e={}){let t,i,n=null,r=0;const s=D(null),a=D(!1),c=w(),u={sendFinish:(e,t)=>{v(),c.sendMessage(M.DisplayFinish,JSON.stringify({score:Math.round(e),best:Math.round(t)})),i=setTimeout((()=>c.close()),1500)}},h={left:!1,right:!1,state:0,reset:()=>{h.update(!1,!1),h.update(!0,!1)},update:(e,t)=>{e?h.right=t:h.left=t,h.state=t?e?1:-1:e?h.left?-1:0:h.right?1:0}},d=l(o({install:function(e){c.install(e),e.provide("rtcDisplay",d),t=e.config.globalProperties,t.$rtcDisplay=d,c.config({apiKey:"AIzaSyAQmo2SWDl0JX-gW5tMQe0e2QfWa35igJI",authDomain:"montblanc-explorer.firebaseapp.com",databaseURL:"https://montblanc-explorer-default-rtdb.europe-west1.firebasedatabase.app/",projectId:"montblanc-explorer",storageBucket:"montblanc-explorer.appspot.com",messagingSenderId:"731776289118",appId:"1:731776289118:web:3e46f50aad6cd0b0b4a7cf"}),c.watch(m),c.watchStatus(y)},rtc:c,webRTC:c,createRoom:async function(){return n=await c.createRoom(),n},controls:h,error:s,throwError:g,cancelError:v,enabled:a,enable:function(){t.$stores.menuOpen=!1,a.value=!0},disable:function(){t.$stores.menuOpen=!1,a.value=!1},reset:p},u),{get roomURL(){return Bf+"remote/?c="+(n||"")},get roomID(){return n}});return d;function p(){clearTimeout(i),v(),h.reset(),t.$router.push({name:"qrcode-home"})}function m(e){const i=t.$route&&t.$route.name;switch(e){case"remoteReady":case M.RemoteReady:"qrcode-home"===i&&t.$router.push({name:"game"});break;case M.RemoteLeftUp:h.update(!1,!1);break;case M.RemoteLeftDown:h.update(!1,!0);break;case M.RemoteRightUp:h.update(!0,!1);break;case M.RemoteRightDown:h.update(!0,!0)}}function f(){p()}function g(){J.game.state.isGameRunning()&&(s.value||(s.value=!0,r=setTimeout(f,1e4)))}function v(){s.value=!1,clearTimeout(r)}function y(e){"error"===e||"close"===e?g():"connect"===e&&v()}}const Wf=[S,se,ee,T,A,C,L,kf,Gf,P];async function Hf(e,t={}){const i=await S(Object.assign({},t.appHooks));e.use(i);const n=await se(Object.assign({},t.router));e.use(n);const r=await ee(Object.assign({},t.stores));e.use(r);const s=await T(Object.assign({},t.preloader));e.use(s);const a=await A(Object.assign({},t.i18n));e.use(a);const o=await C(Object.assign({},t.device));e.use(o);const l=await L(Object.assign({},t.viewport));e.use(l);const c=await kf(Object.assign({},t.webgl));e.use(c);const u=await Gf(Object.assign({},t.rtcDisplay));e.use(u);const h=await P(Object.assign({},t.statsPlugin));e.use(h)}export{Hf as default,Wf as list};
